
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."CREATE_RAW_AGG_TABLES" (XTABLE_NAME IN VARCHAR2)
AS 
xTABLE_SCRIPT VARCHAR2(32000); 

XAGGREGATE_TABLE_NAME VARCHAR(50);
XSTATEMENT CLOB;
XTABLE_EXISTS  NUMBER;
XERROR VARCHAR2(4000);
XERROR_CODE NUMBER;

BEGIN
    
 FOR XAGGS IN
 (
      SELECT DISTINCT A.AGG_SHEMA,A.XLEVEL
      FROM
      (
    
      SELECT 'NORTHI_RAW_DA' AGG_SHEMA,'DA' XLEVEL  FROM DUAL UNION ALL 
      SELECT 'NORTHI_RAW_WA' AGG_SHEMA,'WA' XLEVEL  FROM DUAL UNION ALL 
      SELECT 'NORTHI_RAW_MA' AGG_SHEMA,'MA' XLEVEL  FROM DUAL
     
      ) A,NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST B
      WHERE TABLE_NAME=XTABLE_NAME
 )
    LOOP
    XAGGREGATE_TABLE_NAME:=XTABLE_NAME;
            
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XAGGREGATE_TABLE_NAME AND OWNER=XAGGS.AGG_SHEMA;
    XTABLE_EXISTS:=NVL(XTABLE_EXISTS,0);

    IF  XTABLE_EXISTS>0 THEN
        xTABLE_SCRIPT:='';
        FOR XMISSION IN 
        (
                SELECT  DISTINCT COLUMN_NAME ,DATA_LENGTH FIELD_LENGTH, T.DATA_TYPE
                FROM ALL_TAB_COLUMNS T WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME  AND OWNER=XAGGS.AGG_SHEMA AND TRIM(COLUMN_NAME) NOT IN(
                SELECT COLUMN_NAME  FROM 
                ALL_TAB_COLUMNS WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME AND OWNER=XAGGS.AGG_SHEMA)
        )
        LOOP
              IF XMISSION.DATA_TYPE='VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE ' || XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
              IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE ' || XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
        END LOOP;
    END IF;
                            
                                
    IF  XTABLE_EXISTS=0 THEN
         xTABLE_SCRIPT:='';
         FOR XFIELDS IN
         (
            SELECT  DISTINCT UPPER(COUNTER_NAME_DB) COUNTER_NAME, COUNTER_TYPE, 12 FIELD_LENGTH FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME AND IS_ACTIVE=1
         )
          LOOP
               IF XFIELDS.COUNTER_TYPE='VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.COUNTER_NAME||' '||XFIELDS.COUNTER_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
               END IF;
               IF XFIELDS.COUNTER_TYPE<>'VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.COUNTER_NAME||' '||XFIELDS.COUNTER_TYPE||', ';
               END IF;
          END LOOP; 
          
          xTABLE_SCRIPT:='CREATE TABLE '|| XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ( '||SUBSTR(xTABLE_SCRIPT,1,LENGTH(xTABLE_SCRIPT)-2)||' ) ' ||
                                    '   PCTFREE    0
                                        INITRANS   25
                                        MAXTRANS   255
                                        STORAGE    (
                                                    BUFFER_POOL      DEFAULT
                                                    FLASH_CACHE      DEFAULT
                                                    CELL_FLASH_CACHE DEFAULT
                                                    initial 64k
                                                    next 64k
                                                   )
                                        PARTITION BY RANGE (DATA_DATE) ' ||
                                            CASE XAGGS.XLEVEL
                                                 WHEN 'DA' THEN ' INTERVAL(NUMTODSINTERVAL(1,''DAY'')) '
                                                 ELSE ' INTERVAL(NUMTOYMINTERVAL(1,''MONTH'')) '
                                            END
                                     || ' 
                                        (  
                                          PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('' 2018-01-01 00:00:00'', ''SYYYY-MM-DD HH24:MI:SS'', ''NLS_CALENDAR=GREGORIAN''))
                                            LOGGING
                                            compress for query high 
                                            PCTFREE    0
                                            INITRANS   25
                                            MAXTRANS   255
                                            STORAGE    (
                                                        MAXSIZE          UNLIMITED
                                                        BUFFER_POOL      DEFAULT
                                                        FLASH_CACHE      DEFAULT
                                                        CELL_FLASH_CACHE DEFAULT
                                                        initial 64k
                                                        next 64k
                                                       )
                                        )  
                                        compress for query high 
                                        NOCACHE
                                        NOPARALLEL
                                        MONITORING';
        XSTATEMENT:=xTABLE_SCRIPT;
        
           INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
        VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'CREATE_AGGREGATE_TABLENN',XSTATEMENT);
        
        EXECUTE IMMEDIATE XSTATEMENT;
          
    END IF;
   END LOOP;
   EXCEPTION
 WHEN OTHERS THEN
 BEGIN
   XERROR:=SUBSTR(SQLERRM,1,4000);
   XERROR_CODE:=SQLCODE;
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'CREATE_AGGREGATE_TABLE',XSTATEMENT);
 END;
END CREATE_RAW_AGG_TABLES;
/
