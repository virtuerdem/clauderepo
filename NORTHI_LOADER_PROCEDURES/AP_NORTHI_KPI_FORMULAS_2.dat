
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."AP_NORTHI_KPI_FORMULAS_2" (XKPI_CODE NUMBER)
AS
XVENDOR_FORMULA VARCHAR2(32000);
XVENDOR_FORMULA_DB VARCHAR2(32000);
XVENDOR_FORMULA_DEFINITION VARCHAR2(32000);
XCOUNTER_ID VARCHAR2(31);
XCOUNTER_NAME VARCHAR2(32000);
XCOUNTER_DESCRIPTION VARCHAR2(32000);
BEGIN
    
    DELETE FROM NORTHI_KPI_FORMULAS_CGDS_2 WHERE RECORD_ID=XKPI_CODE; commit;
    
    FOR XLOOP IN
    (
        SELECT TABLE_NAME,RECORD_ID,TITLE_ID, PHASE,FIELD_ALIAS KPI_NAME,FIELD_EXPRESSION,NE_TYPE,FIELD_CAPTION, KPI_GROUP
        FROM NORTHI_DATA.NORTHI_BASIC_REPORT_DEFINITION
        WHERE RECORD_ID=XKPI_CODE
        ORDER BY KPI_NAME
    )
    LOOP 
        FOR XVENDOR_LIST IN
        (
            SELECT DISTINCT VENDOR_ID 
            FROM NORTHI_KPI_FIELDS  A, NORTHI_TABLE_FIELDS B
            WHERE A.TABLE_NAME=B.TABLE_NAME AND A.LOCAL_FIELD=B.LOCAL_FIELD
            AND A.RECORD_ID=XLOOP.RECORD_ID 
                    )
        LOOP
            XVENDOR_FORMULA_DB:=XLOOP.FIELD_EXPRESSION;
            XVENDOR_FORMULA:=XLOOP.FIELD_EXPRESSION;
            XVENDOR_FORMULA_DEFINITION:= XLOOP.FIELD_EXPRESSION;
            
            FOR XLOOP2 IN
            (
                SELECT A.TABLE_NAME, A.KPI_NAME, A.KPI_GROUP, A.LOCAL_FIELD, VENDOR_ID,  REGEXP_REPLACE(C.REMOTE_FIELD, '[A-Z]{1,2}\.|[A-Z]{1,2}(\d)\.|[A-Z]{,1}\.', '') REMOTE_FIELD  ,-1 NE_LEVEL
                FROM NORTHI_KPI_FIELDS A, NORTHI_TABLE_FIELDS C
                WHERE A.TABLE_NAME=C.TABLE_NAME AND A.LOCAL_FIELD=C.LOCAL_FIELD
                AND A.RECORD_ID=XLOOP.RECORD_ID
                AND VENDOR_ID= XVENDOR_LIST.VENDOR_ID
                ORDER BY A.TABLE_NAME,A.KPI_NAME, LENGTH(A.LOCAL_FIELD) DESC
            )
            LOOP
                XVENDOR_FORMULA_DB:=REPLACE(XVENDOR_FORMULA_DB,XLOOP2.LOCAL_FIELD,XLOOP2.REMOTE_FIELD);
                XVENDOR_FORMULA:=   REPLACE(XVENDOR_FORMULA,XLOOP2.LOCAL_FIELD,XLOOP2.REMOTE_FIELD);
                XVENDOR_FORMULA_DEFINITION:= REPLACE(XVENDOR_FORMULA_DEFINITION,XLOOP2.LOCAL_FIELD,XLOOP2.REMOTE_FIELD);
                FOR XLOOP3 IN 
                (
                    SELECT * FROM (SELECT TO_CHAR(TRIM(REGEXP_SUBSTR(FIELD_EXP, '[^,]+', 1, LEVEL))) AS LOCAL_FIELD
                    FROM 
                    (
                        SELECT MULTIPLE_REPLACE( XLOOP2.REMOTE_FIELD,
                                     NEW t_text( 'ROUND(',',2)','SUM(','MAX(','MIN(','AVG(','DECODE(','+','-','*','/',',0,0,',',0,1,',')','(','NVL(','(',',100',',,,',',,',',8',',104576,',',NULL,',',1,',',60,60,',',0,','NORTHI_DATA.BTRAFFIC_CALCULATE'),
                                     NEW t_text( '','','','','','','',',',',',',',',',',',',',',','(','','','',',',',','',',',',',',',',',',','')
                                   ) FIELD_EXP 
                        FROM DUAL
                    )
                    CONNECT BY LEVEL <= REGEXP_count(FIELD_EXP, '[^,]+')+1
                    ) WHERE LOCAL_FIELD IS NOT NULL
                )
                LOOP
                    SELECT COUNTER_ID , COUNTER_NAME, COUNTER_DESCRIPTION INTO XCOUNTER_ID,XCOUNTER_NAME,XCOUNTER_DESCRIPTION
                    FROM 
                    (
                        SELECT TO_CHAR(COUNTER_NAME_DB) COUNTER_ID, TABLE_NAME,
                               DECODE(COUNTER_NAME_LOOKUP,NULL,COUNTER_NAME_DB,COUNTER_NAME_LOOKUP) COUNTER_NAME,
                               DECODE(COUNTER_DESCRIPTION,NULL,COUNTER_NAME_DB,COUNTER_DESCRIPTION)COUNTER_DESCRIPTION 
                          FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST WHERE OPERATOR_NAME='VODAFONE' 
                         UNION ALL
                        SELECT SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COUNTER_ID,
                               SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) TABLE_NAME,
                               SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COUNTER_NAME,
                               SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COUNTER_DESCRIPTION
                          FROM DUAL
                    ) A, NORTHI_LOADER.NORTHI_LOADER_PARENTS B
                    WHERE A.TABLE_NAME = B.PARENT_NAME AND COUNTER_ID=SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) AND B.TABLE_NAME = XLOOP2.TABLE_NAME
                    AND ROWNUM=1 ;
                    XVENDOR_FORMULA:=REPLACE(XVENDOR_FORMULA,XCOUNTER_ID,XCOUNTER_NAME);
                    XVENDOR_FORMULA_DEFINITION:=REPLACE(XVENDOR_FORMULA_DEFINITION,XCOUNTER_ID,XCOUNTER_DESCRIPTION); 
                   
                    
                END LOOP;
                
            END LOOP;
            
            
            
            INSERT INTO NORTHI_KPI_FORMULAS_CGDS_2(TABLE_NAME, KPI_NAME, VENDOR, NORTHI_FORMULA, VENDOR_FORMULA, NE_LEVEL,VENDOR_FORMULA_DB,VENDOR_FORMULA_DEFINITION,RECORD_ID,KPI_CAPTION,KPI_GROUP)
            VALUES(XLOOP.TABLE_NAME,XLOOP.KPI_NAME,XVENDOR_LIST.VENDOR_ID,XLOOP.FIELD_EXPRESSION,XVENDOR_FORMULA,XLOOP.NE_TYPE,XVENDOR_FORMULA_DB, XVENDOR_FORMULA_DEFINITION, XLOOP.RECORD_ID,XLOOP.FIELD_CAPTION,XLOOP.KPI_GROUP);
            COMMIT;
       END LOOP;
    END LOOP;
    
END;
/
