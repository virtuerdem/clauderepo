
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."Z_PROC_REPORT_CELL_GLOBAL_3G" (XDATE DATE) 
AS
BEGIN
     DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    
    INSERT /*+ append */  INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
    SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
    UTIL_POW,
    R99_CODE_USAGE,
    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
    MEANRTWP,MINRTWP,
    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
    AMR_CTRL_DL12_2 ,
    RB_DLCONVCS_64 , 
    R99,
    HSDPA_TOTALBYTES ,
    HSUPA_TOTALBYTES ,
    TARIH,
    1 BH_TYPE
    FROM 
    (
      SELECT A.NETWORK_ID,
             CELL,
             UTIL_POW,
             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
             MEANRTWP,
             MAXRTWP,
             MINRTWP,
             AMR_CTRL_DL12_2,
             RB_DLCONVCS_64,
             R99,
             HSDPA_TOTALBYTES,
             HSUPA_TOTALBYTES,
             TARIH
     FROM (
     /*SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL, 
                AA.RNCID,
                (POWER(10,AVG(AA.C67199618)/10)-0.15*POWER(10,MAX(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,MAX(CC.MAXTXPOWER)/100)) AS UTIL_POW, 
                AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64) R99_CODE_USAGE ,
                --AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700+C50341688)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64)/(256*0.75)*100 R99_CODE_USAGE ,
                AVG(C67199617) MEANRTWP,
                AVG(C67199680) MAXRTWP, 
                AVG(C67199681) MINRTWP,
                SUM(C67199620)/2 AMR_CTRL_DL12_2 ,
                SUM(C67199556)/2 RB_DLCONVCS_64 , 
                SUM(C67184000+C67183999+C67183998+C67183997+C67183996+C67183995+C67183994+C67183993+C67184008+C67184007+C67184006+C67184005+C67184004+
                C67184003+C67184002+C67184001+C67184021+C67184020+C67184019+C67184018+C67184017+C67184016+C67184015+C67184014+C67184029+C67184028+
                C67184027+C67184026+C67184025+C67184024+C67184023+C67184022) R99,
                SUM(C67189840) HSDPA_TOTALBYTES ,
                SUM(C67192486) HSUPA_TOTALBYTES ,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                M2000.M2_TX_RX_POWER_PER_CELL AA,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(XDATE)-30 AND TRUNC(XDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                M2000.M2_MULTI_RAB_SERVICE_PER_CELL DD,
                M2000.M2_RB_PROC_PER_CELL EE,
                M2000.M2_THROUGHPUT_PER_CELL FF,
                M2000.M2_HSDPA_PER_CELL GG,
                M2000.M2_HSUPA_PER_CELL HH
                --,M2000. M2_HSDPA_PER_LOCAL_CELL XX
                WHERE
                AA.NETWORK_ID = DD.NETWORK_ID AND AA.RNCID = DD.RNCID AND 
                AA.DATA_DATE = DD.DATA_DATE AND
                AA.NETWORK_ID = EE.NETWORK_ID AND AA.RNCID = EE.RNCID AND 
                AA.DATA_DATE = EE.DATA_DATE AND
                AA.NETWORK_ID = FF.NETWORK_ID AND AA.RNCID = FF.RNCID AND 
                AA.DATA_DATE = FF.DATA_DATE AND
                AA.NETWORK_ID = GG.NETWORK_ID AND AA.RNCID = GG.RNCID AND 
                AA.DATA_DATE = GG.DATA_DATE AND
                AA.NETWORK_ID = HH.NETWORK_ID AND AA.RNCID = HH.RNCID AND 
                AA.DATA_DATE = HH.DATA_DATE AND
                AA.NETWORK_ID = BB.CELL_ID AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND
                AA.C67199618 > 0 AND
                BB.CELL_NAME = CELLNAME 
                GROUP BY
                AA.NETWORK_ID,BB.CELL_NAME,AA.RNCID , TRUNC(AA.DATA_DATE,'HH24')*/
                               SELECT 
                B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                (POWER(10,(VS_MEAN_TCP/2)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                CODES_USED_AVG R99_CODE_USAGE, --AVG
                VS_MEANRTWP MEANRTWP, --AVG
                VS_MAXRTWP MAXRTWP, --AVG
                VS_MINRTWP MINRTWP, --AVG
                CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                TRAF_HSUPA HSUPA_TOTALBYTES
                FROM 
                (
                SELECT NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                FROM M2000.M2_THROUGHPUT_PER_CELL
                WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
                GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') 
                ) A, NORTHI_DATA.CELL_STATISTICS B,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB
                WHERE A.NETWORK_ID=B.NETWORK_ID
                AND A.RNCID=B.RNC_ID 
                AND A.DATA_DATE=B.FRAGMENT_DATE
                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                AND B.DTYPE=1
                AND VS_MEAN_TCP>0
                AND B.NETWORK_ID = BB.CELL_ID
                AND BB.CELL_NAME = CELLNAME
                )A,
                  M2000.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE B.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
           ) 
    )
    WHERE RN=1;
            
    COMMIT;
    
    INSERT /*+ append */  INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G        
    SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000)  DESC) RN,
    UTIL_POW,
    R99_CODE_USAGE,
    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL,
    MEANRTWP,MINRTWP,
    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
    AMR_CTRL_DL12_2 ,
    RB_DLCONVCS_64 , 
    R99,
    HSDPA_TOTALBYTES ,
    HSUPA_TOTALBYTES ,
    TARIH,
    2 BH_TYPE
    FROM 
    ( SELECT A.NETWORK_ID,
             CELL,
             
             UTIL_POW,
             (R99_CODE_USAGE+(C50341688*16))/(236*0.75)*100 R99_CODE_USAGE,
             MEANRTWP,
             MAXRTWP,
             MINRTWP,
             AMR_CTRL_DL12_2,
             RB_DLCONVCS_64,
             R99,
             HSDPA_TOTALBYTES,
             HSUPA_TOTALBYTES,
             TARIH
             FROM (
            /* SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL,
                AA.RNCID, 
                (POWER(10,AVG(AA.C67199618)/10)-0.15*POWER(10,MAX(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,MAX(CC.MAXTXPOWER)/100)) AS UTIL_POW, 
                AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64) R99_CODE_USAGE ,
                --AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700+C50341688)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64)/(236*0.75)*100 R99_CODE_USAGE ,
                AVG(C67199617) MEANRTWP,
                AVG(C67199680) MAXRTWP, 
                AVG(C67199681) MINRTWP,
                SUM(C67199620)/2 AMR_CTRL_DL12_2 ,
                SUM(C67199556)/2 RB_DLCONVCS_64 , 
                SUM(C67184000+C67183999+C67183998+C67183997+C67183996+C67183995+C67183994+C67183993+C67184008+C67184007+C67184006+C67184005+C67184004+
                C67184003+C67184002+C67184001+C67184021+C67184020+C67184019+C67184018+C67184017+C67184016+C67184015+C67184014+C67184029+C67184028+
                C67184027+C67184026+C67184025+C67184024+C67184023+C67184022) R99,
                SUM(C67189840) HSDPA_TOTALBYTES ,
                SUM(C67192486) HSUPA_TOTALBYTES ,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                M2000.M2_TX_RX_POWER_PER_CELL AA,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(XDATE)-30 AND trunc(XDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                M2000.M2_MULTI_RAB_SERVICE_PER_CELL DD,
                M2000.M2_RB_PROC_PER_CELL EE,
                M2000.M2_THROUGHPUT_PER_CELL FF,
                M2000.M2_HSDPA_PER_CELL GG,
                M2000.M2_HSUPA_PER_CELL HH
                --,M2000. M2_HSDPA_PER_LOCAL_CELL XX
                WHERE
                AA.NETWORK_ID = DD.NETWORK_ID AND AA.RNCID = DD.RNCID AND 
                AA.DATA_DATE = DD.DATA_DATE AND
                AA.NETWORK_ID = EE.NETWORK_ID AND AA.RNCID = EE.RNCID AND 
                AA.DATA_DATE = EE.DATA_DATE AND
                AA.NETWORK_ID = FF.NETWORK_ID AND AA.RNCID = FF.RNCID AND 
                AA.DATA_DATE = FF.DATA_DATE AND
                AA.NETWORK_ID = GG.NETWORK_ID AND AA.RNCID = GG.RNCID AND 
                AA.DATA_DATE = GG.DATA_DATE AND
                AA.NETWORK_ID = HH.NETWORK_ID AND AA.RNCID = HH.RNCID AND 
                AA.DATA_DATE = HH.DATA_DATE AND
                AA.NETWORK_ID = BB.CELL_ID AND
                --AA.NETWORK_ID=XX.LOCAL_CELL_ID AND
                -- TRUNC(AA.DATA_DATE,'HH24') =XX.DATA_DATE AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND
                AA.C67199618 > 0 AND
                BB.CELL_NAME = CELLNAME 
                GROUP BY
                AA.NETWORK_ID,AA.RNCID,BB.CELL_NAME,TRUNC(AA.DATA_DATE,'HH24')*/
                               SELECT 
                B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                (POWER(10,(VS_MEAN_TCP/2)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                CODES_USED_AVG R99_CODE_USAGE, --AVG
                VS_MEANRTWP MEANRTWP, --AVG
                VS_MAXRTWP MAXRTWP, --AVG
                VS_MINRTWP MINRTWP, --AVG
                CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                TRAF_HSUPA HSUPA_TOTALBYTES
                FROM 
                (
                SELECT NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                FROM M2000.M2_THROUGHPUT_PER_CELL
                WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
                GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') 
                ) A, NORTHI_DATA.CELL_STATISTICS B,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+40 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB
                WHERE A.NETWORK_ID=B.NETWORK_ID
                AND A.RNCID=B.RNC_ID 
                AND A.DATA_DATE=B.FRAGMENT_DATE
                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                AND B.DTYPE=1
                AND VS_MEAN_TCP>0
                AND B.NETWORK_ID = BB.CELL_ID
                AND BB.CELL_NAME = CELLNAME
                 )A,
                  M2000.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
                )
     )
     WHERE RN=1;
            
     COMMIT;
END;
/
