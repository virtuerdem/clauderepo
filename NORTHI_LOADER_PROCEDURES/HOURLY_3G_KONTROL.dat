
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."HOURLY_3G_KONTROL" 
AS
XDAY1 NUMBER;
XDAY2 NUMBER;
XFARK NUMBER;


BEGIN 

 WITH DS_3G AS
    (
    SELECT   /*+ MATERIALIZE PARALLEL 8 */ 
    NVL(SUM(DECODE(FRAGMENT_DATE,TRUNC(SYSDATE,'HH24')-5/24,CNT,'' )),0) "HOUR_5"
    FROM 
    (
    SELECT FRAGMENT_DATE, COUNT(DISTINCT NETWORK_ID) CNT FROM NORTHI_DATA.CELL_STATISTICS WHERE (F_DL_ID IS NULL OR F_DL_ID = -99) AND FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-5/24 AND DTYPE = 1 GROUP BY FRAGMENT_DATE
    )
    )
    
    SELECT /*+ PARALLEL(8) */  HOUR_5 INTO XFARK
    FROM DS_3G;

   IF XFARK >= 10000 THEN
    
     UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, LOADER_COUNT=2 WHERE DATA_DATE = TRUNC(SYSDATE,'HH24')-5/24 AND ORG_TABLE='CELL_STATISTICS'; COMMIT;
     
     DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME = 'CELL_STATISTICS' AND FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-5/24; COMMIT;

   END IF;

END;
/
