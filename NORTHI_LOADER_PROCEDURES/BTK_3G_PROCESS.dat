
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."BTK_3G_PROCESS" 
IS
BEGIN 

EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.TMP_481'; COMMIT;


INSERT INTO NORTHI_DATA.TMP_481 (NETWORK_ID, FRAGMENT_DATE, TRAFF_TOPLAM, VOICE_RAB_EST_F_R_DEN, VOICE_RAB_EST_F_R_NUM, VOICE_RAB_ABN_REL_R_DEN_NEW, VOICE_RAB_ABN_REL_R_NUM_NEW, VS_RAB_ATTESTCS_AMRWB, VS_RAB_SUCCESTCS_AMRWB)

SELECT NETWORK_ID,FRAGMENT_DATE,
ROUND((CS_VOICE_CALL_TRAFF)/2,2) TRAFF_TOPLAM,
(VOICE_RAB_EST_F_R_DEN) VOICE_RAB_EST_F_R_DEN, (VOICE_RAB_EST_F_R_NUM) VOICE_RAB_EST_F_R_NUM,
(VOICE_RAB_ABN_REL_R_DEN_NEW) VOICE_RAB_ABN_REL_R_DEN_NEW, (VOICE_RAB_ABN_REL_R_NUM_NEW) VOICE_RAB_ABN_REL_R_NUM_NEW,
(VS_RAB_ATTESTCS_AMRWB) VS_RAB_ATTESTCS_AMRWB, (VS_RAB_SUCCESTCS_AMRWB) VS_RAB_SUCCESTCS_AMRWB
FROM NORTHI_DATA.DBH_CELL_STATISTICS 
WHERE BH_TYPE=4   AND FRAGMENT_DATE  BETWEEN TRUNC(SYSDATE-1) AND TRUNC(SYSDATE-1)+23/24;

COMMIT;
                                                                                                       

    DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
    WHERE TARIH BETWEEN TRUNC(SYSDATE-1) AND ADD_MONTHS(TRUNC(SYSDATE,'MONTH'),1)-0.5/24;

    COMMIT;

INSERT  /*+ APPEND PARALLEL(4)  */  INTO NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON (CITY,CELL_NAME,TARIH,DCR_P,DCR_PD,CONG_P,CONG_PD,TRAFFIC,NODEB_NAME)
SELECT /*+ PARALLEL(4)  */ CITY,CELL_NAME,FRAGMENT_DATE TARIH,

SUM(VOICE_RAB_ABN_REL_R_NUM_NEW) DCR_P,SUM(VOICE_RAB_ABN_REL_R_DEN_NEW) DCR_PD,
SUM(VOICE_RAB_EST_F_R_NUM+VS_RAB_SUCCESTCS_AMRWB) CONG_P,SUM(VOICE_RAB_EST_F_R_DEN+VS_RAB_ATTESTCS_AMRWB) CONG_PD,ROUND(SUM(TRAFF_TOPLAM),2) TRAFFIC,NODEB_NAME
FROM
(
SELECT NETWORK_ID,XX.CELL_NAME,YY.CITY,
 FRAGMENT_DATE,
ROUND((TRAFF_TOPLAM),2) TRAFF_TOPLAM,
(VOICE_RAB_EST_F_R_DEN) VOICE_RAB_EST_F_R_DEN, (VOICE_RAB_EST_F_R_NUM) VOICE_RAB_EST_F_R_NUM,
(VOICE_RAB_ABN_REL_R_DEN_NEW) VOICE_RAB_ABN_REL_R_DEN_NEW, (VOICE_RAB_ABN_REL_R_NUM_NEW) VOICE_RAB_ABN_REL_R_NUM_NEW,
(VS_RAB_ATTESTCS_AMRWB) VS_RAB_ATTESTCS_AMRWB, (VS_RAB_SUCCESTCS_AMRWB) VS_RAB_SUCCESTCS_AMRWB, NODEB_NAME
FROM NORTHI_DATA.TMP_481  TTT , NORTHI_DATA.LIST_RNC_NODEB_CELL XX , NORTHI_DATA.Z_TBL_TK_3G_CELL_LIST_481 YY
WHERE  TTT.NETWORK_ID=XX.CELL_ID  AND XX.CELL_NAME=YY.CELL_NAME AND 
FRAGMENT_DATE BETWEEN TRUNC(SYSDATE-1) AND TRUNC(SYSDATE-1)+23/24
)

GROUP BY CELL_NAME,CITY,NODEB_NAME,FRAGMENT_DATE;

COMMIT;

   DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
   WHERE CONG_PD=0 AND DCR_PD=0 AND TRAFFIC=0;
   COMMIT;    
   
----------------------------ERKAN BAKAR IN ISTEGIYLE BH VE CS TRAFIK DEGISTI TEST YAPILIYOR 06.10.25 CASE 5215645--------------------------------------------

EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.TMP_481_V2'; COMMIT;


INSERT INTO NORTHI_DATA.TMP_481_V2 (NETWORK_ID, FRAGMENT_DATE, TRAFF_TOPLAM, VOICE_RAB_EST_F_R_DEN, VOICE_RAB_EST_F_R_NUM, VOICE_RAB_ABN_REL_R_DEN_NEW, VOICE_RAB_ABN_REL_R_NUM_NEW, VS_RAB_ATTESTCS_AMRWB, VS_RAB_SUCCESTCS_AMRWB)

SELECT NETWORK_ID,FRAGMENT_DATE,
ROUND((VS_AMR_ERLANG_BEST_CELL),2) TRAFF_TOPLAM,
(VOICE_RAB_EST_F_R_DEN) VOICE_RAB_EST_F_R_DEN, (VOICE_RAB_EST_F_R_NUM) VOICE_RAB_EST_F_R_NUM,
(VOICE_RAB_ABN_REL_R_DEN_NEW) VOICE_RAB_ABN_REL_R_DEN_NEW, (VOICE_RAB_ABN_REL_R_NUM_NEW) VOICE_RAB_ABN_REL_R_NUM_NEW,
(VS_RAB_ATTESTCS_AMRWB) VS_RAB_ATTESTCS_AMRWB, (VS_RAB_SUCCESTCS_AMRWB) VS_RAB_SUCCESTCS_AMRWB
FROM NORTHI_DATA.DBH_CELL_STATISTICS 
WHERE BH_TYPE=111   AND FRAGMENT_DATE  BETWEEN TRUNC(SYSDATE-1) AND TRUNC(SYSDATE-1)+23/24;

COMMIT;
                                                                                                       

    DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON_V2
    WHERE TARIH BETWEEN TRUNC(SYSDATE-1) AND ADD_MONTHS(TRUNC(SYSDATE,'MONTH'),1)-0.5/24;

    COMMIT;

INSERT  /*+ APPEND PARALLEL(4)  */  INTO NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON_V2 (CITY,CELL_NAME,TARIH,DCR_P,DCR_PD,CONG_P,CONG_PD,TRAFFIC,NODEB_NAME)
SELECT /*+ PARALLEL(4)  */ CITY,CELL_NAME,FRAGMENT_DATE TARIH,

SUM(VOICE_RAB_ABN_REL_R_NUM_NEW) DCR_P,SUM(VOICE_RAB_ABN_REL_R_DEN_NEW) DCR_PD,
SUM(VOICE_RAB_EST_F_R_NUM+VS_RAB_SUCCESTCS_AMRWB) CONG_P,SUM(VOICE_RAB_EST_F_R_DEN+VS_RAB_ATTESTCS_AMRWB) CONG_PD,ROUND(SUM(TRAFF_TOPLAM),2) TRAFFIC,NODEB_NAME
FROM
(
SELECT NETWORK_ID,XX.CELL_NAME,YY.CITY,
 FRAGMENT_DATE,
ROUND((TRAFF_TOPLAM),2) TRAFF_TOPLAM,
(VOICE_RAB_EST_F_R_DEN) VOICE_RAB_EST_F_R_DEN, (VOICE_RAB_EST_F_R_NUM) VOICE_RAB_EST_F_R_NUM,
(VOICE_RAB_ABN_REL_R_DEN_NEW) VOICE_RAB_ABN_REL_R_DEN_NEW, (VOICE_RAB_ABN_REL_R_NUM_NEW) VOICE_RAB_ABN_REL_R_NUM_NEW,
(VS_RAB_ATTESTCS_AMRWB) VS_RAB_ATTESTCS_AMRWB, (VS_RAB_SUCCESTCS_AMRWB) VS_RAB_SUCCESTCS_AMRWB, NODEB_NAME
FROM NORTHI_DATA.TMP_481_V2  TTT , NORTHI_DATA.LIST_RNC_NODEB_CELL XX , NORTHI_DATA.Z_TBL_TK_3G_CELL_LIST_481 YY
WHERE  TTT.NETWORK_ID=XX.CELL_ID  AND XX.CELL_NAME=YY.CELL_NAME AND 
FRAGMENT_DATE BETWEEN TRUNC(SYSDATE-1) AND TRUNC(SYSDATE-1)+23/24
)

GROUP BY CELL_NAME,CITY,NODEB_NAME,FRAGMENT_DATE;

COMMIT;

   DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON_V2
   WHERE CONG_PD=0 AND DCR_PD=0 AND TRAFFIC=0;
   COMMIT;    

   
----------------------------------------------Z_TBL_TK_3G_CONG_EFF------------------

   DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_CONG_EFF;

   COMMIT;

   INSERT /*+ APPEND PARALLEL(4)  */ INTO NORTHI_DATA.Z_TBL_TK_3G_CONG_EFF (CITY,
                                                            CELL_NAME,
                                                            CONG_EFF,UPDATE_DATE)
      SELECT /*+ PARALLEL(4)  */ AA.CITY,
             CELL_NAME,
             ROUND ( DECODE(CITY_CONG_PD,0,0,CELL_CONG_PD / CITY_CONG_PD) * 100, 2) CONG_EFF,TRUNC(SYSDATE) UPDATE_DATE
        FROM (  SELECT CITY, CELL_NAME, SUM (CONG_PD - CONG_P) CELL_CONG_PD
                  FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
                 WHERE TARIH >= TRUNC (SYSDATE - 7)
                HAVING SUM (CONG_PD - CONG_P) <> 0
              GROUP BY CITY, CELL_NAME) AA,
             (  SELECT CITY, SUM (CONG_PD - CONG_P) CITY_CONG_PD
                  FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
                 WHERE TARIH >= TRUNC (SYSDATE - 7)
              GROUP BY CITY) BB
       WHERE AA.CITY = BB.CITY;

   COMMIT;
       
-----------------------------------------------Z_TBL_TK_3G_DCR_EFF

   DELETE FROM NORTHI_DATA.Z_TBL_TK_3G_DCR_EFF;

   COMMIT;

   INSERT /*+ APPEND PARALLEL(4)  */ INTO NORTHI_DATA.Z_TBL_TK_3G_DCR_EFF (CITY,
                                                           CELL_NAME,
                                                           DCR_EFF,UPDATE_DATE)
      SELECT /*+ PARALLEL(4)  */ AA.CITY,
             CELL_NAME,
             ROUND ( DECODE(CITY_DCR_PD,0,0,CELL_DCR_PD / CITY_DCR_PD) * 100, 2) DCR_EFF,TRUNC(SYSDATE) UPDATE_DATE
        FROM (  SELECT CITY, CELL_NAME, SUM (DCR_P) CELL_DCR_PD
                  FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
                 WHERE TARIH >= TRUNC (SYSDATE - 7)
                HAVING SUM (DCR_P) <> 0
              GROUP BY CITY, CELL_NAME) AA,
             (  SELECT CITY, SUM (DCR_P) CITY_DCR_PD
                  FROM NORTHI_DATA.Z_TBL_TK_3G_CITY_LIST_481_SON
                 WHERE TARIH >= TRUNC (SYSDATE - 7)
              GROUP BY CITY) BB
       WHERE AA.CITY = BB.CITY;

   COMMIT;
   
----------------------------------------------
    
END;
/
