
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."BTK_4G_PROCESS" (XDATE DATE)
IS
BEGIN 

EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.TMP_BTK_LTE'; COMMIT;
 
INSERT INTO NORTHI_DATA.TMP_BTK_LTE(NETWORK_ID, FRAGMENT_DATE, TRAFF_TOPLAM, VOLTE_ACC_DEN, VOLTE_ACC_NUM, VOLTE_CALLS, ERAB_DCR_NUM)

SELECT NETWORK_ID,FRAGMENT_DATE,
ROUND((VOLTE_TRAFFIC)/36000,2) TRAFF_TOPLAM,
(VOLTE_ACC_DEN) VOLTE_ACC_DEN, 
(VOLTE_ACC_NUM) VOLTE_ACC_NUM,
(VOLTE_CALLS) VOLTE_CALLS, 
(ERAB_DCR_NUM) ERAB_DCR_NUM
FROM NORTHI_DATA.DBH_CELLSTS_4G 
WHERE BH_TYPE=1   AND FRAGMENT_DATE  BETWEEN TRUNC(XDATE-1) AND TRUNC(XDATE-1)+23/24;

COMMIT;
                                                                                                       

DELETE FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
WHERE TARIH BETWEEN TRUNC(XDATE-1) AND ADD_MONTHS(TRUNC(XDATE,'MONTH'),1)-0.5/24;
COMMIT;

INSERT  /*+ APPEND PARALLEL(4)  */  INTO NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON (CITY,CELL_NAME,TARIH,DCR_P,DCR_PD,CONG_P,CONG_PD,TRAFFIC,ENODEB_NAME)
SELECT /*+PARALLEL(4)*/  CITY,CELL_NAME,FRAGMENT_DATE TARIH,

SUM(ERAB_DCR_NUM) DCR_P,SUM(VOLTE_CALLS) DCR_PD,
SUM(VOLTE_ACC_NUM) CONG_P,SUM(VOLTE_ACC_DEN) CONG_PD,
ROUND(SUM(TRAFF_TOPLAM),2) TRAFFIC,ENODEB_NAME
FROM
(
SELECT NETWORK_ID,XX.CELL_NAME,YY.CITY,
 FRAGMENT_DATE,
ROUND((TRAFF_TOPLAM),2) TRAFF_TOPLAM,
(VOLTE_ACC_DEN) VOLTE_ACC_DEN, 
(VOLTE_ACC_NUM) VOLTE_ACC_NUM,
(VOLTE_CALLS) VOLTE_CALLS, 
(ERAB_DCR_NUM) ERAB_DCR_NUM,
ENODEB_NAME
 
FROM NORTHI_DATA.TMP_BTK_LTE  TTT , NORTHI_DATA.LIST_ENODEB_CELL XX , NORTHI_DATA.Z_TBL_TK_4G_CELL_LIST_2000 YY
WHERE  TTT.NETWORK_ID=XX.CELL_ID  AND XX.CELL_NAME=YY.CELL_NAME AND 
FRAGMENT_DATE BETWEEN TRUNC(XDATE-1) AND TRUNC(XDATE-1)+23/24
)

GROUP BY CELL_NAME,CITY,ENODEB_NAME,FRAGMENT_DATE;

COMMIT;

   DELETE FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
   WHERE CONG_PD=0 AND DCR_PD=0 AND TRAFFIC=0 ;
   COMMIT;    

--------------------------------------- Z_TBL_TK_4G_DCR_EFF---------------------

   DELETE FROM NORTHI_DATA.Z_TBL_TK_4G_DCR_EFF;

   COMMIT;

   INSERT /*+ APPEND PARALLEL(4)  */  INTO NORTHI_DATA.Z_TBL_TK_4G_DCR_EFF (CITY,
                                                           CELL_NAME,
                                                           DCR_EFF,UPDATE_DATE)
      SELECT /*+PARALLEL(4)*/ AA.CITY,
             CELL_NAME,
             ROUND (DECODE(CITY_DCR_PD,0,0,(CELL_DCR_PD / CITY_DCR_PD) * 100), 2) DCR_EFF,TRUNC(XDATE) UPDATE_DATE
        FROM (  SELECT CITY, CELL_NAME, SUM (DCR_P) CELL_DCR_PD
                  FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
                 WHERE TARIH >= TRUNC (XDATE - 7)
                HAVING SUM (DCR_P) <> 0
              GROUP BY CITY, CELL_NAME) AA,
             (  SELECT CITY, SUM (DCR_P) CITY_DCR_PD
                  FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
                 WHERE TARIH >= TRUNC (XDATE - 7)
              GROUP BY CITY) BB
       WHERE AA.CITY = BB.CITY;

   COMMIT;
   
----------------------------------------------PRO_4G_CITY_CONG_EFF------------------

  DELETE FROM NORTHI_DATA.Z_TBL_TK_4G_CONG_EFF;

   COMMIT;

   INSERT /*+ APPEND PARALLEL(4)*/  INTO NORTHI_DATA.Z_TBL_TK_4G_CONG_EFF (CITY,
                                                            CELL_NAME,
                                                            CONG_EFF,UPDATE_DATE)
      SELECT /*+PARALLEL(4)*/ AA.CITY,
             CELL_NAME,
             ROUND (decode(CITY_CONG_PD,0,0,(CELL_CONG_PD / CITY_CONG_PD) * 100), 2) CONG_EFF,TRUNC(XDATE) UPDATE_DATE
        FROM (  SELECT CITY, CELL_NAME, SUM (CONG_PD - CONG_P) CELL_CONG_PD
                  FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
                 WHERE TARIH >= TRUNC (XDATE - 7)
                HAVING SUM (CONG_PD - CONG_P) <> 0
              GROUP BY CITY, CELL_NAME) AA,
             (  SELECT CITY, SUM (CONG_PD - CONG_P) CITY_CONG_PD
                  FROM NORTHI_DATA.Z_TBL_TK_4G_CITY_LIST_2000_SON
                 WHERE TARIH >= TRUNC (XDATE - 7)
              GROUP BY CITY) BB
       WHERE AA.CITY = BB.CITY;COMMIT; 
       
-----------------------------------------------
    
END;
/
