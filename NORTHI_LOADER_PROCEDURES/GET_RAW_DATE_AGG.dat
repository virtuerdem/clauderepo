
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."GET_RAW_DATE_AGG" (XTABLE_NAME IN VARCHAR2,XRESULT IN OUT VARCHAR2, XRESULT2 IN OUT VARCHAR2)
AS
XAGGREGATION_FIELDS VARCHAR2(32000);
XLOCAL_FIELDS VARCHAR2(32000);

 BEGIN
    XAGGREGATION_FIELDS:='';
    XLOCAL_FIELDS :='';
    FOR XFIELDS IN
    (
          SELECT *
         FROM (
         SELECT   
         DECODE(TIME_STAT_METH,'MAX','MAX' ,'MIN','MIN','AVG','AVG','SUM','SUM','SUM') ||'('||COUNTER_NAME_DB||')'||UPPER(COUNTER_NAME_DB)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,
         COUNTER_NAME_DB LOCAL_FIELD,
         ROW_NUMBER() OVER (PARTITION BY UPPER(COUNTER_NAME_DB) ORDER BY UPPER(COUNTER_NAME_DB)) RN 
         FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST WHERE COUNTER_MODEL='VARIABLE' AND  OPERATOR_NAME='VODAFONE' AND TABLE_NAME=XTABLE_NAME 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN 
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XLOCAL_FIELDS :=XLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
    
     IF LENGTH(XLOCAL_FIELDS)>0 THEN
        XLOCAL_FIELDS:=SUBSTR(XLOCAL_FIELDS,1,LENGTH(XLOCAL_FIELDS)-1);
    END IF;
   
   
 
    
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    
    XRESULT2:=XLOCAL_FIELDS;
    
   
 END  GET_RAW_DATE_AGG;
/
