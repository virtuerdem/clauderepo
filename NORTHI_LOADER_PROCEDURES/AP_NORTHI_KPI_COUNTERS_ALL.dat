
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."AP_NORTHI_KPI_COUNTERS_ALL" 
AS
XVENDOR_COUNTER VARCHAR2(32000);
XVENDOR_COUNTER_DB VARCHAR2(32000);
XCOUNTER_ID VARCHAR2(500);
XCOUNTER_NAME VARCHAR2(32000);
XCOUNTER_DESCRIPTION VARCHAR2(32000);

BEGIN
    
    DELETE FROM NORTHI_KPI_COUNTERS WHERE VENDOR_ID= 9 ;
    COMMIT;
    FOR XLOOP IN
    (
        SELECT TABLE_NAME,RECORD_ID,TITLE_ID, PHASE,FIELD_ALIAS KPI_NAME,FIELD_EXPRESSION,NE_TYPE,FIELD_CAPTION,KPI_GROUP
        FROM NORTHI_DATA.NORTHI_BASIC_REPORT_DEFINITION
        WHERE FIELD_ALIAS!='HOUR' AND PHASE = '5G' 
        ORDER BY KPI_NAME
    )
    LOOP 
        FOR XVENDOR_LIST IN
        (
            SELECT DISTINCT VENDOR_ID 
            FROM NORTHI_KPI_FIELDS  A, NORTHI_TABLE_FIELDS B
            WHERE A.TABLE_NAME=B.TABLE_NAME AND A.LOCAL_FIELD=B.LOCAL_FIELD 
            AND A.RECORD_ID=XLOOP.RECORD_ID
        )
        LOOP
            FOR XLOOP2 IN
            (
                SELECT A.TABLE_NAME, A.KPI_NAME, A.KPI_GROUP, A.LOCAL_FIELD, VENDOR_ID, C.REMOTE_FIELD ,-1 NE_LEVEL
                FROM NORTHI_KPI_FIELDS A, NORTHI_TABLE_FIELDS C
                WHERE A.TABLE_NAME=C.TABLE_NAME AND A.LOCAL_FIELD=C.LOCAL_FIELD
                --AND A.RECORD_ID=XLOOP.RECORD_ID
                AND VENDOR_ID=9--XVENDOR_LIST.VENDOR_ID
                ORDER BY A.TABLE_NAME,A.KPI_NAME, LENGTH(A.LOCAL_FIELD) DESC
            )
            LOOP
                FOR XLOOP3 IN 
                (
                    SELECT REGEXP_REPLACE(LOCAL_FIELD, '[A-Z]{1,2}\.|[A-Z]{1,2}(\d)\.|[A-Z]{,1}\.', '') LOCAL_FIELD
                      FROM
                      (
                        SELECT TO_CHAR(TRIM(REGEXP_SUBSTR(FIELD_EXP, '[^,]+', 1, LEVEL))) AS LOCAL_FIELD
                          FROM 
                          (
                              SELECT MULTIPLE_REPLACE( XLOOP2.REMOTE_FIELD,
                                           NEW t_text( 'ROUND(',',2)','SUM(','MAX(','MIN(','AVG(','DECODE(','+','-','*','/',',0,0,',',0,1,',')','(','NVL(','(',',100',',,,',',,',',8',',104576,',',NULL,',',1,',',60,60,',',0,','NORTHI_DATA.BTRAFFIC_CALCULATE'),
                                           NEW t_text( '','','','','','','',',',',',',',',',',',',',',','(','','','',',',',','',',',',',',',',',',','')
                                         ) FIELD_EXP 
                              FROM DUAL
                          )
                          CONNECT BY LEVEL <= REGEXP_count(FIELD_EXP, '[^,]+')+1
                      )
                     WHERE LOCAL_FIELD IS NOT NULL
                )
                LOOP
                    SELECT COUNTER_ID , COUNTER_NAME ,COUNTER_DESCRIPTION  INTO XCOUNTER_ID, XCOUNTER_NAME , XCOUNTER_DESCRIPTION
                    FROM 
                    (   SELECT COUNTER_NAME_DB COUNTER_ID , COUNTER_NAME_LOOKUP COUNTER_NAME ,DECODE(COUNTER_DESCRIPTION,NULL,COUNTER_NAME_DB,COUNTER_DESCRIPTION)COUNTER_DESCRIPTION
                        FROM  NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST A,  (SELECT * FROM NORTHI_LOADER.NORTHI_LOADER_PARENTS WHERE VENDOR_ID=9) X 
                        WHERE A.TABLE_NAME=X.PARENT_NAME 
                        UNION ALL
                        SELECT SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COLUMN_NAME, SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COLUMN_NAME ,SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COLUMN_NAME
                        FROM DUAL
                    )
                    WHERE COUNTER_ID=SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1)
                    AND ROWNUM=1;
                    XVENDOR_COUNTER_DB:=XLOOP3.LOCAL_FIELD;
                    XVENDOR_COUNTER:=XCOUNTER_NAME;
                    IF (NUMBERS_ONLY( XVENDOR_COUNTER_DB) IS NULL) AND (XVENDOR_COUNTER_DB!=' ') AND (XVENDOR_COUNTER_DB IS NOT NULL) THEN
                         
                        INSERT INTO NORTHI_KPI_COUNTERS(TABLE_NAME, REPORT_ID, LEVEL_CODE, KPI_NAME, KPI_COUNTER, KPI_COUNTER_NAME, KPI_COUNTER_DEFINITION, VENDOR_ID, ACTIVE,KPI_CAPTION,KPI_GROUP)
                        VALUES (XLOOP.TABLE_NAME,XLOOP.RECORD_ID,XLOOP.NE_TYPE,XLOOP.KPI_NAME,XVENDOR_COUNTER_DB,XVENDOR_COUNTER,XCOUNTER_DESCRIPTION,XVENDOR_LIST.VENDOR_ID,1,XLOOP.FIELD_CAPTION,XLOOP.KPI_GROUP);
                    
                        COMMIT;
                    END IF;
                END LOOP;
            END LOOP;
       END LOOP;
    END LOOP;
    
END;
/
