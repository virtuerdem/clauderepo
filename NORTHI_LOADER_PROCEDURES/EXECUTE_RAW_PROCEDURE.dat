
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."EXECUTE_RAW_PROCEDURE" 
(
    XTABLE_NAME IN VARCHAR2,
    XDATA_DATE IN DATE,
    XLOADER_DATE IN DATE,
    XROWCOUNT IN OUT NUMBER,
    XVENDOR_ID IN OUT NUMBER,
    XPROC_TYPE IN VARCHAR2
)
AS
XUSER_NAME VARCHAR(100);
XSTATEMENT VARCHAR(32000);
XAPPEND_DATE DATE;
XAPPEND_TIME NUMBER;
CID INTEGER;
XPROC_SHEMA VARCHAR(20);

BEGIN
XAPPEND_DATE:= SYSDATE;
XUSER_NAME:=USER;

IF XVENDOR_ID IN (1,4,5,6,7,9) THEN 
   IF XPROC_TYPE='RAW_DA' THEN XPROC_SHEMA:= 'NORTHI_RAW_DA.'; END IF;
   IF XPROC_TYPE='RAW_WA' THEN XPROC_SHEMA:= 'NORTHI_RAW_WA.'; END IF;
   IF XPROC_TYPE='RAW_MA' THEN XPROC_SHEMA:= 'NORTHI_RAW_MA.'; END IF; 
ELSIF XVENDOR_ID IN (22,23,47) THEN
   IF XPROC_TYPE='RAW_DA' THEN XPROC_SHEMA:= 'NORTHI_KKTC_RAW_DA.'; END IF;
   IF XPROC_TYPE='RAW_WA' THEN XPROC_SHEMA:= 'NORTHI_KKTC_RAW_WA.'; END IF;
   IF XPROC_TYPE='RAW_MA' THEN XPROC_SHEMA:= 'NORTHI_KKTC_RAW_MA.'; END IF; 
END IF;

XSTATEMENT:='BEGIN '||XPROC_SHEMA||'P_'||SUBSTR(XTABLE_NAME,1,28)||'(:XDATA_DATE); END;';

EXECUTE IMMEDIATE XSTATEMENT USING XDATA_DATE;
XROWCOUNT:= SQL%ROWCOUNT;

IF XROWCOUNT>0 THEN
   XAPPEND_TIME:=(SYSDATE-XAPPEND_DATE)*1440*60;
END IF;
  EXCEPTION
   WHEN OTHERS THEN
  BEGIN
   XROWCOUNT:=-1;
   INSERT_PROCESS_ERROR_LOG (XUSER_NAME,SQLCODE,SUBSTR(SQLERRM, 1, 4000),XTABLE_NAME,XDATA_DATE,XLOADER_DATE,XROWCOUNT,'EXECUTE_PROCEDURE',XSTATEMENT,XVENDOR_ID);
   IF SQLCODE IN (-24344,-00942,-06512,-00905,-06550) OR SUBSTR(SQLERRM,1,3) = 'PLS' THEN
        northi.send_mail('northi@ttgint.com','NORTHI_LOADER.EXECUTE_PROCEDURE execution ALARM', 'Error while executing statement : ' || XSTATEMENT || ' || ERROR_CODE : ' || SQLCODE);
   END IF;
    IF DBMS_SQL.IS_OPEN (CID) THEN
        DBMS_SQL.CLOSE_CURSOR(CID);
    END IF;
  END;
END;
/
