
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."CREATE_PARTITIONS1" 
AS
XDATA_DATE DATE;
XEND_DATE DATE;
BEGIN
/*
-- Bu Select cumlesi partition i create ettikten sonra partition olusturma islemini takip icin kullanilir.
SELECT A.TABLE_NAME,DATA_DATE
FROM
(
SELECT TABLE_NAME, MAX(DATA_DATE) DATA_DATE
FROM NORTHI_TABLE_PARTITION_LIST
GROUP BY TABLE_NAME
) A
WHERE
A.TABLE_NAME NOT IN (
    SELECT TABLE_NAME
    FROM NORTHI_LOADER_SETTINGS
    WHERE ACTIVE=0
    UNION ALL
    SELECT TABLE_NAME||'_DA'
    FROM NORTHI_LOADER_SETTINGS
    WHERE ACTIVE=0
) 
AND DATA_DATE<TO_DATE('31.03.2012','DD.MM.YYYY')
AND A.TABLE_NAME NOT LIKE '%TEST%'
AND TABLE_NAME NOT LIKE '%SIGTRAN%'
ORDER BY DATA_DATE DESC

*/

XEND_DATE:=ADD_MONTHS(TRUNC(SYSDATE,'MONTH'),2);

    FOR XPRT  IN
    (
    select DISTINCT *
    from (
     SELECT TABLE_NAME,TABLE_NAME||'_'||A.AGG_TYPE AGG_TABLE,PARTITION_TYPE
        FROM
        (
                SELECT 'DA'  AGG_TYPE      FROM DUAL
                --UNION ALL SELECT '5WA' AGG_TYPE  FROM DUAL
                --UNION ALL SELECT '7WA' AGG_TYPE  FROM DUAL
                --UNION ALL SELECT '7MA' AGG_TYPE  FROM DUAL
                --UNION ALL SELECT '5MA' AGG_TYPE  FROM DUAL
        ) A,NORTHI_LOADER_SETTINGS B,(SELECT DISTINCT PARTITION_ID,PARTITION_TYPE FROM NORTHI_PARTITION_TYPE) C
        WHERE B.PARTITION_ID=C.PARTITION_ID  AND INSTR(B.DATE_AGGREGATE_TYPES,A.AGG_TYPE)>0
        AND VENDOR_ID in (1,5,14)
        AND TABLE_NAME NOT LIKE '%TEST%'
        UNION ALL

        SELECT  *
        FROM (

        SELECT TABLE_NAME,TABLE_NAME AGG_TABLE,PARTITION_TYPE 
        FROM NORTHI_LOADER_SETTINGS B,(SELECT DISTINCT PARTITION_ID,PARTITION_TYPE FROM NORTHI_PARTITION_TYPE) C
        WHERE  B.PARTITION_ID=C.PARTITION_ID 
        AND VENDOR_ID in (1,5,14)
        )
        WHERE AGG_TABLE IN (SELECT DISTINCT TABLE_NAME FROM NORTHI_TABLE_PARTITION_LIST )
        AND TABLE_NAME NOT LIKE '%TEST%'
        ORDER BY PARTITION_TYPE DESC
        )
        where table_name IN ('DPROC','CELLHO','CELLGPRS','GBL','LAPD','S7LINK','FEGESTS','GSL','BSS_STATISTICS')
        ORDER BY AGG_TABLE
    )
    LOOP
        SELECT MAX(DATA_DATE)+1/24 INTO XDATA_DATE FROM NORTHI_TABLE_PARTITION_LIST WHERE TABLE_NAME=XPRT.AGG_TABLE;
        IF XDATA_DATE< XEND_DATE THEN
            IF INSTR(XPRT.AGG_TABLE,'5WA')>0 OR INSTR(XPRT.AGG_TABLE,'_5MA')>0 OR INSTR(XPRT.AGG_TABLE,'7WA')>0 OR INSTR(XPRT.AGG_TABLE,'7MA')>0 THEN
                LOADER_CREATION.ADD_TABLE_PARTITION('NORTHI_DATA.'||XPRT.AGG_TABLE,XPRT.TABLE_NAME ,XDATA_DATE,TO_DATE('08.02.2015 23','DD.MM.YYYY HH24'),7);
            ELSIF INSTR(XPRT.AGG_TABLE,'_DA')>0 THEN
                LOADER_CREATION.ADD_TABLE_PARTITION('NORTHI_DATA.'||XPRT.AGG_TABLE,XPRT.TABLE_NAME ,XDATA_DATE,TO_DATE('08.02.2015 23','DD.MM.YYYY HH24'),1);
            ELSE
                LOADER_CREATION.ADD_TABLE_PARTITION('NORTHI_DATA.'||XPRT.AGG_TABLE,XPRT.TABLE_NAME ,XDATA_DATE,TO_DATE('08.02.2015 23','DD.MM.YYYY HH24'),XPRT.PARTITION_TYPE);
            END IF;
        END IF;
    END LOOP;
END; 
/
