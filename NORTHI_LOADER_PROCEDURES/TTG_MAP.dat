
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."TTG_MAP" (P_NUMBER1 NUMBER,P_NUMBER2 NUMBER , P_NUMBER3 NUMBER,P_NUMBER4 NUMBER,P_NUMBER5 NUMBER,
P_VARCHAR1 VARCHAR,P_VARCHAR2 VARCHAR , P_VARCHAR3 VARCHAR,P_VARCHAR4 VARCHAR,P_VARCHAR5 VARCHAR,
 io_cursor OUT SYS_REFCURSOR) IS

XRECORD_ID NUMBER;
XSELECT_COND VARCHAR2(4000);
XFIELD_EXP VARCHAR2(4000);
XFIELD_AL VARCHAR2(4000);
BEGIN
    IF P_NUMBER1=1 THEN -- FILL COMBO BOXES

        IF P_NUMBER2 = 1 THEN -- REGION_LIST
         OPEN io_cursor FOR
            SELECT DISTINCT REGION_NAME
            FROM COORDINATES_SITE
            WHERE REGION_NAME IS NOT NULL
            ORDER BY REGION_NAME;
        ELSIF P_NUMBER2 = 2 THEN -- CLUSTER
         OPEN io_cursor FOR
            SELECT DISTINCT CLUSTER_NAME
            FROM COORDINATES_SITE
            WHERE CLUSTER_NAME IS NOT NULL
            ORDER BY CLUSTER_NAME;
        ELSIF P_NUMBER2 = 3 THEN -- VODAFONE_REGION
         OPEN io_cursor FOR
            SELECT DISTINCT VODAFONE_REGION
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            ORDER BY VODAFONE_REGION;
        ELSIF P_NUMBER2 = 4 THEN -- RNC
          OPEN io_cursor FOR
            SELECT DISTINCT RNC_NAME
            FROM COORDINATES_SITE
            WHERE RNC_NAME IS NOT NULL
            ORDER BY RNC_NAME;
        ELSIF P_NUMBER2 = 5 THEN --CITY
         OPEN io_cursor FOR
            SELECT DISTINCT CITY
            FROM COORDINATES_SITE
            WHERE CITY IS NOT NULL
            ORDER BY CITY;
        END IF;
    END IF;
    IF P_NUMBER1 = 2 THEN -- RETURN MAP DATA

        IF P_NUMBER2 = -2 THEN

         OPEN io_cursor FOR
        /* SELECT *
         FROM(
               SELECT SITE_NAME,RNC_ID,RNC_NAME, ROUND(AVG(LATTITUDE),4) LATTITUDE, ROUND(AVG(LONGTITUDE),4) LONGTITUDE,'rncx.png' IMG,
               ROW_NUMBER() OVER (PARTITION BY RNC_ID ORDER BY SITE_NAME) RN
               FROM COORDINATES_SITE
               WHERE RNC_NAME IS NOT NULL
               GROUP BY RNC_ID,RNC_NAME,SITE_NAME
              )
              WHERE RN<4*/
              /*SELECT *
              FROM
              (
               SELECT SITE_NAME,RNC_ID,RNC_NAME, (LATTITUDE) LATTITUDE, (LONGTITUDE)  LONGTITUDE,'rncx.png' IMG,
               ROW_NUMBER() OVER (PARTITION BY RNC_ID ORDER BY SITE_NAME) RN
               FROM COORDINATES_SITE a, (SELECT distinct nodeb
               FROM NORTHI_DATA.SITE_ALARM_LIST ) b
               WHERE
               a.site_name=b.nodeb
               and
               RNC_NAME IS NOT NULL
               )WHERE RN<4 ;*/
               SELECT *
              FROM
              (
               SELECT SITE_NAME,RNC_ID,RNC_NAME, (LATTITUDE) LATTITUDE, (LONGTITUDE)  LONGTITUDE,'rncx.png' IMG,
               ROW_NUMBER() OVER (PARTITION BY RNC_ID ORDER BY SITE_NAME) RN
               FROM COORDINATES_SITE a
               WHERE
               RNC_NAME IS NOT NULL
               )WHERE RN<4 ;
        ELSIF P_NUMBER2 = -1 THEN --DISPLAY ONLY RNCS

         OPEN io_cursor FOR
          SELECT *
           FROM
           (
               SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'rnc.png' IMG,
               ROW_NUMBER() OVER (PARTITION BY RNC_ID ORDER BY LATTITUDE) RN
               FROM COORDINATES_SITE
               WHERE LATTITUDE IS NOT NULL
            )
           WHERE RN=1;
        ELSIF P_NUMBER2 = 0 THEN --DISPLAY WHOLE MAP

         OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE   RN=1 AND LATTITUDE IS NOT NULL and ROWNUM<20;

        ELSIF P_NUMBER2 = 1 THEN --FILTER BY REGION
          OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE REGION_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2 = 2 THEN --FILTER BY CLUSTER
          OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE CLUSTER_NAME=P_VARCHAR1;

        ELSIF P_NUMBER2 = 3 THEN --FILTER BY VODAFONE_REGION
           OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE VODAFONE_REGION=P_VARCHAR1;

        ELSIF P_NUMBER2 = 4 THEN --FILTER BY RNC
         OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE RNC_NAME=P_VARCHAR1;

        ELSIF P_NUMBER2 = 5 THEN --FILTER BY CITY
         OPEN io_cursor FOR
           SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,'nodeb_blue.png' IMG
           FROM
           (
                SELECT RNC_ID,RNC_NAME,OMC_SITE_ID_3G, SITE_ID,CITY,CLUSTER_NAME,REGION_NAME,VODAFONE_REGION,
                       SITE_NAME, LATTITUDE, LONGTITUDE,CONSTRUCTION_TYPE,CONSTRUCTION_HEIGHT, STATUS,ROW_NUMBER() OVER (PARTITION BY CITY ORDER BY SITE_NAME) RN
                FROM NORTHI_LOADER.COORDINATES_SITE
           )
           WHERE CITY=P_VARCHAR1;

        END IF;
    END IF;
    IF P_NUMBER1 = 3 THEN -- RETURN COORDINATES OF SELECTED AREAS
        IF P_NUMBER2 = -1 THEN -- REGION_LIST
         OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE;
        ELSIF P_NUMBER2 = 1 THEN -- REGION_LIST
         OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE REGION_NAME IS NOT NULL
            AND REGION_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2 = 2 THEN -- CLUSTER
         OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE CLUSTER_NAME IS NOT NULL
            AND CLUSTER_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2 = 3 THEN -- VODAFONE_REGION
         OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION=P_VARCHAR1;
        ELSIF P_NUMBER2 = 4 THEN -- RNC
          OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE RNC_NAME IS NOT NULL
            AND RNC_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2 = 5 THEN --CITY
         OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE CITY IS NOT NULL
            AND CITY=P_VARCHAR1;
        ELSIF P_NUMBER2 = 6 THEN --CITY
         IF P_NUMBER3=0 THEN
            OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION IN ('Avrupa');
         ELSIF P_NUMBER3 = 1 THEN
            OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION IN ('Asya','Bursa');
         ELSIF P_NUMBER3 = 2 THEN
            OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION IN ('Izmir','Antalya');
         ELSIF P_NUMBER3=0 THEN
          OPEN io_cursor FOR
            SELECT MAX(LATTITUDE) MAX_LATTITUDE,MIN(LATTITUDE) MIN_LATTITUDE,MAX(LONGTITUDE) MAX_LONGTITUDE ,MIN(LONGTITUDE) MIN_LONGTITUDE
            FROM COORDINATES_SITE
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION IN ('Avrupa');
         END IF;
        END IF;
    ELSIF P_NUMBER1=4 THEN
        IF P_NUMBER2=-1 THEN
          OPEN io_cursor FOR
            SELECT * FROM NORTHI_DATA.NORTHI_TTGMAP4;   -- IT IS TRANSFERED TO Materialized View FOR PERFORMANCE ISSUE
            
/*            
        SELECT *
        FROM
        (SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, A.SITE_NAME, A.RN,
            ROW_NUMBER() OVER (PARTITION BY NODEB ORDER BY CELL) RN_CITY
            FROM NORTHI_DATA.SITE_ALARM_LIST A,
            (SELECT * FROM
                (SELECT SITE_NAME,
                 RNC_ID,
                 RNC_NAME,
                 'rncx.png' IMG,
                ROW_NUMBER() OVER (PARTITION BY RNC_ID ORDER BY SITE_NAME) RN
               FROM COORDINATES_SITE a, (SELECT distinct nodeb
               FROM NORTHI_DATA.SITE_ALARM_LIST ) b
               WHERE
               a.site_name=b.nodeb
               and
               RNC_NAME IS NOT NULL
               )WHERE RN<4 ) B
               WHERE A.SITE_NAME=B.SITE_NAME
               )
               WHERE RN_CITY=1;
               */
        ELSIF P_NUMBER2=1 THEN
          OPEN io_cursor FOR
            SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, SITE_NAME, RN
            FROM NORTHI_DATA.SITE_ALARM_LIST
            WHERE REGION_NAME IS NOT NULL
            AND REGION_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2=2 THEN
            OPEN io_cursor FOR
            SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, SITE_NAME, RN
            FROM NORTHI_DATA.SITE_ALARM_LIST
            WHERE CLUSTER_NAME IS NOT NULL
            AND CLUSTER_NAME=P_VARCHAR1;
        ELSIF P_NUMBER2=3 THEN
            OPEN io_cursor FOR
            SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, SITE_NAME, RN
            FROM NORTHI_DATA.SITE_ALARM_LIST
            WHERE VODAFONE_REGION IS NOT NULL
            AND VODAFONE_REGION=P_VARCHAR1;
        ELSIF P_NUMBER2=4 THEN
            OPEN io_cursor FOR
            SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, SITE_NAME, RN
            FROM NORTHI_DATA.SITE_ALARM_LIST
            WHERE RNC IS NOT NULL
            AND RNC=P_VARCHAR1;
        ELSIF P_NUMBER2=5 THEN
            OPEN io_cursor FOR
            SELECT REGION_NAME, REGION_ID, VODAFONE_REGION, CITY, OMC_SITE_ID_3G, CLUSTER_NAME, RNC, NODEB, CELL, LATTITUDE, LONGTITUDE, OBJECT_ID, SUMMARY, DESCRIPTION, NAME, INSERTED_DATE, STATUS, SITE_NAME, RN
            FROM NORTHI_DATA.SITE_ALARM_LIST
            WHERE CITY IS NOT NULL
            AND CITY=P_VARCHAR1;
        END IF;
    END IF;


EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END TTG_MAP; 
/
