
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."DAILY_2G_KONTROL" 
AS
XDAY1 NUMBER;
XDAY2 NUMBER;
XFARK NUMBER;


BEGIN 

    WITH DS_2G AS
    (
    SELECT   /*+ MATERIALIZE PARALLEL 8 */ 
    NVL(SUM(DECODE(FRAGMENT_DATE,TRUNC(SYSDATE-1),CNT,'' )),0) "DAY_1",
    NVL(SUM(DECODE(FRAGMENT_DATE,TRUNC(SYSDATE-2),CNT,'' )),0) "DAY_2"
    FROM (
    SELECT FRAGMENT_DATE, COUNT(DISTINCT NETWORK_ID) CNT FROM NORTHI_DATA.CELLSTS_DA WHERE FRAGMENT_DATE>=TRUNC(SYSDATE-2) GROUP BY FRAGMENT_DATE
    UNION ALL
    SELECT TRUNC(FRAGMENT_DATE), COUNT( NETWORK_ID) CNT FROM NORTHI_DATA.DBH_CELLSTS WHERE TRUNC(FRAGMENT_DATE)>=TRUNC(SYSDATE-2) GROUP BY TRUNC(FRAGMENT_DATE)
    )
    )
    
    SELECT /*+ PARALLEL(8) */  DAY_1,DAY_2 , ROUND(((DAY_1-DAY_2)/DAY_2*100),2) FARK INTO  XDAY1 ,XDAY2 ,XFARK
    FROM DS_2G;

   IF XFARK <=-25 THEN
    
     UPDATE NORTHI_DAILY_PROCESS SET AGGREGATE_STATE=0, PROCESS_COUNT=2 WHERE DATA_DATE=TRUNC(SYSDATE-1) AND ORG_TABLE='CELLSTS'; COMMIT;
     
     UPDATE NORTHI_DBH_PROCESS SET BH_STATE=0, PROCESS_COUNT=2 WHERE DATA_DATE=TRUNC(SYSDATE-1) AND ORG_TABLE='CELLSTS'; COMMIT;


     dbms_scheduler.run_job (job_name => 'NORTHI_LOADER.BEGIN_DAILY_WORKS_BSS');

    END IF;


END; 
/
