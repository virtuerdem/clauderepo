
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."AP_NORTHI_KPI_FORMULAS_ALL" 
AS
XVENDOR_FORMULA VARCHAR2(32000);
XVENDOR_FORMULA_DB VARCHAR2(32000);
XCOUNTER_ID VARCHAR2(4000);
XCOUNTER_NAME VARCHAR2(32000);
BEGIN
    
    DELETE FROM NORTHI_KPI_FORMULAS WHERE VENDOR = 9;
    COMMIT;
    FOR XLOOP IN
    (
        SELECT TABLE_NAME,RECORD_ID,TITLE_ID, PHASE,FIELD_ALIAS KPI_NAME,FIELD_EXPRESSION,NE_TYPE,FIELD_CAPTION,KPI_GROUP
        FROM NORTHI_DATA.NORTHI_BASIC_REPORT_DEFINITION
        WHERE FIELD_ALIAS!='HOUR' AND PHASE='5G'
        ORDER BY KPI_NAME
    )
    LOOP 
        FOR XVENDOR_LIST IN
        (
            SELECT DISTINCT VENDOR_ID 
            FROM NORTHI_KPI_FIELDS  A, NORTHI_TABLE_FIELDS B
            WHERE A.TABLE_NAME=B.TABLE_NAME AND A.LOCAL_FIELD=B.LOCAL_FIELD
            AND A.RECORD_ID=XLOOP.RECORD_ID
        )
        LOOP
            XVENDOR_FORMULA_DB:=XLOOP.FIELD_EXPRESSION;
            XVENDOR_FORMULA:=XLOOP.FIELD_EXPRESSION;
            FOR XLOOP2 IN
            (
                SELECT A.TABLE_NAME, A.KPI_NAME, A.KPI_GROUP, A.LOCAL_FIELD, VENDOR_ID,
                       REGEXP_REPLACE(C.REMOTE_FIELD, '[A-Z]{1,2}\.|[A-Z]{1,2}(\d)\.|[A-Z]{,1}\.', '') REMOTE_FIELD,
                       -1 NE_LEVEL
                  FROM NORTHI_KPI_FIELDS A, NORTHI_TABLE_FIELDS C
                 WHERE A.TABLE_NAME=C.TABLE_NAME AND A.LOCAL_FIELD=C.LOCAL_FIELD
                   AND A.RECORD_ID=XLOOP.RECORD_ID
                   AND VENDOR_ID=9--XVENDOR_LIST.VENDOR_ID
                 ORDER BY A.TABLE_NAME,A.KPI_NAME, LENGTH(A.LOCAL_FIELD) DESC
            )
            LOOP
                XVENDOR_FORMULA_DB := REPLACE(XVENDOR_FORMULA_DB,XLOOP2.LOCAL_FIELD,XLOOP2.REMOTE_FIELD);
                XVENDOR_FORMULA:=   REPLACE(XVENDOR_FORMULA,XLOOP2.LOCAL_FIELD,XLOOP2.REMOTE_FIELD);
                FOR XLOOP3 IN 
                (
                    SELECT * FROM (SELECT TO_CHAR(TRIM(REGEXP_SUBSTR(FIELD_EXP, '[^,]+', 1, LEVEL))) AS LOCAL_FIELD
                    FROM 
                    (
                        SELECT MULTIPLE_REPLACE( XLOOP2.REMOTE_FIELD,
                                     NEW t_text( 'ROUND(',',2)','SUM(','MAX(','MIN(','AVG(','DECODE(','+','-','*','/',',0,0,',',0,1,',')','(','NVL(','(',',100',',,,',',,',',8',',104576,',',NULL,',',1,',',60,60,',',0,','NORTHI_DATA.BTRAFFIC_CALCULATE'),
                                     NEW t_text( '','','','','','','',',',',',',',',',',',',',',','(','','','',',',',','',',',',',',',',',',','')
                                   ) FIELD_EXP 
                        FROM DUAL
                    )
                    CONNECT BY LEVEL <= REGEXP_count(FIELD_EXP, '[^,]+')+1
                    ) WHERE LOCAL_FIELD IS NOT NULL
                )
                LOOP
                    SELECT COUNTER_ID , COUNTER_NAME INTO XCOUNTER_ID,XCOUNTER_NAME
                    FROM 
                    (
                       
                        SELECT TO_CHAR(COUNTER_NAME_DB) COUNTER_ID, COUNTER_NAME_LOOKUP COUNTER_NAME
                        FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST A,  (SELECT * FROM NORTHI_LOADER.NORTHI_LOADER_PARENTS WHERE VENDOR_ID=9) X 
                        WHERE A.TABLE_NAME=X.PARENT_NAME 
                        
                        UNION ALL
                        SELECT SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COLUMN_NAME, SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1) COLUMN_NAME
                        FROM DUAL
                    )
                    WHERE COUNTER_ID=SUBSTR(XLOOP3.LOCAL_FIELD,INSTR(XLOOP3.LOCAL_FIELD,'.')+1)
                    AND ROWNUM=1;
                    XVENDOR_FORMULA:=REPLACE(XVENDOR_FORMULA,XCOUNTER_ID,XCOUNTER_NAME);
                END LOOP;
            END LOOP;
            
            INSERT INTO NORTHI_KPI_FORMULAS(TABLE_NAME, KPI_NAME, VENDOR, NORTHI_FORMULA, VENDOR_FORMULA, NE_LEVEL,VENDOR_FORMULA_DB,RECORD_ID,KPI_CAPTION,KPI_GROUP)
            VALUES(XLOOP.TABLE_NAME,XLOOP.KPI_NAME,XVENDOR_LIST.VENDOR_ID,XLOOP.FIELD_EXPRESSION,XVENDOR_FORMULA,XLOOP.NE_TYPE,XVENDOR_FORMULA_DB,XLOOP.RECORD_ID,XLOOP.FIELD_CAPTION,XLOOP.KPI_GROUP);
            COMMIT;
       END LOOP;
    END LOOP;
    
END;
/
