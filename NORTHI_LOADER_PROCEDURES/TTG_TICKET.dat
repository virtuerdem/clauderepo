
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."TTG_TICKET" (P_NUMBER1 NUMBER,P_NUMBER2 NUMBER , P_NUMBER3 NUMBER,P_NUMBER4 NUMBER,P_NUMBER5 NUMBER,
P_VARCHAR1 VARCHAR,P_VARCHAR2 VARCHAR , P_VARCHAR3 VARCHAR,P_VARCHAR4 VARCHAR,P_VARCHAR5 VARCHAR,
 io_cursor OUT SYS_REFCURSOR) IS
XSTATEMENT VARCHAR2(32000);
XRECORD_ID NUMBER;
XSELECT_COND VARCHAR2(4000);
XFIELD_EXP VARCHAR2(4000);
XFIELD_AL VARCHAR2(4000);
BEGIN
    IF P_NUMBER1=1 THEN -- Fill Boxes

        IF P_NUMBER2 = 1 THEN -- Fill Vendor List
         OPEN io_cursor FOR
            SELECT VENDOR_ID,VENDOR_NAME
            FROM NORTHI_VENDOR_LIST
            WHERE ACTIVE=1
            ORDER BY VENDOR_ID;
        ELSIF P_NUMBER2 = 2 THEN -- Fill Statistic Tables
         OPEN io_cursor FOR
            SELECT DISTINCT TABLE_NAME
            FROM NORTHI_LOADER_SETTINGS
            WHERE ACTIVE=1
            ORDER BY TABLE_NAME;
        ELSIF P_NUMBER2 = 3 THEN -- Fill Alarm Severity
         OPEN io_cursor FOR
            SELECT SEVERITY_ID, SEVERITY_NAME
            FROM NORTHI_PAT.ALARM_SEVERITY
            ORDER BY SEVERITY_ID ;

        ELSIF P_NUMBER2 = 4 THEN -- Fill Alarm Type
         OPEN io_cursor FOR
            SELECT ALARM_TYPE_ID, ALARM_TYPE_NAME
            FROM NORTHI_PAT.ALARM_TYPE
            ORDER BY ALARM_TYPE_NAME;
        ELSIF P_NUMBER2 = 5 THEN -- Fill Alarm Owner
         OPEN io_cursor FOR
            SELECT OWNER_ID, OWNER_NAME
            FROM NORTHI_PAT.ALARM_OWNER
            ORDER BY OWNER_NAME;
        ELSIF P_NUMBER2 = 6 THEN -- Fill Alarm Status
         OPEN io_cursor FOR
            SELECT STATUS_ID, STATUS_NAME
            FROM NORTHI_PAT.ALARM_STATUS
            ORDER BY STATUS_ID;

        ELSIF P_NUMBER2 = 7 THEN -- Filter Statistics by Vendor_id
          IF P_NUMBER3>0 THEN
             OPEN io_cursor FOR
                SELECT DISTINCT TABLE_NAME
                FROM NORTHI_LOADER_SETTINGS
                WHERE ACTIVE=1 AND VENDOR_ID=P_NUMBER3
                ORDER BY TABLE_NAME;
          ELSE --If Vendor ID=0 Display All Vendors statistics tables.
             OPEN io_cursor FOR
                SELECT DISTINCT TABLE_NAME
                FROM NORTHI_LOADER_SETTINGS
                WHERE ACTIVE=1
                ORDER BY TABLE_NAME;
          END IF;
        END IF;
    ELSIF P_NUMBER1 = 2 THEN -- List Alarms

        IF P_NUMBER2 = -1 THEN -- Display Whole Alarms

         OPEN io_cursor FOR
          SELECT ALARM_ID, VENDOR_NAME , STATISTIC , E.ALARM_TYPE_NAME ALARM_TYPE, C.SEVERITY_NAME SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, B.OWNER_NAME OWNER, ALARM_DETAIL,D.STATUS_NAME ALARM_STATUS, ALARM_COUNT
          FROM NORTHI_PAT.ALARM_LIST A,NORTHI_PAT.ALARM_OWNER B,NORTHI_PAT.ALARM_SEVERITY C,NORTHI_PAT.ALARM_STATUS D,NORTHI_PAT.ALARM_TYPE E,NORTHI_VENDOR_LIST F
          WHERE
          A.VENDOR=F.VENDOR_ID
          AND A.SEVERITY=C.SEVERITY_ID
          AND  A.ALARM_TYPE=E.ALARM_TYPE_ID
          AND A.OWNER=B.OWNER_ID
          AND A.ALARM_STATUS=D.STATUS_ID
          ORDER BY ALARM_OPEN_DATE DESC;
        END IF;
    ELSIF P_NUMBER1 = 3 THEN -- ALARM ID YE GORE ALARM DONDURMECE.
      IF P_NUMBER2 = 1 THEN -- ALARM_ID P_NUMBER3,
         OPEN io_cursor FOR
            SELECT ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS, ALARM_COUNT
            FROM NORTHI_PAT.ALARM_LIST A
            WHERE ALARM_ID=P_NUMBER3;
        END IF;
    ELSIF P_NUMBER1 = 4 THEN -- ALARM ID YE GORE ALARM HISTORY DONDURMECE.
      IF P_NUMBER2 = 1 THEN -- ALARM_ID P_NUMBER3,
         OPEN io_cursor FOR
            SELECT ALARM_ID, VENDOR_NAME , STATISTIC , E.ALARM_TYPE_NAME ALARM_TYPE, C.SEVERITY_NAME SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, B.OWNER_NAME OWNER, ALARM_DETAIL,D.STATUS_NAME ALARM_STATUS, ALARM_COUNT
          FROM NORTHI_PAT.ALARM_LIST_HISTORY A,NORTHI_PAT.ALARM_OWNER B,NORTHI_PAT.ALARM_SEVERITY C,NORTHI_PAT.ALARM_STATUS D,NORTHI_PAT.ALARM_TYPE E,NORTHI_VENDOR_LIST F
          WHERE
          A.VENDOR=F.VENDOR_ID
          AND A.SEVERITY=C.SEVERITY_ID
          AND  A.ALARM_TYPE=E.ALARM_TYPE_ID
          AND A.OWNER=B.OWNER_ID
          AND A.ALARM_STATUS=D.STATUS_ID
          AND ALARM_ID=P_NUMBER3
          ORDER BY ALARM_OPEN_DATE DESC;
        END IF;
    ELSIF P_NUMBER1=5 THEN --Alarm Filtrelemece.
     FOR XFILTER IN
     (
        SELECT DECODE(ROWNUM,1,'VENDOR',2,'STATISTIC',3,'ALARM_TYPE',4,'SEVERITY',5,'ALARM_OPEN_DATE',6,'ALARM_CLOSE_DATE',7,'OWNER',8,'DATA_DATE',9,'ALARM_STATUS') ROWNUMX
        ,COLUMN_VALUE FROM TABLE ( NORTHI.STRING_FNC.SPLIT2(P_VARCHAR1,';') )
     )
     LOOP
       --0 Vendor 1 Statistic 2 AlarmType 3 Severity 4 SD 5 ED 6 Owner 7 DD 8 Status
        IF (XFILTER.ROWNUMX='ALARM_OPEN_DATE' )AND (XFILTER.COLUMN_VALUE!='All' ) THEN
            XSTATEMENT:=XSTATEMENT||' AND '|| XFILTER.ROWNUMX||'>='||XFILTER.COLUMN_VALUE;
            XSTATEMENT:=XSTATEMENT;
        ELSIF (XFILTER.ROWNUMX='ALARM_CLOSE_DATE' )AND (XFILTER.COLUMN_VALUE!='All' ) THEN
            XSTATEMENT:=XSTATEMENT;
            XSTATEMENT:=XSTATEMENT||' AND '|| XFILTER.ROWNUMX||'<='||XFILTER.COLUMN_VALUE;
        ELSIF XFILTER.COLUMN_VALUE!='''All''' THEN
            XSTATEMENT:=XSTATEMENT||' AND '|| XFILTER.ROWNUMX||'='||XFILTER.COLUMN_VALUE;
        END IF;
     END LOOP;
     XSTATEMENT:='SELECT ALARM_ID, VENDOR_NAME , STATISTIC , E.ALARM_TYPE_NAME ALARM_TYPE, C.SEVERITY_NAME SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, B.OWNER_NAME OWNER, ALARM_DETAIL,D.STATUS_NAME ALARM_STATUS, ALARM_COUNT
          FROM NORTHI_PAT.ALARM_LIST_HISTORY A,NORTHI_PAT.ALARM_OWNER B,NORTHI_PAT.ALARM_SEVERITY C,NORTHI_PAT.ALARM_STATUS D,NORTHI_PAT.ALARM_TYPE E,NORTHI_VENDOR_LIST F
          WHERE A.VENDOR=F.VENDOR_ID
          AND A.SEVERITY=C.SEVERITY_ID
          AND  A.ALARM_TYPE=E.ALARM_TYPE_ID
          AND A.OWNER=B.OWNER_ID
          AND A.ALARM_STATUS=D.STATUS_ID '||XSTATEMENT;
        OPEN io_cursor FOR
            XSTATEMENT;
    END IF;
EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
       -- Consider logging the error and then re-raise
       RAISE;
END TTG_TICKET; 
/
