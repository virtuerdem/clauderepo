
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."RAW_DATA_GENERATE_KPI2" (XTABLE_NAME VARCHAR2,XKPI_NAMES VARCHAR2,XSCHEMA_TYPE NUMBER)
AS
XSELECT VARCHAR2(32000);
XFROM VARCHAR2(32000);
XWHERE VARCHAR2(32000);
XDATE_FIELD VARCHAR2(31);
XSCHEMA VARCHAR2(40);
XKPI_RAW_FORMULA VARCHAR2(32000);
XCURRENT_KPI VARCHAR2(40);
XCURRENT_NI_FORMULA VARCHAR2(1000);
XTEMP_KPI VARCHAR2(32000);
XTEMP_NI_FORMULA VARCHAR2(1000);
XTEMP VARCHAR2(100);
XGROUP_BY VARCHAR2(100);
BEGIN 
-- BU PROCEDURE KPI IN ICINDEKI LOCAL_FIELD LARA COUNTERLARI YERLESTIRECEK SEKILDE DUZENLENMELI.
FOR XVENDORS IN 
(
            SELECT DISTINCT B.VENDOR_ID,WHERE_CLAUSE,NI_TABLE
            FROM (SELECT DISTINCT A.TABLE_NAME NI_TABLE, B.TABLE_NAME RAW_TABLE, RAW_COUNTER
                  FROM VIEW_KPI_COUNTER_DEVISION A, ALL_TAB_COLUMNS B,  (
                    SELECT X.KPI_NAME
                    FROM 
                    (
                        SELECT 
                            CAST( SPLIT(XKPI_NAMES) AS KPI_COLL_TYPE)  KPI_NAME
                        FROM DUAL
                   ) B,TABLE (B.KPI_NAME) X ) Y
                 WHERE     A.RAW_COUNTER = B.COLUMN_NAME
                       AND A.TABLE_NAME = XTABLE_NAME
                       AND A.KPI_NAME =Y.KPI_NAME
                       ) A,
               NORTHI_LOADER_SETTINGS B
            WHERE     INSTR (B.FROM_CLAUSE||' ', A.RAW_TABLE||' ') > 0
               AND B.TABLE_NAME =  XTABLE_NAME
               AND A.NI_TABLE = B.TABLE_NAME
) LOOP
    XSELECT :='';
    XFROM := '';
    XWHERE := '';
    XKPI_RAW_FORMULA:='';
    XCURRENT_KPI :='';
    XTEMP_KPI:=' ';
    XCURRENT_NI_FORMULA :='';
    XTEMP_NI_FORMULA :='';
    XDATE_FIELD:='FRAGMENT_DATE';
       IF INSTR(XVENDORS.WHERE_CLAUSE,'FRAGMENT_DATE')>0 THEN 
            XDATE_FIELD:='FRAGMENT_DATE';
        ELSIF INSTR(XVENDORS.WHERE_CLAUSE,'DATA_DATE')>0 THEN 
            XDATE_FIELD:='DATA_DATE';
        ELSIF INSTR(XVENDORS.WHERE_CLAUSE,'PERIOD_START_TIME')>0 THEN 
            XDATE_FIELD:='PERIOD_START_TIME';
        END IF;
    FOR XTABLES IN (
        SELECT NI_TABLE, RAW_TABLE||' A'||ROWNUM RAW_TABLE, ROWNUM RN,VENDOR_ID
          FROM 
          (
            SELECT DISTINCT A.NI_TABLE, A.RAW_TABLE, B.VENDOR_ID
            FROM (SELECT DISTINCT A.TABLE_NAME NI_TABLE, B.TABLE_NAME RAW_TABLE, RAW_COUNTER
                  FROM VIEW_KPI_COUNTER_DEVISION A, ALL_TAB_COLUMNS B,    (
                    SELECT X.KPI_NAME
                    FROM 
                    (
                        SELECT 
                            CAST( SPLIT(XKPI_NAMES) AS KPI_COLL_TYPE)  KPI_NAME
                        FROM DUAL
                   ) B,TABLE (B.KPI_NAME) X ) Y
                 WHERE     A.RAW_COUNTER = B.COLUMN_NAME
                       AND A.TABLE_NAME = XTABLE_NAME
                       AND A.KPI_NAME =Y.KPI_NAME
                       ) A,
               NORTHI_LOADER_SETTINGS B
            WHERE     INSTR (B.FROM_CLAUSE||' ', A.RAW_TABLE||' ') > 0
               AND B.TABLE_NAME =  XTABLE_NAME
               AND A.NI_TABLE = B.TABLE_NAME
               AND VENDOR_ID=XVENDORS.VENDOR_ID
           )
           ORDER BY RAW_TABLE
    )LOOP
        SELECT DECODE(XSCHEMA_TYPE,0,TEMP_SCHEMA,1,PERM_SCHEMA,TEMP_SCHEMA) INTO XSCHEMA
        FROM NORTHI_VENDOR_LIST 
        WHERE VENDOR_ID=XVENDORS.VENDOR_ID;  
        
        XFROM:=XFROM||CHR(13)||CHR(10)||CHR(9)||XSCHEMA||'.'||XTABLES.RAW_TABLE||',';
         XWHERE :=XWHERE||CHR(13)||CHR(10)||CHR(9)||'C1.FRAGMENT_DATE'||'=A'||XTABLES.RN||'.'||XDATE_FIELD||' AND C1.NETWORK_ID='||'A'||XTABLES.RN||'.NETWORK_ID AND ';
    END LOOP;
    XSELECT :='SELECT C1.NETWORK_ID,C1.FRAGMENT_DATE,';
    FOR XCOUNTERS IN (
           SELECT DISTINCT RAW_TABLE,VENDOR_ID ,RAW_COUNTER RAW_COUNTER,KPI_NAME,NI_FORMULA,NI_FIELD,NE_TYPE
          FROM 
          (
            SELECT DISTINCT A.NI_TABLE, A.RAW_TABLE, B.VENDOR_ID,KPI_NAME,RAW_COUNTER,NI_FORMULA,NI_FIELD,NE_TYPE
            FROM 
            (
                SELECT DISTINCT A.TABLE_NAME NI_TABLE, B.TABLE_NAME RAW_TABLE, RAW_COUNTER,A.KPI_NAME,NI_FORMULA,NI_FIELD,NE_TYPE
                  FROM VIEW_KPI_COUNTER_DEVISION A, ALL_TAB_COLUMNS B,    (
                    SELECT X.KPI_NAME
                    FROM 
                    (
                        SELECT 
                            CAST( SPLIT(XKPI_NAMES) AS KPI_COLL_TYPE)  KPI_NAME
                        FROM DUAL
                   ) B,TABLE (B.KPI_NAME) X ) Y
                 WHERE     A.RAW_COUNTER = B.COLUMN_NAME
                       AND A.TABLE_NAME =XTABLE_NAME
                       AND A.KPI_NAME  =Y.KPI_NAME
                ) A,
               NORTHI_LOADER_SETTINGS B
            WHERE     INSTR (B.FROM_CLAUSE||' ', A.RAW_TABLE||' ') > 0
               AND B.TABLE_NAME =  XTABLE_NAME
               AND A.NI_TABLE = B.TABLE_NAME
               AND VENDOR_ID=XVENDORS.VENDOR_ID
               )
               ORDER BY KPI_NAME,NI_FORMULA
    )LOOP
            XCURRENT_KPI:=XCOUNTERS.KPI_NAME;
            XCURRENT_NI_FORMULA:=XCOUNTERS.NI_FORMULA;
             IF  (XCURRENT_KPI <>XTEMP_KPI OR XCURRENT_NI_FORMULA<>XTEMP_NI_FORMULA) THEN
                    IF (XCOUNTERS.NE_TYPE<>'GEN') THEN
                        XKPI_RAW_FORMULA:=XCOUNTERS.NI_FORMULA||' '||XCOUNTERS.KPI_NAME||'_'||XCOUNTERS.NE_TYPE||',';
                    ELSE
                        XKPI_RAW_FORMULA:=XCOUNTERS.NI_FORMULA||' '||XCOUNTERS.KPI_NAME||',';
                    END IF;
                    XTEMP_KPI:=XCURRENT_KPI;
                    XTEMP_NI_FORMULA:=XCURRENT_NI_FORMULA;
                    XSELECT :=XSELECT||CHR(13)||CHR(10)||CHR(9)||MULTIPLE_REPLACE(XKPI_RAW_FORMULA,NEW T_TEXT('C1.','SUM(','AVG(','MIN(','MAX(','NVL('),NEW T_TEXT('','SUM(C1.','AVG(C1.','MIN(C1.','MAX(C1.','NVL(C1.'));
                    XKPI_RAW_FORMULA:='';
             END IF; 
            XTEMP:='ROUND(SUM('||SUBSTR(SUBSTR(XFROM||',',INSTR(XFROM||',',XCOUNTERS.RAW_TABLE)) ,LENGTH(XCOUNTERS.RAW_TABLE)+2,INSTR(SUBSTR(XFROM||',',INSTR(XFROM||',',XCOUNTERS.RAW_TABLE)),',') -LENGTH(XCOUNTERS.RAW_TABLE)-2)||'.'||XCOUNTERS.RAW_COUNTER||'),4) '||XCOUNTERS.RAW_COUNTER;
            IF (INSTR(XSELECT,XTEMP)=0) THEN
                XSELECT :=XSELECT||CHR(13)||CHR(10)||CHR(9)||XTEMP||',';
            END IF;
            
    END LOOP;
    XSELECT:=SUBSTR(XSELECT,1,LENGTH(XSELECT)-1);
    XFROM:='FROM '||SUBSTR(XFROM,1,LENGTH(XFROM)-1)||',NORTHI_DATA.'||XVENDORS.NI_TABLE||' C1';
    XWHERE:='WHERE '||SUBSTR(XWHERE,1,LENGTH(XWHERE)-4);
    XGROUP_BY:='GROUP BY C1.NETWORK_ID,C1.FRAGMENT_DATE';
   INSERT INTO SIL_QUERY_TEXT(QUERY_TEXT)
    VALUES(XWHERE);--||CHR(13)||CHR(10)||XFROM||CHR(13)||CHR(10)||XWHERE||CHR(13)||CHR(10)||XGROUP_BY);
    --VALUES(XSELECT);--||CHR(13)||CHR(10)||XFROM||CHR(13)||CHR(10)||XWHERE||CHR(13)||CHR(10)||XGROUP_BY);
    COMMIT;
END LOOP; 
END;
/
