
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."NK_ABID_4G_UTILIZATION_HOURLY" AS  
BEGIN

DELETE FROM /*+ PARALLEL */   NORTHI_DATA.NK_4G_UTILIZATION_HOURLY WHERE FRAGMENT_DATE = TRUNC(SYSDATE-1,'HH24')-3/24; COMMIT;

--------------------------------------------------------------------------------------
INSERT /*+ APPEND */  INTO NORTHI_DATA.NK_4G_UTILIZATION_HOURLY (CITY_NAME, DISTRICT_NAME, SUB_REGION_NAME,FRAGMENT_DATE, DTYPE, "4G_CONGESTION_DAILY", "4G_USER_THROUGHPUT_BH", "4G_PRB_UTILIZATION_BH")

WITH CELL_UTIL_PRB_4G_1920 AS
(
SELECT  FRAGMENT_DATE, NETWORK_ID, FBAND, TO_NUMBER(BW) BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, 
        ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) KPI160_3,                                      
        CASE
        WHEN ROUND((A.DL_NONGBR_ACTIVE_USERS)/((5*BW-(0.15*VOLTE_SESSION_TIME)-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 AND (DL_NONGBR_NORM_USER_THRPUT)<3  THEN 1                   
        ELSE 0
        END  KPI160AB_3,                  
        ROUND( DL_NONGBR_USER_THROUGHPUT,4)    DL_NONGBR_USER_THROUGHPUT
        FROM
            (
            SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
            ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
            ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
            ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
            ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN),0,0,(SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL-DL_NORM_USER_THRPUT_NUM)/1000)/SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN)),2) DL_NONGBR_NORM_USER_THRPUT, 
            ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),4) DL_NONGBR_USER_THROUGHPUT,
            ROUND(SUM(DL_NONGBR_ACTIVE_USERS)/3600000,2) DL_NONGBR_ACTIVE_USERS,
            ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME                              
            FROM NORTHI_DATA.CELLSTS_4G
            where dtype=1 and  FRAGMENT_DATE =TRUNC(SYSDATE,'HH24')-2/24
            GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID 
            )   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
            WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID = B.FBAND_ID 
     
UNION ALL

SELECT  FRAGMENT_DATE, NETWORK_ID, FREQUENCY FBAND, BAND_WIDTH BW,
0 PRBS_USED_BY_PDSCH, 
0 AVAILABLE_PRBS, 
ROUND(SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9 -PM_DRB_UeThrLastTimeDlQCI6-PM_DRB_UeThrLastTimeDlQCI7-PM_DRB_UeThrLastTimeDlQCI8-PM_DRB_UeThrLastTimeDlQCI9)/(3600*1000),2) DL_NONGBR_ACTIVE_USERS,         
0 DL_USER_THROUGHPUT, 
ROUND(DECODE(SUM(PM_RRU_PrbTotDlAvailable-(3600*1000*10)),0,0,SUM(PM_RRU_PrbTotDlUsed)/SUM(PM_RRU_PrbTotDlAvailable-(3600*1000*10)))*100,2) KPI160_3,       
CASE
WHEN ROUND((SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9 -PM_DRB_UeThrLastTimeDlQCI6-PM_DRB_UeThrLastTimeDlQCI7-PM_DRB_UeThrLastTimeDlQCI8-PM_DRB_UeThrLastTimeDlQCI9)/(3600*1000))/(((5*BAND_WIDTH)-0.15*SUM(PM_ERAB_SessionTimeQCI1/3600)-10)/10),2) > 1 AND ROUND(DECODE(SUM(PM_RRU_PrbTotDlAvailable-(3600*1000*10)),0,0,SUM(PM_RRU_PrbTotDlUsed)/SUM(PM_RRU_PrbTotDlAvailable-(3600*1000*10)))*100,2) > 100 AND ROUND(((SUM(PM_DRB_UeThrTotVolDlQCI6+PM_DRB_UeThrTotVolDlQCI7+PM_DRB_UeThrTotVolDlQCI8+PM_DRB_UeThrTotVolDlQCI9) - SUM(PM_DRB_UeThrLastVolDlQCI6+PM_DRB_UeThrLastVolDlQCI7+PM_DRB_UeThrLastVolDlQCI8+PM_DRB_UeThrLastVolDlQCI9))/1000)/(SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9) - SUM(PM_DRB_UeThrLastTimeDlQCI6+PM_DRB_UeThrLastTimeDlQCI7+PM_DRB_UeThrLastTimeDlQCI8+PM_DRB_UeThrLastTimeDlQCI9)),2) < 3 THEN 1             
ELSE 0
END  KPI160AB_3,                  
ROUND(DECODE((SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9) - SUM(PM_DRB_UeThrLastTimeDlQCI6+PM_DRB_UeThrLastTimeDlQCI7+PM_DRB_UeThrLastTimeDlQCI8+PM_DRB_UeThrLastTimeDlQCI9)) , 0, 0, ((SUM(PM_DRB_UeThrTotVolDlQCI6+PM_DRB_UeThrTotVolDlQCI7+PM_DRB_UeThrTotVolDlQCI8+PM_DRB_UeThrTotVolDlQCI9) - SUM(PM_DRB_UeThrLastVolDlQCI6+PM_DRB_UeThrLastVolDlQCI7+PM_DRB_UeThrLastVolDlQCI8+PM_DRB_UeThrLastVolDlQCI9))/1000) / (SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9) - SUM(PM_DRB_UeThrLastTimeDlQCI6+PM_DRB_UeThrLastTimeDlQCI7+PM_DRB_UeThrLastTimeDlQCI8+PM_DRB_UeThrLastTimeDlQCI9))),4) DL_NONGBR_USER_THROUGHPUT
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, 
SUM(VOLTE_TRAFFIC_NUM) PM_ERAB_SessionTimeQCI1,
SUM(UL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtUlVolSum,
SUM(DL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtDlVolSum,
SUM(PM_RRU_PRBTOTDLAVAILABLE) PM_RRU_PrbTotDlAvailable,
SUM(PM_RRU_PrbTotDlUsed) PM_RRU_PrbTotDlUsed,
SUM(PM_DRB_UeThrTotTimeDlQCI6) PM_DRB_UeThrTotTimeDlQCI6,
SUM(PM_DRB_UeThrTotTimeDlQCI7) PM_DRB_UeThrTotTimeDlQCI7,
SUM(PM_DRB_UeThrTotTimeDlQCI8) PM_DRB_UeThrTotTimeDlQCI8,
SUM(PM_DRB_UeThrTotTimeDlQCI9) PM_DRB_UeThrTotTimeDlQCI9,
SUM(PM_DRB_UeThrLastTimeDlQCI6) PM_DRB_UeThrLastTimeDlQCI6,
SUM(PM_DRB_UeThrLastTimeDlQCI7) PM_DRB_UeThrLastTimeDlQCI7,
SUM(PM_DRB_UeThrLastTimeDlQCI8) PM_DRB_UeThrLastTimeDlQCI8,
SUM(PM_DRB_UeThrLastTimeDlQCI9) PM_DRB_UeThrLastTimeDlQCI9,
SUM(PM_DRB_UeThrTotVolDlQCI6) PM_DRB_UeThrTotVolDlQCI6,
SUM(PM_DRB_UeThrTotVolDlQCI7) PM_DRB_UeThrTotVolDlQCI7,
SUM(PM_DRB_UeThrTotVolDlQCI8) PM_DRB_UeThrTotVolDlQCI8,
SUM(PM_DRB_UeThrTotVolDlQCI9) PM_DRB_UeThrTotVolDlQCI9,
SUM(PM_DRB_UeThrLastVolDlQCI6) PM_DRB_UeThrLastVolDlQCI6,
SUM(PM_DRB_UeThrLastVolDlQCI7) PM_DRB_UeThrLastVolDlQCI7,
SUM(PM_DRB_UeThrLastVolDlQCI8) PM_DRB_UeThrLastVolDlQCI8,
SUM(PM_DRB_UeThrLastVolDlQCI9) PM_DRB_UeThrLastVolDlQCI9
FROM NORTHI_DATA.ULAK_4G
WHERE DTYPE=1 AND FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-2/24
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
) A, NORTHI_DATA.LIST_ULAK_ENODEB_CELL X, NORTHI_PARSER.OBJECTS_ULAK4G_DAILY Y
WHERE A.NETWORK_ID=X.CELL_ID AND A.NETWORK_ID = Y.NE_ID AND TRUNC(A.FRAGMENT_DATE) = Y.DATA_DATE
GROUP BY FRAGMENT_DATE, NETWORK_ID, FREQUENCY, BAND_WIDTH
),

LIST_ENODEB AS
(
SELECT  *
FROM NORTHI_DATA.LIST_ENODEB_CELL

UNION ALL

SELECT  *
FROM NORTHI_DATA.LIST_ULAK_ENODEB_CELL
)

SELECT  
UPPER(CITY_NAME) CITY_NAME, ILCE_NAME DISTRICT_NAME,'' SUB_REGION_NAME, A.FRAGMENT_DATE,
1 DTYPE,
ROUND(SUM(KPI160AB_3)/SUM(1)*100,2) "4G_CONGESTION_DAILY",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),4) "4G_USER_THROUGHPUT_BH",
ROUND(AVG(KPI160_3),2) "4G_PRB_UTILIZATION_BH"
FROM   CELL_UTIL_PRB_4G_1920 A, LIST_ENODEB X 
WHERE A.NETWORK_ID=X.CELL_ID AND UPPER(ENODEB_NAME) NOT LIKE '%CROWD%' AND CITY_NAME <> 'null' and ILCE_NAME <> 'null'
GROUP BY A.FRAGMENT_DATE,UPPER(CITY_NAME) ,ILCE_NAME
UNION ALL
SELECT 
UPPER(CITY_NAME) CITY_NAME, '' ILCE_NAME,'' SUB_REGION_NAME,A.FRAGMENT_DATE, 2 DTYPE,
ROUND(SUM(KPI160AB_3)/SUM(1)*100,2) "4G_CONGESTION_DAILY",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),4) "4G_USER_THROUGHPUT_BH",
ROUND(AVG(KPI160_3),2) "4G_PRB_UTILIZATION_BH"
FROM   CELL_UTIL_PRB_4G_1920 A, LIST_ENODEB X 
WHERE A.NETWORK_ID=X.CELL_ID AND UPPER(ENODEB_NAME) NOT LIKE '%CROWD%' AND CITY_NAME <> 'null'
GROUP BY A.FRAGMENT_DATE,UPPER(CITY_NAME) 
UNION ALL
SELECT  
TO_NCHAR ('NW') CITY_NAME, '' ILCE_NAME,'' SUB_REGION_NAME, A.FRAGMENT_DATE, 3 DTYPE,
ROUND(SUM(KPI160AB_3)/SUM(1)*100,2) "4G_CONGESTION_DAILY",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),4) "4G_USER_THROUGHPUT_BH",
ROUND(AVG(KPI160_3),2) "4G_PRB_UTILIZATION_BH"
FROM   CELL_UTIL_PRB_4G_1920 A, LIST_ENODEB X 
WHERE A.NETWORK_ID=X.CELL_ID AND UPPER(ENODEB_NAME) NOT LIKE '%CROWD%' 
GROUP BY A.FRAGMENT_DATE
UNION ALL
SELECT  
TO_NCHAR ('') CITY_NAME, '' ILCE_NAME,UPPER(SUB_REGION_NAME), A.FRAGMENT_DATE, 4 DTYPE, --SUB_REGION_NAME
ROUND(SUM(KPI160AB_3)/SUM(1)*100,2) "4G_CONGESTION_DAILY",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),4) "4G_USER_THROUGHPUT_BH",
ROUND(AVG(KPI160_3),2) "4G_PRB_UTILIZATION_BH"
FROM   CELL_UTIL_PRB_4G_1920 A, LIST_ENODEB X 
WHERE A.NETWORK_ID=X.CELL_ID AND UPPER(ENODEB_NAME) NOT LIKE '%CROWD%'  AND UPPER(SUB_REGION_NAME) <> 'NULL'
GROUP BY A.FRAGMENT_DATE,UPPER(SUB_REGION_NAME);
        
COMMIT;


END;
/
