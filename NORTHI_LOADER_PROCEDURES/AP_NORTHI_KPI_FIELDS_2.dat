
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."AP_NORTHI_KPI_FIELDS_2" (XKPI_CODE NUMBER)
AS 
XFIELD VARCHAR2(40);
XCNT NUMBER;
BEGIN
    
    DELETE FROM NORTHI_KPI_FIELDS_CGDS WHERE RECORD_ID=XKPI_CODE;
    COMMIT;
    FOR XLOOP IN
    (
        SELECT TABLE_NAME,RECORD_ID,TITLE_ID, PHASE,FIELD_ALIAS KPI_NAME,FIELD_CAPTION, 
        multiple_replace( FIELD_EXPRESSION,
                             NEW t_text( 'ROUND(',',2)','SUM(','MAX(','MIN(','AVG(','DECODE(','+','-','*','/',',0,0,',',0,1,',')','(','NVL(','(',',100',',,,',',,',',8',',104576,',',NULL,',',1,',',60,60,',',0,','NORTHI_DATA.BTRAFFIC_CALCULATE'),
                             NEW t_text( '','','','','','','',',',',',',',',',',',',',',','(','','','',',',',','',',',',',',',',',',','')
                           ) FIELD_EXP,
                           KPI_GROUP
        FROM NORTHI_DATA.NORTHI_BASIC_REPORT_DEFINITION
        WHERE RECORD_ID=XKPI_CODE
        ORDER BY KPI_NAME
    )
    LOOP 
        FOR XLOOP2 IN
        (
            SELECT TO_CHAR(TRIM(REGEXP_SUBSTR(XLOOP.FIELD_EXP, '[^,]+', 1, LEVEL))) AS LOCAL_FIELD
            FROM DUAL
            CONNECT BY LEVEL <= REGEXP_count(XLOOP.FIELD_EXP, '[^,]+')+1
        )
        LOOP
            XFIELD:=XLOOP2.LOCAL_FIELD;
            IF (NUMBERS_ONLY( XLOOP2.LOCAL_FIELD) IS NULL) AND (XFIELD!=' ') AND (XFIELD IS NOT NULL) THEN
                SELECT COUNT(*) INTO XCNT
                FROM NORTHI_KPI_FIELDS_CGDS
                WHERE TABLE_NAME=XLOOP.TABLE_NAME AND  RECORD_ID=XLOOP.RECORD_ID AND TITLE_ID=XLOOP.TITLE_ID AND KPI_NAME=XLOOP.KPI_NAME AND LOCAL_FIELD=TRIM(XLOOP2.LOCAL_FIELD);
                IF XCNT=0 THEN
                    INSERT INTO NORTHI_KPI_FIELDS_CGDS(TABLE_NAME, RECORD_ID, TITLE_ID, PHASE, KPI_NAME, LOCAL_FIELD,KPI_CAPTION,KPI_GROUP)
                    VALUES(XLOOP.TABLE_NAME, XLOOP.RECORD_ID, XLOOP.TITLE_ID, XLOOP.PHASE, XLOOP.KPI_NAME, TRIM(XLOOP2.LOCAL_FIELD),XLOOP.FIELD_CAPTION,XLOOP.KPI_GROUP);
                    COMMIT;
                END IF;
            END IF;
        END LOOP;
    END LOOP;
END;
/
