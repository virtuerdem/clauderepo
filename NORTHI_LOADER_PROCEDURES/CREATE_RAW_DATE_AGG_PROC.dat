
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."CREATE_RAW_DATE_AGG_PROC" (XTABLE_NAME IN VARCHAR2)
AS 
XSTATEMENT CLOB;
XAGGREGATE_PROCEDURE_NAME VARCHAR(50);
XAGGREGATION_FIELDS VARCHAR(32000);
XLOCAL_FIELDS VARCHAR(32000);
XFROM_CLAUSE VARCHAR2(4000);
XWHERE_CLAUSE VARCHAR2(4000);
XINSERT_TABLE_NAME VARCHAR2(1000);
BEGIN
    
   
    FOR XAGGREGATE IN 
    (
       SELECT DISTINCT TABLE_NAME,A.AGG_SHEMA,A.XLEVEL,A.SD,A.ED
        FROM 
        (
                          SELECT 'DA'  XLEVEL,    'NORTHI_RAW_DA' AGG_SHEMA     ,'TRUNC(XDATA_DATE)' SD       ,     '(TRUNC(XDATA_DATE)+1)-0.01/24' ED FROM DUAL 
                UNION ALL SELECT 'WA' XLEVEL,     'NORTHI_RAW_WA' AGG_SHEMA    ,'TRUNC(XDATA_DATE,''DAY'')' SD ,   '(TRUNC(XDATA_DATE,''DAY'')+7)-0.01/24' FROM DUAL 
                UNION ALL SELECT 'MA' XLEVEL,     'NORTHI_RAW_MA' AGG_SHEMA  ,'TRUNC(XDATA_DATE,''MONTH'')' SD,  'ADD_MONTHS(TRUNC(XDATA_DATE),1)-0.01/24' FROM DUAL 
               
        ) A,NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST  B
        WHERE TABLE_NAME=XTABLE_NAME
        
       

    )
    
    LOOP
       
       XSTATEMENT:='';
       
       XAGGREGATE_PROCEDURE_NAME:= XAGGREGATE.AGG_SHEMA ||'.P_'||SUBSTR(XTABLE_NAME,1,29);
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XAGGREGATE_PROCEDURE_NAME,'NNNN12 >>' || XSTATEMENT, SYSDATE); COMMIT;
     
       GET_RAW_DATE_AGG(XTABLE_NAME,XAGGREGATION_FIELDS,XLOCAL_FIELDS);
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XAGGREGATE_PROCEDURE_NAME,'NNNN13 >>' || XSTATEMENT, SYSDATE); COMMIT;
       
       --SELECT FROM_CLAUSE,LOAD_TYPE,DATE_FIELD,WHERE_CLAUSE INTO XFROM_CLAUSE,XLOAD_TYPE,XDATE_FIELD,XWHERE_CLAUSE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
       
       -- IF XAGGREGATE.AGG_TYPE='H' THEN
       -- XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;
       -- XWHERE_CLAUSE:=XWHERE_CLAUSE||' AND ';
       -- ELSE 
       
       --END IF;

       IF XAGGREGATE.XLEVEL='WA' OR XAGGREGATE.XLEVEL='MA' THEN
        XFROM_CLAUSE:='NORTHI_RAW_DA.'||XTABLE_NAME||'  A ';
        XWHERE_CLAUSE:='';
       ELSE 
        XFROM_CLAUSE:='HIZIR2.'||XTABLE_NAME||' A ';
        XWHERE_CLAUSE:='';
       END IF;
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XFROM_CLAUSE,'NNNN14 >>' || XSTATEMENT, SYSDATE); COMMIT;
       --/*+ PARALLEL(A,16) APPEND */

      -- XINSERT_TABLE_NAME:=XTABLE_NAME ||'_'||XAGGREGATE.XLEVEL;
       XSTATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
      CHR(13)||'BEGIN'||
      CHR(13)||CHR(9)||'INSERT  /*+ APPEND */ INTO ' ||XAGGREGATE.AGG_SHEMA ||'.'||XTABLE_NAME  ||
      CHR(13)||CHR(9)||'('||
      CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||',NETWORK_ID'||',DATA_DATE'||
       CHR(13)||CHR(9)||')'||
       CHR(13)||CHR(9)||'SELECT '||
       CHR(13)||CHR(9)||CHR(9)|| XAGGREGATION_FIELDS|| ',NETWORK_ID'||',XDATA_DATE '||
       CHR(13)||CHR(9)||' FROM '||XFROM_CLAUSE|| 
       CHR(13)||CHR(9)||' WHERE '||XWHERE_CLAUSE||' DATA_DATE BETWEEN '||XAGGREGATE.SD||' AND '||XAGGREGATE.ED||
       CHR(13)||CHR(9)||' GROUP BY NETWORK_ID'||',XDATA_DATE'||' ;'||
      
      'COMMIT;'||CHR(13)|| 
      CHR(13)||'END;';
             
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XSTATEMENT,'NNNN15 >>' || XSTATEMENT, SYSDATE); COMMIT;
        
       EXECUTE IMMEDIATE XSTATEMENT ;
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XSTATEMENT,'NNNN16 >>' || XSTATEMENT, SYSDATE); COMMIT;
       
    END LOOP;
   EXCEPTION
   WHEN NO_DATA_FOUND THEN
   NULL;
   WHEN OTHERS THEN
   BEGIN
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,111,XSTATEMENT,SYSDATE,'CREATE_LOADER_PROCEDURE2',XSTATEMENT);
   END;
END CREATE_RAW_DATE_AGG_PROC;
/
