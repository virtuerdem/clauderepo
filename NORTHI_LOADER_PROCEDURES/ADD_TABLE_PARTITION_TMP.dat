
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."ADD_TABLE_PARTITION_TMP" (XTABLE_NAME VARCHAR2,XORG_TABLE VARCHAR2,XSTART_DATE DATE,XEND_DATE DATE,XLEVEL NUMBER)
IS

   XSTATEMENT VARCHAR2(32000);
   XPARTITION_SCRIPT   VARCHAR2 (4000);
   XDATE               DATE;
   XDATE_STR           VARCHAR2 (50);
   XCNT                NUMBER;
   XADD                NUMBER;
   XAGGREGATE_TABLE_NAME VARCHAR2(50);
   XDATE_MOUNTH_END DATE;
   XSUBPARTITION_SCRIPT VARCHAR2(4000);
   XPARTITION_VALUE VARCHAR2(1000);
   XBASE_NUMBER NUMBER;
   XPARTITION_COUNT NUMBER;
BEGIN
INSERT INTO NORTHI_USED_TABLES(TABLE_NAME) VALUES(XTABLE_NAME);COMMIT;
    /*
        XLEVEL:
                0 = HOURLY
                1 = DAILY
                7 = WEEKLY
               30 = MONTHLY
    */
    SELECT COUNT(*) INTO XPARTITION_COUNT FROM ALL_TAB_PARTITIONS WHERE TABLE_NAME = REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA';

   IF XPARTITION_COUNT=0 THEN
        XBASE_NUMBER:=0;
    ELSE
        SELECT  MAX(TO_NUMBER(SUBSTR(PARTITION_NAME,INSTR(PARTITION_NAME,'_',1,2)+1))) INTO XBASE_NUMBER
        FROM ALL_TAB_PARTITIONS
        WHERE TABLE_NAME=REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA' AND PARTITION_NAME!='TABLE_PARTITION_MAX';
    END IF;

   --XBASE_NUMBER:=XPARTITION_COUNT;
   IF XLEVEL=0 THEN
    XDATE := XSTART_DATE+1/24; --TO_DATE ('2008-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS');
   ELSE
    XDATE := XSTART_DATE; --TO_DATE ('2008-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS');
   END IF;
   XAGGREGATE_TABLE_NAME := XTABLE_NAME;  --'XBL_STATISTICS';
   XDATE_MOUNTH_END:=add_months(trunc(sysdate,'YEAR'),13);

        begin
             XSTATEMENT :=
                 'ALTER TABLE '
              || XAGGREGATE_TABLE_NAME
              || ' drop PARTITION TABLE_PARTITION_MAX';

           EXECUTE IMMEDIATE XSTATEMENT;
        exception
          when others then
            null;
        end;

        XCNT :=  XEND_DATE - XSTART_DATE;

        IF XLEVEL=0 THEN

            XCNT:=XCNT*24;
            XADD := 1/24;

        END IF;

        IF XLEVEL=1 THEN

            XCNT:=TRUNC(XCNT);
            XADD := 1;

        END IF;

        IF XLEVEL=7 THEN

            XCNT:= MONTHS_BETWEEN (XEND_DATE, XSTART_DATE);
            XADD := 1;

        END IF;

        IF XLEVEL=30 THEN

            XCNT:= MONTHS_BETWEEN (XEND_DATE, XSTART_DATE);
            XADD := 1;

        END IF;


         FOR XI IN 1 .. XCNT
         LOOP

            IF XLEVEL=7 OR XLEVEL=30 THEN
                XDATE := ADD_MONTHS (XDATE, XADD);
            ELSE
                XDATE := XDATE + XADD;
            END IF;

            XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER)||
            ' VALUES LESS THAN (TO_DATE('''|| TO_CHAR (XDATE, 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24'')) COMPRESS FOR OLTP STORAGE (INITIAL 64K NEXT 64K) ';
            --EXECUTE IMMEDIATE XSTATEMENT;
            XSUBPARTITION_SCRIPT:='';
            FOR XPARTITIONS IN
            (
                SELECT DISTINCT PARTITION_ID,PARTITION_NUMBER
                FROM NORTHI_PARTITION_TYPE
                WHERE PARTITION_ID IN
                (
                    SELECT PARTITION_ID
                    FROM NORTHI_LOADER_SETTINGS
                    WHERE TABLE_NAME=REPLACE(XORG_TABLE,'NORTHI_DATA.')
                )
                --AND( DTYPE!=0 )
            )
            LOOP

                   XPARTITION_VALUE:='';
                   FOR XPARTITION_VALUES IN
                   (
                     SELECT DTYPE
                     FROM NORTHI_PARTITION_TYPE
                     WHERE PARTITION_ID=XPARTITIONS.PARTITION_ID AND PARTITION_NUMBER=XPARTITIONS.PARTITION_NUMBER
                     AND DTYPE!=0
                   )
                   LOOP
                        XPARTITION_VALUE:=XPARTITION_VALUE||XPARTITION_VALUES.DTYPE||',';
                   END LOOP;
                   IF LENGTH (XPARTITION_VALUE)>0 THEN
                        XSUBPARTITION_SCRIPT:=XSUBPARTITION_SCRIPT||' SUBPARTITION P'|| TO_CHAR (XI+XBASE_NUMBER)||'_'||XPARTITIONS.PARTITION_NUMBER||
                        ' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA COMPRESS FOR OLTP   ,';
                   END IF;
            END LOOP;
            IF LENGTH(XSUBPARTITION_SCRIPT)>0 THEN
                    XSUBPARTITION_SCRIPT:='( '||SUBSTR(XSUBPARTITION_SCRIPT,1,LENGTH(XSUBPARTITION_SCRIPT)-1)||')';
            END IF;
            --INSERT INTO NORTHI_LOADER_ERROR_LOG(SQLTEXT) VALUES(XSTATEMENT);COMMIT;
            --dbms_output.put_line(CHR(13) || 'ADD_PARTITION -->' || CHR(13)||CHR(13)||XSTATEMENT||XSUBPARTITION_SCRIPT || CHR(13));
            EXECUTE IMMEDIATE XSTATEMENT||XSUBPARTITION_SCRIPT;
            INSERT INTO NORTHI_TABLE_PARTITION_LIST(TABLE_NAME,DATA_DATE,PARTITION_NAME,DATA_TYPE)
            VALUES(REPLACE(XTABLE_NAME,'NORTHI_DATA.'),XDATE,'TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER),XLEVEL);
            COMMIT;
         END LOOP;

        XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_MAX VALUES LESS THAN (MAXVALUE) ';
        EXECUTE IMMEDIATE XSTATEMENT;
END;
/
