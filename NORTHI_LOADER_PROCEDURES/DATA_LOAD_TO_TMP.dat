
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."DATA_LOAD_TO_TMP" (
    XTABLE_NAME  in  VARCHAR2 ) AS
   
XSTATEMENT1 VARCHAR(1000);
XSTATEMENT2 VARCHAR(1000);
XSTATEMENT3 VARCHAR(1000);
xsql        VARCHAR2 (1000);
 
 

 BEGIN
 

 
  
    /*FOR xtrunc_table IN (SELECT   parent_name
                          FROM   northi_loader_parents
                         WHERE   active = 1 AND table_name = 'CELLSTS_4G')
   LOOP
      EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_PARSER.' || xtrunc_table.parent_name;
       xsql :=
            'insert into NORTHI_PARSER.'
         || xtrunc_table.PARENT_NAME
         || ' (SELECT * FROM HIZIR2.'
         || xtrunc_table.PARENT_NAME
         || '
 WHERE DATA_DATE=TRUNC(SYSDATE,''HH24'')-3/24) )';
 
      EXECUTE IMMEDIATE xsql;


      COMMIT;

   END LOOP; */
     INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'DATA_LOAD_TO_TMP',XSTATEMENT1,'STARTED');commit;
  
    --NORTHI_LOADER.SQLLDR_TRACKING_ERDEM; 
   
  FOR 
 XLOG IN ( SELECT FRAGMENT_DATE , COUNT(*) FROM NORTHI_dATA.CELLSTS_4G WHERE FRAGMENT_DATE BETWEEN TRUNC(SYSDATE,'HH24')-17/24 AND TRUNC(SYSDATE,'HH24')-3/24
            GROUP BY FRAGMENT_dATE
       MINUS
           SELECT FRAGMENT_dATE, COUNT(*) FROM NORTHI_DATA.CELLSTS_4G_TMP WHERE  FRAGMENT_DATE BETWEEN TRUNC(SYSDATE,'HH24')-17/24 AND TRUNC(SYSDATE,'HH24')-3/24
            GROUP BY FRAGMENT_dATE  )
 LOOP
    IF  TO_CHAR(TRUNC(SYSDATE,'HH24'),'HH24') NOT IN ('05') AND 
        ( XLOG.FRAGMENT_DATE between TRUNC( SYSDATE-1 ) and  TRUNC( SYSDATE, 'HH24' ) - 4 / 24  )
    THEN
    
    XSTATEMENT1:='BEGIN DELETE /*+ PARALLEL(8) */  FROM NORTHI_DATA.'|| XTABLE_NAME|| '_TMP  WHERE  FRAGMENT_DATE=TO_DATE('''|| TO_CHAR (XLOG.FRAGMENT_DATE, 'dd.mm.yyyy hh24:MI')|| ''',''dd.mm.yyyy hh24:MI''); COMMIT; END;';
       EXECUTE IMMEDIATE XSTATEMENT1; 

        
              --INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'DATA_LOAD_TO_TMP',XSTATEMENT1,'DELETE');commit;
  
    XSTATEMENT2:=' BEGIN INSERT /*+ APPEND PARALLEL(8) */ INTO NORTHI_DATA.'||XTABLE_NAME|| '_TMP   (SELECT /*+ PARALLEL(8) */  * FROM NORTHI_DATA.'||XTABLE_NAME
          || ' WHERE FRAGMENT_DATE =TO_DATE('''|| TO_CHAR (XLOG.FRAGMENT_DATE, 'dd.mm.yyyy hh24:MI')|| ''',''dd.mm.yyyy hh24:MI'')); COMMIT; END;';
       EXECUTE IMMEDIATE XSTATEMENT2; 

              INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'DATA_LOAD_TO_TMP',XSTATEMENT2,'INSERT'); commit;

    ELSIF  TO_CHAR(TRUNC(SYSDATE,'HH24'),'HH24') NOT IN ('25') AND 
             XLOG.FRAGMENT_DATE IN( TRUNC( SYSDATE, 'HH24' ) - 3 / 24 )
    THEN
    
     NORTHI_LOADER.EP_BACKFILLDATA(XLOG.FRAGMENT_DATE);
    
    XSTATEMENT3:='BEGIN INSERT /*+ APPEND PARALLEL(8) */  INTO NORTHI_DATA.'|| XTABLE_NAME|| '_TMP   (SELECT /*+ PARALLEL(8) */  * FROM NORTHI_DATA.'||XTABLE_NAME
          || ' WHERE FRAGMENT_DATE=TO_DATE('''|| TO_CHAR (XLOG.FRAGMENT_DATE, 'dd.mm.yyyy hh24:MI')|| ''',''dd.mm.yyyy hh24:MI'')); COMMIT; END;';
      EXECUTE IMMEDIATE XSTATEMENT3; 
      
             INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'DATA_LOAD_TO_TMP',XSTATEMENT3,'ONLY_INSERT'); commit;

    
    --ELSIF TO_CHAR(TRUNC(SYSDATE,'HH24'),'HH24')  IN ('19' ) THEN 
    --XSTATEMENT1:='BEGIN DELETE /*+ APPEND PARALLEL(8) */  FROM NORTHI_DATA.'|| XTABLE_NAME|| '_TMP  WHERE  FRAGMENT_DATE BETWEEN TRUNC(SYSDATE-8) AND TRUNC(SYSDATE-8)+23/24; COMMIT; END;';
       --EXECUTE IMMEDIATE XSTATEMENT1; 


 
     END IF; 
    END LOOP;
      

      END;
/
