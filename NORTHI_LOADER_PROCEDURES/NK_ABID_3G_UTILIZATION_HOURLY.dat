
  CREATE OR REPLACE EDITIONABLE PROCEDURE "NORTHI_LOADER"."NK_ABID_3G_UTILIZATION_HOURLY" AS  
BEGIN

DELETE FROM /*+ PARALLEL */  NORTHI_DATA.NK_3G_UTILIZATION_HOURLY WHERE FRAGMENT_DATE = TRUNC(SYSDATE-1,'HH24')-3/24; COMMIT;

--------------------------------------------------------------------------------------
INSERT /*+ APPEND */  INTO NORTHI_DATA.NK_3G_UTILIZATION_HOURLY (CITY_NAME, DISTRICT_NAME,SUB_REGION_NAME, FRAGMENT_DATE, DTYPE, "3G_CONGESTION_DAILY", "3G_USER_THROUGHPUT_BH")

WITH DS_CMEX AS
(
SELECT /*+ MATERIALIZE  PARALLEL 8 */ CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT /*+ MATERIALIZE PARALLEL 8 */  CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
) ,

DS_LCELL AS
(
SELECT /*+ MATERIALIZE  PARALLEL 8 */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_DL_CODE_USED_MEAN) VS_DL_CODE_USED_MEAN
FROM NORTHI_DATA.LCELL_STATISTICS
WHERE DTYPE=1 AND  FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-3/24
GROUP BY NETWORK_ID, FRAGMENT_DATE
), 

DS_CELL AS
(
SELECT  /*+ MATERIALIZE  PARALLEL 8 */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_MEAN_TCP) VS_MEAN_TCP,
SUM(VS_HSDPA_UE_MEAN_CELL) VS_HSDPA_UE_MEAN_CELL,
SUM(VS_HSDPA_MEANCH_THRO) VS_HSDPA_MEANCH_THRO,
SUM(TRAF_HSDPA) TRAF_HSDPA,
SUM(VS_AMR_ERLANG_BEST_CELL) VS_AMR_ERLANG_BEST_CELL,
SUM(VSHSUPAUEMeanCell) VSHSUPAUEMeanCell,
SUM(TRAF_HSUPA) TRAF_HSUPA,
SUM(VQI_UL_BAD_PER_NUM) VQI_UL_BAD_PER_NUM,
SUM(VQI_UL_BAD_PER_DEN) VQI_UL_BAD_PER_DEN,
SUM(PS_UL_DATA) PS_UL_DATA,
SUM(PS_DL_DATA) PS_DL_DATA
FROM NORTHI_DATA.CELL_STATISTICS
WHERE DTYPE=1 AND FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-3/24
GROUP BY  NETWORK_ID, FRAGMENT_DATE
),

PRB_CELL AS
(
SELECT  /*+ PARALLEL 8 */  NETWORK_ID, FRAGMENT_DATE,
    GREATEST(DL_UTIL ,CODE_UTIL) CELL_UTIL,
    DL_UTIL ,CODE_UTIL, 
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
    FROM 
  (
SELECT  /*+ PARALLEL 16 */
    C.NETWORK_ID,C.FRAGMENT_DATE ,cell_name cell,
    ROW_NUMBER() OVER (PARTITION BY CELL_NAME ORDER BY VS_HSDPA_UE_MEAN_CELL DESC, VS_AMR_ERLANG_BEST_CELL DESC) RN,
    (POWER(10,(VS_MEAN_TCP)/10))*100/(0.7*POWER(10,(MAXTXPOWER)/100)) DL_UTIL,
    VS_DL_CODE_USED_MEAN/(0.7*256)*100 CODE_UTIL,
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO/2 VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL/2 VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
FROM DS_CMEX A, DS_LCELL B, DS_CELL C , NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE  A.CELLNAME=X.CELL_NAME AND B.NETWORK_ID=C.NETWORK_ID AND 
B.NETWORK_ID=X.CELL_ID AND B.FRAGMENT_DATE=C.FRAGMENT_DATE AND 
C.FRAGMENT_DATE = TRUNC(SYSDATE,'HH24')-3/24
)
)

SELECT /*+ PARALLEL (8) */  CITY_NAME, ILCE_NAME DISTRICT_NAME,'' SUB_REGION_NAME, A.FRAGMENT_DATE, 1 DTYPE, --ILCE
ROUND(SUM (CASE WHEN A.VS_HSDPA_UE_MEAN_CELL>0 THEN 
           (CASE WHEN (A.CELL_UTIL)>100 AND A.VS_HSDPA_UE_MEAN_CELL>10 AND (A.VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
     WHEN A.VS_HSDPA_UE_MEAN_CELL<=0 THEN
           (CASE WHEN (A.CELL_UTIL)>100 THEN 1 ELSE 0 END)
     ELSE 0 END)*100/COUNT(*),2)   "3G_CONGESTION_DAILY",   
ROUND(AVG(A.VS_HSDPA_MEANCH_THRO)/1000,2) "3G_USER_THROUGHPUT_BH"
FROM PRB_CELL  A, DS_CELL B, NORTHI_DATA.LIST_RNC_NODEB_CELL X 
WHERE 
A.NETWORK_ID = B.NETWORK_ID AND A.FRAGMENT_DATE = B.FRAGMENT_DATE AND 
A.NETWORK_ID=X.CELL_ID 
AND CITY_NAME <> 'null'
AND ILCE_NAME <> 'null'
GROUP BY CITY_NAME, ILCE_NAME, A.FRAGMENT_DATE
union all
SELECT /*+ PARALLEL (8) */  CITY_NAME, -- CITY 
'' DISTRICT_NAME,'' SUB_REGION_NAME,
A.FRAGMENT_DATE, 
2 DTYPE,
ROUND(SUM (CASE WHEN A.VS_HSDPA_UE_MEAN_CELL>0 THEN 
           (CASE WHEN (A.CELL_UTIL)>100 AND A.VS_HSDPA_UE_MEAN_CELL>10 AND (A.VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
     WHEN A.VS_HSDPA_UE_MEAN_CELL<=0 THEN
           (CASE WHEN (A.CELL_UTIL)>100 THEN 1 ELSE 0 END)
     ELSE 0 END)*100/COUNT(*),2)   "3G_CONGESTION_DAILY",   
ROUND(AVG(A.VS_HSDPA_MEANCH_THRO)/1000,2) "3G_USER_THROUGHPUT_BH"
FROM PRB_CELL  A, DS_CELL B, NORTHI_DATA.LIST_RNC_NODEB_CELL X 
WHERE 
A.NETWORK_ID = B.NETWORK_ID AND A.FRAGMENT_DATE = B.FRAGMENT_DATE AND 
A.NETWORK_ID=X.CELL_ID 
AND CITY_NAME <> 'null'
GROUP BY CITY_NAME,A.FRAGMENT_DATE
union all
SELECT /*+PARALLEL (8) */  TO_NCHAR ('NW') CITY_NAME, --NW
'' DISTRICT_NAME,'' SUB_REGION_NAME,
A.FRAGMENT_DATE FRAGMENT_DATE, 
3 DTYPE,
ROUND(SUM (CASE WHEN A.VS_HSDPA_UE_MEAN_CELL>0 THEN 
           (CASE WHEN (A.CELL_UTIL)>100 AND A.VS_HSDPA_UE_MEAN_CELL>10 AND (A.VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
     WHEN A.VS_HSDPA_UE_MEAN_CELL<=0 THEN
           (CASE WHEN (A.CELL_UTIL)>100 THEN 1 ELSE 0 END)
     ELSE 0 END)*100/COUNT(*),2)   "3G_CONGESTION_DAILY",   
ROUND(AVG(A.VS_HSDPA_MEANCH_THRO)/1000,2) "3G_USER_THROUGHPUT_BH"
FROM PRB_CELL  A, DS_CELL B, NORTHI_DATA.LIST_RNC_NODEB_CELL X 
WHERE 
A.NETWORK_ID = B.NETWORK_ID AND A.FRAGMENT_DATE = B.FRAGMENT_DATE AND
A.NETWORK_ID=X.CELL_ID 
GROUP BY A.FRAGMENT_DATE
union all
 SELECT /*+ PARALLEL (8) */   TO_NCHAR ('') CITY_NAME,'' DISTRICT_NAME, SUB_REGION_NAME,A.FRAGMENT_DATE, 4 DTYPE, --SUB_REGION_NAME
ROUND(SUM (CASE WHEN A.VS_HSDPA_UE_MEAN_CELL>0 THEN 
           (CASE WHEN (A.CELL_UTIL)>100 AND A.VS_HSDPA_UE_MEAN_CELL>10 AND (A.VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
     WHEN A.VS_HSDPA_UE_MEAN_CELL<=0 THEN
           (CASE WHEN (A.CELL_UTIL)>100 THEN 1 ELSE 0 END)
     ELSE 0 END)*100/COUNT(*),2)   "3G_CONGESTION_DAILY",   
ROUND(AVG(A.VS_HSDPA_MEANCH_THRO)/1000,2) "3G_USER_THROUGHPUT_BH"
FROM PRB_CELL  A, DS_CELL B, NORTHI_DATA.LIST_RNC_NODEB_CELL X 
WHERE 
A.NETWORK_ID = B.NETWORK_ID AND A.FRAGMENT_DATE = B.FRAGMENT_DATE AND 
A.NETWORK_ID=X.CELL_ID 
AND UPPER(SUB_REGION_NAME) <> 'NULL'
GROUP BY  sub_region_name, A.FRAGMENT_DATE;

COMMIT;


END;
/
