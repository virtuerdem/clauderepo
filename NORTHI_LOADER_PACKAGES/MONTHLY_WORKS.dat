
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."MONTHLY_WORKS" AS

/******************************************************************************

   NAME:       MONTHLY_WORKS

   PURPOSE:



   REVISIONS:

   Ver        Date        Author           Description

   ---------  ----------  ---------------  ------------------------------------

   1.0        12/25/2009             1. Created this package.

******************************************************************************/

  PROCEDURE INSERT_MBH_PROCESS(P_SYSTEM_ID NUMBER,XTABLE_NAME VARCHAR2,XDATA_DATE DATE )

  AS

  XCOUNT NUMBER;

  BEGIN

        SELECT COUNT(*) INTO XCOUNT  FROM NORTHI_MBH_PROCESS WHERE ORG_TABLE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

        IF XCOUNT=0 THEN

            INSERT INTO NORTHI_MBH_PROCESS(TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE,BH_PROCEDURE,PROCESS_COUNT)

            SELECT DISTINCT MA||A.TABLE_NAME,A.TABLE_NAME,XDATA_DATE,P_SYSTEM_ID,SYSDATE,SYSDATE,0,MA||A.TABLE_NAME||'_'||BH_ALIAS BH_PROCEDURE,1

            FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, (SELECT 'MBH5_' MA FROM DUAL UNION ALL SELECT'MBH7_' MA FROM DUAL ),  NORTHI_VENDOR_LIST C

            WHERE A.TABLE_NAME=B.TABLE_NAME AND A.VENDOR_ID=C.VENDOR_ID AND SYSTEM_ID=P_SYSTEM_ID

            AND A.TABLE_NAME=XTABLE_NAME AND A.TABLE_NAME!='CELLGPRS';

        ELSE 

            UPDATE NORTHI_MBH_PROCESS SET BH_STATE=0 ,START_DATE=SYSDATE, PROCESS_COUNT=PROCESS_COUNT+1

            WHERE (BH_PROCEDURE,DATA_DATE)IN 

            (

                SELECT DISTINCT MA||A.TABLE_NAME||'_'||BH_ALIAS  BH_PROCEDURE,XDATA_DATE

                FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, (SELECT 'MBH5_' MA FROM DUAL UNION ALL SELECT'MBH7_' MA FROM DUAL ) , NORTHI_VENDOR_LIST C

                WHERE A.TABLE_NAME=B.TABLE_NAME AND A.TABLE_NAME=B.TABLE_NAME AND SYSTEM_ID=P_SYSTEM_ID

                AND A.TABLE_NAME=XTABLE_NAME AND A.TABLE_NAME!='CELLGPRS' 

            );

        END IF;

        COMMIT;

  END;

  PROCEDURE BEGIN_MBH_TRANSFER(P_SYSTEM_ID NUMBER)

  AS

  XCOUNT NUMBER;

  XROW_COUNT NUMBER;

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XSYSTEM_ID NUMBER;

  BEGIN

  XSYSTEM_ID := P_SYSTEM_ID;

    FOR XMBH IN

    (

        SELECT  TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE, BH_PROCEDURE, PROCESS_COUNT,

        ROW_NUMBER() OVER (PARTITION BY TABLE_NAME,DATA_DATE ORDER BY PROCESS_COUNT) RN 

        FROM NORTHI_MBH_PROCESS 

        WHERE BH_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID

    )

    LOOP

        XTABLE_NAME:=XMBH.BH_PROCEDURE;

        XDATA_DATE:=XMBH.DATA_DATE;

        UPDATE NORTHI_MBH_PROCESS SET BH_STATE=1 ,START_DATE=SYSDATE, END_DATE=NULL  WHERE BH_PROCEDURE=XMBH.BH_PROCEDURE AND DATA_DATE=XMBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

        COMMIT;

        IF XMBH.PROCESS_COUNT>1 AND XMBH.RN=1 THEN

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XMBH.TABLE_NAME || ' WHERE FRAGMENT_DATE = TO_DATE('''||to_char(XMBH.DATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'') ';

        END IF;

        EXECUTE_PROCEDURE(XMBH.BH_PROCEDURE,XMBH.DATA_DATE,XMBH.START_DATE,XROW_COUNT,XSYSTEM_ID);

        UPDATE NORTHI_MBH_PROCESS SET BH_STATE=2 , END_DATE=SYSDATE WHERE BH_PROCEDURE=XMBH.BH_PROCEDURE AND DATA_DATE=XMBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

    END LOOP;

    COMMIT;

    

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_MBH_PROCESS SET BH_STATE=3 WHERE BH_PROCEDURE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END BEGIN_MBH_TRANSFER;

  PROCEDURE INSERT_MA_PROCESS(P_SYSTEM_ID NUMBER)

  AS 

  XEXISTS NUMBER;

  XCOUNT NUMBER;

  BEGIN

    FOR XMA IN

    (

        SELECT DISTINCT ORG_TABLE , ORG_TABLE||'_5MA' MA_TABLE,TRUNC(DATA_DATE,'MONTH') DATA_DATE FROM NORTHI_DAILY_PROCESS WHERE AGGREGATE_STATE=2 AND MONTHLY_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID AND TRUNC(DATA_DATE,'MONTH')!=TRUNC(SYSDATE,'MONTH') AND 

        (ORG_TABLE) IN

        (SELECT TABLE_NAME FROM NORTHI_LOADER_SETTINGS WHERE SYSTEM_ID=P_SYSTEM_ID AND ACTIVE=1 AND INSTR(DATE_AGGREGATE_TYPES,'''5MA''')>0 )

        UNION ALL

        SELECT DISTINCT ORG_TABLE , ORG_TABLE||'_7MA' MA_TABLE,TRUNC(DATA_DATE,'MONTH') DATA_DATE FROM NORTHI_DAILY_PROCESS WHERE AGGREGATE_STATE=2 AND MONTHLY_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID AND TRUNC(DATA_DATE,'MONTH')!=TRUNC(SYSDATE,'MONTH') AND 

        (ORG_TABLE) IN

        (SELECT TABLE_NAME FROM NORTHI_LOADER_SETTINGS WHERE SYSTEM_ID=P_SYSTEM_ID AND ACTIVE=1 AND INSTR(DATE_AGGREGATE_TYPES,'''7MA''')>0 )

    )

    LOOP

            INSERT_MBH_PROCESS(P_SYSTEM_ID,XMA.ORG_TABLE ,XMA.DATA_DATE );

            SELECT COUNT(*) INTO XEXISTS FROM NORTHI_MONTHLY_PROCESS WHERE TABLE_NAME=XMA.MA_TABLE AND DATA_DATE=XMA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID ;

            UPDATE NORTHI_DAILY_PROCESS SET MONTHLY_STATE=1 WHERE ORG_TABLE=XMA.ORG_TABLE AND TRUNC(DATA_DATE,'MONTH')=XMA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; 

             IF XEXISTS>0 THEN

                UPDATE NORTHI_MONTHLY_PROCESS 

                SET AGGREGATE_STATE=0 ,PROCESS_COUNT=PROCESS_COUNT+1 WHERE TABLE_NAME=XMA.MA_TABLE AND DATA_DATE=XMA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

                 

             ELSE 

                INSERT INTO NORTHI_MONTHLY_PROCESS(TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,ORG_TABLE,SYSTEM_ID) 

                VALUES(XMA.MA_TABLE,XMA.DATA_DATE,SYSDATE,0,SYSDATE,0,1,XMA.ORG_TABLE,P_SYSTEM_ID);

            END IF;    

    END LOOP;

    COMMIT;

  END INSERT_MA_PROCESS;

  

  PROCEDURE BEGIN_MA_TRANSFER(P_SYSTEM_ID NUMBER)

  AS 

  XEXISTS NUMBER;

  XCOUNT NUMBER;

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XAGGREGATE_DATE DATE;

  XROW_COUNT NUMBER;

  XSYSTEM_ID NUMBER;

  BEGIN

  XSYSTEM_ID :=P_SYSTEM_ID;

    FOR XMA IN

    (

        SELECT TABLE_NAME,DATA_DATE DATA_DATE,AGGREGATE_DATE,PROCESS_COUNT,ORG_TABLE FROM NORTHI_MONTHLY_PROCESS WHERE AGGREGATE_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID

    )

    LOOP 

     XTABLE_NAME:=XMA.TABLE_NAME;

     XDATA_DATE:=XMA.DATA_DATE;

     XAGGREGATE_DATE:=XMA.AGGREGATE_DATE;

            UPDATE NORTHI_MONTHLY_PROCESS SET AGGREGATE_STATE=1 , LOADER_DATE=SYSDATE , AGGREGATE_DATE=NULL  WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; 

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XTABLE_NAME || ' WHERE FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

            DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XTABLE_NAME AND FRAGMENT_DATE=TRUNC(XDATA_DATE);

            COMMIT;

            EXECUTE_PROCEDURE(XTABLE_NAME,XDATA_DATE,XAGGREGATE_DATE,XROW_COUNT,XSYSTEM_ID);

            UPDATE NORTHI_MONTHLY_PROCESS SET AGGREGATE_STATE=2 , AGGREGATE_DATE=SYSDATE  WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

            COMMIT;

    END LOOP;   

    COMMIT;

    BEGIN_MBH_TRANSFER(P_SYSTEM_ID);

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_MONTHLY_PROCESS SET AGGREGATE_STATE=3 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END BEGIN_MA_TRANSFER;

  

  

  PROCEDURE EXECUTE_MA_WORKS(P_SYSTEM_ID NUMBER)

  AS 

  XSYSTEM_NAME VARCHAR2(100);

  BEGIN

    SELECT SYSTEM_NAME INTO XSYSTEM_NAME FROM NORTHI_SYSTEM_LIST 

    WHERE SYSTEM_ID=P_SYSTEM_ID;

    XSYSTEM_NAME:='MA_'||XSYSTEM_NAME;

    DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

    DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    IF (LOADER_STATE.GET_STATE(XSYSTEM_NAME)=0) THEN

        LOADER_STATE.SET_START(XSYSTEM_NAME);

        INSERT_MA_PROCESS(P_SYSTEM_ID);

        BEGIN_MA_TRANSFER(P_SYSTEM_ID);

        BEGIN_MBH_TRANSFER(P_SYSTEM_ID);

        LOADER_STATE.SET_END(XSYSTEM_NAME);

    END IF;

  END EXECUTE_MA_WORKS;

  

END MONTHLY_WORKS;
/
