
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."BH_CREATION" AS
/******************************************************************************

   NAME:       
   PURPOSE: This package consists table and procedure creation procedures for STS and GPRS

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        6/24/2009  1.Vesile Taskiran  Use to create daily, weekly, monthly BH 
******************************************************************************/
PROCEDURE ADD_BH_TABLE_PARTITION(XTABLE_NAME VARCHAR2,XORG_TABLE VARCHAR2,XSTART_DATE DATE,XEND_DATE DATE,XLEVEL NUMBER)
IS

   XSTATEMENT CLOB;
   XPARTITION_SCRIPT   VARCHAR2 (2000);
   XDATE               DATE;
   XDATE_STR           VARCHAR2 (50);
   XCNT                NUMBER;
   XADD                NUMBER;
   XAGGREGATE_TABLE_NAME VARCHAR2(50);
   XDATE_MOUNTH_END DATE;
   XSUBPARTITION_SCRIPT VARCHAR2(4000);
   XPARTITION_VALUE VARCHAR2(1000);
   XBASE_NUMBER NUMBER;
   XPARTITION_COUNT NUMBER;
BEGIN

    /*
        XLEVEL:
                0 = HOURLY
                1 = DAILY
                7 = WEEKLY
               30 = MONTHLY
    */
    SELECT COUNT(*) INTO XPARTITION_COUNT FROM ALL_TAB_PARTITIONS WHERE TABLE_NAME = REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA';
    
    IF XPARTITION_COUNT=0 THEN 
        XBASE_NUMBER:=1;
    ELSE
        SELECT  MAX(TO_NUMBER(SUBSTR(PARTITION_NAME,INSTR(PARTITION_NAME,'_',1,2)+1))) INTO XBASE_NUMBER
        FROM ALL_TAB_PARTITIONS
        WHERE TABLE_NAME=REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA' AND PARTITION_NAME!='TABLE_PARTITION_MAX';
    END IF;

   XDATE := XSTART_DATE; --TO_DATE ('2008-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS');
   XAGGREGATE_TABLE_NAME := XTABLE_NAME;  --'XBL_STATISTICS';
   XDATE_MOUNTH_END:=TO_DATE ('2016-01-01', 'YYYY-MM-DD');
   
        begin
             XSTATEMENT :=
                 'ALTER TABLE '
              || XAGGREGATE_TABLE_NAME
              || ' drop PARTITION TABLE_PARTITION_MAX';

           EXECUTE IMMEDIATE XSTATEMENT;
        exception
          when others then
            null;
        end;    
  
        XCNT :=  XEND_DATE - XSTART_DATE;
        
        IF XLEVEL=0 THEN
        
            XCNT:=XCNT*24;
            XADD := 1/24;
            
        END IF;
        
        IF XLEVEL=1 THEN
        
            XCNT:=TRUNC(XCNT);
            XADD := 1;
            
        END IF;
        
        IF XLEVEL=7 THEN
        
            XCNT:= MONTHS_BETWEEN (XDATE_MOUNTH_END, XSTART_DATE);
            XADD := 1;
            
        END IF;
        
        IF XLEVEL=30 THEN
        
            XCNT:= MONTHS_BETWEEN (XDATE_MOUNTH_END, XSTART_DATE);
            XADD := 1;
            
        END IF;
        
        
         FOR XI IN 1 .. XCNT
         LOOP
            
            IF XLEVEL=7 OR XLEVEL=30 THEN
                XDATE := ADD_MONTHS (XDATE, XADD);
            ELSE
                XDATE := XDATE + XADD;
            END IF;
            
            XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER)|| 
            ' VALUES LESS THAN (TO_DATE('''|| TO_CHAR (XDATE, 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24'')) COMPRESS FOR OLTP STORAGE (INITIAL 64K NEXT 64K) ';
            --EXECUTE IMMEDIATE XSTATEMENT;
           XSUBPARTITION_SCRIPT:='';
            FOR XPARTITIONS IN
            (
                SELECT DISTINCT DATA_TYPE PARTITION_NUMBER
                FROM NORTHI_BH_SETTINGS
                WHERE TABLE_NAME=REPLACE(XORG_TABLE,'NORTHI_DATA.')
            )
            LOOP
            
               XPARTITION_VALUE:='';
               FOR XSUBPARTITION_VALUES IN
               (
                  SELECT BH_TYPE
                  FROM NORTHI_BH_SETTINGS
                  WHERE TABLE_NAME=REPLACE(XORG_TABLE,'NORTHI_DATA.')
                  AND DATA_TYPE=XPARTITIONS.PARTITION_NUMBER
               )
            LOOP
                    XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.BH_TYPE||',';
            END LOOP;
            IF LENGTH (XPARTITION_VALUE)>0 THEN
                        XSUBPARTITION_SCRIPT:=XSUBPARTITION_SCRIPT||' SUBPARTITION P'|| TO_CHAR (XI+XBASE_NUMBER)||'_'||XPARTITIONS.PARTITION_NUMBER||
                        ' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA  COMPRESS FOR OLTP,';
                   END IF; 
            END LOOP;
            IF LENGTH(XSUBPARTITION_SCRIPT)>0 THEN
                    XSUBPARTITION_SCRIPT:='( '||SUBSTR(XSUBPARTITION_SCRIPT,1,LENGTH(XSUBPARTITION_SCRIPT)-1)||')'; 
            END IF;
            EXECUTE IMMEDIATE XSTATEMENT||XSUBPARTITION_SCRIPT;
            INSERT INTO NORTHI_TABLE_PARTITION_LIST(TABLE_NAME,DATA_DATE,PARTITION_NAME,DATA_TYPE)
            VALUES(REPLACE(XTABLE_NAME,'NORTHI_DATA.'),XDATE,'TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER),XLEVEL);
            COMMIT;
         END LOOP;
         
        XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_MAX VALUES LESS THAN (MAXVALUE) ';
        EXECUTE IMMEDIATE XSTATEMENT;
END ADD_BH_TABLE_PARTITION;

PROCEDURE CREATE_DBH_TABLE(XTABLE_NAME VARCHAR2)
AS
XTABLE_EXISTS  NUMBER;
XTABLE_SCRIPT VARCHAR2(32000);
XSTATEMENT CLOB;
XPARTITION_VALUE VARCHAR2(2000);
XPARTITION_SCRIPT VARCHAR2(10000);
BEGIN
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = 'DBH_'||XTABLE_NAME AND OWNER='NORTHI_DATA';
    IF XTABLE_EXISTS>0 THEN
        FOR XMISSION IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME AND UPPER(LOCAL_FIELD) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME IN (
                    SELECT 'DBH_'||XTABLE_NAME
                    FROM DUAL 
            ) 
            AND OWNER='NORTHI_DATA'  
            )
        )
        LOOP
            IF XMISSION.DATA_TYPE='VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.DBH_'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF;
            IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.DBH_'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF; 
        END LOOP ;
    END IF;
    IF XTABLE_EXISTS=0 THEN
        FOR XFIELDS IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME 
        )
        LOOP
            IF XFIELDS.DATA_TYPE='VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
            END IF;
            IF XFIELDS.DATA_TYPE<>'VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||', ';
             END IF;
        END LOOP ;
        
        
        
        XPARTITION_SCRIPT:='';
        FOR XPARTITIONS IN
        (
            SELECT DISTINCT DATA_TYPE PARTITION_NUMBER
            FROM NORTHI_BH_SETTINGS
            WHERE TABLE_NAME=XTABLE_NAME
        )
        LOOP
            XPARTITION_VALUE:='';
           FOR XSUBPARTITION_VALUES IN
           (
              SELECT BH_TYPE
              FROM NORTHI_BH_SETTINGS
              WHERE TABLE_NAME=XTABLE_NAME
              AND DATA_TYPE=XPARTITIONS.PARTITION_NUMBER
           )
           LOOP
                XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.BH_TYPE||',';
           END LOOP;
           IF LENGTH(XPARTITION_VALUE)>0 THEN 
                XPARTITION_SCRIPT:=XPARTITION_SCRIPT||' SUBPARTITION P0_'||XPARTITIONS.PARTITION_NUMBER||' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA  COMPRESS FOR OLTP,';
           END IF;
        END LOOP;
        
        IF LENGTH(XTABLE_SCRIPT)>0 THEN
              XTABLE_SCRIPT:='CREATE TABLE NORTHI_DATA.DBH_'||XTABLE_NAME||' ( '||SUBSTR(XTABLE_SCRIPT,1,LENGTH(XTABLE_SCRIPT)-2)||',BH_TYPE NUMBER ) '
                             || ' TABLESPACE NORTHI_DATA   COMPRESS FOR OLTP PCTFREE  0 NOLOGGING  PARTITION BY RANGE(FRAGMENT_DATE) SUBPARTITION BY LIST(BH_TYPE) (' ||
                             ' PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('01/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
                             LOGGING 
                             TABLESPACE NORTHI_DATA  COMPRESS FOR OLTP
                             (
                                    '||SUBSTR(XPARTITION_SCRIPT,1,LENGTH(XPARTITION_SCRIPT)-1)||'
                             )
                             )';
            
              XSTATEMENT:=XTABLE_SCRIPT;
              EXECUTE IMMEDIATE XSTATEMENT;
              ADD_BH_TABLE_PARTITION('NORTHI_DATA.DBH_'||XTABLE_NAME,XTABLE_NAME,TO_DATE('01.01.2015 00','DD.MM.YYYY HH24'),TO_DATE('31.01.2015 23','DD.MM.YYYY HH24'),1);
              XSTATEMENT:='CREATE INDEX NORTHI_DATA.IDX_DBH_'||XTABLE_NAME||'_FN on NORTHI_DATA.DBH_'||XTABLE_NAME||' (FRAGMENT_DATE,NETWORK_ID) LOCAL PARALLEL 16 NOLOGGING';
              EXECUTE IMMEDIATE XSTATEMENT;
              XSTATEMENT:=' CREATE INDEX NORTHI_DATA.IDX_DBH_'||XTABLE_NAME||'_FD ON NORTHI_DATA.DBH_'||XTABLE_NAME||'(FRAGMENT_DATE) LOCAL';
              EXECUTE IMMEDIATE XSTATEMENT;
  
         END IF; 
    END IF;
END CREATE_DBH_TABLE;
PROCEDURE CREATE_WBH_TABLE(XTABLE_NAME VARCHAR2,FIVE_OR_SEVEN NUMBER)
AS
XTABLE_EXISTS  NUMBER;
XTABLE_SCRIPT VARCHAR2(32000);
XSTATEMENT CLOB;
XTABLE_NAME2 VARCHAR2(40);
XPARTITION_SCRIPT VARCHAR2(2000);
XPARTITION_VALUE VARCHAR2(2000);
BEGIN
    IF FIVE_OR_SEVEN=5 THEN
        XTABLE_NAME2:='WBH5_';
    ELSE 
        XTABLE_NAME2:='WBH7_';
    END IF;
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XTABLE_NAME2||XTABLE_NAME AND OWNER='NORTHI_DATA';
    IF XTABLE_EXISTS>0 THEN
        FOR XMISSION IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME AND UPPER(LOCAL_FIELD) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME IN (
                    SELECT XTABLE_NAME2||XTABLE_NAME
                    FROM DUAL 
            ) 
            AND OWNER='NORTHI_DATA'  
            )
        )
        LOOP
            IF XMISSION.DATA_TYPE='VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF;
            IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF; 
        END LOOP ;
    END IF;
    IF XTABLE_EXISTS=0 THEN
        FOR XFIELDS IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME AND UPPER(LOCAL_FIELD) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME IN (
                    SELECT XTABLE_NAME2||XTABLE_NAME
                    FROM DUAL 
            ) 
            AND OWNER='NORTHI_DATA'  
            )
        )
        LOOP
            IF XFIELDS.DATA_TYPE='VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
            END IF;
            IF XFIELDS.DATA_TYPE<>'VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||', ';
             END IF;
        END LOOP ;
       
        XPARTITION_SCRIPT:='';
        FOR XPARTITIONS IN
        (
            SELECT DISTINCT DATA_TYPE PARTITION_NUMBER
            FROM NORTHI_BH_SETTINGS
            WHERE TABLE_NAME=XTABLE_NAME
        )
        LOOP
            XPARTITION_VALUE:='';
           FOR XSUBPARTITION_VALUES IN
           (
              SELECT BH_TYPE
              FROM NORTHI_BH_SETTINGS
              WHERE TABLE_NAME=XTABLE_NAME
              AND DATA_TYPE=XPARTITIONS.PARTITION_NUMBER
           )
           LOOP
                XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.BH_TYPE||',';
           END LOOP;
           IF LENGTH(XPARTITION_VALUE)>0 THEN 
                XPARTITION_SCRIPT:=XPARTITION_SCRIPT||' SUBPARTITION P0_'||XPARTITIONS.PARTITION_NUMBER||' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA,';
           END IF;
        END LOOP;
        
        IF LENGTH(XTABLE_SCRIPT)>0 THEN
              XTABLE_SCRIPT:='CREATE TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ( '||SUBSTR(XTABLE_SCRIPT,1,LENGTH(XTABLE_SCRIPT)-2)||',BH_TYPE NUMBER,BHOUR NUMBER ) '
                             || ' TABLESPACE NORTHI_DATA PCTFREE  0 NOLOGGING  PARTITION BY RANGE(FRAGMENT_DATE) SUBPARTITION BY LIST(BH_TYPE) (' ||
                             ' PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('01/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
                             LOGGING 
                             TABLESPACE NORTHI_DATA
                             (
                                    '||SUBSTR(XPARTITION_SCRIPT,1,LENGTH(XPARTITION_SCRIPT)-1)||'
                             )
                             )';
            
              XSTATEMENT:=XTABLE_SCRIPT;
              EXECUTE IMMEDIATE XSTATEMENT;
              ADD_BH_TABLE_PARTITION('NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME,XTABLE_NAME,TO_DATE('01.01.2015 00','DD.MM.YYYY HH24'),TO_DATE('31.01.2015 23','DD.MM.YYYY HH24'),7);
              XSTATEMENT:='CREATE INDEX NORTHI_DATA.IDX_'||XTABLE_NAME2||XTABLE_NAME||'_FN on NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' (FRAGMENT_DATE,NETWORK_ID) LOCAL PARALLEL 16 NOLOGGING';
              EXECUTE IMMEDIATE XSTATEMENT;
              XSTATEMENT:=' CREATE INDEX NORTHI_DATA.IDX_'||XTABLE_NAME2||XTABLE_NAME||'_FD ON NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||'(FRAGMENT_DATE) LOCAL';
              EXECUTE IMMEDIATE XSTATEMENT;
  
         END IF; 
          
    END IF;
END CREATE_WBH_TABLE;

PROCEDURE CREATE_MBH_TABLE(XTABLE_NAME VARCHAR2,FIVE_OR_SEVEN NUMBER)
AS
XTABLE_EXISTS  NUMBER;
XTABLE_SCRIPT VARCHAR2(32000);
XSTATEMENT CLOB;
XTABLE_NAME2 VARCHAR2(40);
XPARTITION_SCRIPT VARCHAR2(2000);
XPARTITION_VALUE VARCHAR2(2000);
BEGIN
    IF FIVE_OR_SEVEN=5 THEN
        XTABLE_NAME2:='MBH5_';
    ELSE 
        XTABLE_NAME2:='MBH7_';
    END IF;
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XTABLE_NAME2||XTABLE_NAME AND OWNER='NORTHI_DATA';
    IF XTABLE_EXISTS>0 THEN
        FOR XMISSION IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME AND UPPER(LOCAL_FIELD) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME IN (
                    SELECT XTABLE_NAME2||XTABLE_NAME
                    FROM DUAL 
            ) 
            AND OWNER='NORTHI_DATA'  
            )
        )
        LOOP
            IF XMISSION.DATA_TYPE='VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF;
            IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
                XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                EXECUTE IMMEDIATE XSTATEMENT;
            END IF; 
        END LOOP ;
    END IF;
    IF XTABLE_EXISTS=0 THEN
        FOR XFIELDS IN 
        (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE 
            TABLE_NAME=XTABLE_NAME AND UPPER(LOCAL_FIELD) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME IN (
                    SELECT XTABLE_NAME2||XTABLE_NAME
                    FROM DUAL 
            ) 
            AND OWNER='NORTHI_DATA'  
            )
        )
        LOOP
            IF XFIELDS.DATA_TYPE='VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
            END IF;
            IF XFIELDS.DATA_TYPE<>'VARCHAR2' THEN
                XTABLE_SCRIPT:=XTABLE_SCRIPT||XFIELDS.COLUMN_NAME||' '||XFIELDS.DATA_TYPE||', ';
             END IF;
        END LOOP ;
       
        XPARTITION_SCRIPT:='';
        FOR XPARTITIONS IN
        (
            SELECT DISTINCT DATA_TYPE PARTITION_NUMBER
            FROM NORTHI_BH_SETTINGS
            WHERE TABLE_NAME=XTABLE_NAME
        )
        LOOP
            XPARTITION_VALUE:='';
           FOR XSUBPARTITION_VALUES IN
           (
              SELECT BH_TYPE
              FROM NORTHI_BH_SETTINGS
              WHERE TABLE_NAME=XTABLE_NAME
              AND DATA_TYPE=XPARTITIONS.PARTITION_NUMBER
           )
           LOOP
                XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.BH_TYPE||',';
           END LOOP;
           IF LENGTH(XPARTITION_VALUE)>0 THEN 
                XPARTITION_SCRIPT:=XPARTITION_SCRIPT||' SUBPARTITION P0_'||XPARTITIONS.PARTITION_NUMBER||' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA,';
           END IF;
        END LOOP;
        
        IF LENGTH(XTABLE_SCRIPT)>0 THEN
              XTABLE_SCRIPT:='CREATE TABLE NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' ( '||SUBSTR(XTABLE_SCRIPT,1,LENGTH(XTABLE_SCRIPT)-2)||',BH_TYPE NUMBER,BHOUR NUMBER ) '
                             || ' TABLESPACE NORTHI_DATA PCTFREE  0 NOLOGGING  PARTITION BY RANGE(FRAGMENT_DATE) SUBPARTITION BY LIST(BH_TYPE) (' ||
                             ' PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('01/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
                             LOGGING 
                             TABLESPACE NORTHI_DATA
                             (
                                    '||SUBSTR(XPARTITION_SCRIPT,1,LENGTH(XPARTITION_SCRIPT)-1)||'
                             )
                             )';
            
              XSTATEMENT:=XTABLE_SCRIPT;
              EXECUTE IMMEDIATE XSTATEMENT;
              ADD_BH_TABLE_PARTITION('NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME,XTABLE_NAME,TO_DATE('01.01.2015 00','DD.MM.YYYY HH24'),TO_DATE('31.01.2015 23','DD.MM.YYYY HH24'),30);
              XSTATEMENT:='CREATE INDEX NORTHI_DATA.IDX_'||XTABLE_NAME2||XTABLE_NAME||'_FN on NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||' (FRAGMENT_DATE,NETWORK_ID) LOCAL PARALLEL 16 NOLOGGING';
              EXECUTE IMMEDIATE XSTATEMENT;
              XSTATEMENT:=' CREATE INDEX NORTHI_DATA.IDX_'||XTABLE_NAME2||XTABLE_NAME||'_FD ON NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||'(FRAGMENT_DATE) LOCAL';
              EXECUTE IMMEDIATE XSTATEMENT;
  
         END IF; 
          
    END IF;
END CREATE_MBH_TABLE;

PROCEDURE CREATE_DBH_PROCEDURE(XTABLE_NAME VARCHAR2)
AS
XSELECT_FIELDS VARCHAR2(32000);
XAGG_FIELDS VARCHAR2(32000);
XTABLES VARCHAR2(400);
XWHERE VARCHAR2(1000);
XSTATEMENT CLOB;
XDECODE_STR VARCHAR2(1000);
XDTYPE NUMBER;
XFROM_TABLE VARCHAR2(100);--TMP TABLOLAR ICIN EKLENDI.

BEGIN
    LOADER_CREATION.GET_BH_FIELDS(XTABLE_NAME,'NULL',XSELECT_FIELDS);
    LOADER_CREATION.GET_BH_FIELDS(XTABLE_NAME,'A1',XAGG_FIELDS);
    XFROM_TABLE:=XTABLE_NAME;

    
    FOR XTYPES IN
    (
         SELECT DISTINCT BH_COUNTER,BH_ALIAS FROM NORTHI_BH_SETTINGS WHERE TABLE_NAME=XTABLE_NAME
         
    )
    LOOP
        XSTATEMENT:= ' CREATE OR REPLACE PROCEDURE P_DBH_'||XTABLE_NAME||'_'||XTYPES.BH_ALIAS ||' (XDATA_DATE IN DATE) AS
        BEGIN 
        INSERT /*+ APPEND */ INTO NORTHI_DATA.DBH_'||XTABLE_NAME||' E ('||XSELECT_FIELDS||'NETWORK_ID,FRAGMENT_DATE,BH_TYPE)';
        
             XDECODE_STR:='';
             FOR XDECODE IN
             (
                SELECT DISTINCT PARTITION_VALUE,BH_TYPE,DTYPE FROM NORTHI_PARTITION_TYPE A,NORTHI_LOADER_SETTINGS B,NORTHI_BH_SETTINGS C
                WHERE A.PARTITION_ID=B.PARTITION_ID AND C.TABLE_NAME=XTABLE_NAME    
                AND B.TABLE_NAME=C.TABLE_NAME AND A.PARTITION_VALUE=C.DATA_TYPE
                AND C.BH_COUNTER=XTYPES.BH_COUNTER
             )
             LOOP
                XDECODE_STR:=XDECODE_STR||TO_CHAR(XDECODE.DTYPE)||','||TO_CHAR(XDECODE.BH_TYPE)||',';
                XDTYPE:=XDECODE.DTYPE;
             END LOOP;
             
             IF XTABLE_NAME IN ('CELLSTS_4G') THEN 
                XFROM_TABLE:=XTABLE_NAME||'_TMP';
             END IF; 
                       
             
             IF XDTYPE>0 THEN
                XDECODE_STR:='DECODE(A1.DTYPE,'||SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1)||')';
                XSTATEMENT:=XSTATEMENT || ' '||
            ' SELECT /*+ PARALLEL(16) */'||XAGG_FIELDS||'
             A1.NETWORK_ID, A1.FRAGMENT_DATE,'||XDECODE_STR||' TYPE 
              FROM NORTHI_DATA.'||XFROM_TABLE|| ' A1,
              (
                        SELECT /*+ PARALLEL(16) */ NETWORK_ID,DTYPE,MAX(FRAGMENT_DATE) 
                        KEEP (DENSE_RANK LAST ORDER BY '||XTYPES.BH_COUNTER||') FRAGMENT_DATE 
                        FROM NORTHI_DATA.'||XFROM_TABLE||' 
                        WHERE '||XWHERE||'  FRAGMENT_DATE BETWEEN XDATA_DATE AND  XDATA_DATE + 23 / 24
                        GROUP BY NETWORK_ID,DTYPE
                      ) X 
              WHERE '||XWHERE||' A1.NETWORK_ID=X.NETWORK_ID AND A1.DTYPE=X.DTYPE AND  
                     A1.FRAGMENT_DATE=X.FRAGMENT_DATE AND  A1.FRAGMENT_DATE BETWEEN XDATA_DATE AND XDATA_DATE+23/24; COMMIT; END;';
             ELSE 
                XDECODE_STR:=REPLACE(SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1),'0,','');
                XSTATEMENT:=XSTATEMENT || ' '||
            ' SELECT /*+ PARALLEL(16) */ '||XAGG_FIELDS||'
             A1.NETWORK_ID, A1.FRAGMENT_DATE,'||XDECODE_STR||' TYPE 
              FROM NORTHI_DATA.'||XFROM_TABLE|| ' A1,
              (
                        SELECT /*+ PARALLEL(16) */ NETWORK_ID,MAX(FRAGMENT_DATE) 
                        KEEP (DENSE_RANK LAST ORDER BY '||XTYPES.BH_COUNTER||') FRAGMENT_DATE 
                        FROM NORTHI_DATA.'||XFROM_TABLE||' 
                        WHERE '||XWHERE||'  FRAGMENT_DATE BETWEEN XDATA_DATE AND  XDATA_DATE + 23 / 24
                        GROUP BY NETWORK_ID
                      ) X 
              WHERE '||XWHERE||' A1.NETWORK_ID=X.NETWORK_ID AND  
                     A1.FRAGMENT_DATE=X.FRAGMENT_DATE AND  A1.FRAGMENT_DATE BETWEEN XDATA_DATE AND XDATA_DATE+23/24; COMMIT; END;';
             END IF;
             
            EXECUTE IMMEDIATE XSTATEMENT;
    END LOOP; 
    
END CREATE_DBH_PROCEDURE;

PROCEDURE CREATE_WBH_PROCEDURE(XTABLE_NAME VARCHAR2,FIVE_OR_SEVEN NUMBER)
AS
    XSELECT_FIELDS  VARCHAR2(32000);
    XAGG_FIELDS     VARCHAR2(32000);
    XTABLES         VARCHAR2(400);
    XWHERE          VARCHAR2(1000);
    XSTATEMENT      CLOB;
    XTABLE_NAME2    VARCHAR2(40);
    XDECODE_STR     VARCHAR2(1000);
    XDTYPE          NUMBER;
    XAGG_FIELDS2    VARCHAR2(1000);
    XFROM_CLAUSE VARCHAR2(4000);
    V_ERROR_CODE    NUMBER;
    V_ERROR         VARCHAR(4000);
    V_STATE         VARCHAR2(100);
BEGIN
    IF FIVE_OR_SEVEN=5 THEN
        XTABLE_NAME2:='WBH5_';
    ELSE 
        XTABLE_NAME2:='WBH7_';
    END IF;
V_STATE := '1';
    LOADER_CREATION.GET_BH_FIELDS(XTABLE_NAME,'NULL',XSELECT_FIELDS);
V_STATE := '2';
    LOADER_CREATION.GET_BH_AGGREGATE_FIELDS(XTABLE_NAME,XAGG_FIELDS,XAGG_FIELDS2);
V_STATE := '3';
    FOR XTYPES IN
    (
         SELECT DISTINCT BH_COUNTER,BH_ALIAS FROM NORTHI_BH_SETTINGS WHERE TABLE_NAME=XTABLE_NAME
         
    )
    LOOP
V_STATE := '4';
        XDECODE_STR:='';
        XSTATEMENT:= ' CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME2||XTABLE_NAME||'_'||XTYPES.BH_ALIAS ||'(XDATA_DATE IN DATE) AS
        BEGIN 
        INSERT /*+ APPEND */ INTO NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||'('||XSELECT_FIELDS||' FRAGMENT_DATE,NETWORK_ID,BHOUR,BH_TYPE)';
        
         FOR XDECODE IN
         (
            SELECT DISTINCT PARTITION_VALUE,BH_TYPE,DTYPE FROM NORTHI_PARTITION_TYPE A,NORTHI_LOADER_SETTINGS B,NORTHI_BH_SETTINGS C
            WHERE A.PARTITION_ID=B.PARTITION_ID AND C.TABLE_NAME=XTABLE_NAME    
            AND B.TABLE_NAME=C.TABLE_NAME AND A.PARTITION_VALUE=C.DATA_TYPE
            AND C.BH_COUNTER=XTYPES.BH_COUNTER
         )
         LOOP
V_STATE := '5';
            XDECODE_STR:=XDECODE_STR||TO_CHAR(XDECODE.DTYPE)||','||TO_CHAR(XDECODE.BH_TYPE)||',';
            XDTYPE:=XDECODE.DTYPE;
         END LOOP;
         IF XDTYPE>0 THEN
V_STATE := '6';
            XDECODE_STR:='DECODE(DTYPE,'||SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1)||')';
         ELSE
V_STATE := '7'; 
            XDECODE_STR:=REPLACE(SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1),'0,','');
         END IF;
V_STATE := '8';

          IF XTABLE_NAME IN ('CELLSTS_4G') THEN
           XFROM_CLAUSE:= XTABLE_NAME||'_TMP ';


          ELSE XFROM_CLAUSE:= XTABLE_NAME;
          END IF; 
        
        XSTATEMENT:=XSTATEMENT || ' '||
        ' SELECT /*+ PARALLEL(16) */ '||XAGG_FIELDS||',TRUNC(A1.FRAGMENT_DATE,''DAY'') FRAGMENT_DATE,A1.NETWORK_ID,BHOUR,'||XDECODE_STR||' TYPE  
        FROM NORTHI_DATA.' ||XFROM_CLAUSE||' A1,'
        ||'( SELECT /*+ PARALLEL(16) */ NETWORK_ID,
        MAX(BHOUR) KEEP (DENSE_RANK LAST ORDER BY BH_COUNTER) BHOUR 
        FROM 
        (
        SELECT /*+ PARALLEL(16) */  A1.NETWORK_ID,
                         SUM('||XTYPES.BH_COUNTER||') BH_COUNTER,
                         TO_CHAR(A1.FRAGMENT_DATE,''HH24'') BHOUR
                        FROM  NORTHI_DATA.'||XFROM_CLAUSE||' A1
                        WHERE '||XWHERE ||'
                                A1.FRAGMENT_DATE BETWEEN TRUNC(XDATA_DATE,''DAY'')
                                                         AND  (TRUNC(XDATA_DATE,''DAY'')+'||TO_CHAR(FIVE_OR_SEVEN-1)||') + 23 / 24 
                         GROUP BY   A1.NETWORK_ID, TO_CHAR(A1.FRAGMENT_DATE,''HH24'')
        )
        GROUP BY NETWORK_ID ) X 
        WHERE '||XWHERE ||' TO_CHAR(A1.FRAGMENT_DATE,''HH24'')=X.BHOUR AND A1.NETWORK_ID=X.NETWORK_ID 
                            AND A1.FRAGMENT_DATE BETWEEN TRUNC(XDATA_DATE,''DAY'')
                                                         AND ( TRUNC(XDATA_DATE,''DAY'')+'||TO_CHAR(FIVE_OR_SEVEN-1)||') + 23 / 24 
        GROUP BY TRUNC(A1.FRAGMENT_DATE,''DAY'') , A1.NETWORK_ID,BHOUR ,'||XDECODE_STR||XAGG_FIELDS2||
        ';COMMIT; END;';
        EXECUTE IMMEDIATE XSTATEMENT;
    END LOOP;

EXCEPTION
    WHEN OTHERS THEN
        V_ERROR         :=SQLERRM;
        V_ERROR_CODE    :=SQLCODE;
        INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
        VALUES (USER,XTABLE_NAME,V_ERROR_CODE,V_ERROR,SYSDATE,'CREATE_WBH_PROCEDURE_FIVE_OR_SEVEN:' || TO_CHAR(FIVE_OR_SEVEN),XSTATEMENT);
        RAISE;
END CREATE_WBH_PROCEDURE;
PROCEDURE CREATE_MBH_PROCEDURE(XTABLE_NAME VARCHAR2,FIVE_OR_SEVEN NUMBER)
AS
XSELECT_FIELDS VARCHAR2(32000);
XAGG_FIELDS VARCHAR2(32000);
XTABLES VARCHAR2(400);
XWHERE VARCHAR2(1000);
XSTATEMENT CLOB;
XTABLE_NAME2 VARCHAR2(40);
XDECODE_STR VARCHAR2(1000);
XDTYPE NUMBER;
X5OR7 VARCHAR2(500);
XAGG_FIELDS2 VARCHAR2(1000);
BEGIN
    IF FIVE_OR_SEVEN=5 THEN
        XTABLE_NAME2:='MBH5_';
        X5OR7:='AND  (TO_CHAR(A1.FRAGMENT_DATE,''DY'') NOT IN (''SAT'',''SUN''))';
    ELSE 
        XTABLE_NAME2:='MBH7_';
        X5OR7:='';
    END IF;
    LOADER_CREATION.GET_BH_FIELDS(XTABLE_NAME,'NULL',XSELECT_FIELDS);
    LOADER_CREATION.GET_BH_AGGREGATE_FIELDS(XTABLE_NAME,XAGG_FIELDS,XAGG_FIELDS2);
    FOR XTYPES IN
    (
         SELECT DISTINCT BH_COUNTER,BH_ALIAS FROM NORTHI_BH_SETTINGS WHERE TABLE_NAME=XTABLE_NAME
         
    )
    LOOP
        XDECODE_STR:='';
        XSTATEMENT:= ' CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME2||XTABLE_NAME||'_'||XTYPES.BH_ALIAS ||'(XDATA_DATE IN DATE) AS
        BEGIN 
        INSERT /*+ APPEND */ INTO NORTHI_DATA.'||XTABLE_NAME2||XTABLE_NAME||'('||XSELECT_FIELDS||' FRAGMENT_DATE,NETWORK_ID,BHOUR,BH_TYPE)';
        
         FOR XDECODE IN
         (
            SELECT DISTINCT PARTITION_VALUE,BH_TYPE,DTYPE FROM NORTHI_PARTITION_TYPE A,NORTHI_LOADER_SETTINGS B,NORTHI_BH_SETTINGS C
            WHERE A.PARTITION_ID=B.PARTITION_ID AND C.TABLE_NAME=XTABLE_NAME    
            AND B.TABLE_NAME=C.TABLE_NAME AND A.PARTITION_VALUE=C.DATA_TYPE
            AND C.BH_COUNTER=XTYPES.BH_COUNTER
         )
         LOOP
            XDECODE_STR:=XDECODE_STR||TO_CHAR(XDECODE.DTYPE)||','||TO_CHAR(XDECODE.BH_TYPE)||',';
            XDTYPE:=XDECODE.DTYPE;
         END LOOP;
         IF XDTYPE>0 THEN
            XDECODE_STR:='DECODE(DTYPE,'||SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1)||')';
         ELSE 
            XDECODE_STR:=REPLACE(SUBSTR(XDECODE_STR,1,LENGTH(XDECODE_STR)-1),'0,','');
         END IF;
        
        XSTATEMENT:=XSTATEMENT || ' '||
        ' SELECT /*+ PARALLEL(16) */ '||XAGG_FIELDS||',TRUNC(A1.FRAGMENT_DATE,''MONTH'') FRAGMENT_DATE,A1.NETWORK_ID,BHOUR,'||XDECODE_STR||' TYPE  
        FROM NORTHI_DATA.' ||XTABLE_NAME||' A1,'
        ||'( SELECT /*+ PARALLEL(16) */ NETWORK_ID,
        MAX(BHOUR) KEEP (DENSE_RANK LAST ORDER BY BH_COUNTER) BHOUR 
        FROM 
        (
        SELECT /*+ PARALLEL(16) */  A1.NETWORK_ID,
                         SUM('||XTYPES.BH_COUNTER||') BH_COUNTER,
                         TO_CHAR(A1.FRAGMENT_DATE,''HH24'') BHOUR
                        FROM  NORTHI_DATA.'||XTABLE_NAME||' A1
                        WHERE '||XWHERE ||'
                                A1.FRAGMENT_DATE BETWEEN TRUNC(XDATA_DATE,''MONTH'')
                                                         AND  (ADD_MONTHS(TRUNC(XDATA_DATE,''MONTH''),1)-1/24) '||X5OR7|| ' 
                         GROUP BY   A1.NETWORK_ID, TO_CHAR(A1.FRAGMENT_DATE,''HH24'')
        )
        GROUP BY NETWORK_ID ) X 
        WHERE '||XWHERE ||' TO_CHAR(A1.FRAGMENT_DATE,''HH24'')=X.BHOUR AND A1.NETWORK_ID=X.NETWORK_ID 
                           AND A1.FRAGMENT_DATE BETWEEN TRUNC(XDATA_DATE,''MONTH'')
                                                         AND  (ADD_MONTHS(TRUNC(XDATA_DATE,''MONTH''),1)-1/24)'||X5OR7|| '   
        GROUP BY TRUNC(A1.FRAGMENT_DATE,''MONTH'') , A1.NETWORK_ID,BHOUR ,'||XDECODE_STR||XAGG_FIELDS2||
        ';COMMIT; END;';
        EXECUTE IMMEDIATE XSTATEMENT;
    END LOOP;  
END CREATE_MBH_PROCEDURE;    
END BH_CREATION;
/
