
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."WEEKLY_WORKS" AS



  PROCEDURE INSERT_WBH_PROCESS(P_SYSTEM_ID NUMBER,XTABLE_NAME VARCHAR2,XDATA_DATE DATE)

  AS

  XCOUNT NUMBER;

  BEGIN

        SELECT COUNT(*) INTO XCOUNT  FROM NORTHI_WBH_PROCESS WHERE ORG_TABLE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

        IF XCOUNT=0 THEN

            INSERT INTO NORTHI_WBH_PROCESS(TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE,BH_PROCEDURE,PROCESS_COUNT)

            SELECT DISTINCT WA||A.TABLE_NAME,A.TABLE_NAME,XDATA_DATE,P_SYSTEM_ID,SYSDATE,SYSDATE,0,WA||A.TABLE_NAME||'_'||BH_ALIAS BH_PROCEDURE,1

            FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, (SELECT 'WBH5_' WA FROM DUAL UNION ALL SELECT'WBH7_' WA FROM DUAL ), NORTHI_VENDOR_LIST C

            WHERE A.VENDOR_ID=C.VENDOR_ID AND A.TABLE_NAME=B.TABLE_NAME AND C.SYSTEM_ID=P_SYSTEM_ID

            AND A.TABLE_NAME=XTABLE_NAME;

        ELSE 

            UPDATE NORTHI_WBH_PROCESS SET BH_STATE=0 ,START_DATE=SYSDATE, PROCESS_COUNT=PROCESS_COUNT+1

            WHERE (BH_PROCEDURE,DATA_DATE)IN 

            (

                SELECT DISTINCT WA||A.TABLE_NAME||'_'||BH_ALIAS  BH_PROCEDURE,XDATA_DATE

                FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, (SELECT 'WBH5_' WA FROM DUAL UNION ALL SELECT'WBH7_' WA FROM DUAL ), NORTHI_VENDOR_LIST C

                WHERE A.VENDOR_ID=C.SYSTEM_ID AND A.TABLE_NAME=B.TABLE_NAME AND C.SYSTEM_ID=P_SYSTEM_ID

                AND A.TABLE_NAME=XTABLE_NAME    

            );

        END IF;

        COMMIT;

  END;

  PROCEDURE BEGIN_WBH_TRANSFER(P_SYSTEM_ID NUMBER)

  AS

  XCOUNT NUMBER;

  XROW_COUNT NUMBER;

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XSYSTEM NUMBER;

  BEGIN

  XSYSTEM := P_SYSTEM_ID;

   DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

   DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    FOR XWBH IN

    (

        SELECT  TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE, BH_PROCEDURE, PROCESS_COUNT,

        ROW_NUMBER() OVER (PARTITION BY TABLE_NAME,DATA_DATE ORDER BY PROCESS_COUNT) RN 

        FROM NORTHI_WBH_PROCESS 

        WHERE BH_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID

    )

    LOOP

        XTABLE_NAME:=XWBH.BH_PROCEDURE;

        XDATA_DATE:=XWBH.DATA_DATE;

        UPDATE NORTHI_WBH_PROCESS SET BH_STATE=1,  START_DATE=SYSDATE, END_DATE=NULL WHERE BH_PROCEDURE=XWBH.BH_PROCEDURE AND DATA_DATE=XWBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

        COMMIT;

        IF XWBH.PROCESS_COUNT>1 AND XWBH.RN=1 THEN

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XWBH.TABLE_NAME || ' WHERE FRAGMENT_DATE = TO_DATE('''||to_char(XWBH.DATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'') ';

        END IF;

        EXECUTE_PROCEDURE(XWBH.BH_PROCEDURE,XWBH.DATA_DATE,XWBH.START_DATE,XROW_COUNT,XSYSTEM);

        UPDATE NORTHI_WBH_PROCESS SET BH_STATE=2 ,END_DATE=SYSDATE WHERE BH_PROCEDURE=XWBH.BH_PROCEDURE AND DATA_DATE=XWBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

    END LOOP;

    COMMIT;

    

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_WBH_PROCESS SET BH_STATE=3 WHERE BH_PROCEDURE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END;

  PROCEDURE INSERT_WA_PROCESS(P_SYSTEM_ID NUMBER)

  AS

  XEXISTS NUMBER;

  XSYSTEM NUMBER;

  BEGIN

  XSYSTEM :=P_SYSTEM_ID;

   DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

   DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    FOR XWA IN

    (

        SELECT DISTINCT ORG_TABLE , ORG_TABLE||'_5WA' WA_TABLE,TRUNC(DATA_DATE,'DAY') DATA_DATE FROM NORTHI_DAILY_PROCESS WHERE AGGREGATE_STATE=2 AND WEEKLY_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID AND TRUNC(DATA_DATE,'DAY')!=TRUNC(SYSDATE,'DAY') AND 

        (ORG_TABLE) IN

        (SELECT TABLE_NAME FROM NORTHI_LOADER_SETTINGS A, NORTHI_VENDOR_LIST B WHERE A.VENDOR_ID=B.VENDOR_ID AND SYSTEM_ID=P_SYSTEM_ID  AND A.ACTIVE=1 AND INSTR(DATE_AGGREGATE_TYPES,'''5WA''')>0 )

        UNION ALL

        SELECT DISTINCT ORG_TABLE , ORG_TABLE||'_7WA' WA_TABLE,TRUNC(DATA_DATE,'DAY') DATA_DATE FROM NORTHI_DAILY_PROCESS WHERE AGGREGATE_STATE=2 AND WEEKLY_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID AND TRUNC(DATA_DATE,'DAY')!=TRUNC(SYSDATE,'DAY') AND 

        (ORG_TABLE) IN

        (SELECT TABLE_NAME FROM NORTHI_LOADER_SETTINGS A, NORTHI_VENDOR_LIST B WHERE A.VENDOR_ID=B.VENDOR_ID AND SYSTEM_ID=P_SYSTEM_ID AND A.ACTIVE=1 AND INSTR(DATE_AGGREGATE_TYPES,'''7WA''')>0 )

    )

    LOOP

            INSERT_WBH_PROCESS(P_SYSTEM_ID,XWA.ORG_TABLE ,XWA.DATA_DATE );

            SELECT COUNT(*) INTO XEXISTS FROM NORTHI_WEEKLY_PROCESS WHERE TABLE_NAME=XWA.WA_TABLE AND DATA_DATE=XWA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID ;

            UPDATE NORTHI_DAILY_PROCESS SET WEEKLY_STATE=1 WHERE ORG_TABLE=XWA.ORG_TABLE AND TRUNC(DATA_DATE,'DAY')=XWA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; 

             IF XEXISTS>0 THEN

                UPDATE NORTHI_WEEKLY_PROCESS 

                SET AGGREGATE_STATE=0 ,PROCESS_COUNT=PROCESS_COUNT+1 WHERE TABLE_NAME=XWA.WA_TABLE AND DATA_DATE=XWA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

                 

             ELSE 

                INSERT INTO NORTHI_WEEKLY_PROCESS(TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,ORG_TABLE,SYSTEM_ID) 

                VALUES(XWA.WA_TABLE,XWA.DATA_DATE,SYSDATE,0,SYSDATE,0,1,XWA.ORG_TABLE,P_SYSTEM_ID);

            END IF;    

    END LOOP;

    COMMIT;

  END;

  PROCEDURE BEGIN_WA_TRANSFER(P_SYSTEM_ID NUMBER)

  AS 

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XAGGREGATE_DATE DATE;

  XROW_COUNT NUMBER;

  XSYSTEM_ID NUMBER;

  BEGIN

  XSYSTEM_ID :=P_SYSTEM_ID;

  DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

   DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    FOR XWA IN

    (

        SELECT TABLE_NAME,DATA_DATE DATA_DATE,AGGREGATE_DATE,PROCESS_COUNT,ORG_TABLE FROM NORTHI_WEEKLY_PROCESS WHERE AGGREGATE_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID

    )

    LOOP 

     XTABLE_NAME:=XWA.TABLE_NAME;

     XDATA_DATE:=XWA.DATA_DATE;

     XAGGREGATE_DATE:=XWA.AGGREGATE_DATE;

            UPDATE NORTHI_WEEKLY_PROCESS SET AGGREGATE_STATE=1, LOADER_DATE=SYSDATE , AGGREGATE_DATE=NULL WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; 

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XTABLE_NAME || ' WHERE FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

            DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XTABLE_NAME AND FRAGMENT_DATE=TRUNC(XDATA_DATE);

            COMMIT;

            EXECUTE_PROCEDURE(XTABLE_NAME,XDATA_DATE,XAGGREGATE_DATE,XROW_COUNT,XSYSTEM_ID);

            UPDATE NORTHI_WEEKLY_PROCESS SET AGGREGATE_STATE=2,AGGREGATE_DATE=SYSDATE WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

            COMMIT;

    END LOOP;   

    COMMIT;

    BEGIN_WBH_TRANSFER(XSYSTEM_ID);

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_WEEKLY_PROCESS SET AGGREGATE_STATE=3 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END;

  PROCEDURE EXECUTE_WA_WORKS(P_SYSTEM_ID NUMBER)

  AS

  XSYSTEM_NAME VARCHAR2(100);

  BEGIN

    DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

    DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    SELECT SYSTEM_NAME INTO XSYSTEM_NAME FROM NORTHI_SYSTEM_LIST 

    WHERE SYSTEM_ID=P_SYSTEM_ID;

    XSYSTEM_NAME:='WA_'||XSYSTEM_NAME;

    IF (LOADER_STATE.GET_STATE(XSYSTEM_NAME)=0) THEN

        LOADER_STATE.SET_START(XSYSTEM_NAME);

        INSERT_WA_PROCESS(P_SYSTEM_ID);

        BEGIN_WA_TRANSFER(P_SYSTEM_ID);

        LOADER_STATE.SET_END(XSYSTEM_NAME);

    END IF;

    

  END;

END;
/
