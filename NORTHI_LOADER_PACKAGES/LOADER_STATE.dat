
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."LOADER_STATE" 
AS
  PROCEDURE SET_START(XPROCESS_NAME VARCHAR2)
  AS
  BEGIN
    INSERT INTO NORTHI_LOADER_RUNNING_PROCS (PROCEDURE_NAME,PROCEDURE_STATUS,START_DATE,PROCEDURE_STATE)
    VALUES(XPROCESS_NAME,'RUNNING',SYSDATE,1);
    COMMIT;
  END;
 PROCEDURE SET_END(XPROCESS_NAME VARCHAR2)
 AS
 BEGIN
    UPDATE NORTHI_LOADER_RUNNING_PROCS SET PROCEDURE_STATUS='STOPPED',END_DATE=SYSDATE,PROCEDURE_STATE=0 
    WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING' ;
    COMMIT;
 END SET_END;

 FUNCTION GET_STATE(XPROCESS_NAME VARCHAR2) RETURN NUMBER
 AS
 XRUNNING NUMBER;
 XCOUNT NUMBER;
 XMINUTE NUMBER;
 BEGIN

 XMINUTE:=60;

    SELECT COUNT (*) INTO XCOUNT FROM NORTHI_LOADER_RUNNING_PROCS WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING';
    IF XCOUNT>0 THEN 
        SELECT (SYSDATE-START_DATE)*60*24 INTO XMINUTE FROM NORTHI_LOADER_RUNNING_PROCS WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING';
    END IF;
     IF XMINUTE> 120 THEN
        UPDATE NORTHI_LOADER_RUNNING_PROCS SET PROCEDURE_STATUS='TERMINATED',END_DATE=SYSDATE,PROCEDURE_STATE=0 
        WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING' ; 
        COMMIT;
     END IF;
     SELECT COUNT(*) INTO XRUNNING FROM NORTHI_LOADER_RUNNING_PROCS WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING';
    
    --- BURADAN ---- 
     
        IF XRUNNING=1 THEN
     
           FOR DK IN 1..15
                   
                LOOP 
                dbms_lock.sleep(60);
                SELECT COUNT(*) INTO XRUNNING FROM NORTHI_LOADER_RUNNING_PROCS WHERE PROCEDURE_NAME=XPROCESS_NAME AND PROCEDURE_STATUS='RUNNING';
                
                          IF XRUNNING=0 THEN  
                        
                          RETURN XRUNNING;
                        
                          END IF;
               
                END LOOP;

     END IF;
     
     ---- BURASI ----
     
     RETURN XRUNNING;
     
 END GET_STATE; 
END ;
/
