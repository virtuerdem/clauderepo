
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."RAW_LOADER_CREATION_TEST" AS

PROCEDURE CREATE_RAW_AGG_TABLES (XTABLE_NAME IN VARCHAR2)
AS 
xTABLE_SCRIPT VARCHAR2(32000); 

XAGGREGATE_TABLE_NAME VARCHAR(50);
XSTATEMENT CLOB;
XTABLE_EXISTS  NUMBER;
XERROR VARCHAR2(4000);
XERROR_CODE NUMBER;

BEGIN
    
 FOR XAGGS IN
 (
      SELECT DISTINCT A.AGG_SHEMA,A.XLEVEL
      FROM
      (
    
      SELECT 'NORTHI_RAW_DA' AGG_SHEMA,'DA' XLEVEL  FROM DUAL UNION ALL 
      SELECT 'NORTHI_RAW_WA' AGG_SHEMA,'WA' XLEVEL  FROM DUAL UNION ALL 
      SELECT 'NORTHI_RAW_MA' AGG_SHEMA,'MA' XLEVEL  FROM DUAL
     
      ) A,NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST B
      WHERE TABLE_NAME=XTABLE_NAME
 )
    LOOP
    XAGGREGATE_TABLE_NAME:=XTABLE_NAME;
            
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XAGGREGATE_TABLE_NAME AND OWNER=XAGGS.AGG_SHEMA;
    XTABLE_EXISTS:=NVL(XTABLE_EXISTS,0);

    IF  XTABLE_EXISTS>0 THEN
        xTABLE_SCRIPT:='';
        FOR XMISSION IN 
        (
                SELECT  DISTINCT COLUMN_NAME ,DATA_LENGTH FIELD_LENGTH, T.DATA_TYPE
                FROM ALL_TAB_COLUMNS T WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME  AND OWNER='HIZIR2' AND TRIM(COLUMN_NAME) NOT IN(
                SELECT COLUMN_NAME  FROM 
                ALL_TAB_COLUMNS WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME AND OWNER=XAGGS.AGG_SHEMA)
        )
        LOOP
              IF XMISSION.DATA_TYPE='VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE ' || XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
              IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE ' || XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
        END LOOP;
    END IF;
                            
                                
    IF  XTABLE_EXISTS=0 THEN
         xTABLE_SCRIPT:='';
         FOR XFIELDS IN
         (
            SELECT  DISTINCT UPPER(COUNTER_NAME_DB) COUNTER_NAME, COUNTER_TYPE, 30 FIELD_LENGTH FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME AND IS_ACTIVE=1  AND OPERATOR_NAME='VODAFONE'
         )
          LOOP
               IF XFIELDS.COUNTER_TYPE='VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.COUNTER_NAME||' '||XFIELDS.COUNTER_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
               END IF;
               IF XFIELDS.COUNTER_TYPE<>'VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.COUNTER_NAME||' '||XFIELDS.COUNTER_TYPE||', ';
               END IF;
          END LOOP; 
          
          xTABLE_SCRIPT:='CREATE TABLE '|| XAGGS.AGG_SHEMA || '.'||XAGGREGATE_TABLE_NAME||' ( '||SUBSTR(xTABLE_SCRIPT,1,LENGTH(xTABLE_SCRIPT)-2)||' ) ' ||
                                    '   PCTFREE    0
                                        INITRANS   25
                                        MAXTRANS   255
                                        STORAGE    (
                                                    BUFFER_POOL      DEFAULT
                                                    FLASH_CACHE      DEFAULT
                                                    CELL_FLASH_CACHE DEFAULT
                                                    initial 64k
                                                    next 64k
                                                   )
                                        PARTITION BY RANGE (DATA_DATE) ' ||
                                            CASE XAGGS.XLEVEL
                                                 WHEN 'DA' THEN ' INTERVAL(NUMTODSINTERVAL(1,''DAY'')) '
                                                 ELSE ' INTERVAL(NUMTOYMINTERVAL(1,''MONTH'')) '
                                            END
                                     || ' 
                                        (  
                                          PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('' 2018-01-01 00:00:00'', ''SYYYY-MM-DD HH24:MI:SS'', ''NLS_CALENDAR=GREGORIAN''))
                                            LOGGING
                                            compress for query high 
                                            PCTFREE    0
                                            INITRANS   25
                                            MAXTRANS   255
                                            STORAGE    (
                                                        MAXSIZE          UNLIMITED
                                                        BUFFER_POOL      DEFAULT
                                                        FLASH_CACHE      DEFAULT
                                                        CELL_FLASH_CACHE DEFAULT
                                                        initial 64k
                                                        next 64k
                                                       )
                                        )  
                                        compress for query high 
                                        NOCACHE
                                        NOPARALLEL
                                        MONITORING';
        XSTATEMENT:=xTABLE_SCRIPT;
        
           INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
        VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'CREATE_AGGREGATE_TABLENN',XSTATEMENT);
        
        EXECUTE IMMEDIATE XSTATEMENT;
          
    END IF;
   END LOOP;
   EXCEPTION
 WHEN OTHERS THEN
 BEGIN
   XERROR:=SUBSTR(SQLERRM,1,4000);
   XERROR_CODE:=SQLCODE;
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'CREATE_AGGREGATE_TABLE',XSTATEMENT);
 END;
END CREATE_RAW_AGG_TABLES;


PROCEDURE CREATE_RAW_DATE_AGG_PROC (XTABLE_NAME IN VARCHAR2)
AS 
XSTATEMENT CLOB;
XAGGREGATE_PROCEDURE_NAME VARCHAR(50);
XAGGREGATION_FIELDS VARCHAR(32000);
XLOCAL_FIELDS VARCHAR(32000);
XFROM_CLAUSE VARCHAR2(4000);
XWHERE_CLAUSE VARCHAR2(4000);
XINSERT_TABLE_NAME VARCHAR2(1000);
BEGIN
    
   
    FOR XAGGREGATE IN 
    (
       SELECT DISTINCT TABLE_NAME,A.AGG_SHEMA,A.XLEVEL,A.SD,A.ED
        FROM 
        (
                          SELECT 'DA'  XLEVEL,    'NORTHI_RAW_DA' AGG_SHEMA     ,'TRUNC(XDATA_DATE)' SD       ,     '(TRUNC(XDATA_DATE)+1)-0.01/24' ED FROM DUAL 
                UNION ALL SELECT 'WA' XLEVEL,     'NORTHI_RAW_WA' AGG_SHEMA    ,'TRUNC(XDATA_DATE,''DAY'')' SD ,   '(TRUNC(XDATA_DATE,''DAY'')+7)-0.01/24' FROM DUAL 
                UNION ALL SELECT 'MA' XLEVEL,     'NORTHI_RAW_MA' AGG_SHEMA  ,'TRUNC(XDATA_DATE,''MONTH'')' SD,  'ADD_MONTHS(TRUNC(XDATA_DATE),1)-0.01/24' FROM DUAL 
               
        ) A,NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST  B
        WHERE TABLE_NAME=XTABLE_NAME
        
       

    )
    
    LOOP
       
       XSTATEMENT:='';
       
       XAGGREGATE_PROCEDURE_NAME:= XAGGREGATE.AGG_SHEMA ||'.P_'||SUBSTR(XTABLE_NAME,1,28);
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XAGGREGATE_PROCEDURE_NAME,'NNNN12 >>' || XSTATEMENT, SYSDATE); COMMIT;
     
       GET_RAW_DATE_AGG(XTABLE_NAME,XAGGREGATION_FIELDS,XLOCAL_FIELDS);
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XAGGREGATE_PROCEDURE_NAME,'NNNN13 >>' || XSTATEMENT, SYSDATE); COMMIT;
       
       --SELECT FROM_CLAUSE,LOAD_TYPE,DATE_FIELD,WHERE_CLAUSE INTO XFROM_CLAUSE,XLOAD_TYPE,XDATE_FIELD,XWHERE_CLAUSE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
       
       -- IF XAGGREGATE.AGG_TYPE='H' THEN
       -- XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;
       -- XWHERE_CLAUSE:=XWHERE_CLAUSE||' AND ';
       -- ELSE 
       
       --END IF;

       IF XAGGREGATE.XLEVEL='WA' OR XAGGREGATE.XLEVEL='MA' THEN
        XFROM_CLAUSE:='NORTHI_RAW_DA.'||XTABLE_NAME||'  A ';
        XWHERE_CLAUSE:='';
       ELSE 
        XFROM_CLAUSE:='HIZIR2.'||XTABLE_NAME||' A ';
        XWHERE_CLAUSE:='';
       END IF;
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XFROM_CLAUSE,'NNNN14 >>' || XSTATEMENT, SYSDATE); COMMIT;
       --/*+ PARALLEL(A,16) APPEND */

      -- XINSERT_TABLE_NAME:=XTABLE_NAME ||'_'||XAGGREGATE.XLEVEL;
       XSTATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
      CHR(13)||'BEGIN'||
      CHR(13)||CHR(9)||'INSERT  /*+ APPEND PARALLEL(8) */  INTO ' ||XAGGREGATE.AGG_SHEMA ||'.'||XTABLE_NAME  ||
      CHR(13)||CHR(9)||'('||
      CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||',NETWORK_ID'||',DATA_DATE'||
       CHR(13)||CHR(9)||')'||
       CHR(13)||CHR(9)||'SELECT /*+PARALLEL (A 8)FULL(A)*/'||
       CHR(13)||CHR(9)||CHR(9)|| XAGGREGATION_FIELDS|| ',NETWORK_ID'||',XDATA_DATE '||
       CHR(13)||CHR(9)||' FROM '||XFROM_CLAUSE|| 
       CHR(13)||CHR(9)||' WHERE '||XWHERE_CLAUSE||' DATA_DATE BETWEEN '||XAGGREGATE.SD||' AND '||XAGGREGATE.ED||
       CHR(13)||CHR(9)||' GROUP BY NETWORK_ID'||',XDATA_DATE'||' ;'||
      
      'COMMIT;'||CHR(13)|| 
      CHR(13)||'END;';
             
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XSTATEMENT,'NNNN15 >>' || XSTATEMENT, SYSDATE); COMMIT;
        
       EXECUTE IMMEDIATE XSTATEMENT ;
       
        INSERT INTO NORTHI_DATA.NI_TEST_ERROR (SQLTEXT,LOG_ORDER,DATE_TIME)
        VALUES (XSTATEMENT,'NNNN16 >>' || XSTATEMENT, SYSDATE); COMMIT;
       
    END LOOP;
   EXCEPTION
   WHEN NO_DATA_FOUND THEN
   NULL;
   WHEN OTHERS THEN
   BEGIN
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,111,XSTATEMENT,SYSDATE,'CREATE_LOADER_PROCEDURE2',XSTATEMENT);
   END;
END CREATE_RAW_DATE_AGG_PROC;


PROCEDURE GET_RAW_DATE(XKPI_NAME VARCHAR2,XTABLE_NAME VARCHAR2, XVENDOR_ID VARCHAR2, IO_CUR OUT SYS_REFCURSOR )
AS
XFROM VARCHAR2(32000);
XWHERE VARCHAR2(32000);
XSELECT VARCHAR2(32000);
BEGIN
    SELECT FROM_CLAUSE,WHERE_CLAUSE INTO XFROM,XWHERE
    FROM NORTHI_LOADER.NORTHI_LOADER_SETTINGS A
    WHERE TABLE_NAME=XTABLE_NAME
    AND A.VENDOR_ID IN (XVENDOR_ID);
     
    --COUNTERLARDAN VE KPI DAN SELECT OLUSTURMA.
    FOR XFIELDS IN (
     select 'a' xcounter,'b' xcounter_name
     from dual
    )
    LOOP
        XSELECT :=XSELECT ||XFIELDS.XCOUNTER||' '||XFIELDS.xCOUNTER_NAME;
    END LOOP;
    
END GET_RAW_DATE;


PROCEDURE GET_RAW_DATE_AGG (XTABLE_NAME IN VARCHAR2,XRESULT IN OUT VARCHAR2, XRESULT2 IN OUT VARCHAR2)
AS
XAGGREGATION_FIELDS VARCHAR2(32000);
XLOCAL_FIELDS VARCHAR2(32000);

 BEGIN
    XAGGREGATION_FIELDS:='';
    XLOCAL_FIELDS :='';
    FOR XFIELDS IN
    (
          SELECT *
         FROM (
         SELECT   
         DECODE(TIME_STAT_METH,'MAX','MAX' ,'MIN','MIN','AVG','AVG','SUM','SUM','SUM') ||'('||COUNTER_NAME_DB||')'||UPPER(COUNTER_NAME_DB)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,
         COUNTER_NAME_DB LOCAL_FIELD,
         ROW_NUMBER() OVER (PARTITION BY UPPER(COUNTER_NAME_DB) ORDER BY UPPER(COUNTER_NAME_DB)) RN 
         FROM NORTHI_PARSER_SETTINGS.PARSER_COUNTER_LIST WHERE COUNTER_MODEL='VARIABLE' AND  OPERATOR_NAME='VODAFONE' AND TABLE_NAME=XTABLE_NAME 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN 
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XLOCAL_FIELDS :=XLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
    
     IF LENGTH(XLOCAL_FIELDS)>0 THEN
        XLOCAL_FIELDS:=SUBSTR(XLOCAL_FIELDS,1,LENGTH(XLOCAL_FIELDS)-1);
    END IF;
   
   
 
    
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    
    XRESULT2:=XLOCAL_FIELDS;
    
   
 END  GET_RAW_DATE_AGG;
 
 PROCEDURE EXECUTE_ALL_RAW_PROCS AS

BEGIN
     FOR XTABLES IN 
    ( 
        SELECT DISTINCT TABLE_NAME 
        FROM NORTHI_PARSER_SETTINGS.PARSER_RAW_TABLE_LIST 
        WHERE SYSTEM_TYPE IN ('HW4G') AND TABLE_TYPE IN ('CELL', 'NRCELL', 'NRDUCELL') 
        AND OPERATOR_NAME='VODAFONE' AND IS_ACTIVE=1 AND NETWORK_ID_TYPE ='NUMBER'
    )
   
    LOOP
    
    
      CREATE_RAW_AGG_TABLES (XTABLES.TABLE_NAME);
      
      CREATE_RAW_DATE_AGG_PROC (XTABLES.TABLE_NAME);
   
    END LOOP;
    
 END EXECUTE_ALL_RAW_PROCS;

END RAW_LOADER_CREATION_TEST;
/
