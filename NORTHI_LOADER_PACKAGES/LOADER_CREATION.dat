
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."LOADER_CREATION" AS
/******************************************************************************

   NAME:       
   PURPOSE: This package consists all loader creation procedures and functions.

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        2/11/2009  1.Vesile Taskiran  Use to create Loader
   note : partition_type tablosunda auxiliary column da eleman siralari onemli netwotk id den once gelen alanlar select e ekleniyor.  
******************************************************************************/
PROCEDURE GET_BH_AGGREGATE_FIELDS(XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
BEGIN
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS IN
    (
         SELECT *
         FROM (
         SELECT DATE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN 
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS2 IN
    (
        SELECT *
         FROM (
        SELECT UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN 
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') AND DATE_AGGREGATE IS NULL ) ORDER BY ROWID
         
    )
    LOOP
        IF XFIELDS2.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS2.AGGREGATE_FIELD||',';
        END IF;
    END LOOP; 
    IF LENGTH(XAGGREGATION_FIELDS)>0 THEN 
        XRESULT2:=','||SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    ELSE 
        XRESULT2:='';
    END IF;
END GET_BH_AGGREGATE_FIELDS;
PROCEDURE GET_DATE_AGGREGATE2(XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
BEGIN
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT DATE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD,
         TYPE_AGGREGATE||'('||REMOTE_FIELD||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) DIRECT_LOAD_FIELDS,
         ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN  
         FROM NORTHI_TABLE_FIELDS WHERE UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') 
         AND TABLE_NAME=XTABLE_NAME 
         AND DATE_AGGREGATE IS NOT NULL AND ACTIVE=1
         --AND VENDOR_ID=XVENDOR_ID 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XDIRECT_LOAD_FIELDS:=XDIRECT_LOAD_FIELDS||XFIELDS.DIRECT_LOAD_FIELDS||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    XRESULT2:=SUBSTR(XDIRECT_LOAD_FIELDS,1,LENGTH(XDIRECT_LOAD_FIELDS)-4);
END GET_DATE_AGGREGATE2;
PROCEDURE GET_DATE_AGGREGATE2XX(XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
BEGIN
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT DATE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD,
         TYPE_AGGREGATE||'('||REMOTE_FIELD||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) DIRECT_LOAD_FIELDS,
         ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN  
         FROM NORTHI_TABLE_FIELDS WHERE UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') 
         AND TABLE_NAME=XTABLE_NAME 
         AND DATE_AGGREGATE IS NOT NULL AND ACTIVE=1
         AND VENDOR_ID=XVENDOR_ID 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XDIRECT_LOAD_FIELDS:=XDIRECT_LOAD_FIELDS||XFIELDS.DIRECT_LOAD_FIELDS||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    XRESULT2:=SUBSTR(XDIRECT_LOAD_FIELDS,1,LENGTH(XDIRECT_LOAD_FIELDS)-4);
END GET_DATE_AGGREGATE2XX;
PROCEDURE GET_DATE_AGGREGATE(XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
XVENDOR_ID NUMBER;
BEGIN
    XAGGREGATION_FIELDS:='';
    SELECT VENDOR_ID INTO XVENDOR_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME AND ROWNUM=1;
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT DATE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD,
         TYPE_AGGREGATE||'('||REMOTE_FIELD||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) DIRECT_LOAD_FIELDS ,
         ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN 
         FROM NORTHI_TABLE_FIELDS WHERE UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') AND TABLE_NAME=XTABLE_NAME AND ACTIVE=1 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN 
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XDIRECT_LOAD_FIELDS:=XDIRECT_LOAD_FIELDS||XFIELDS.DIRECT_LOAD_FIELDS||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    IF XVENDOR_ID=1 THEN
        XRESULT2:='';
    ELSE
        XRESULT2:=SUBSTR(XDIRECT_LOAD_FIELDS,1,LENGTH(XDIRECT_LOAD_FIELDS)-4);
    END IF;
END GET_DATE_AGGREGATE;
PROCEDURE GET_TYPE_AGGREGATE(XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
BEGIN
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT TYPE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD,
         TYPE_AGGREGATE||'('||REMOTE_FIELD||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) DIRECT_LOAD_FIELDS,
         ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN 
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND TYPE_AGGREGATE IS NOT NULL --AND VENDOR_ID=XVENDOR_ID
         )ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XDIRECT_LOAD_FIELDS:=XDIRECT_LOAD_FIELDS||XFIELDS.DIRECT_LOAD_FIELDS||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    XRESULT2:=SUBSTR(XDIRECT_LOAD_FIELDS,1,LENGTH(XDIRECT_LOAD_FIELDS)-4);
END  GET_TYPE_AGGREGATE;
PROCEDURE GET_TYPE_AGGREGATEXX(XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
BEGIN
    XAGGREGATION_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT TYPE_AGGREGATE||'('||UPPER(LOCAL_FIELD)||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD,
         TYPE_AGGREGATE||'('||REMOTE_FIELD||')'||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) DIRECT_LOAD_FIELDS,
         ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN 
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND TYPE_AGGREGATE IS NOT NULL AND VENDOR_ID=XVENDOR_ID
         )ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            XAGGREGATION_FIELDS:=XAGGREGATION_FIELDS||XFIELDS.AGGREGATE_FIELD||',';
            XDIRECT_LOAD_FIELDS:=XDIRECT_LOAD_FIELDS||XFIELDS.DIRECT_LOAD_FIELDS||',';
        END IF;
    END LOOP;
    XRESULT:=SUBSTR(XAGGREGATION_FIELDS,1,LENGTH(XAGGREGATION_FIELDS)-4);
    XRESULT2:=SUBSTR(XDIRECT_LOAD_FIELDS,1,LENGTH(XDIRECT_LOAD_FIELDS)-4);
END  GET_TYPE_AGGREGATEXX;
PROCEDURE GET_REMOTE_TABLE_FIELDS (XTABLE_NAME IN VARCHAR2,xREMOTE_FIELDS IN OUT CLOB,XVENDOR_ID NUMBER)
AS
XERROR_CODE NUMBER;
XERROR VARCHAR(32000);
XCNT NUMBER; 
BEGIN

    xREMOTE_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
         SELECT REMOTE_FIELD,UPPER(LOCAL_FIELD) LOCAL_FIELD,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN  
         FROM NORTHI_TABLE_FIELDS 
         WHERE TABLE_NAME=XTABLE_NAME AND VENDOR_ID=XVENDOR_ID AND  ACTIVE=1 
         ) ORDER BY ROWID
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            xREMOTE_FIELDS:=xREMOTE_FIELDS||XFIELDS.REMOTE_FIELD||' '||xFIELDS.LOCAL_FIELD||','||CHR(13)||CHR(9)||CHR(9);
        END IF;
    END LOOP;
    IF LENGTH(xREMOTE_FIELDS)>0 THEN
        xREMOTE_FIELDS:=SUBSTR(xREMOTE_FIELDS,1,LENGTH(xREMOTE_FIELDS)-4);
    END IF; 

     SELECT COUNT(*) INTO XCNT  FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME) AND DTYPE=1;
     IF XCNT>0 THEN
        xREMOTE_FIELDS:=xREMOTE_FIELDS||',1 DTYPE'||CHR(13)||CHR(9)||CHR(9) ;
     END IF; 
    -- EXCEPTION WHEN OTHERS THEN BEGIN /*INSERT ERROR_CODE*/ END;
END GET_REMOTE_TABLE_FIELDS;
PROCEDURE  GET_BH_FIELDS (XTABLE_NAME IN VARCHAR2,XALIAS VARCHAR2,xLOCAL_FIELDS IN OUT CLOB)
AS
 XERROR_CODE NUMBER;
 XERROR VARCHAR(32000);
 XDTYPE VARCHAR2(20);
 XCNT NUMBER;
BEGIN
    xLOCAL_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
        SELECT DECODE(XALIAS,'NULL','',XALIAS||'.')||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) LOCAL_FIELD,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN  FROM NORTHI_TABLE_FIELDS WHERE UPPER(LOCAL_FIELD) NOT IN ('NETWORK_ID','FRAGMENT_DATE','DTYPE') AND TABLE_NAME=XTABLE_NAME AND ACTIVE=1 
        )
        ORDER BY ROWID  
    )
    LOOP
        IF XFIELDS.RN=1 THEN
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
END GET_BH_FIELDS;
PROCEDURE  GET_LOCAL_FIELDS (XTABLE_NAME IN VARCHAR2,XALIAS VARCHAR2,XVENDOR_ID NUMBER,xLOCAL_FIELDS IN OUT CLOB)
AS
 XERROR_CODE NUMBER;
 XERROR VARCHAR(32000);
 XDTYPE VARCHAR2(20);
 XCNT NUMBER;
BEGIN
    xLOCAL_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
            SELECT DECODE(XALIAS,'NULL','',XALIAS||'.')||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) LOCAL_FIELD FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND VENDOR_ID=XVENDOR_ID 
        )
        ORDER BY ROWID  
    )
    LOOP
        xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
    END LOOP;
    IF LENGTH(xLOCAL_FIELDS)>0 THEN
        xLOCAL_FIELDS:=SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-1);
    END IF;
    SELECT COUNT(DECODE(XALIAS,'NULL','1 DTYPE',XALIAS||'.DTYPE')||CHR(13)||CHR(9)||CHR(9)) INTO XCNT  FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME) AND DTYPE=1;
     IF XCNT>0 THEN
        SELECT DECODE(XALIAS,'NULL',',1 DTYPE',','||XALIAS||'.DTYPE')||CHR(13)||CHR(9)||CHR(9) INTO XDTYPE FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME) AND DTYPE=1;       
        xLOCAL_FIELDS:=xLOCAL_FIELDS||XDTYPE;
     END IF; 
 --EXCEPTION WHEN OTHERS THEN BEGIN /*INSERT ERROR_CODE*/ END;
END GET_LOCAL_FIELDS;
PROCEDURE  GET_AGGREGATE_FIELDS2 (XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XALIAS VARCHAR2,XRESULT  OUT CLOB,XRESULT2  OUT CLOB)
AS
 XERROR_CODE NUMBER;
 XERROR VARCHAR(32000);
 XDTYPE VARCHAR2(20);
 XCNT NUMBER;
 XLOCAL_FIELDS CLOB;
 RXNUM NUMBER;
BEGIN
    xLOCAL_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
       SELECT DECODE(XALIAS,'NULL','','A'||'.')||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) LOCAL_FIELD, ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RX FROM NORTHI_TABLE_FIELDS 
        WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND TYPE_AGGREGATE IS  NOT NULL  
        --AND VENDOR_ID=XVENDOR_ID
        )ORDER BY ROWID
    )
    LOOP
        RXNUM:=XFIELDS.RX;
        IF RXNUM=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
     
    IF LENGTH(xLOCAL_FIELDS)>0 THEN
        xLOCAL_FIELDS:=SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    END IF;
    XRESULT:=XLOCAL_FIELDS;
    
    
    xLOCAL_FIELDS:='';
    FOR XFIELDS2 IN
    (
        SELECT *
         FROM (
        SELECT UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') AND DATE_AGGREGATE IS NULL 
         )
         ORDER BY ROWID
    )
    LOOP
         IF XFIELDS2.RN=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS2.AGGREGATE_FIELD||',';
         END IF;
    END LOOP; 
    IF LENGTH(xLOCAL_FIELDS)>0 THEN 
        XRESULT2:=','||SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    ELSE 
        XRESULT2:='';
    END IF;
    
 --EXCEPTION WHEN OTHERS THEN BEGIN /*INSERT ERROR_CODE*/ END;
END GET_AGGREGATE_FIELDS2;
PROCEDURE  GET_AGGREGATE_FIELDS2XX (XVENDOR_ID IN NUMBER,XTABLE_NAME IN VARCHAR2,XALIAS VARCHAR2,XRESULT  OUT CLOB,XRESULT2  OUT CLOB)
AS
 XERROR_CODE NUMBER;
 XERROR VARCHAR(32000);
 XDTYPE VARCHAR2(20);
 XCNT NUMBER;
 XLOCAL_FIELDS CLOB;
 RXNUM NUMBER;
BEGIN
    xLOCAL_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
       SELECT DECODE(XALIAS,'NULL','','A'||'.')||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) LOCAL_FIELD, ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RX FROM NORTHI_TABLE_FIELDS 
        WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND TYPE_AGGREGATE IS  NOT NULL  
        AND VENDOR_ID=XVENDOR_ID
        )ORDER BY ROWID
    )
    LOOP
        RXNUM:=XFIELDS.RX;
        IF RXNUM=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
     
    IF LENGTH(xLOCAL_FIELDS)>0 THEN
        xLOCAL_FIELDS:=SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    END IF;
    XRESULT:=XLOCAL_FIELDS;
    
    
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,'NULL',SYSDATE,'GET_AGGREGATE_FIELDS2XX',XRESULT);
    
    xLOCAL_FIELDS:='';
    FOR XFIELDS2 IN
    (
        SELECT *
         FROM (
        SELECT UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') AND DATE_AGGREGATE IS NULL 
         )
         ORDER BY ROWID
    )
    LOOP
         IF XFIELDS2.RN=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS2.AGGREGATE_FIELD||',';
         END IF;
    END LOOP; 
    IF LENGTH(xLOCAL_FIELDS)>0 THEN 
        XRESULT2:=','||SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    ELSE 
        XRESULT2:='';
    END IF;
    
    
   INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
   VALUES (USER,XTABLE_NAME,XERROR_CODE,'NULL',SYSDATE,'GET_AGGREGATE_FIELDS2XX',XRESULT2);
    
    
    
    
    
    
 --EXCEPTION WHEN OTHERS THEN BEGIN /*INSERT ERROR_CODE*/ END;
END GET_AGGREGATE_FIELDS2XX;
PROCEDURE  GET_AGGREGATE_FIELDS (XTABLE_NAME IN VARCHAR2,XALIAS VARCHAR2,XRESULT IN OUT CLOB,XRESULT2 IN OUT CLOB)
AS
 XERROR_CODE NUMBER;
 XERROR VARCHAR(32000);
 XDTYPE VARCHAR2(20);
 XCNT NUMBER;
 XLOCAL_FIELDS CLOB;
BEGIN
    xLOCAL_FIELDS:='';
    FOR XFIELDS IN
    (
        SELECT *
         FROM (
        SELECT DECODE(XALIAS,'NULL','',XALIAS||'.')||UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) LOCAL_FIELD,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN FROM NORTHI_TABLE_FIELDS 
        WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN('FRAGMENT_DATE','NETWORK_ID')  
        )
        ORDER BY ROWID  
    )
    LOOP
        IF XFIELDS.RN=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS.LOCAL_FIELD||',';
        END IF;
    END LOOP;
    IF LENGTH(xLOCAL_FIELDS)>0 THEN
        xLOCAL_FIELDS:=SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    END IF;
    XRESULT:=XLOCAL_FIELDS;
    xLOCAL_FIELDS:='';
    FOR XFIELDS2 IN
    (
        SELECT *
         FROM (
        SELECT UPPER(LOCAL_FIELD)||CHR(13)||CHR(9)||CHR(9) AGGREGATE_FIELD ,ROW_NUMBER() OVER (PARTITION BY UPPER(LOCAL_FIELD) ORDER BY UPPER(LOCAL_FIELD)) RN
         FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND UPPER(LOCAL_FIELD) NOT IN ('FRAGMENT_DATE','NETWORK_ID') AND DATE_AGGREGATE IS NULL 
         )
         ORDER BY ROWID
    )
    LOOP
        IF XFIELDS2.RN=1 THEN 
            xLOCAL_FIELDS:=xLOCAL_FIELDS||XFIELDS2.AGGREGATE_FIELD||',';
        END IF;
    END LOOP; 
    IF LENGTH(xLOCAL_FIELDS)>0 THEN 
        XRESULT2:=','||SUBSTR(xLOCAL_FIELDS,1,LENGTH(xLOCAL_FIELDS)-4);
    ELSE 
        XRESULT2:='';
    END IF;
 --EXCEPTION WHEN OTHERS THEN BEGIN /*INSERT ERROR_CODE*/ END;
END GET_AGGREGATE_FIELDS;
FUNCTION  RETURN_ON(XTABLE_NAME IN VARCHAR2) RETURN VARCHAR2
AS
XSTATEMENT CLOB;
BEGIN
    XSTATEMENT:='';
    FOR XFIELDS IN
    (
        SELECT DISTINCT UPPER(LOCAL_FIELD) LOCAL_FIELD FROM NORTHI_TABLE_FIELDS WHERE DATE_AGGREGATE IS NULL AND TABLE_NAME=XTABLE_NAME 
    )
    LOOP
     XSTATEMENT:=XSTATEMENT||' A.'||XFIELDS.LOCAL_FIELD||'=E.'||XFIELDS.LOCAL_FIELD||' AND ';   
    END LOOP;
    RETURN SUBSTR(XSTATEMENT,0,LENGTH(XSTATEMENT)-4);
END RETURN_ON;

PROCEDURE ADD_TABLE_PARTITION(XTABLE_NAME VARCHAR2,XORG_TABLE VARCHAR2,XSTART_DATE DATE,XEND_DATE DATE,XLEVEL NUMBER)
IS

   XSTATEMENT CLOB;
   XPARTITION_SCRIPT   VARCHAR2 (32000);
   XDATE               DATE;
   XDATE_STR           VARCHAR2 (50);
   XCNT                NUMBER;
   XADD                NUMBER;
   XAGGREGATE_TABLE_NAME VARCHAR2(50);
   XDATE_MOUNTH_END DATE;
   XSUBPARTITION_SCRIPT VARCHAR2(32000);
   XPARTITION_VALUE VARCHAR2(1000);
   XBASE_NUMBER NUMBER;
   XPARTITION_COUNT NUMBER;
BEGIN
INSERT /*+ APPEND */INTO NORTHI_USED_TABLES(TABLE_NAME) VALUES(XTABLE_NAME);COMMIT;
    /*
        XLEVEL:
                0 = HOURLY
                1 = DAILY
                7 = WEEKLY
               30 = MONTHLY
    */
    SELECT /*+ PARALLEL(16) */ COUNT(*) INTO XPARTITION_COUNT FROM ALL_TAB_PARTITIONS WHERE TABLE_NAME = REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA';
    
   IF XPARTITION_COUNT=0 THEN 
        XBASE_NUMBER:=0;
    ELSE
        SELECT  MAX(TO_NUMBER(SUBSTR(PARTITION_NAME,INSTR(PARTITION_NAME,'_',1,2)+1))) INTO XBASE_NUMBER
        FROM ALL_TAB_PARTITIONS
        WHERE TABLE_NAME=REPLACE(XTABLE_NAME,'NORTHI_DATA.') AND TABLE_OWNER='NORTHI_DATA' AND PARTITION_NAME!='TABLE_PARTITION_MAX';
    END IF;
    
   --XBASE_NUMBER:=XPARTITION_COUNT;
   IF XLEVEL=0 THEN
    XDATE := XSTART_DATE+1/24; --TO_DATE ('2008-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS'); 
   ELSE
    XDATE := XSTART_DATE; --TO_DATE ('2008-11-01 00:00:00', 'YYYY-MM-DD HH24:MI:SS');
   END IF;
   XAGGREGATE_TABLE_NAME := XTABLE_NAME;  --'XBL_STATISTICS';
   XDATE_MOUNTH_END:=add_months(trunc(sysdate,'YEAR'),13);
   
        begin
             XSTATEMENT :=
                 'ALTER TABLE '
              || XAGGREGATE_TABLE_NAME
              || ' drop PARTITION TABLE_PARTITION_MAX';

           EXECUTE IMMEDIATE XSTATEMENT;
        exception
          when others then
            null;
        end;    
  
        XCNT :=  XEND_DATE - XSTART_DATE;
        
        IF XLEVEL=0 THEN
        
            XCNT:=XCNT*24;
            XADD := 1/24;
            
        END IF;
        
        IF XLEVEL=1 THEN
        
            XCNT:=TRUNC(XCNT);
            XADD := 1;
            
        END IF;
        
        IF XLEVEL=7 THEN
        
            XCNT:= MONTHS_BETWEEN (XEND_DATE, XSTART_DATE);
            XADD := 1;
            
        END IF;
        
        IF XLEVEL=30 THEN
        
            XCNT:= MONTHS_BETWEEN (XEND_DATE, XSTART_DATE);
            XADD := 1;
            
        END IF;
        
        
         FOR XI IN 1 .. XCNT
         LOOP
            
            IF XLEVEL=7 OR XLEVEL=30 THEN
                XDATE := ADD_MONTHS (XDATE, XADD);
            ELSE
                XDATE := XDATE + XADD;
            END IF;
            
            XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER)|| 
            ' VALUES LESS THAN (TO_DATE('''|| TO_CHAR (XDATE, 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24'')) COMPRESS FOR OLTP STORAGE (INITIAL 64K NEXT 64K) ';
            --EXECUTE IMMEDIATE XSTATEMENT;
            XSUBPARTITION_SCRIPT:='';
            FOR XPARTITIONS IN
            (
                SELECT DISTINCT PARTITION_ID,PARTITION_NUMBER
                FROM NORTHI_PARTITION_TYPE
                WHERE PARTITION_ID IN
                (
                    SELECT PARTITION_ID
                    FROM NORTHI_LOADER_SETTINGS
                    WHERE TABLE_NAME=REPLACE(XORG_TABLE,'NORTHI_DATA.')
                )
                --AND( DTYPE!=0 )
            )
            LOOP
            
                   XPARTITION_VALUE:='';
                   FOR XPARTITION_VALUES IN
                   (
                     SELECT DTYPE
                     FROM NORTHI_PARTITION_TYPE
                     WHERE PARTITION_ID=XPARTITIONS.PARTITION_ID AND PARTITION_NUMBER=XPARTITIONS.PARTITION_NUMBER
                     AND DTYPE!=0
                   )
                   LOOP
                        XPARTITION_VALUE:=XPARTITION_VALUE||XPARTITION_VALUES.DTYPE||',';
                   END LOOP;
                   IF LENGTH (XPARTITION_VALUE)>0 THEN
                        XSUBPARTITION_SCRIPT:=XSUBPARTITION_SCRIPT||' SUBPARTITION P'|| TO_CHAR (XI+XBASE_NUMBER)||'_'||XPARTITIONS.PARTITION_NUMBER||
                        ' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA COMPRESS FOR OLTP   ,';
                   END IF; 
            END LOOP;
            IF LENGTH(XSUBPARTITION_SCRIPT)>0 THEN
                    XSUBPARTITION_SCRIPT:='( '||SUBSTR(XSUBPARTITION_SCRIPT,1,LENGTH(XSUBPARTITION_SCRIPT)-1)||')'; 
            END IF;
            --INSERT INTO NORTHI_LOADER_ERROR_LOG(SQLTEXT) VALUES(XSTATEMENT);COMMIT;
            EXECUTE IMMEDIATE XSTATEMENT||XSUBPARTITION_SCRIPT;
            INSERT INTO NORTHI_TABLE_PARTITION_LIST(TABLE_NAME,DATA_DATE,PARTITION_NAME,DATA_TYPE)
            VALUES(REPLACE(XTABLE_NAME,'NORTHI_DATA.'),XDATE,'TABLE_PARTITION_'|| TO_CHAR (XI+XBASE_NUMBER),XLEVEL);
            COMMIT;
         END LOOP;
         
        XSTATEMENT :='ALTER TABLE '|| XAGGREGATE_TABLE_NAME|| ' ADD PARTITION TABLE_PARTITION_MAX VALUES LESS THAN (MAXVALUE) ';
        EXECUTE IMMEDIATE XSTATEMENT;
END ADD_TABLE_PARTITION;
FUNCTION GET_WHERE_CLAUSE (XTABLE_NAME IN VARCHAR2,XVENDOR_ID NUMBER) RETURN VARCHAR2
IS
 xWHERE_CLAUSE CLOB;
BEGIN
 SELECT WHERE_CLAUSE INTO xWHERE_CLAUSE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME AND VENDOR_ID=XVENDOR_ID;
 RETURN NVL(xWHERE_CLAUSE,'');
END GET_WHERE_CLAUSE;

FUNCTION GET_WHERE_CLAUSETEST (XTABLE_NAME IN VARCHAR2)
RETURN VARCHAR2
IS
 xWHERE_CLAUSE CLOB; 
BEGIN
 SELECT REPLACE(MAX(WHERE_CLAUSE),'XDATA_DATE','TRUNC(SYSDATE)') INTO xWHERE_CLAUSE  FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
 RETURN NVL(xWHERE_CLAUSE,'');
END GET_WHERE_CLAUSETEST;

FUNCTION GET_REMOTE_FROM_CLAUSE (XTABLE_NAME IN VARCHAR2,XVENDOR_ID NUMBER) RETURN CLOB
IS
 xREMOTE_CLAUSE CLOB; 
BEGIN
 SELECT FROM_CLAUSE INTO xREMOTE_CLAUSE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME AND VENDOR_ID=XVENDOR_ID;
 RETURN NVL(xREMOTE_CLAUSE,'');
END GET_REMOTE_FROM_CLAUSE;

PROCEDURE CREATE_LOADER_PROCEDURE (XTABLE_NAME IN VARCHAR2)
AS
XSTATEMENT CLOB;
XERROR VARCHAR2(32000);
XERROR_CODE NUMBER;
XEXIST NUMBER;
XLOCAL_FIELDS CLOB;
XREMOTE_FIELDS CLOB; 
XREMOTE_FROM_CLAUSE CLOB;
XWHERE_CLAUSE CLOB;
XVALUES_LOCAL_FIELDS CLOB;
XINSERT_LOCAL_FIELDS CLOB;
XSTATEMENT_ON CLOB;
XTABLE_NAME2 VARCHAR2(100);
XERROR2 LONG;
 BEGIN    
         
         FOR XTABLES IN 
         (
            SELECT VENDOR_ID XVENDOR_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME  ORDER BY VENDOR_ID ASC
         )
         LOOP
            GET_LOCAL_FIELDS(XTABLE_NAME,'NULL',XTABLES.XVENDOR_ID,XLOCAL_FIELDS);
            GET_LOCAL_FIELDS(XTABLE_NAME,'E',XTABLES.XVENDOR_ID, XVALUES_LOCAL_FIELDS);
            GET_LOCAL_FIELDS(XTABLE_NAME,'A',XTABLES.XVENDOR_ID,XINSERT_LOCAL_FIELDS);
            GET_REMOTE_TABLE_FIELDS(XTABLE_NAME,XREMOTE_FIELDS,XTABLES.XVENDOR_ID);
            XREMOTE_FROM_CLAUSE:=NVL(GET_REMOTE_FROM_CLAUSE(XTABLE_NAME,XTABLES.XVENDOR_ID),'');
            XWHERE_CLAUSE :=NVL(GET_WHERE_CLAUSE(XTABLE_NAME,XTABLES.XVENDOR_ID),'');
            XSTATEMENT_ON := RETURN_ON(XTABLE_NAME);
             IF XTABLE_NAME = 'CELLSTS' OR XTABLE_NAME = 'CELLGPRS' OR XTABLE_NAME = 'LCELL_STATISTICS' OR XTABLE_NAME = 'CELL_STATISTICS' OR XTABLE_NAME = 'CELLSTS_5G' OR
                      XTABLE_NAME = 'NODEB_STATISTICS' OR XTABLE_NAME = 'CELLSTS_4G' OR XTABLE_NAME = 'HONBR3TO2' OR XTABLE_NAME = 'HONBR3TO3' OR
                      XTABLE_NAME = 'HONBR4TO2' OR XTABLE_NAME = 'HONBR4TO3' OR XTABLE_NAME = 'HONBR4TO4' THEN
                IF XTABLES.XVENDOR_ID=1 OR XTABLES.XVENDOR_ID=4 OR XTABLES.XVENDOR_ID=5 OR XTABLES.XVENDOR_ID=14 OR XTABLES.XVENDOR_ID=3 OR  XTABLES.XVENDOR_ID=42 OR  XTABLES.XVENDOR_ID=43
                 OR XTABLES.XVENDOR_ID=2 OR XTABLES.XVENDOR_ID=17 OR XTABLES.XVENDOR_ID=18 OR XTABLES.XVENDOR_ID=19 
                 OR XTABLES.XVENDOR_ID=16 OR XTABLES.XVENDOR_ID=20 OR XTABLES.XVENDOR_ID=21 OR  XTABLES.XVENDOR_ID=22  
                 OR  XTABLES.XVENDOR_ID=23 OR  XTABLES.XVENDOR_ID=26  OR  XTABLES.XVENDOR_ID=27 OR  XTABLES.XVENDOR_ID=28 OR XTABLES.XVENDOR_ID=40 OR  XTABLES.XVENDOR_ID=41
                 OR  XTABLES.XVENDOR_ID=29 OR  XTABLES.XVENDOR_ID=30 OR  XTABLES.XVENDOR_ID=31 OR   XTABLES.XVENDOR_ID=32 OR   XTABLES.XVENDOR_ID=33  OR   XTABLES.XVENDOR_ID=34  
                 OR  XTABLES.XVENDOR_ID=6 OR  XTABLES.XVENDOR_ID=7 OR XTABLES.XVENDOR_ID=35 OR XTABLES.XVENDOR_ID=37 OR XTABLES.XVENDOR_ID=38 OR XTABLES.XVENDOR_ID=39 OR XTABLES.XVENDOR_ID=8 OR XTABLES.XVENDOR_ID= 44 OR
                 XTABLES.XVENDOR_ID = 9 OR XTABLES.XVENDOR_ID = 52 OR XTABLES.XVENDOR_ID = 46 OR XTABLES.XVENDOR_ID = 48 OR XTABLES.XVENDOR_ID = 47 OR XTABLES.XVENDOR_ID = 49 OR XTABLES.XVENDOR_ID = 50 THEN
                   
                    IF XTABLES.XVENDOR_ID=5 OR  XTABLES.XVENDOR_ID=14 OR  XTABLES.XVENDOR_ID=31 OR  XTABLES.XVENDOR_ID=32 OR XTABLES.XVENDOR_ID=40 OR  XTABLES.XVENDOR_ID=41 THEN
                        XTABLE_NAME2:=XTABLE_NAME||XTABLES.XVENDOR_ID;
                    ELSE 
                        XTABLE_NAME2:=XTABLE_NAME;
                    END IF;
                    IF XTABLE_NAME = 'HONBR4TO2' THEN 
                    
                    XSTATEMENT := 'CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME2||'(XDATA_DATE IN DATE) AS XREC_COUNT NUMBER; '||CHR(13)||'BEGIN '||
                     CHR(13)||CHR(9)||'INSERT /*+ NO PARALLEL */ INTO NORTHI_DATA.'||XTABLE_NAME||'
                     ('||CHR(13)||CHR(9)||CHR(9)||REPLACE(XLOCAL_FIELDS,'1 DTYPE','DTYPE')||')'
                     ||'SELECT /*+ PARALLEL(8) */ '||CHR(13)||CHR(9)||CHR(9)||
                     XREMOTE_FIELDS||CHR(13)||CHR(9)||'FROM '||XREMOTE_FROM_CLAUSE||CHR(13)||CHR(9)||'WHERE '||XWHERE_CLAUSE||';
                     XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                    'INSERT /*+ APPEND */INTO NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,''LOADER'',XREC_COUNT );'||CHR(13)||CHR(9)||
                    'COMMIT;'||CHR(13)|| 
                    'END;';
                    
                    ELSE 
                    XSTATEMENT := 'CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME2||'(XDATA_DATE IN DATE) AS XREC_COUNT NUMBER; '||CHR(13)||'BEGIN '||
                     CHR(13)||CHR(9)||'INSERT /*+ APPEND PARALLEL(8) */ INTO NORTHI_DATA.'||XTABLE_NAME||'
                     ('||CHR(13)||CHR(9)||CHR(9)||REPLACE(XLOCAL_FIELDS,'1 DTYPE','DTYPE')||')'
                     ||'SELECT /*+ PARALLEL(8) */ '||CHR(13)||CHR(9)||CHR(9)||
                     XREMOTE_FIELDS||CHR(13)||CHR(9)||'FROM '||XREMOTE_FROM_CLAUSE||CHR(13)||CHR(9)||'WHERE '||XWHERE_CLAUSE||';
                     XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                    'INSERT /*+ APPEND */INTO NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,''LOADER'',XREC_COUNT );'||CHR(13)||CHR(9)||
                    'COMMIT;'||CHR(13)|| 
                    'END;';
                    END IF;
                 ELSE-- /*+ PARALLEL(A,16) APPEND */  
                     XSTATEMENT := 'CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME||'(XDATA_DATE IN DATE) AS XREC_COUNT NUMBER; '||CHR(13)||'BEGIN '||
                     CHR(13)||CHR(9)||'MERGE INTO NORTHI_DATA.'||XTABLE_NAME||' A USING ('||CHR(13)||CHR(9)||'SELECT '||CHR(13)||CHR(9)||CHR(9)||
                     XREMOTE_FIELDS||CHR(13)||CHR(9)||'FROM '||XREMOTE_FROM_CLAUSE||CHR(13)||CHR(9)||'WHERE '||XWHERE_CLAUSE||') E'||CHR(13)||CHR(9)||
                    'ON ('||XSTATEMENT_ON||') '||CHR(13)||CHR(9)||'WHEN NOT MATCHED THEN' ||CHR(13)||CHR(9)||
                    'INSERT ('||CHR(13)||CHR(9)||CHR(9)||XINSERT_LOCAL_FIELDS||')'||CHR(13)||CHR(9)|| 
                    'VALUES ('||CHR(13)||CHR(9)||CHR(9)||XVALUES_LOCAL_FIELDS||');'||CHR(13)||CHR(9)||
                    'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                    'INSERT /*+ APPEND */ INTO NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,''LOADER'',XREC_COUNT );'||CHR(13)||CHR(9)||
                    'COMMIT;'||CHR(13)|| 
                    'END;';  
                 END IF;
             ELSE
               IF XTABLES.XVENDOR_ID=1 OR XTABLES.XVENDOR_ID=4 OR XTABLES.XVENDOR_ID=5 OR XTABLES.XVENDOR_ID=14 OR XTABLES.XVENDOR_ID=3 OR  XTABLES.XVENDOR_ID=42 OR  XTABLES.XVENDOR_ID=43
                 OR XTABLES.XVENDOR_ID=2 OR XTABLES.XVENDOR_ID=17 OR XTABLES.XVENDOR_ID=18 OR XTABLES.XVENDOR_ID=19 
                 OR XTABLES.XVENDOR_ID=16 OR XTABLES.XVENDOR_ID=20 OR XTABLES.XVENDOR_ID=21 OR  XTABLES.XVENDOR_ID=22  
                 OR  XTABLES.XVENDOR_ID=23 OR  XTABLES.XVENDOR_ID=26  OR  XTABLES.XVENDOR_ID=27 OR  XTABLES.XVENDOR_ID=28 OR XTABLES.XVENDOR_ID=40 OR  XTABLES.XVENDOR_ID=41
                 OR  XTABLES.XVENDOR_ID=29 OR  XTABLES.XVENDOR_ID=30 OR  XTABLES.XVENDOR_ID=31 OR   XTABLES.XVENDOR_ID=32 OR   XTABLES.XVENDOR_ID=33  OR   XTABLES.XVENDOR_ID=34  
                 OR  XTABLES.XVENDOR_ID=6 OR  XTABLES.XVENDOR_ID=7 OR XTABLES.XVENDOR_ID=35 OR XTABLES.XVENDOR_ID=37 OR XTABLES.XVENDOR_ID=38 OR XTABLES.XVENDOR_ID=39 OR XTABLES.XVENDOR_ID=8 OR XTABLES.XVENDOR_ID= 44 OR
                 XTABLES.XVENDOR_ID = 9 OR XTABLES.XVENDOR_ID = 52 OR XTABLES.XVENDOR_ID = 46 OR XTABLES.XVENDOR_ID = 48 OR XTABLES.XVENDOR_ID = 47 OR XTABLES.XVENDOR_ID = 49 OR XTABLES.XVENDOR_ID = 50 THEN
                   
                    IF XTABLES.XVENDOR_ID=5 OR  XTABLES.XVENDOR_ID=14 OR  XTABLES.XVENDOR_ID=31 OR  XTABLES.XVENDOR_ID=32 OR XTABLES.XVENDOR_ID=40 OR  XTABLES.XVENDOR_ID=41 THEN
                        XTABLE_NAME2:=XTABLE_NAME||XTABLES.XVENDOR_ID;
                    ELSE 
                        XTABLE_NAME2:=XTABLE_NAME;
                    END IF;
                    XSTATEMENT := 'CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME2||'(XDATA_DATE IN DATE) AS XREC_COUNT NUMBER; '||CHR(13)||'BEGIN '||
                     CHR(13)||CHR(9)||'INSERT /*+ APPEND */ INTO NORTHI_DATA.'||XTABLE_NAME||'
                     ('||CHR(13)||CHR(9)||CHR(9)||REPLACE(XLOCAL_FIELDS,'1 DTYPE','DTYPE')||')'
                     ||'SELECT '||CHR(13)||CHR(9)||CHR(9)||
                     XREMOTE_FIELDS||CHR(13)||CHR(9)||'FROM '||XREMOTE_FROM_CLAUSE||CHR(13)||CHR(9)||'WHERE '||XWHERE_CLAUSE||';
                     XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                    'INSERT /*+ APPEND */INTO NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,''LOADER'',XREC_COUNT );'||CHR(13)||CHR(9)||
                    'COMMIT;'||CHR(13)|| 
                    'END;';
                 ELSE-- /*+ PARALLEL(A,16) APPEND */  
                     XSTATEMENT := 'CREATE OR REPLACE PROCEDURE P_'||XTABLE_NAME||'(XDATA_DATE IN DATE) AS XREC_COUNT NUMBER; '||CHR(13)||'BEGIN '||
                     CHR(13)||CHR(9)||'MERGE INTO NORTHI_DATA.'||XTABLE_NAME||' A USING ('||CHR(13)||CHR(9)||'SELECT '||CHR(13)||CHR(9)||CHR(9)||
                     XREMOTE_FIELDS||CHR(13)||CHR(9)||'FROM '||XREMOTE_FROM_CLAUSE||CHR(13)||CHR(9)||'WHERE '||XWHERE_CLAUSE||') E'||CHR(13)||CHR(9)||
                    'ON ('||XSTATEMENT_ON||') '||CHR(13)||CHR(9)||'WHEN NOT MATCHED THEN' ||CHR(13)||CHR(9)||
                    'INSERT ('||CHR(13)||CHR(9)||CHR(9)||XINSERT_LOCAL_FIELDS||')'||CHR(13)||CHR(9)|| 
                    'VALUES ('||CHR(13)||CHR(9)||CHR(9)||XVALUES_LOCAL_FIELDS||');'||CHR(13)||CHR(9)||
                    'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                    'INSERT /*+ APPEND */ INTO NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,''LOADER'',XREC_COUNT );'||CHR(13)||CHR(9)||
                    'COMMIT;'||CHR(13)|| 
                    'END;';  
                 END IF;
             END IF;
             EXECUTE IMMEDIATE XSTATEMENT ;
         END LOOP;
     
   
    SELECT COUNT(TABLE_NAME) INTO XEXIST FROM NORTHI_LOADER_PROCEDURES WHERE TABLE_NAME=XTABLE_NAME;
       
       IF XEXIST=0 THEN
        INSERT INTO NORTHI_LOADER_PROCEDURES(TABLE_NAME,PROCEDURE_NAME,ACTIVE)
        VALUES (XTABLE_NAME,'P_'||XTABLE_NAME,1);
       ELSE 
        UPDATE NORTHI_LOADER_PROCEDURES SET TABLE_NAME=XTABLE_NAME,PROCEDURE_NAME='P_'||XTABLE_NAME,ACTIVE=1
        WHERE TABLE_NAME=XTABLE_NAME;    
       END IF;
       
  EXCEPTION
   WHEN NO_DATA_FOUND THEN
       NULL;
   WHEN OTHERS THEN
   BEGIN
   XERROR:=SUBSTR(SQLERRM,1,32000);
   XERROR_CODE:=SQLCODE;
   XERROR2:=SQLERRM;
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'PREPARE_LOADER_TABLE_PTN',SUBSTR(XSTATEMENT,1,4000));
    
     INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR2,SYSDATE,'PREPARE_LOADER_CREATE_PROC',XSTATEMENT);
    COMMIT;
 END;
 END CREATE_LOADER_PROCEDURE;
 

PROCEDURE PREPARE_LOADER_TABLE_PTN (XTABLE_NAME IN VARCHAR2)
AS
xTABLE_SCRIPT CLOB; 
XSTATEMENT CLOB;
XSTATEMENT2 CLOB;
XERROR VARCHAR2(32000);
XERROR_CODE NUMBER;
XTABLE_EXISTS  NUMBER;
XPARTITION_SCRIPT VARCHAR2(32000);
XPARTITION_VALUE VARCHAR2(2000);
XDATE DATE;
XDATE_STR VARCHAR2(50);
XCNT NUMBER;
XADD NUMBER;
XPARTITION_TYPE NUMBER;
XACTIVE NUMBER;
XDATE_FIELD VARCHAR2(50);
XNE_FIELD VARCHAR2(50);
XLEN NUMBER;
XERROR2 LONG;
BEGIN
    xTABLE_SCRIPT:='';
    XTABLE_EXISTS:=0;
    
    -- Tablo aktif degilse olusturulmuyor.
    SELECT COUNT(*) INTO XACTIVE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1;
    IF XACTIVE=0 THEN 
        RETURN;
    END IF;
    
    -- Belirtilen tablo adi North-I in ayar icin kullandigi tablo adlarinin icindeyse buna izin verilmiyor. 
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM NORTHI_USED_TABLES WHERE TABLE_NAME=XTABLE_NAME;
    IF XTABLE_EXISTS>0 THEN  
        RETURN;
    END IF;
    
    -- Tablo create mi yoksa alter mi edilecek. Karar veriliyor. 
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XTABLE_NAME AND OWNER='NORTHI_DATA';
    XTABLE_EXISTS:=NVL(XTABLE_EXISTS,0);
    IF  XTABLE_EXISTS>0 THEN
        xTABLE_SCRIPT:='';
        FOR XMISSION IN 
          (
            SELECT DISTINCT UPPER(T.LOCAL_FIELD) COLUMN_NAME , T.DATA_TYPE,T.FIELD_LENGTH 
            FROM NORTHI_TABLE_FIELDS T WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 AND TRIM(UPPER(LOCAL_FIELD)) NOT IN(
            SELECT COLUMN_NAME  FROM 
            ALL_TAB_COLUMNS WHERE TABLE_NAME=XTABLE_NAME AND OWNER='NORTHI_DATA'  )
           )
        LOOP
         
          IF XMISSION.DATA_TYPE='VARCHAR2'  AND XTABLE_NAME IN ('CELLSTS_4G') THEN 
          XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
              EXECUTE IMMEDIATE XSTATEMENT; 
          XSTATEMENT2:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||'_TMP ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
              EXECUTE IMMEDIATE XSTATEMENT2;
          ELSIF XMISSION.DATA_TYPE='VARCHAR2'    AND XTABLE_NAME NOT IN ('CELLSTS_4G') THEN
          XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
              EXECUTE IMMEDIATE XSTATEMENT;          
          END IF; 
          

          
          IF  XMISSION.DATA_TYPE<>'VARCHAR2' AND XTABLE_NAME NOT IN ('CELLSTS_4G') THEN
          XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
              EXECUTE IMMEDIATE XSTATEMENT;

          
          ELSIF XMISSION.DATA_TYPE<>'VARCHAR2' AND XTABLE_NAME IN ('CELLSTS_4G') THEN
          XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
              EXECUTE IMMEDIATE XSTATEMENT;
          XSTATEMENT2:=' ALTER TABLE NORTHI_DATA.'||XTABLE_NAME||'_TMP ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
              EXECUTE IMMEDIATE XSTATEMENT2;
          END IF;
        END LOOP;
    END IF;
   IF  XTABLE_EXISTS=0 THEN
         xTABLE_SCRIPT:='';
         FOR XFIELDS IN
         (
             SELECT DISTINCT UPPER(LOCAL_FIELD) LOCAL_FIELD,DATA_TYPE,FIELD_LENGTH FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1
         )
         LOOP
               IF XFIELDS.DATA_TYPE='VARCHAR2' THEN
                    xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.LOCAL_FIELD||' '||XFIELDS.DATA_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
               END IF;
               IF XFIELDS.DATA_TYPE<>'VARCHAR2' THEN
                    xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.LOCAL_FIELD||' '||XFIELDS.DATA_TYPE||' , ';
               END IF;
         END LOOP;
         XLEN := LENGTH(xTABLE_SCRIPT);
     IF LENGTH(xTABLE_SCRIPT)>0 THEN
        XPARTITION_SCRIPT:='';
        FOR XPARTITIONS IN
        (
            SELECT DISTINCT PARTITION_ID,PARTITION_NUMBER
            FROM NORTHI_PARTITION_TYPE
            WHERE PARTITION_ID IN
            (
                SELECT PARTITION_ID
                FROM NORTHI_LOADER_SETTINGS
                WHERE TABLE_NAME=XTABLE_NAME
            )
        )
        LOOP
            XPARTITION_VALUE:='';
           FOR XSUBPARTITION_VALUES IN
           (
             SELECT DTYPE
             FROM NORTHI_PARTITION_TYPE
             WHERE PARTITION_ID=XPARTITIONS.PARTITION_ID AND PARTITION_NUMBER=XPARTITIONS.PARTITION_NUMBER
             AND DTYPE!=0
           )
           LOOP
                XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.DTYPE||',';
           END LOOP;
           IF LENGTH(XPARTITION_VALUE)>0 THEN 
                XPARTITION_SCRIPT:=XPARTITION_SCRIPT||' SUBPARTITION P0_'||XPARTITIONS.PARTITION_NUMBER||' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA,';
           END IF;
        END LOOP;
        XLEN := LENGTH(XPARTITION_SCRIPT);
        IF LENGTH(XPARTITION_SCRIPT)>0 THEN
            xTABLE_SCRIPT:=xTABLE_SCRIPT||' DTYPE NUMBER, ';
            XPARTITION_SCRIPT:=' PARTITION BY RANGE(FRAGMENT_DATE) SUBPARTITION BY LIST(DTYPE) ('||
            --'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TRUNC(SYSDATE,'MONTH'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('11/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            LOGGING  COMPRESS FOR OLTP
            TABLESPACE NORTHI_DATA
            (
                '||SUBSTR(XPARTITION_SCRIPT,1,LENGTH(XPARTITION_SCRIPT)-1)||'
            )
            )';
        ELSE 
            XPARTITION_SCRIPT:=' PARTITION BY RANGE(FRAGMENT_DATE) ('||
            --'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TRUNC(SYSDATE,'MONTH'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('11/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            LOGGING COMPRESS FOR OLTP 
            TABLESPACE NORTHI_DATA
            )';
        END IF;
        xTABLE_SCRIPT:='CREATE TABLE NORTHI_DATA.'||XTABLE_NAME||' ( '||SUBSTR(xTABLE_SCRIPT,1,LENGTH(xTABLE_SCRIPT)-2)||' ) ' 
        ||XPARTITION_SCRIPT;
        XSTATEMENT:=xTABLE_SCRIPT;
        XLEN := LENGTH(XSTATEMENT);
        EXECUTE IMMEDIATE XSTATEMENT;
        SELECT DISTINCT PARTITION_TYPE INTO XPARTITION_TYPE FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN 
        (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME);
        --ADD_TABLE_PARTITION('NORTHI_DATA.'||XTABLE_NAME,XTABLE_NAME,TRUNC(SYSDATE,'MM'),ADD_MONTHS (TRUNC(SYSDATE,'MM'),1),XPARTITION_TYPE);      
        ADD_TABLE_PARTITION('NORTHI_DATA.'||XTABLE_NAME,XTABLE_NAME,TO_DATE('01.11.2015 00','DD.MM.YYYY HH24'),TO_DATE('30.11.2015 23','DD.MM.YYYY HH24'),XPARTITION_TYPE);
      
        SELECT  DATE_FIELD, NE_FIELD INTO XDATE_FIELD,XNE_FIELD FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
        XSTATEMENT:='CREATE INDEX NORTHI_DATA.IDX_'||SUBSTR(XTABLE_NAME,1,23)||'_FN on NORTHI_DATA.'||XTABLE_NAME||' ('||REPLACE(XDATE_FIELD,'PERIOD_START_TIME','FRAGMENT_DATE')||','||XNE_FIELD||') LOCAL PARALLEL 8 NOLOGGING';
        EXECUTE IMMEDIATE XSTATEMENT;
      
     END IF; 
   END IF;
EXCEPTION
 WHEN OTHERS THEN
 BEGIN
   XERROR:=SUBSTR(SQLERRM,1,32000);
   XERROR_CODE:=SQLCODE;
   XERROR2:=SQLERRM;
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'PREPARE_LOADER_TABLE_PTN',SUBSTR(XSTATEMENT,1,4000));
    
     INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR2,SYSDATE,'PREPARE_LOADER_TABLE_PTN',XSTATEMENT);
    COMMIT;
 END;

END PREPARE_LOADER_TABLE_PTN;

PROCEDURE CREATE_AGGREGATE_TABLES (XTABLE_NAME IN VARCHAR2)
AS 
xTABLE_SCRIPT VARCHAR2(32000); 
XDATE_FIELD VARCHAR(400);
XNE_FIELD VARCHAR(400);
XAGGREGATE_TABLE_NAME VARCHAR(50);
XSTATEMENT CLOB;
XTABLE_EXISTS  NUMBER;
XERROR VARCHAR2(32000);
XERROR_CODE NUMBER;
XPARTITION_SCRIPT VARCHAR2(32000);
XPARTITION_VALUE VARCHAR2(400);
BEGIN
    
   FOR XAGGS IN
   (
        SELECT A.AGG_TYPE,A.XLEVEL
        FROM
        (
        SELECT  '15MIN' AGG_TYPE,0 XLEVEL  FROM DUAL UNION ALL
        SELECT 'H' AGG_TYPE,0 XLEVEL  FROM DUAL UNION ALL 
        SELECT 'DA' AGG_TYPE,1 XLEVEL  FROM DUAL UNION ALL 
        SELECT '5WA' AGG_TYPE,7 XLEVEL FROM DUAL UNION ALL 
        SELECT '7WA' AGG_TYPE,7 XLEVEL FROM DUAL UNION ALL 
        SELECT '5MA' AGG_TYPE,30 XLEVEL FROM DUAL UNION ALL 
        SELECT '7MA' AGG_TYPE,30 XLEVEL FROM DUAL
        ) A,NORTHI_LOADER_SETTINGS B
        WHERE TABLE_NAME=XTABLE_NAME
        AND INSTR(B.DATE_AGGREGATE_TYPES,A.AGG_TYPE)>0
   )
    LOOP
    XAGGREGATE_TABLE_NAME:=XTABLE_NAME||'_'||XAGGS.AGG_TYPE;
            
    SELECT COUNT(*) INTO XTABLE_EXISTS FROM ALL_TABLES  WHERE TABLE_NAME = XAGGREGATE_TABLE_NAME AND OWNER='NORTHI_DATA';
    XTABLE_EXISTS:=NVL(XTABLE_EXISTS,0);

    IF  XTABLE_EXISTS>0 THEN
        xTABLE_SCRIPT:='';
        FOR XMISSION IN 
        (
                SELECT  DISTINCT COLUMN_NAME ,DATA_LENGTH FIELD_LENGTH, T.DATA_TYPE
                FROM ALL_TAB_COLUMNS T WHERE TABLE_NAME=XTABLE_NAME AND OWNER='NORTHI_DATA' AND TRIM(COLUMN_NAME) NOT IN(
                SELECT COLUMN_NAME  FROM 
                ALL_TAB_COLUMNS WHERE TABLE_NAME=XAGGREGATE_TABLE_NAME AND OWNER='NORTHI_DATA')
        )
        LOOP
              IF XMISSION.DATA_TYPE='VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||'('||TO_CHAR(XMISSION.FIELD_LENGTH)||' CHAR))';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
              IF XMISSION.DATA_TYPE<>'VARCHAR2' THEN
              XSTATEMENT:=' ALTER TABLE NORTHI_DATA.'||XAGGREGATE_TABLE_NAME||' ADD ('||XMISSION.COLUMN_NAME||' '||XMISSION.DATA_TYPE||')';
                  EXECUTE IMMEDIATE XSTATEMENT;
              END IF;
        END LOOP;
    END IF;
                            
                                
    IF  XTABLE_EXISTS=0 THEN
         xTABLE_SCRIPT:='';
         FOR XFIELDS IN
         (
            SELECT DISTINCT UPPER(LOCAL_FIELD) LOCAL_FIELD,DATA_TYPE,FIELD_LENGTH FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1
         )
          LOOP
               IF XFIELDS.DATA_TYPE='VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.LOCAL_FIELD||' '||XFIELDS.DATA_TYPE||'('||TO_CHAR(XFIELDS.FIELD_LENGTH)||' CHAR), ';
               END IF;
               IF XFIELDS.DATA_TYPE<>'VARCHAR2' THEN
                xTABLE_SCRIPT:=xTABLE_SCRIPT||XFIELDS.LOCAL_FIELD||' '||XFIELDS.DATA_TYPE||', ';
               END IF;
          END LOOP;
     IF LENGTH(xTABLE_SCRIPT)>0 THEN
        XPARTITION_SCRIPT:='';
        FOR XPARTITIONS IN
        (
            SELECT DISTINCT PARTITION_ID,PARTITION_NUMBER
            FROM NORTHI_PARTITION_TYPE
            WHERE PARTITION_ID IN
            (
                SELECT PARTITION_ID
                FROM NORTHI_LOADER_SETTINGS
                WHERE TABLE_NAME=XTABLE_NAME
            )
        )
        LOOP
            XPARTITION_VALUE:='';
           FOR XSUBPARTITION_VALUES IN
           (
             SELECT DTYPE
             FROM NORTHI_PARTITION_TYPE
             WHERE PARTITION_ID=XPARTITIONS.PARTITION_ID AND PARTITION_NUMBER=XPARTITIONS.PARTITION_NUMBER
             AND DTYPE!=0
           )
           LOOP
                XPARTITION_VALUE:=XPARTITION_VALUE||XSUBPARTITION_VALUES.DTYPE||',';
           END LOOP;
           IF LENGTH(XPARTITION_VALUE)>0 THEN 
                XPARTITION_SCRIPT:=XPARTITION_SCRIPT||' SUBPARTITION P0_'||XPARTITIONS.PARTITION_NUMBER||' VALUES('||SUBSTR(XPARTITION_VALUE,1,LENGTH(XPARTITION_VALUE)-1)||') TABLESPACE NORTHI_DATA,';
           END IF;
        END LOOP;
        
        IF LENGTH(XPARTITION_SCRIPT)>0 THEN
            xTABLE_SCRIPT:=xTABLE_SCRIPT||' DTYPE NUMBER, ';
            XPARTITION_SCRIPT:=' PARTITION BY RANGE(FRAGMENT_DATE) SUBPARTITION BY LIST(DTYPE) ('||
            --'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TRUNC(SYSDATE,'MONTH'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('11/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            LOGGING 
            TABLESPACE NORTHI_DATA
            (
                '||SUBSTR(XPARTITION_SCRIPT,1,LENGTH(XPARTITION_SCRIPT)-1)||'
            )
            )';
        ELSE 
            XPARTITION_SCRIPT:=' PARTITION BY RANGE(FRAGMENT_DATE) ('||
            --'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TRUNC(SYSDATE,'MONTH'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            'PARTITION TABLE_PARTITION_0 VALUES LESS THAN (TO_DATE('''|| TO_CHAR (TO_DATE('11/01/2015 00','MM/DD/YYYY HH24'), 'MM/DD/YYYY HH24')|| ''',''MM/DD/YYYY HH24''))
            LOGGING 
            TABLESPACE NORTHI_DATA
            )';
        END IF;       
        xTABLE_SCRIPT:='CREATE TABLE NORTHI_DATA.'||XAGGREGATE_TABLE_NAME||' ( '||SUBSTR(xTABLE_SCRIPT,1,LENGTH(xTABLE_SCRIPT)-2)||' ) ' 
        ||XPARTITION_SCRIPT;
        XSTATEMENT:=xTABLE_SCRIPT;
        EXECUTE IMMEDIATE XSTATEMENT;
               
        --ADD_TABLE_PARTITION('NORTHI_DATA.'||XAGGREGATE_TABLE_NAME,XTABLE_NAME,TRUNC(SYSDATE,'MM'),ADD_MONTHS (TRUNC(SYSDATE,'MM'),1),XAGGS.XLEVEL);
        ADD_TABLE_PARTITION('NORTHI_DATA.'||XAGGREGATE_TABLE_NAME,XTABLE_NAME,TO_DATE('01.11.2015 00','DD.MM.YYYY HH24'),TO_DATE('30.11.2015 23','DD.MM.YYYY HH24'),XAGGS.XLEVEL);
        
        SELECT  DISTINCT DATE_FIELD, NE_FIELD INTO XDATE_FIELD,XNE_FIELD FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
        XSTATEMENT:='CREATE INDEX NORTHI_DATA.IDX_'||SUBSTR(XAGGREGATE_TABLE_NAME,1,23)||'_FN on NORTHI_DATA.'||XAGGREGATE_TABLE_NAME||' ('||REPLACE(XDATE_FIELD,'PERIOD_START_TIME','FRAGMENT_DATE')||','||XNE_FIELD||') LOCAL PARALLEL 16 NOLOGGING';
        EXECUTE IMMEDIATE XSTATEMENT;
        
     END IF;
    END IF;
   END LOOP;
   EXCEPTION
 WHEN OTHERS THEN
 BEGIN
   XERROR:=SUBSTR(SQLERRM,1,32000);
   XERROR_CODE:=SQLCODE;
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'CREATE_AGGREGATE_TABLE',SUBSTR(XSTATEMENT,1,32000));
 END;
END CREATE_AGGREGATE_TABLES;

PROCEDURE CREATE_DATE_AGG_PROCEDURE (XTABLE_NAME IN VARCHAR2)
AS 
XSTATEMENT CLOB;
XAGGREGATE_PROCEDURE_NAME VARCHAR(50);
XAGGREGATION_FIELDS CLOB;
XAGGREGATE_TYPE VARCHAR(40);
XLOCAL_FIELDS CLOB;
XDTYPE NUMBER;
XDTYPE_STR VARCHAR2(10);
XDIRECT_LOAD_FIELDS CLOB;
XFROM_CLAUSE VARCHAR2(32000);
XLOAD_TYPE NUMBER;
XDATE_FIELD VARCHAR2(40);
XWHERE_CLAUSE VARCHAR2(32000);
XINSERT_TABLE_NAME VARCHAR2(1000);
XGROUP_COND VARCHAR2(1000);
V_STATEMENT CLOB;
BEGIN
    
    XDTYPE_STR:='';
    SELECT SUM(PARTITION_NUMBER) INTO XDTYPE FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME);
    IF XDTYPE>0 THEN XDTYPE_STR:=',DTYPE'; END IF;
    
    FOR XAGGREGATE IN 
    (
         SELECT DISTINCT TABLE_NAME,A.AGG_TYPE,A.XLEVEL,A.SD,A.ED
        FROM 
        (
        SELECT                   '5MIN'    AGG_TYPE,      0  XLEVEL     ,'XDATA_DATE' SD ,                  'XDATA_DATE+0.083/24' ED FROM DUAL
                UNION ALL SELECT '15MIN'   AGG_TYPE,      0  XLEVEL     ,'XDATA_DATE' SD ,                  'XDATA_DATE+0.2498/24' ED FROM DUAL    
                UNION ALL SELECT 'H'   AGG_TYPE,      0  XLEVEL     ,'XDATA_DATE' SD ,                  'XDATA_DATE+0.99/24' ED FROM DUAL
                UNION ALL SELECT 'DA'  AGG_TYPE,      1  XLEVEL     ,'TRUNC(XDATA_DATE)' SD       ,     '(TRUNC(XDATA_DATE)+1)-0.01/24' ED FROM DUAL 
                UNION ALL SELECT '5WA' AGG_TYPE,      7  XLEVEL     ,'TRUNC(XDATA_DATE,''DAY'')' SD ,   '(TRUNC(XDATA_DATE,''DAY'')+5)-0.01/24' FROM DUAL 
                UNION ALL SELECT '7WA' AGG_TYPE,      7  XLEVEL     ,'TRUNC(XDATA_DATE,''DAY'')' SD ,   '(TRUNC(XDATA_DATE,''DAY'')+7)-0.01/24' FROM DUAL 
                UNION ALL SELECT '7MA' AGG_TYPE,      30 XLEVEL     ,'TRUNC(XDATA_DATE,''MONTH'')' SD,  'ADD_MONTHS(TRUNC(XDATA_DATE),1)-0.01/24' FROM DUAL 
                UNION ALL SELECT '5MA' AGG_TYPE,      30 XLEVEL     ,'TRUNC(XDATA_DATE,''MONTH'')' SD,  'ADD_MONTHS(TRUNC(XDATA_DATE),1)-0.01/24 AND TO_CHAR(FRAGMENT_DATE,''D'') NOT IN (6,7)'  FROM DUAL
        ) A,
        (
        SELECT TABLE_NAME , REGEXP_SUBSTR(replace(DATE_AGGREGATE_TYPES,'''',''), '[^,]+', 1, LEVEL) AGGREGATE_TYPE
        FROM (SELECT * 
        FROM NORTHI_LOADER.NORTHI_LOADER_SETTINGS 
                WHERE TABLE_NAME= XTABLE_NAME )
        CONNECT BY REGEXP_SUBSTR(replace(DATE_AGGREGATE_TYPES,'''',''), '[^,]+', 1, LEVEL) IS NOT NULL
        ) B
        WHERE A.AGG_TYPE = B.AGGREGATE_TYPE
    )
    LOOP
       
       V_STATEMENT:='';
       XAGGREGATE_PROCEDURE_NAME:='P_'||XTABLE_NAME||'_'||XAGGREGATE.AGG_TYPE;
       GET_AGGREGATE_FIELDS(XTABLE_NAME,'NULL',XLOCAL_FIELDS,XGROUP_COND);
       GET_DATE_AGGREGATE(XTABLE_NAME,XAGGREGATION_FIELDS,XDIRECT_LOAD_FIELDS);
       
       --SELECT FROM_CLAUSE,LOAD_TYPE,DATE_FIELD,WHERE_CLAUSE INTO XFROM_CLAUSE,XLOAD_TYPE,XDATE_FIELD,XWHERE_CLAUSE FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME;
       
       -- IF XAGGREGATE.AGG_TYPE='H' THEN
       -- XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;
       -- XWHERE_CLAUSE:=XWHERE_CLAUSE||' AND ';
       -- ELSE 
       

       
       /* Tmp eklendigi icin cilarildi.
       
       XFROM_CLAUSE:='NORTHI_DATA.'||XTABLE_NAME||' A ';
        XWHERE_CLAUSE:='';*/ 
       --END IF;

             -- CELLSTS_4G_TMP icin ayarlandi.
       IF (XAGGREGATE.AGG_TYPE='5WA' OR XAGGREGATE.AGG_TYPE='5MA' OR XAGGREGATE.AGG_TYPE='7WA' OR XAGGREGATE.AGG_TYPE='7MA') THEN
        XFROM_CLAUSE:='NORTHI_DATA.'||XTABLE_NAME||'_DA A ';
        XWHERE_CLAUSE:='';
       ELSIF XAGGREGATE.AGG_TYPE='DA' AND XTABLE_NAME IN ('CELLSTS_4G') THEN
        XFROM_CLAUSE:='NORTHI_DATA.'||XTABLE_NAME||'_TMP A ';
        XWHERE_CLAUSE:='';
       ELSE XFROM_CLAUSE:='NORTHI_DATA.'||XTABLE_NAME||' A ';
         XWHERE_CLAUSE:='';
       END IF;
       --/*+ PARALLEL(A,16) APPEND */

       XINSERT_TABLE_NAME:=XTABLE_NAME ||'_'||XAGGREGATE.AGG_TYPE;
       V_STATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
       CHR(13)||'BEGIN'||
       CHR(13)||CHR(9)||'INSERT  /*+ APPEND */ INTO NORTHI_DATA.'||XTABLE_NAME ||'_'||XAGGREGATE.AGG_TYPE||
       CHR(13)||CHR(9)||'('||
       CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||',NETWORK_ID'||XDTYPE_STR||',FRAGMENT_DATE'||
       CHR(13)||CHR(9)||')'||
       CHR(13)||CHR(9)||'SELECT '||
       CHR(13)||CHR(9)||CHR(9)|| XAGGREGATION_FIELDS|| ',NETWORK_ID'||XDTYPE_STR||',XDATA_DATE '||
       CHR(13)||CHR(9)||' FROM '||XFROM_CLAUSE|| 
       CHR(13)||CHR(9)||' WHERE '||XWHERE_CLAUSE||' FRAGMENT_DATE BETWEEN '||XAGGREGATE.SD||' AND '||XAGGREGATE.ED||
       CHR(13)||CHR(9)||' GROUP BY NETWORK_ID'||XDTYPE_STR||',XDATA_DATE'||XGROUP_COND||' ;'||
       CHR(13)||CHR(13)||CHR(9)||'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
       'INSERT /*+ APPEND */ INTO NORTHI_LOADER.NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XINSERT_TABLE_NAME||''',XDATA_DATE,'''||XAGGREGATE.AGG_TYPE||''',XREC_COUNT );'||CHR(13)||CHR(9)||
       'COMMIT;'||CHR(13)|| 
       CHR(13)||'END;';
              
       EXECUTE IMMEDIATE V_STATEMENT ;
       
    END LOOP;
   EXCEPTION
   WHEN NO_DATA_FOUND THEN
   NULL;
   WHEN OTHERS THEN
   BEGIN
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,'PCD',SUBSTR('ASD',1,32000),SYSDATE,'CREATE_LOADER_PROCEDURE2',SUBSTR(V_STATEMENT,1,32000));
   END;
END CREATE_DATE_AGG_PROCEDURE;
PROCEDURE CREATE_TYPE_AGG_PROCEDUREX (XTABLE_NAME IN VARCHAR2)
AS 
XSTATEMENT CLOB;
XAGGREGATE_PROCEDURE_NAME VARCHAR(60);
XAGGREGATION_FIELDS CLOB;
XDIRECT_LOAD_FIELDS CLOB;
XAGGREGATE_TYPE VARCHAR(40);
XLOCAL_FIELDS CLOB;
--XFROM_CLAUSE VARCHAR2(4000);
--XLOAD_TYPE NUMBER;
--XDATE_FIELD VARCHAR2(40);
XWHERE_CLAUSE VARCHAR2(4000);
XWHERE VARCHAR2(10000);
--XVENDOR_ID NUMBER;
--XWHERE_CL VARCHAR2(4000);
XDATE_COND VARCHAR2(300);
XSELECT_COND VARCHAR2(300);
XEXTRA_COLS VARCHAR2(10000);
XGROUP_COND VARCHAR2(1000);
XDTYPE_STR VARCHAR2(40);
XDTYPE NUMBER;
V_SQLERRM   CLOB;
V_STATE     VARCHAR2(100);
V_SQLCODE   NUMBER;
V_STATEMENT CLOB;
BEGIN
    
    XDTYPE_STR:='';
    SELECT SUM(PARTITION_NUMBER) INTO XDTYPE FROM NORTHI_PARTITION_TYPE WHERE PARTITION_ID IN (SELECT PARTITION_ID FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME);
    IF XDTYPE>0 AND XTABLE_NAME!='NWSTS'  THEN
    XDTYPE_STR:=',DTYPE'; 
    END IF;
    --INTO XFROM_CLAUSE,XLOAD_TYPE,XDATE_FIELD,XVENDOR_ID,XWHERE_CL
    FOR XLOOP IN 
    (
        SELECT FROM_CLAUSE XFROM_CLAUSE,LOAD_TYPE XLOAD_TYPE,DATE_FIELD XDATE_FIELD,VENDOR_ID XVENDOR_ID,DECODE(NVL(LENGTH(WHERE_CLAUSE),0),0,'',' AND '||WHERE_CLAUSE) XWHERE_CL 
        FROM NORTHI_LOADER_SETTINGS WHERE TABLE_NAME=XTABLE_NAME 
    ) LOOP
    
        FOR XAGGREGATE IN 
        (
            SELECT PARTITION_ID,PARTITION_NUMBER,PARTITION_VALUE,DTYPE,PARTITION_TYPE,SUBSTR(AUXILIARY_COLUMN,1,INSTR(AUXILIARY_COLUMN,'!',1,1)-1) XSELECT,
            SUBSTR(AUXILIARY_COLUMN,INSTR(AUXILIARY_COLUMN,'!',1,1)+1,INSTR(AUXILIARY_COLUMN,'!',1,2)-INSTR(AUXILIARY_COLUMN,'!',1,1)-1) XFROM,
            SUBSTR(AUXILIARY_COLUMN,INSTR(AUXILIARY_COLUMN,'!',1,2)+1,INSTR(AUXILIARY_COLUMN,'!',1,3)-INSTR(AUXILIARY_COLUMN,'!',1,2)-1) XWHERE,
            SUBSTR(AUXILIARY_COLUMN,INSTR(AUXILIARY_COLUMN,'!',1,3)+1,INSTR(AUXILIARY_COLUMN,'!',1,4)-INSTR(AUXILIARY_COLUMN,'!',1,3)-1) XGROUP_BY,
            --DECODE(INSTR(AUXILIARY_COLUMN,'||'),0,SUBSTR(SUBSTR(SUBSTR(AUXILIARY_COLUMN,1,INSTR(AUXILIARY_COLUMN,'!')-1),1,
            --INSTR(SUBSTR(AUXILIARY_COLUMN,1,INSTR(AUXILIARY_COLUMN,'!')-1),'NETWORK_ID')-1),1,
            --INSTR(SUBSTR(SUBSTR(AUXILIARY_COLUMN,1,INSTR(AUXILIARY_COLUMN,'!')-1),1,INSTR(SUBSTR(AUXILIARY_COLUMN,1,INSTR(AUXILIARY_COLUMN,'!')-1),'NETWORK_ID')-1),',',-1,1)-1)) 
            DECODE(
             INSTR(DECODE (INSTR (AUXILIARY_COLUMN, '||'),0,SUBSTR (SUBSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),1,INSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),'NETWORK_ID')- 1),1,
             INSTR (SUBSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),1,INSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),'NETWORK_ID')- 1),',',-1,1)- 1)),'DECODE'),0,DECODE (INSTR (AUXILIARY_COLUMN, '||'),0,
             SUBSTR (SUBSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),1,INSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),'NETWORK_ID')- 1),1,
             INSTR (SUBSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),1,INSTR (SUBSTR (AUXILIARY_COLUMN,1,INSTR (AUXILIARY_COLUMN, '!') - 1),'NETWORK_ID')- 1),',',-1,1)- 1)),'') XINSERT,
            XINSERT2,
            AUXILIARY_COLUMN FROM 
            NORTHI_PARTITION_TYPE
            WHERE PARTITION_ID IN(
            SELECT PARTITION_ID 
            FROM NORTHI_LOADER_SETTINGS 
            WHERE TABLE_NAME=XTABLE_NAME
            )
            AND AUXILIARY_COLUMN IS  NOT NULL  
            ORDER BY DTYPE
        )
        LOOP 
            IF (XLOOP.XVENDOR_ID=31 AND XAGGREGATE.DTYPE=1)
                OR
                XLOOP.XVENDOR_ID IN (4,3,32,1,5,30,28,23,26,33,29,21,22,27,17,16,6,37,38,39,34,28,40,41,8,7,42,43,44,9,46,48,47,49,50,52) OR (XLOOP.XVENDOR_ID=32 AND XAGGREGATE.DTYPE=1)
--                (XLOOP.XVENDOR_ID=4)  OR (XLOOP.XVENDOR_ID=3) OR (XLOOP.XVENDOR_ID=32 AND XAGGREGATE.DTYPE=1) OR (XLOOP.XVENDOR_ID=1)  OR  (XLOOP.XVENDOR_ID=5) OR (XLOOP.XVENDOR_ID=30)  OR (XLOOP.XVENDOR_ID=28)  OR (XLOOP.XVENDOR_ID=23)  OR (XLOOP.XVENDOR_ID=26) 
--                OR (XLOOP.XVENDOR_ID=33) OR (XLOOP.XVENDOR_ID=29) OR (XLOOP.XVENDOR_ID=21) OR (XLOOP.XVENDOR_ID=22) OR (XLOOP.XVENDOR_ID=27) OR (XLOOP.XVENDOR_ID=17) OR (XLOOP.XVENDOR_ID=16) OR (XLOOP.XVENDOR_ID=6)  OR (XLOOP.XVENDOR_ID=37) OR (XLOOP.XVENDOR_ID=38) OR (XLOOP.XVENDOR_ID=39) OR (XLOOP.XVENDOR_ID=34) 
--                OR (XLOOP.XVENDOR_ID=28) OR (XLOOP.XVENDOR_ID=40) OR (XLOOP.XVENDOR_ID=41) OR (XLOOP.XVENDOR_ID=8) OR (XLOOP.XVENDOR_ID=7)
                    THEN
                   IF (XLOOP.XVENDOR_ID IN (4,17,18,19,16,23,6,3,7,26,27,29,30,31,33,37,38,39,34,8,42,43,44,9,46,48,47,49,50,52))
--                   (XLOOP.XVENDOR_ID=4 OR XLOOP.XVENDOR_ID=17 OR XLOOP.XVENDOR_ID=18 OR XLOOP.XVENDOR_ID=19 OR XLOOP.XVENDOR_ID=16  OR XLOOP.XVENDOR_ID=23  OR XLOOP.XVENDOR_ID=6 OR XLOOP.XVENDOR_ID=3  OR XLOOP.XVENDOR_ID=7
--                    OR XLOOP.XVENDOR_ID=26 OR XLOOP.XVENDOR_ID=27  OR XLOOP.XVENDOR_ID=29 OR XLOOP.XVENDOR_ID=30  OR XLOOP.XVENDOR_ID=31 OR XLOOP.XVENDOR_ID=33 OR XLOOP.XVENDOR_ID=37 OR XLOOP.XVENDOR_ID=38
--                      OR XLOOP.XVENDOR_ID=39 OR XLOOP.XVENDOR_ID=34 OR XLOOP.XVENDOR_ID=8 )  
                    AND (XAGGREGATE.DTYPE=1 OR XAGGREGATE.DTYPE=0)  THEN
V_STATE := '1';
                        GET_DATE_AGGREGATE2XX(XLOOP.XVENDOR_ID,XTABLE_NAME,XAGGREGATION_FIELDS,XDIRECT_LOAD_FIELDS);
V_STATE := '11';
                        
                        GET_AGGREGATE_FIELDS2XX(XLOOP.XVENDOR_ID,XTABLE_NAME,'NULL',XLOCAL_FIELDS,XGROUP_COND);
V_STATE := '12';
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_0', XLOCAL_FIELDS);
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_0', XGROUP_COND);
--    COMMIT;
           
                    ELSIF
                        XLOOP.XVENDOR_ID IN (17,18,19,16,23,26,27,29,30,33,37,38,39,8,43,44,46,48,49,50)
--                        (XLOOP.XVENDOR_ID=17 OR XLOOP.XVENDOR_ID=18 OR XLOOP.XVENDOR_ID=19 OR XLOOP.XVENDOR_ID=16  OR XLOOP.XVENDOR_ID=23 
--                     OR XLOOP.XVENDOR_ID=26 OR XLOOP.XVENDOR_ID=27 OR XLOOP.XVENDOR_ID=29 OR XLOOP.XVENDOR_ID=30 OR XLOOP.XVENDOR_ID=33 OR XLOOP.XVENDOR_ID=37 OR XLOOP.XVENDOR_ID=38 OR XLOOP.XVENDOR_ID=39 OR XLOOP.XVENDOR_ID=34  OR XLOOP.XVENDOR_ID=8  )
                     AND XAGGREGATE.DTYPE>1 THEN
V_STATE := '2'; 
                        GET_TYPE_AGGREGATEXX(XLOOP.XVENDOR_ID,XTABLE_NAME,XAGGREGATION_FIELDS,XDIRECT_LOAD_FIELDS);
V_STATE := '21';

                        GET_AGGREGATE_FIELDS2XX(XLOOP.XVENDOR_ID,XTABLE_NAME,'NULL',XLOCAL_FIELDS,XGROUP_COND);
                      
                    ELSIF XLOOP.XVENDOR_ID=4  AND  XAGGREGATE.DTYPE>=1 THEN
V_STATE := '3';
                        GET_TYPE_AGGREGATE(XLOOP.XVENDOR_ID,XTABLE_NAME,XAGGREGATION_FIELDS,XDIRECT_LOAD_FIELDS);
V_STATE := '31';

                        GET_AGGREGATE_FIELDS2(XLOOP.XVENDOR_ID,XTABLE_NAME,'NULL',XLOCAL_FIELDS,XGROUP_COND);
V_STATE := '32'; 
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_1',XLOCAL_FIELDS);
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_1',XGROUP_COND);
--    COMMIT;
                    
                    ELSE 
V_STATE := '41';
                        GET_TYPE_AGGREGATE(XLOOP.XVENDOR_ID,XTABLE_NAME,XAGGREGATION_FIELDS,XDIRECT_LOAD_FIELDS);
V_STATE := '42';

                        GET_AGGREGATE_FIELDS2(XLOOP.XVENDOR_ID,XTABLE_NAME,'NULL',XLOCAL_FIELDS,XGROUP_COND);
V_STATE := '43';
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_2',XLOCAL_FIELDS);
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_2',XGROUP_COND);
--    COMMIT;
                    END IF;
                    
                    IF XLOOP.XLOAD_TYPE=2 AND (XAGGREGATE.DTYPE=1 OR XAGGREGATE.DTYPE=0) 
                    AND XLOOP.XVENDOR_ID IN (3,4,17,18,19,16,23,8,26,27,29,30,31,33,34,37,38,39,40,44,46,48,49,50) THEN
--                    AND (XLOOP.XVENDOR_ID=4 OR XLOOP.XVENDOR_ID=17 OR XLOOP.XVENDOR_ID=18 OR XLOOP.XVENDOR_ID=19 OR XLOOP.XVENDOR_ID=16 OR XLOOP.XVENDOR_ID=23 OR XLOOP.XVENDOR_ID=8 
--                    OR XLOOP.XVENDOR_ID=26 OR XLOOP.XVENDOR_ID=27 OR XLOOP.XVENDOR_ID=29 OR XLOOP.XVENDOR_ID=30 OR XLOOP.XVENDOR_ID=31 OR XLOOP.XVENDOR_ID=33 OR XLOOP.XVENDOR_ID=37 OR XLOOP.XVENDOR_ID=38 OR XLOOP.XVENDOR_ID=39) THEN
V_STATE := '5';
                        XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;
                    ELSIF XLOOP.XLOAD_TYPE=2 AND XLOOP.XVENDOR_ID=2 THEN
V_STATE := '6';
                        XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;
--                    ELSIF XLOOP.XLOAD_TYPE=2 AND (XLOOP.XVENDOR_ID=28 OR XLOOP.XVENDOR_ID=40 OR XLOOP.XVENDOR_ID=41 ) THEN
--                        XAGGREGATION_FIELDS:=XDIRECT_LOAD_FIELDS;    
                    ELSE
                        XLOOP.XFROM_CLAUSE:='NORTHI_DATA.'||XTABLE_NAME|| ' A ';
                    END IF;
                    
--    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--    VALUES (USER,XTABLE_NAME,NULL,'NULL',SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_3',XGROUP_COND);
--    COMMIT;
                   
                
                   XWHERE:='';
                   
                   
                   IF LENGTH(XAGGREGATE.XWHERE)>0 THEN
V_STATE := '7';
                    XDATE_COND:=','||XLOOP.XDATE_FIELD;
                    XSELECT_COND:=','||XLOOP.XDATE_FIELD||' FRAGMENT_DATE ';
                    XWHERE_CLAUSE := XLOOP.XDATE_FIELD||'=XDATA_DATE';
                    XWHERE := XWHERE_CLAUSE || ' AND ' ||  XAGGREGATE.XWHERE;
                    XEXTRA_COLS:= XAGGREGATE.XSELECT||XSELECT_COND;

                   ELSIF
                   XLOOP.XVENDOR_ID IN (3,4,17,18,19,16,21,23,26,8,7,27,28,29,30,31,33,34,37,38,39,40,44,46,48,49,50)
--                   (XLOOP.XVENDOR_ID=4 OR XLOOP.XVENDOR_ID=17 OR XLOOP.XVENDOR_ID=18 OR XLOOP.XVENDOR_ID=19 OR XLOOP.XVENDOR_ID=16 OR XLOOP.XVENDOR_ID=21 OR XLOOP.XVENDOR_ID=23 OR XLOOP.XVENDOR_ID=26 OR XLOOP.XVENDOR_ID=8 OR XLOOP.XVENDOR_ID=7
--                   OR XLOOP.XVENDOR_ID=27 OR XLOOP.XVENDOR_ID=28 OR XLOOP.XVENDOR_ID=29 OR XLOOP.XVENDOR_ID=30  OR XLOOP.XVENDOR_ID=31  OR XLOOP.XVENDOR_ID=33 OR XLOOP.XVENDOR_ID=37 OR XLOOP.XVENDOR_ID=38 OR XLOOP.XVENDOR_ID=39) 
                   AND (XAGGREGATE.DTYPE=1 OR  XAGGREGATE.DTYPE=0) THEN
V_STATE := '71';
                    XDATE_COND:='';
                    XWHERE_CLAUSE := ' A.DATA_DATE BETWEEN TRUNC(XDATA_DATE,''HH24'') AND TRUNC(XDATA_DATE,''HH24'')+0.8/24 ';

                    IF XLOOP.XVENDOR_ID = 40 THEN  -- VENDOR_ID 40 olanin date kolonu datetime olarak geldiginden
                        XWHERE_CLAUSE   := REPLACE(XWHERE_CLAUSE,'A.DATA_DATE','A.DATETIME');
                    END IF;
                    
                     IF XLOOP.XVENDOR_ID = 44 THEN  -- VENDOR_ID 44 olanin date kolonu datetime olarak geldiginden
                        XWHERE_CLAUSE   := ' A.DATA_DATE BETWEEN TRUNC(XDATA_DATE,''HH24'') AND TRUNC(XDATA_DATE,''HH24'')+0.999/24 ';
                    END IF;

                    XWHERE := XWHERE_CLAUSE || XLOOP.XWHERE_CL;
                    XEXTRA_COLS:=XAGGREGATE.XSELECT;

                   ELSE
V_STATE := '72';
                    XDATE_COND:=','||XLOOP.XDATE_FIELD;
                    XSELECT_COND:=','||XLOOP.XDATE_FIELD||' FRAGMENT_DATE ';
                    XWHERE_CLAUSE := XLOOP.XDATE_FIELD||'=XDATA_DATE';
                    XWHERE := XWHERE_CLAUSE;
                    XEXTRA_COLS:=XAGGREGATE.XSELECT||XSELECT_COND;

                   END IF;
                   V_STATEMENT:='';
                   IF XLOOP.XVENDOR_ID=31 AND XAGGREGATE.DTYPE=1 THEN
V_STATE := '73';
                    XAGGREGATE_PROCEDURE_NAME:='P_'||XTABLE_NAME||'_'||XAGGREGATE.PARTITION_VALUE||'31';
                   ELSE
V_STATE := '74';
                    XAGGREGATE_PROCEDURE_NAME:='P_'||XTABLE_NAME||'_'||XAGGREGATE.PARTITION_VALUE;
                   END IF;
            --/*+ PARALLEL(A,16) APPEND */
V_STATE := '741';
                    IF XTABLE_NAME = 'CELLSTS' OR XTABLE_NAME = 'CELLGPRS' OR XTABLE_NAME = 'LCELL_STATISTICS' OR XTABLE_NAME = 'CELL_STATISTICS' OR
                      XTABLE_NAME = 'NODEB_STATISTICS' OR XTABLE_NAME = 'CELLSTS_4G' OR XTABLE_NAME = 'CELLSTS_5G' OR XTABLE_NAME = 'HONBR3TO2' OR XTABLE_NAME = 'HONBR3TO3' OR
                      XTABLE_NAME = 'HONBR4TO2' OR XTABLE_NAME = 'HONBR4TO3' OR XTABLE_NAME = 'HONBR4TO4'  THEN
                      
                       V_STATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
                       CHR(13)||'BEGIN'||
                       CHR(13)||CHR(9)||'INSERT 
                       /*+ APPEND PARALLEL(8) */ INTO NORTHI_DATA.'||XTABLE_NAME ||
                       CHR(13)||CHR(9)||'('||
                       CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||XAGGREGATE.XINSERT||XAGGREGATE.XINSERT2||',NETWORK_ID'||XDTYPE_STR||',FRAGMENT_DATE'||
                       CHR(13)||CHR(9)||')'||
                       CHR(13)||CHR(9)||'SELECT /*+ PARALLEL(8) */ '||
                       CHR(13)||CHR(9)||CHR(9)||XAGGREGATION_FIELDS|| XEXTRA_COLS ||
                       CHR(13)||CHR(9)||' FROM '||XLOOP.XFROM_CLAUSE||XAGGREGATE.XFROM|| 
                       CHR(13)||CHR(9)||' WHERE '|| XWHERE ||
                       CHR(13)||CHR(9)||' GROUP BY '||XAGGREGATE.XGROUP_BY||XDATE_COND||' ;'||
                       CHR(13)||CHR(13)||CHR(9)||'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                       'INSERT /*+ APPEND */ INTO NORTHI_LOADER.NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,'''||XAGGREGATE.PARTITION_VALUE||''',XREC_COUNT );'||CHR(13)||CHR(9)||
                       'COMMIT;'||CHR(13)|| 
                       CHR(13)||'END;';
                       
                   ELSIF XTABLE_NAME = 'CELL_STATISTICS' THEN --3G TARAFINDA TAKILI KALMA PROBLEMINDEN DOLAYI 25.01.2024 TARIHINDE ACS ONERISIYLE SORGUYA HINT EKLENDI...
                   
                        V_STATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
                       CHR(13)||'BEGIN'||
                       CHR(13)||CHR(9)||'INSERT 
                       /*+ APPEND PARALLEL(8) */ INTO NORTHI_DATA.'||XTABLE_NAME ||
                       CHR(13)||CHR(9)||'('||
                       CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||XAGGREGATE.XINSERT||XAGGREGATE.XINSERT2||',NETWORK_ID'||XDTYPE_STR||',FRAGMENT_DATE'||
                       CHR(13)||CHR(9)||')'||
                       CHR(13)||CHR(9)||'SELECT /*+ NO_USE_NL(A,B,C,D,E,F,G,H) NO_USE_NL(I,J,L,M,N,O,P) USE_HASH(R,S,T,U,V,MN,A1) USE_HASH(A2,A3,A4,A5,A6,X)   PARALLEL(8) */ '||
                       CHR(13)||CHR(9)||CHR(9)||XAGGREGATION_FIELDS|| XEXTRA_COLS ||
                       CHR(13)||CHR(9)||' FROM '||XLOOP.XFROM_CLAUSE||XAGGREGATE.XFROM|| 
                       CHR(13)||CHR(9)||' WHERE '|| XWHERE ||
                       CHR(13)||CHR(9)||' GROUP BY '||XAGGREGATE.XGROUP_BY||XDATE_COND||' ;'||
                       CHR(13)||CHR(13)||CHR(9)||'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                       'INSERT /*+ APPEND */ INTO NORTHI_LOADER.NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,'''||XAGGREGATE.PARTITION_VALUE||''',XREC_COUNT );'||CHR(13)||CHR(9)||
                       'COMMIT;'||CHR(13)|| 
                       CHR(13)||'END;';
                       
                   ELSE
                       V_STATEMENT:='CREATE OR REPLACE PROCEDURE '||XAGGREGATE_PROCEDURE_NAME||'(XDATA_DATE DATE) AS XREC_COUNT NUMBER;'||
                       CHR(13)||'BEGIN'||
                       CHR(13)||CHR(9)||'INSERT 
                       /*+ APPEND */ INTO NORTHI_DATA.'||XTABLE_NAME ||
                       CHR(13)||CHR(9)||'('||
                       CHR(13)||CHR(9)||CHR(9)||XLOCAL_FIELDS||XAGGREGATE.XINSERT||XAGGREGATE.XINSERT2||',NETWORK_ID'||XDTYPE_STR||',FRAGMENT_DATE'||
                       CHR(13)||CHR(9)||')'||
                       CHR(13)||CHR(9)||'SELECT '||
                       CHR(13)||CHR(9)||CHR(9)||XAGGREGATION_FIELDS|| XEXTRA_COLS ||
                       CHR(13)||CHR(9)||' FROM '||XLOOP.XFROM_CLAUSE||XAGGREGATE.XFROM|| 
                       CHR(13)||CHR(9)||' WHERE '|| XWHERE ||
                       CHR(13)||CHR(9)||' GROUP BY '||XAGGREGATE.XGROUP_BY||XDATE_COND||' ;'||
                       CHR(13)||CHR(13)||CHR(9)||'XREC_COUNT:=SQL%ROWCOUNT; '||CHR(13)||CHR(9)||
                       'INSERT /*+ APPEND */ INTO NORTHI_LOADER.NORTHI_TABLE_LOGS(TABLE_NAME,FRAGMENT_DATE,AGGREGATE_TYPE,DATA_COUNT) VALUES('''||XTABLE_NAME||''',XDATA_DATE,'''||XAGGREGATE.PARTITION_VALUE||''',XREC_COUNT );'||CHR(13)||CHR(9)||
                       'COMMIT;'||CHR(13)|| 
                       CHR(13)||'END;';
                   
                   END IF;
--                    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
--                    VALUES (USER,XTABLE_NAME,NULL,XLOOP.XFROM_CLAUSE || '---' || XWHERE,SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_STATEMENT',V_STATEMENT);
--                    COMMIT;
                   
                   EXECUTE IMMEDIATE V_STATEMENT ;
           END IF;  
                
        END LOOP;
    
   END LOOP;
   EXCEPTION
   WHEN NO_DATA_FOUND THEN
    NULL;
   
   WHEN OTHERS THEN
--   NULL;
   BEGIN
    V_SQLERRM   := SQLERRM;
    V_SQLCODE   := SQLCODE;
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,V_SQLCODE,V_STATE || '-'  || V_SQLERRM,SYSDATE,'CREATE_TYPE_AGG_PROCEDUREX_EXP',V_STATEMENT); COMMIT;
   END;
   RAISE;
END CREATE_TYPE_AGG_PROCEDUREX; 
PROCEDURE GET_REMOTE_FIELDS_TEST (XTABLE_NAME IN VARCHAR2,xREMOTE_FIELDS IN OUT VARCHAR2)
AS
XERROR_CODE NUMBER;
XERROR VARCHAR(32000);
XREMOTE VARCHAR(4000); 
BEGIN

xREMOTE_FIELDS:='';

FOR XFIELDS IN
(
 SELECT *
         FROM (
 SELECT REMOTE_FIELD REMOTE_FIELD,UPPER(LOCAL_FIELD) LOCAL_FIELD,DATE_AGGREGATE FROM NORTHI_TABLE_FIELDS WHERE TABLE_NAME=XTABLE_NAME AND ACTIVE=1 
 ) ORDER BY ROWID
)
LOOP

IF (XFIELDS.DATE_AGGREGATE IS NULL ) THEN
    XREMOTE:=XFIELDS.REMOTE_FIELD;
ELSE 
    XREMOTE:='ROUND('||XFIELDS.REMOTE_FIELD||',2)';
END IF;
    xREMOTE_FIELDS:=xREMOTE_FIELDS||XREMOTE||' '||xFIELDS.LOCAL_FIELD||',';
END LOOP;
IF LENGTH(xREMOTE_FIELDS)>0 THEN
 xREMOTE_FIELDS:=SUBSTR(xREMOTE_FIELDS,1,LENGTH(xREMOTE_FIELDS)-1);
END IF; 

EXCEPTION
 WHEN OTHERS THEN
 BEGIN
   xREMOTE_FIELDS:='';
   XERROR:=SUBSTR(SQLERRM,1,32000);
   XERROR_CODE:=SQLCODE;
    INSERT INTO NORTHI_CREATETABLE_ERROR_LOG(USER_NAME, TABLE_NAME, SQL_CODE, SQL_ERROR_MESSAGE, EXECUTE_DATE, PROCEDURE_NAME, SQL_TEXT)
    VALUES (USER,XTABLE_NAME,XERROR_CODE,XERROR,SYSDATE,'GET_REMOTE_TABLE_FIELDS',SUBSTR(XREMOTE_FIELDS,1,32000));
 END;

END GET_REMOTE_FIELDS_TEST;
PROCEDURE EXECUTE_ALL_PROCS AS
XRES NUMBER;
XCNT NUMBER;
BEGIN
     FOR XTABLES IN 
    ( 
        SELECT DISTINCT TABLE_NAME FROM NORTHI_LOADER.NORTHI_LOADER_SETTINGS 
        WHERE TABLE_NAME in ('CELLSTS_5G') AND ACTIVE=1
    )
    LOOP
    
       PREPARE_LOADER_TABLE_PTN(XTABLES.TABLE_NAME);

       CREATE_AGGREGATE_TABLES(XTABLES.TABLE_NAME);

       CREATE_LOADER_PROCEDURE(XTABLES.TABLE_NAME);

       CREATE_TYPE_AGG_PROCEDUREX(XTABLES.TABLE_NAME);

       CREATE_DATE_AGG_PROCEDURE(XTABLES.TABLE_NAME);

        
        SELECT COUNT(*)  INTO XCNT
        FROM NORTHI_BH_SETTINGS
        WHERE TABLE_NAME=XTABLES.TABLE_NAME;
        IF XCNT>0 THEN 
        
        BH_CREATION.CREATE_DBH_TABLE(XTABLES.TABLE_NAME);
        BH_CREATION.CREATE_DBH_PROCEDURE(XTABLES.TABLE_NAME);
        BH_CREATION.CREATE_WBH_TABLE(XTABLES.TABLE_NAME,5);
        BH_CREATION.CREATE_WBH_TABLE(XTABLES.TABLE_NAME,7);
        BH_CREATION.CREATE_MBH_TABLE(XTABLES.TABLE_NAME,5);
        BH_CREATION.CREATE_MBH_TABLE(XTABLES.TABLE_NAME,7);
        
        BH_CREATION.CREATE_WBH_PROCEDURE(XTABLES.TABLE_NAME,5);
        BH_CREATION.CREATE_WBH_PROCEDURE(XTABLES.TABLE_NAME,7);
        BH_CREATION.CREATE_MBH_PROCEDURE(XTABLES.TABLE_NAME,5);
        BH_CREATION.CREATE_MBH_PROCEDURE(XTABLES.TABLE_NAME,7);
        
        END IF;
        
    END LOOP;
END;

END LOADER_CREATION;
/
