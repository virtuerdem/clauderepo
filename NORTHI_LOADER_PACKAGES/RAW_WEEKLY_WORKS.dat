
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."RAW_WEEKLY_WORKS" AS

PROCEDURE INSERT_RAW_WA_PROCESS(P_VENDOR_ID NUMBER)

  AS

  XEXISTS NUMBER;

  XVENDOR NUMBER;
  
  

  BEGIN
  
 

  XVENDOR :=P_VENDOR_ID;

   DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

   DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    FOR XWA IN

    (

       SELECT DISTINCT TABLE_NAME , TRUNC(DATA_DATE,'DAY') DATA_DATE FROM NORTHI_RAW_DA_PROCESS WHERE AGGREGATE_STATE=2 AND WEEKLY_STATE=0 AND VENDOR_ID=P_VENDOR_ID AND TRUNC(DATA_DATE,'DAY')!=TRUNC(SYSDATE,'DAY')
      

    )

    LOOP

           

            SELECT COUNT(*) INTO XEXISTS FROM NORTHI_RAW_WA_PROCESS WHERE TABLE_NAME=XWA.TABLE_NAME AND DATA_DATE=XWA.DATA_DATE AND VENDOR_ID=P_VENDOR_ID ;

            UPDATE NORTHI_RAW_DA_PROCESS SET WEEKLY_STATE=1 WHERE TABLE_NAME=XWA.TABLE_NAME AND TRUNC(DATA_DATE,'DAY')=XWA.DATA_DATE AND VENDOR_ID=P_VENDOR_ID; 

             IF XEXISTS>0 THEN

                UPDATE NORTHI_RAW_WA_PROCESS 

                SET AGGREGATE_STATE=0 ,PROCESS_COUNT=PROCESS_COUNT+1 WHERE TABLE_NAME=XWA.TABLE_NAME AND DATA_DATE=XWA.DATA_DATE AND VENDOR_ID=P_VENDOR_ID ;

                 

             ELSE 

                INSERT INTO NORTHI_RAW_WA_PROCESS(TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,VENDOR_ID) 

                VALUES(XWA.TABLE_NAME,XWA.DATA_DATE,SYSDATE,0,SYSDATE,0,1,P_VENDOR_ID);

            END IF;    

    END LOOP;

    COMMIT;

  END;

  PROCEDURE BEGIN_RAW_WA_TRANSFER(P_VENDOR_ID NUMBER)

  AS 

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XAGGREGATE_DATE DATE;

  XROW_COUNT NUMBER;

  XVENDOR_ID NUMBER;
  
  XPROC_TYPE VARCHAR2(30);

  BEGIN
  
  XPROC_TYPE:= 'RAW_WA';

  XVENDOR_ID :=P_VENDOR_ID;

  DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

   DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    FOR XWA IN

    (

        SELECT TABLE_NAME,DATA_DATE DATA_DATE,AGGREGATE_DATE,PROCESS_COUNT FROM NORTHI_RAW_WA_PROCESS WHERE AGGREGATE_STATE=0 AND VENDOR_ID=P_VENDOR_ID

    )

    LOOP 

     XTABLE_NAME:=XWA.TABLE_NAME;

     XDATA_DATE:=XWA.DATA_DATE;

     XAGGREGATE_DATE:=XWA.AGGREGATE_DATE;

            UPDATE NORTHI_RAW_WA_PROCESS SET AGGREGATE_STATE=1 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND VENDOR_ID=P_VENDOR_ID; 

            
            
           IF XVENDOR_ID IN (1,4,5,6,7,9) THEN

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_RAW_WA.'|| XTABLE_NAME || ' WHERE DATA_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

           ELSIF XVENDOR_ID IN (22,23,47) THEN
            
            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_KKTC_RAW_WA.'|| XTABLE_NAME || ' WHERE DATA_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

           END IF;     

           
            COMMIT;

            EXECUTE_RAW_PROCEDURE(XTABLE_NAME,XDATA_DATE,XAGGREGATE_DATE,XROW_COUNT,XVENDOR_ID,XPROC_TYPE);
            

            UPDATE NORTHI_RAW_WA_PROCESS SET AGGREGATE_STATE=2 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND VENDOR_ID=P_VENDOR_ID;

            COMMIT;

    END LOOP;   

    COMMIT;

   

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_RAW_WA_PROCESS SET AGGREGATE_STATE=3 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END;

  PROCEDURE EXECUTE_RAW_WA_WORKS(P_VENDOR_ID NUMBER)

  AS

  XVENDOR_NAME VARCHAR2(100);

  BEGIN

    DBMS_SESSION.SET_NLS('NLS_TERRITORY','''TURKEY''');

    DBMS_SESSION.SET_NLS('NLS_NUMERIC_CHARACTERS','''.,''');

    SELECT VENDOR_NAME INTO XVENDOR_NAME FROM NORTHI_VENDOR_LIST  WHERE VENDOR_ID=P_VENDOR_ID;

    XVENDOR_NAME:='RAW_WA_'||XVENDOR_NAME;

    IF (LOADER_STATE.GET_STATE(XVENDOR_NAME)=0) THEN

        LOADER_STATE.SET_START(XVENDOR_NAME);

        INSERT_RAW_WA_PROCESS(P_VENDOR_ID);

        BEGIN_RAW_WA_TRANSFER(P_VENDOR_ID);

        LOADER_STATE.SET_END(XVENDOR_NAME);

    END IF;

    

  END;

END;
/
