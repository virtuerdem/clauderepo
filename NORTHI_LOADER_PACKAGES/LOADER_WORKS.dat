
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."LOADER_WORKS" AS
/******************************************************************************
   NAME:       LOADER_WORKS
PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   2.0        11/19/2009  1.VESILE TASKIRAN Loader works with aggregates.
******************************************************************************/

  PROCEDURE INSERT_LOADER_PROCESS(P_SYSTEM_ID NUMBER)
  AS
  XTABLE_NAME VARCHAR2(40);
  XCOUNT NUMBER;
  BEGIN
   XTABLE_NAME:='';
     FOR XDATA IN
    (
          SELECT A.TABLE_NAME ORG_TABLE,
          DECODE(LOAD_TYPE,2,A.TABLE_NAME||'_'||PARTITION_VALUE,DECODE(DTYPE,0,A.TABLE_NAME,1,A.TABLE_NAME,A.TABLE_NAME||'_'||PARTITION_VALUE)) TABLE_NAME,
          PARSER_DATE,DATA_DATE,DTYPE
          FROM (
               SELECT B.TABLE_NAME,PARTITION_ID,LOAD_TYPE,MAX(PARSER_DATE) PARSER_DATE, DECODE (LOAD_TYPE,3, DATA_DATE, TRUNC(DATA_DATE,'HH24'))  DATA_DATE
               FROM 
               (
                    SELECT S.TABLE_NAME,P.PARENT_NAME PARENT_NAME,PARTITION_ID ,LOAD_TYPE
                    FROM NORTHI_LOADER_PARENTS P,
                    NORTHI_LOADER_SETTINGS S 
                    WHERE S.TABLE_NAME=P.TABLE_NAME AND S.ACTIVE=1 AND P.ACTIVE=1 AND S.VENDOR_ID IN (SELECT VENDOR_ID FROM NORTHI_VENDOR_LIST WHERE SYSTEM_ID=P_SYSTEM_ID) 
               ) B,
               (    SELECT DECODE (UPPER(A.TABLE_NAME),'NSNCSDB_APERTIOCOUNTERS_UNITED','NSNCSDB_APERTIOCOUNTERS0',UPPER(A.TABLE_NAME)) TABLE_NAME,MAX(PARSER_DATE) PARSER_DATE,  DATA_DATE, SUM(LOADED_DATA_COUNT) PARSER_DATA_COUNT  ,A.OPERATOR_NAME -- ,COUNT(1) OMCFOLDERID_COUNT 
                    FROM NORTHI_PARSER_SETTINGS.PARSER_SQLLDR_LOGS A, 
                    (
                        SELECT 
                        TABLE_NAME, SYSTEM_ID ,OPERATOR_NAME
                        FROM NORTHI_PARSER_SETTINGS.PARSER_RAW_TABLE_LIST
                        WHERE SYSTEM_ID=P_SYSTEM_ID
                    ) B
                    WHERE 
                    A.TABLE_NAME=B.TABLE_NAME AND A.OPERATOR_NAME=B.OPERATOR_NAME
                    AND PARSER_STATE=1  
                    AND LOADER_STATE=0 
                    AND DATA_DATE >=TRUNC(SYSDATE-1)
                    GROUP BY A.TABLE_NAME,DATA_DATE, A.OPERATOR_NAME 
                    
               ) A
               WHERE A.TABLE_NAME IN(B.PARENT_NAME)
               GROUP BY B.TABLE_NAME,DECODE (LOAD_TYPE,3, DATA_DATE, TRUNC(DATA_DATE,'HH24')),PARTITION_ID,LOAD_TYPE
           ) A, NORTHI_PARTITION_TYPE B
           WHERE A.PARTITION_ID=B.PARTITION_ID AND TABLE_NAME  NOT IN ('ABID3G')
          
          
        --  NSNCSDB_APERTIOCOUNTERS_UNITED TABLOSU ASLINDA (0-7) TABLOLARININ BIRLESIMI OLDUGUNDAN SQLLOG TABLOSUNDA KAYDI BULUNMUYOR, BUNUN ICIN BU SEKILDE NSNCSDB_APERTIOCOUNTERS0 MIS GIBI DAVRANIYOR. 
           
    )
    LOOP
      
      --11.05.2021 gelistirmesinden dolayi bu if eklendi. onceki halinde if yoktu.
      IF NOT (P_SYSTEM_ID = 21 AND XDATA.ORG_TABLE <> 'ULAK_4G' AND XDATA.DATA_DATE = TRUNC(SYSDATE-2/24,'HH24')) THEN
        UPDATE NORTHI_PARSER_SETTINGS.PARSER_SQLLDR_LOGS   SET LOADER_STATE=1 
        WHERE   PARSER_STATE=1 AND DATA_DATE BETWEEN XDATA.DATA_DATE AND XDATA.DATA_DATE+0.99/24
        AND UPPER(TABLE_NAME) IN  (SELECT PARENT_NAME TABLE_NAME FROM NORTHI_LOADER_PARENTS WHERE TABLE_NAME=XDATA.ORG_TABLE)
        AND TABLE_NAME IN (SELECT TABLE_NAME FROM NORTHI_PARSER_SETTINGS.PARSER_RAW_TABLE_LIST WHERE SYSTEM_ID=P_SYSTEM_ID)
        AND OPERATOR_NAME IN (SELECT DISTINCT OPERATOR_NAME FROM NORTHI_PARSER_SETTINGS.PARSER_RAW_TABLE_LIST WHERE SYSTEM_ID=P_SYSTEM_ID);
        COMMIT;
           
 
      END IF;
       
      SELECT COUNT(*) INTO XCOUNT 
        FROM NORTHI_LOADER_PROCESS 
       WHERE TABLE_NAME=XDATA.TABLE_NAME 
         AND DATA_DATE=XDATA.DATA_DATE 
         AND SYSTEM_ID=P_SYSTEM_ID;
                   
      IF XCOUNT>0 THEN
        -- Erdi Gurbuz - 11.12.2018
        -- 4G HO'lari en fazla 2 defa islemeye izin veriyor.Tekrar parser'da is acilirsa loader'a is acmiyor
        --IF XDATA.TABLE_NAME = 'HONBR4TO4' OR XDATA.TABLE_NAME = 'HONBR4TO3' OR XDATA.TABLE_NAME = 'HONBR4TO2' THEN
/*          --11.05.2021 toplanti sonunda t0-1 ve t0-3 saatlerinin islenmesi karalastirildi
        IF P_SYSTEM_ID=21  AND XDATA.DATA_DATE> TRUNC(SYSDATE,'HH24')-3/24  THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE LOADER_COUNT < 2 AND TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
            
        --ELSE
        ELSIF  XDATA.ORG_TABLE = 'CELLSTS_4G'  AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-5/24 and (to_char(XDATA.DATA_DATE,'HH24') > 22 or to_char(XDATA.DATA_DATE,'HH24') < 6) THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
*/
        --11.05.2021 toplanti dogrultusunda bu if eklendi.
        IF P_SYSTEM_ID = 21 AND XDATA.ORG_TABLE <> 'ULAK_4G' AND XDATA.ORG_TABLE <> 'HONBR4TO2' AND XDATA.ORG_TABLE <> 'HONBR4TO3' AND XDATA.ORG_TABLE <> 'HONBR4TO4'  AND XDATA.ORG_TABLE <> 'CELLSTS_4G' --AND  XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-2/24 THEN
          AND XDATA.DATA_DATE in (TRUNC(SYSDATE-1/24,'HH24') , TRUNC(SYSDATE-3/24,'HH24')) THEN 
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
        
        ELSIF (XDATA.ORG_TABLE = 'HONBR4TO2' OR XDATA.ORG_TABLE = 'HONBR4TO3' OR XDATA.ORG_TABLE = 'HONBR4TO4' ) AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-2/24 THEN 
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
            
        ELSIF P_SYSTEM_ID = 1 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-4/24 THEN 
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
          
        ELSIF P_SYSTEM_ID = 2 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-4/24 THEN 
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
          
        ELSIF P_SYSTEM_ID = 30 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-7/24 THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
         
        ELSIF P_SYSTEM_ID = 32 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-7/24 THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
          
        ELSIF P_SYSTEM_ID = 39 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-7/24 THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
                                                        
        ELSIF (P_SYSTEM_ID NOT IN (1,2,21,30,32,39) OR XDATA.ORG_TABLE = 'ULAK_4G') AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-10/24 THEN
          UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
          WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
          COMMIT;
                                                                     
        END IF;   
                           
      ELSE
        INSERT INTO NORTHI_LOADER_PROCESS(TABLE_NAME, PARSER_DATE, DATA_DATE,  LOADER_DATE, LOADER_STATE, LOAD_DATE, LOADER_DATA_COUNT, LOADER_COUNT, HOURLY_STATE,SYSTEM_ID,DTYPE,DAILY_STATE,ORG_TABLE)
        VALUES(XDATA.TABLE_NAME,XDATA.PARSER_DATE,XDATA.DATA_DATE,NULL,0,NULL,0,1,0,P_SYSTEM_ID,XDATA.DTYPE,0,XDATA.ORG_TABLE);
        COMMIT;
          
      END IF; 
        
/*              IF XCOUNT>0 THEN
                -- Erdi Gurbuz - 11.12.2018
                -- 4G HO'lari en fazla 2 defa islemeye izin veriyor.Tekrar parser'da is acilirsa loader'a is acmiyor
                --IF XDATA.TABLE_NAME = 'HONBR4TO4' OR XDATA.TABLE_NAME = 'HONBR4TO3' OR XDATA.TABLE_NAME = 'HONBR4TO2' THEN
               IF P_SYSTEM_ID=21  AND XDATA.DATA_DATE> TRUNC(SYSDATE,'HH24')-3/24  THEN
                    UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
                    WHERE LOADER_COUNT < 2 AND TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
                    COMMIT;
                --ELSE
               ELSIF  XDATA.ORG_TABLE = 'CELLSTS_4G'  AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-5/24 and (to_char(XDATA.DATA_DATE,'HH24') > 22 or to_char(XDATA.DATA_DATE,'HH24') < 6) THEN
                    UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
                    WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
                    COMMIT;
                    
               ELSIF P_SYSTEM_ID = 2 AND XDATA.DATA_DATE > TRUNC(SYSDATE,'HH24')-4/24 THEN 
                    UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
                    WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
                    COMMIT;
                
                --ELSE
               ELSIF P_SYSTEM_ID NOT IN (2,21) OR XDATA.ORG_TABLE = 'ULAK_4G' THEN
                    UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=0, HOURLY_STATE=0,DAILY_STATE=0,LOADER_COUNT=LOADER_COUNT+1 
                    WHERE TABLE_NAME=XDATA.TABLE_NAME AND DATA_DATE=XDATA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
                    COMMIT;

                                       
               END IF;
               
           ELSE
                INSERT INTO NORTHI_LOADER_PROCESS(TABLE_NAME, PARSER_DATE, DATA_DATE,  LOADER_DATE, LOADER_STATE, LOAD_DATE, LOADER_DATA_COUNT, LOADER_COUNT, HOURLY_STATE,SYSTEM_ID,DTYPE,DAILY_STATE,ORG_TABLE)
                VALUES(XDATA.TABLE_NAME,XDATA.PARSER_DATE,XDATA.DATA_DATE,NULL,0,NULL,0,1,0,P_SYSTEM_ID,XDATA.DTYPE,0,XDATA.ORG_TABLE);
                COMMIT;
           END IF;*/ 
        
    END LOOP;
    DELETE FROM NORTHI_LAST_EXECUTION_LOG WHERE SYSTEM_ID=P_SYSTEM_ID;
    COMMIT;
    INSERT INTO NORTHI_LAST_EXECUTION_LOG(TABLE_NAME,DATA_DATE,SYSTEM_ID)
    SELECT DISTINCT ORG_TABLE,DATA_DATE,P_SYSTEM_ID
    FROM NORTHI_LOADER_PROCESS
    WHERE LOADER_STATE=0
    AND SYSTEM_ID=P_SYSTEM_ID;
    COMMIT;
  END INSERT_LOADER_PROCESS;
  
  
  PROCEDURE BEGIN_LOADER_TRANSFER(P_SYSTEM_ID NUMBER)
  AS
  XTABLE_NAME VARCHAR2(40);
  XDATA_DATE DATE;
  XROW_COUNT NUMBER;
  XVENDOR_ID NUMBER;
  XPARTITION_TYPE NUMBER;
  XPARTITION_NAME VARCHAR2(50);
   XDLT_COUNT NUMBER;
    XTBL_NAME  VARCHAR2(40);
    XDATE DATE;
  BEGIN
  XDLT_COUNT := 0;
  XVENDOR_ID :=5;
  XTBL_NAME:='AAA';
  XDATE:=TO_DATE('01.05.2015 00','DD.MM.YYYY HH24');
    FOR XLOG IN
    (
        SELECT TABLE_NAME,DATA_DATE,LOADER_DATE,LOADER_COUNT,ORG_TABLE,DTYPE, TABLE_NAME PROCEDURE_NAME
        --DECODE(DTYPE,1,ORG_TABLE,0,ORG_TABLE,TABLE_NAME) PROCEDURE_NAME   ( DIGERLERINDE UPDATE OLACAK)
        FROM NORTHI_LOADER_PROCESS 
        WHERE  LOADER_STATE=0 
        AND SYSTEM_ID=P_SYSTEM_ID 
        ORDER BY  case 
                  when ORG_TABLE = 'CELLSTS' OR ORG_TABLE='CELL_STATISTICS' OR ORG_TABLE='CELLSTS_4G' then 1 
                  else 2  
        end  , ORG_TABLE,DATA_DATE,DTYPE
    )
    LOOP
        XTABLE_NAME:=XLOG.ORG_TABLE;
        
/*       IF XTABLE_NAME = 'LCELL_STATISTICS' THEN
            CONTINUE;
       END IF;
*/        
       XDATA_DATE:=XLOG.DATA_DATE;
       IF XTBL_NAME!=XLOG.ORG_TABLE OR XDATE!=XLOG.DATA_DATE THEN
          XTBL_NAME:=XLOG.ORG_TABLE;
          XDATE:=XLOG.DATA_DATE;
          XDLT_COUNT:=0; 
       END IF;
       
       UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=1, LOADER_DATE=SYSDATE, LOAD_DATE=NULL WHERE TABLE_NAME=XLOG.TABLE_NAME AND DATA_DATE=XLOG.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       COMMIT;
       
       IF XLOG.LOADER_COUNT>1 THEN
         IF XDLT_COUNT=0 THEN 
            
          --  INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'LOADER_WORKS',XLOG.ORG_TABLE,'DELETE');commit;
              
            DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XLOG.ORG_TABLE AND FRAGMENT_DATE=XLOG.DATA_DATE;
            COMMIT;  
            
            IF XLOG.ORG_TABLE IN ('HONBR4TO4','HONBR4TO2','HONBR4TO3','CELLSTS_4G') THEN

            EXECUTE IMMEDIATE 'DELETE  /*+ PARALLEL(12) */ FROM NORTHI_DATA.'|| XLOG.ORG_TABLE || ' WHERE  FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24:MI')||''',''dd.mm.yyyy hh24:MI'')'; 
            COMMIT; 
            --INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'LOADER_WORKS',XLOG.ORG_TABLE,'DELETE PROCESS'); commit;

            ELSE
            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XLOG.ORG_TABLE || ' WHERE  FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24:MI')||''',''dd.mm.yyyy hh24:MI'')';
            
            --INSERT INTO NORTHI_DATA.TEST_ERROR (ADD_DATE,PROCEDURE_NAME,SQLTEXT,STATE) VALUES (SYSDATE,'LOADER_WORKS',XLOG.ORG_TABLE,'DELETE PROCESS'); commit;

            
            COMMIT;
          
         END IF;   
            
            XDLT_COUNT:=1;
         END IF;
       END IF; 
       
       --EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
      
      
       
       
       IF ((XLOG.ORG_TABLE!='BSS_STATISTICS') AND  (XLOG.ORG_TABLE!='CELLHO') AND (XLOG.ORG_TABLE!='FEGESTS') AND (XLOG.ORG_TABLE!='HONBR2TO2')  AND (XLOG.ORG_TABLE!='SITESTS')) THEN
            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
       END IF;
      
       IF (XLOG.ORG_TABLE='CELLSTS' OR XLOG.ORG_TABLE='CELLGPRS' OR XLOG.ORG_TABLE='CARRSTS' OR XLOG.ORG_TABLE='FEGESTS' OR XLOG.ORG_TABLE='ABID2G'  OR XLOG.ORG_TABLE='SITESTS') AND XLOG.DTYPE=1 THEN 
            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME||'5',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
       ELSIF ((XLOG.ORG_TABLE='BSS_STATISTICS') OR (XLOG.ORG_TABLE='CELLHO') OR (XLOG.ORG_TABLE='HONBR2TO2')) THEN
            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME||'5',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
       END IF;
       
       
               -- LTE daily job hizli calismasi icin CELLSTS_4G_TMP tablosuna data insert eklendi. 4G daily works bu tablo uzerinden calisiyor.
           IF (XLOG.ORG_TABLE='CELLSTS_4G'   AND XLOG.DTYPE=14 AND XLOG.DATA_DATE=TRUNC(SYSDATE,'HH24')-1/24) THEN
           NORTHI_LOADER.DATA_LOAD_TO_TMP('CELLSTS_4G');
         END IF;
      
--       IF (XLOG.ORG_TABLE='CELLSTS')  AND XLOG.DTYPE=1 THEN
--            TEMP_cell32(XDATA_DATE);
--            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME||'32',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
--       END IF;
--       
--        IF (XLOG.ORG_TABLE='CELLGPRS' )  AND XLOG.DTYPE=1 THEN
--            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME||'32',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
--       END IF;
--       
--        IF (XLOG.ORG_TABLE='ABID2G' )  AND XLOG.DTYPE=1 THEN
--            EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME||'32',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
--       END IF;
       
--       IF  ((XLOG.ORG_TABLE='CELL_STATISTICS' OR XLOG.ORG_TABLE='NODEB_STATISTICS' ) AND XLOG.DTYPE=1) THEN
--           EXECUTE_PROCEDURE(XLOG.TABLE_NAME||'31',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
--       END IF;
       
     
       IF ((XLOG.ORG_TABLE='FEGESTS' OR XLOG.ORG_TABLE='SITESTS') AND XLOG.DTYPE>1 ) THEN
           EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
       END IF;
       
 
       
       UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=2, LOAD_DATE=SYSDATE WHERE TABLE_NAME=XLOG.TABLE_NAME AND DATA_DATE=XLOG.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       COMMIT;     
    END LOOP;
    EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
     UPDATE NORTHI_LOADER_PROCESS SET LOADER_STATE=3 WHERE ORG_TABLE=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       RAISE;
  END BEGIN_LOADER_TRANSFER;
 
 
PROCEDURE EXECUTE_LOADER_WORKS(P_SYSTEM_ID NUMBER)
  AS
  XACTIVE NUMBER;
  X_PNAME VARCHAR2(100);
  BEGIN
    SELECT SUM(ACTIVE)  INTO XACTIVE FROM NORTHI_VENDOR_LIST WHERE SYSTEM_ID=P_SYSTEM_ID;
    IF XACTIVE>=1 THEN
        SELECT  DESCRIPTION INTO X_PNAME FROM NORTHI_SYSTEM_LIST WHERE SYSTEM_ID=P_SYSTEM_ID ;
        IF (LOADER_STATE.GET_STATE(X_PNAME)=0) THEN
            LOADER_STATE.SET_START(X_PNAME);
            INSERT_LOADER_PROCESS(P_SYSTEM_ID);
            BEGIN_LOADER_TRANSFER(P_SYSTEM_ID);
            LOADER_STATE.SET_END(X_PNAME);
            
 
           
        -- ErdiGurbuz
        -- Iptal edildi NORTHI_PARSER_SETTINGS.CHECK_PROBLEMS procedure tarafindan
        -- Running'de takili kalanlar mail ile northi.system@ttgint.com'a bildiriliyor
           -- IF P_SYSTEM_ID=1 THEN
           --     BSS_LOADER_CONTROL('BSS','LAST_LOADED_DATA');
           -- ELSIF P_SYSTEM_ID=2 THEN
           --    LOADER_3GRAN_CONTROL('3GRAN','LAST_LOADED_DATA');
           -- ELSIF P_SYSTEM_ID=21 THEN
           --     LOADER_LTE_CONTROL('LTE','LAST_LOADED_DATA');               
           -- END IF;
            
        END IF;
    END IF;
  END;
 

 END;
/
