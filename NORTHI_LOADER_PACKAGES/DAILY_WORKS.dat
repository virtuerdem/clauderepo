
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."DAILY_WORKS" AS

/******************************************************************************

   NAME:       DAILY_WORKS

   PURPOSE:



   REVISIONS:

   Ver        Date        Author           Description

   ---------  ----------  ---------------  ------------------------------------

   1.0        12/25/2009             1. Created this package.

******************************************************************************/

  PROCEDURE INSERT_DBH_PROCESS(P_SYSTEM_ID NUMBER,XTABLE_NAME VARCHAR2,XDATA_DATE DATE )

  AS

  XCOUNT NUMBER;

  BEGIN

        SELECT COUNT(*) INTO XCOUNT  FROM NORTHI_DBH_PROCESS WHERE ORG_TABLE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

        IF XCOUNT=0 THEN

            INSERT INTO NORTHI_DBH_PROCESS(TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE,BH_PROCEDURE,PROCESS_COUNT)

            SELECT DISTINCT 'DBH_'||A.TABLE_NAME,A.TABLE_NAME,XDATA_DATE,P_SYSTEM_ID,SYSDATE,SYSDATE,0,BH_TABLE||'_'||BH_ALIAS BH_PROCEDURE,1

            FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, NORTHI_VENDOR_LIST C

            WHERE A.VENDOR_ID=C.VENDOR_ID AND A.TABLE_NAME=B.TABLE_NAME AND C.SYSTEM_ID=P_SYSTEM_ID

            AND A.TABLE_NAME=XTABLE_NAME;

        ELSE 

            UPDATE NORTHI_DBH_PROCESS SET BH_STATE=0 ,START_DATE=SYSDATE, PROCESS_COUNT=PROCESS_COUNT+1

            WHERE (BH_PROCEDURE,DATA_DATE)IN 

            (

                SELECT BH_TABLE||'_'||BH_ALIAS BH_PROCEDURE,XDATA_DATE

                FROM NORTHI_LOADER_SETTINGS A, NORTHI_BH_SETTINGS B, NORTHI_VENDOR_LIST C

                WHERE A.VENDOR_ID=C.VENDOR_ID AND  A.TABLE_NAME=B.TABLE_NAME AND C.SYSTEM_ID=P_SYSTEM_ID

                AND A.TABLE_NAME=XTABLE_NAME    

            );

        END IF;

        COMMIT;

  END;

  PROCEDURE BEGIN_DBH_TRANSFER(P_SYSTEM_ID NUMBER)

  AS

  XCOUNT NUMBER;

  XROW_COUNT NUMBER;

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XSYSTEM NUMBER;

  BEGIN

  XSYSTEM :=P_SYSTEM_ID;

    FOR XDBH IN

    (

        SELECT  TABLE_NAME, ORG_TABLE, DATA_DATE, SYSTEM_ID, START_DATE, END_DATE, BH_STATE, BH_PROCEDURE, PROCESS_COUNT,

        ROW_NUMBER() OVER (PARTITION BY TABLE_NAME,DATA_DATE ORDER BY PROCESS_COUNT) RN 

        FROM NORTHI_DBH_PROCESS 

        WHERE BH_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID

    )

    LOOP



        XTABLE_NAME:=XDBH.BH_PROCEDURE;

        XDATA_DATE:=XDBH.DATA_DATE;

        UPDATE NORTHI_DBH_PROCESS SET BH_STATE=1, START_DATE=SYSDATE, END_DATE=NULL  WHERE BH_PROCEDURE=XDBH.BH_PROCEDURE AND DATA_DATE=XDBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;  --  START_DATE=SYSDATE, END_DATE=NULL

        COMMIT;



        IF XDBH.RN=1 THEN

            EXECUTE IMMEDIATE 'DELETE /*+ APPEND PARALLEL(6) */ FROM NORTHI_DATA.'|| XDBH.TABLE_NAME || ' WHERE FRAGMENT_DATE BETWEEN TO_DATE('''||to_char(XDBH.DATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'') AND TO_DATE('''||to_char(XDBH.DATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')+23/24';



        END IF;

        EXECUTE_PROCEDURE(XDBH.BH_PROCEDURE,XDBH.DATA_DATE,XDBH.START_DATE,XROW_COUNT,XSYSTEM);

        UPDATE NORTHI_DBH_PROCESS SET BH_STATE=2, END_DATE=SYSDATE  WHERE BH_PROCEDURE=XDBH.BH_PROCEDURE AND DATA_DATE=XDBH.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; -- END_DATE=SYSDATE



    END LOOP;

    COMMIT;

    

    EXCEPTION

     WHEN NO_DATA_FOUND THEN



       NULL;

     WHEN OTHERS THEN



     UPDATE NORTHI_DBH_PROCESS SET BH_STATE=3 WHERE BH_PROCEDURE=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

     

       RAISE;

  END ;

  PROCEDURE INSERT_DA_PROCESS(P_SYSTEM_ID NUMBER)

  AS 

  XEXISTS NUMBER;

  

  BEGIN

   

    FOR XDA IN

    (

        SELECT DISTINCT ORG_TABLE , DECODE (SYSTEM_ID,18,rtrim(table_name,'_H')||'_D' ,ORG_TABLE||'_DA' )  DA_TABLE,TRUNC(DATA_DATE) DATA_DATE 

        FROM NORTHI_LOADER_PROCESS WHERE LOADER_STATE=2 AND DAILY_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID AND TRUNC(DATA_DATE)!=TRUNC(SYSDATE) AND 

        (ORG_TABLE) IN

        (SELECT DISTINCT TABLE_NAME FROM NORTHI_LOADER_SETTINGS WHERE VENDOR_ID IN (SELECT VENDOR_ID FROM NORTHI_VENDOR_LIST WHERE SYSTEM_ID= P_SYSTEM_ID)  

        AND ACTIVE=1 AND DECODE(SYSTEM_ID , 18 ,INSTR(DATE_AGGREGATE_TYPES,'''D'''), INSTR(DATE_AGGREGATE_TYPES,'''DA''') )>0 )

    )

    LOOP

            INSERT_DBH_PROCESS(P_SYSTEM_ID,XDA.ORG_TABLE ,XDA.DATA_DATE );

            SELECT COUNT(*) INTO XEXISTS FROM NORTHI_DAILY_PROCESS WHERE TABLE_NAME=XDA.DA_TABLE AND DATA_DATE=XDA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

            UPDATE NORTHI_LOADER_PROCESS SET DAILY_STATE=1 WHERE ORG_TABLE=XDA.ORG_TABLE AND TRUNC(DATA_DATE)=XDA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID; 

             IF XEXISTS>0 THEN

                UPDATE NORTHI_DAILY_PROCESS 

                SET AGGREGATE_STATE=0 ,WEEKLY_STATE=0,MONTHLY_STATE=0,PROCESS_COUNT=PROCESS_COUNT+1 WHERE TABLE_NAME=XDA.DA_TABLE AND DATA_DATE=XDA.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;

                 

             ELSE 

                INSERT INTO NORTHI_DAILY_PROCESS(TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,WEEKLY_STATE,MONTHLY_STATE,ORG_TABLE,SYSTEM_ID) 

                VALUES(XDA.DA_TABLE,XDA.DATA_DATE,SYSDATE,0,SYSDATE,0,1,0,0,XDA.ORG_TABLE,P_SYSTEM_ID);

            END IF;    

    END LOOP;

    COMMIT;

  END;

  

  --------

 

  PROCEDURE BEGIN_DA_TRANSFER(P_SYSTEM_ID NUMBER)

  AS 

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XAGGREGATE_DATE DATE;

  XROW_COUNT NUMBER;

  XSYSTEM NUMBER;

  BEGIN

  

    FOR XDA IN

    (

        SELECT TABLE_NAME,DATA_DATE DATA_DATE,AGGREGATE_DATE,PROCESS_COUNT,ORG_TABLE FROM NORTHI_DAILY_PROCESS WHERE AGGREGATE_STATE=0 AND SYSTEM_ID=P_SYSTEM_ID ORDER BY DATA_DATE

    )

    LOOP 

     XTABLE_NAME:=XDA.TABLE_NAME;

     XDATA_DATE:=XDA.DATA_DATE;

     XAGGREGATE_DATE:=XDA.AGGREGATE_DATE;

            UPDATE NORTHI_DAILY_PROCESS SET AGGREGATE_STATE=1,WEEKLY_STATE=0,MONTHLY_STATE=0, LOADER_DATE=SYSDATE , AGGREGATE_DATE =NULL  WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;  -- LOADER_DATE=SYSDATE , AGGREGATE_DATE =NULL

            EXECUTE IMMEDIATE 'DELETE /*+ APPEND PARALLEL(6) */ FROM NORTHI_DATA.'|| XTABLE_NAME || ' WHERE FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

            DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XTABLE_NAME AND FRAGMENT_DATE=TRUNC(XDATA_DATE);

            COMMIT;

            EXECUTE_PROCEDURE(XTABLE_NAME,XDATA_DATE,XAGGREGATE_DATE,XROW_COUNT,XSYSTEM);

            UPDATE NORTHI_DAILY_PROCESS SET AGGREGATE_STATE=2,WEEKLY_STATE=0,MONTHLY_STATE=0, AGGREGATE_DATE =SYSDATE  WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE; -- AGGREGATE_DATE =SYSDATE

            COMMIT;

    END LOOP;   

    COMMIT;

       -- EXTRA_WORKS.PROC_OBJECT_COUNT_DAILY_SR(TRUNC(SYSDATE));

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_DAILY_PROCESS SET AGGREGATE_STATE=3 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END;

  

 

  PROCEDURE EXECUTE_DA_WORKS(P_SYSTEM_ID NUMBER)

  AS 

  XSYSTEM_NAME VARCHAR2(20);

  BEGIN

  

   SELECT SYSTEM_NAME INTO XSYSTEM_NAME FROM NORTHI_SYSTEM_LIST 

   WHERE SYSTEM_ID=P_SYSTEM_ID;

   XSYSTEM_NAME:=XSYSTEM_NAME||'_DA';

  

    IF  (LOADER_STATE.GET_STATE(XSYSTEM_NAME)=0) THEN

        LOADER_STATE.SET_START(XSYSTEM_NAME);

        INSERT_DA_PROCESS(P_SYSTEM_ID);

        BEGIN_DA_TRANSFER(P_SYSTEM_ID);

        BEGIN_DBH_TRANSFER(P_SYSTEM_ID);

        LOADER_STATE.SET_END(XSYSTEM_NAME);

        --PREV_DAY_DATA_CONTROL_BSS;

    END IF;

  END ;

  -------------

  

END ;
/
