
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."DASHBOARD_KPI_WA" AS

PROCEDURE PROCESS_DASH_NED_WA (XDATE DATE) 
AS

BEGIN

INSERT INTO NORTHI_DATA.DASH_NED_WA (NETWORK_ID, FRAGMENT_DATE, V3_24, V3_2G, V3_3G, V3_4G, V1_24, V1_2G, V1_3G, V1_4G, V2, V2_2G, V2_3G, V4, V4_2G, V4_3G)

WITH DATASET_CELLSTS_DBH AS
(
SELECT /*+PARALLEL(4)*/ NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')  FRAGMENT_DATE,ROUND(SUM(V3_CSSR_NUM),2) CSSR2_NUM ,ROUND(SUM(V3_CSSR_DEN),2) CSSR2_DEN 
FROM NORTHI_DATA.NED_2G_REPORT
WHERE DTYPE IN (2,3,4,6) AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')
),

DATASET_CELLSTATISTICS_DBH AS
(
SELECT /*+PARALLEL(4)*/ NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,ROUND(SUM(V3_CSSR_NUM),2) CSSR23_NUM,ROUND(SUM(V3_CSSR_DEN),2) CSSR23_DEN 
FROM NORTHI_DATA.NED_3G_REPORT
WHERE  DTYPE IN (2,3,4,6)  AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+6.99999 --TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')
),

DATASET_CELLSTS_DA AS
(
SELECT /*+PARALLEL(4)*/ NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')FRAGMENT_DATE,ROUND(sum(V1_DCR_DEN),2) DCR_C_2G ,ROUND(sum(V1_DCR_NUM),2) DCR_DC_2G
FROM NORTHI_DATA.NED_2G_REPORT
WHERE DTYPE IN (2,3,4,6) AND  FRAGMENT_dATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')
),

DATASET_V2V4 AS
(
SELECT  NETWORK_ID,SUB_REGION_ID,MAIN_REGION_ID, CITY_ID,2 TYPE, FRAGMENT_DATE,
ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(SUM(V4_CSSR_NUM),2) V4_CSSR_NUM, ROUND(SUM(V4_CSSR_DEN),2) V4_CSSR_DEN,ROUND(SUM(V4_CSSR_DEN),2) V4_TOT_CALL
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE IN (1) AND  FRAGMENT_dATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,SUB_REGION_ID,MAIN_REGION_ID, CITY_ID,FRAGMENT_DATE
UNION ALL
SELECT  NETWORK_ID,SUB_REGION_ID,MAIN_REGION_ID, CITY_ID, 3 TYPE, FRAGMENT_DATE,
ROUND(SUM(V1_DCR_NUM),2) V2_DCR_NUM, ROUND(sum(V1_DCR_DEN),2) V2_DCR_DEN  , ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(SUM(V4_CSSR_NUM),2) V4_CSSR_NUM, ROUND(SUM(V4_CSSR_DEN),2) V4_CSSR_DEN ,  ROUND(SUM(V4_CSSR_DEN),2) V4_TOT_CALL
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE IN (1) AND FRAGMENT_dATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,SUB_REGION_ID,MAIN_REGION_ID, CITY_ID,FRAGMENT_DATE
),

DATASET_CELLSTATISTICS_DA AS
(
SELECT /*+PARALLEL(4)*/ NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,ROUND(sum(V1_DCR_DEN),2) DCR_C_3G  ,ROUND(SUM(V1_DCR_NUM),2) DCR_DC_3G ,ROUND(sum(V1_24_DCR_DEN),2) V1_24_DCR_3G 
FROM NORTHI_DATA.NED_3G_REPORT
WHERE DTYPE IN (2,3,4,6) AND FRAGMENT_dATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')
),

DATASET_CELLSTSLTE_DA AS
(
SELECT /*+PARALLEL(4)*/ NETWORK_ID ,TRUNC(FRAGMENT_DATE,'IW')FRAGMENT_DATE,
ROUND(SUM(V7_DCR_NUM),2) DCR_C_4G,
SUM(V7_CSSR_NUM) CS_RAB_EST_SR_NUM, SUM(V7_CSSR_DEN) CS_RAB_EST_SR_DEN, ROUND(SUM(V1_24_DCR_NUM),2) DCR_DC_4G ,ROUND(sum(V1_24_DCR_DEN),2) V1_24_DCR_4G 
FROM NORTHI_dATA.NED_4G_REPORT
WHERE DTYPE IN (2,3,4,6) AND FRAGMENT_dATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY NETWORK_ID ,TRUNC(FRAGMENT_DATE,'IW')
)

SELECT /*+PARALLEL(4)*/
G2.NETWORK_ID,G2.FRAGMENT_DATE,
ROUND(ROUND(DECODE(SUM(CSSR2_DEN+CSSR23_DEN),0,0,(1-(SUM(CSSR2_NUM+CSSR23_NUM)/SUM(CSSR2_DEN+CSSR23_DEN)))*100),2)*ROUND(DECODE(SUM(DCR_C_2G+DCR_C_3G+DCR_C_4G),0,0,SUM(DCR_C_2G+DCR_C_3G)/SUM(DCR_C_2G+DCR_C_3G+DCR_C_4G)),2)
+
ROUND(DECODE(SUM(CS_RAB_EST_SR_DEN),0,0,SUM(CS_RAB_EST_SR_NUM)/SUM(CS_RAB_EST_SR_DEN)*100),2)*ROUND(DECODE(SUM(DCR_C_2G+DCR_C_3G+DCR_C_4G),0,0,SUM(DCR_C_4G)/SUM(DCR_C_2G+DCR_C_3G+DCR_C_4G)),2),2) V3_24,
ROUND(DECODE(SUM(CSSR2_DEN),0,0,(1-(SUM(CSSR2_NUM)/SUM(CSSR2_DEN)))*100),2) V3_2G,
ROUND(DECODE(SUM(CSSR23_DEN),0,0,(1-(SUM(CSSR23_NUM)/SUM(CSSR23_DEN)))*100),2) V3_3G,
ROUND(DECODE(SUM(CS_RAB_EST_SR_DEN),0,0,SUM(CS_RAB_EST_SR_NUM)/SUM(CS_RAB_EST_SR_DEN)*100),2) V3_4G,
ROUND(DECODE(SUM(DCR_C_2G+V1_24_DCR_3G+V1_24_DCR_4G),0,0,(SUM(DCR_DC_2G+DCR_DC_3G+DCR_DC_4G)/SUM(DCR_C_2G+V1_24_DCR_3G+V1_24_DCR_4G)*100)),4) V1_24,
ROUND(DECODE(SUM(DCR_C_2G),0,0,(SUM(DCR_DC_2G)/SUM(DCR_C_2G)*100)),4) V1_2G, 
ROUND(DECODE(SUM(V1_24_DCR_3G),0,0,(SUM(DCR_DC_3G)/SUM(V1_24_DCR_3G)*100)),4) V1_3G, 
ROUND(DECODE(SUM(V1_24_DCR_4G),0,0,(SUM(DCR_DC_4G)/SUM(V1_24_DCR_4G)*100)),4) V1_4G ,
ROUND(SUM(G7.DCR),4) V2, ROUND(SUM(G8.DCR),4) V2_2G, ROUND(SUM(G9.DCR),4) V2_3G,
ROUND(SUM(G7.CSSR),4) V4 , ROUND(SUM(G8.CSSR),4) V4_2G, ROUND(SUM(G9.CSSR),4) V4_3G
 
FROM
DATASET_CELLSTS_DBH G2 LEFT OUTER JOIN 
DATASET_CELLSTATISTICS_DBH G3 ON (G2.NETWORK_ID = G3.NETWORK_ID AND G2.FRAGMENT_DATE=G3.FRAGMENT_DATE ),
DATASET_CELLSTS_DA G4 LEFT OUTER JOIN  
DATASET_CELLSTATISTICS_DA G5 ON (G4.NETWORK_ID = G5.NETWORK_ID AND G4.FRAGMENT_DATE=G5.FRAGMENT_DATE ),
DATASET_CELLSTSLTE_DA G6 ,
( 
SELECT SUB_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY SUB_REGION_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL 
SELECT MAIN_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY MAIN_REGION_ID,TRUNC(FRAGMENT_DATE,'IW') 
UNION ALL
SELECT CITY_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY CITY_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL
SELECT -999 NETWORK_ID ,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,  ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY TRUNC(FRAGMENT_DATE,'IW')  
) G7 , 

(SELECT SUB_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=2 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY SUB_REGION_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL 
SELECT MAIN_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=2 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY MAIN_REGION_ID,TRUNC(FRAGMENT_DATE,'IW') 
UNION ALL
SELECT CITY_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=2 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY CITY_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL
SELECT -999 NETWORK_ID ,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,  ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=2 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY TRUNC(FRAGMENT_DATE,'IW')  ) G8,

(SELECT SUB_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=3 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY SUB_REGION_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL 
SELECT MAIN_REGION_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW')FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=3 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY MAIN_REGION_ID,TRUNC(FRAGMENT_DATE,'IW') 
UNION ALL
SELECT CITY_ID NETWORK_ID,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE, ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=3 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY CITY_ID,TRUNC(FRAGMENT_DATE,'IW')
UNION ALL
SELECT -999 NETWORK_ID ,TRUNC(FRAGMENT_DATE,'IW') FRAGMENT_DATE,  ROUND(SUM(V2_DCR_NUM),2) V2_DCR_NUM,ROUND(SUM(V2_DCR_DEN),2) V2_DCR_DEN ,ROUND(SUM(V2_TOT_CALL),2) V2_TOT_CALL,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V2_DCR_DEN),0,0,(V2_DCR_NUM)/(V2_DCR_DEN)*100),2) >5 and (V2_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) DCR ,
ROUND(COUNT(CASE WHEN ROUND(DECODE((V4_CSSR_DEN),0,0,(V4_CSSR_NUM)/(V4_CSSR_DEN)*100),2) < 90 and (V4_TOT_CALL)>350  THEN 1 END)*100/count(*) ,4) CSSR
FROM DATASET_V2V4
WHERE TYPE=3 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
GROUP BY TRUNC(FRAGMENT_DATE,'IW')  ) G9
 
WHERE 
G2.NETWORK_ID = G4.NETWORK_ID AND G2.FRAGMENT_DATE=G4.FRAGMENT_DATE AND 
G2.NETWORK_ID = G6.NETWORK_ID AND G2.FRAGMENT_DATE=G6.FRAGMENT_DATE AND
G7.NETWORK_ID = G6.NETWORK_ID AND G7.FRAGMENT_DATE=G6.FRAGMENT_DATE AND
G7.NETWORK_ID = G8.NETWORK_ID AND G7.FRAGMENT_DATE=G8.FRAGMENT_DATE AND
G7.NETWORK_ID = G9.NETWORK_ID AND G7.FRAGMENT_DATE=G9.FRAGMENT_DATE AND

G2.NETWORK_ID <>-99
GROUP BY G2.NETWORK_ID ,G2.FRAGMENT_DATE;

END;


PROCEDURE PROCESS_DASH_AVAIL_WA (XDATE DATE) 
AS
BEGIN
INSERT INTO NORTHI_DATA.DASH_AVAIL_WA(NETWORK_ID,FRAGMENT_DATE, COMB_AVAILABILITY, AVAILABILITY_2G, AVAILABILITY_3G, AVAILABILITY_4G)

WITH DS_OBJ_DATA_2G AS
( 
SELECT    /*+PARALLEL(4)*/ DISTINCT  DATA_DATE, MAIN_REGION_NAME,
                              SUB_REGION_NAME,
                              BSC_NAME,
                              B.BTS_NAME BTS_NAME,
                              CELL_NAME,
                              MAIN_REGION_ID,
                              SUB_REGION_ID,
                              CITY_ID, CITY_NAME,
                              BSC_ID,
                              A.BTS_ID,
                              CELL_ID
              FROM   NORTHI_DATA.OMC_BSC_BTS_CELL_LIST A , 
              (SELECT NE_ID BTS_ID ,NE_NAME BTS_NAME, DATA_DATE FROM NORTHI_PARSER.OBJECTS_HW2G WHERE NE_TYPE=30 
              AND DATA_DATE  BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
              )  B
              WHERE A.BTS_ID=B.BTS_ID   AND 
               ( SUBSTR (B.BTS_NAME,LENGTH (B.BTS_NAME)- INSTR (REVERSE (B.BTS_NAME), '_')+ 2,LENGTH (B.BTS_NAME)) NOT IN('MEVSIM' ,'SLC' ,'SKD' ,'GUV' ,'TRF' ,'ODB','MOB' , 'Mob', 'Mobil', 'MOBIL' ,'TEST' ,'SWAP' ,'AKT' ,'RHM','SE') 
               AND B.BTS_NAME NOT LIKE '%~%'
               AND B.BTS_NAME NOT LIKE '%SWAP%'
               )
            UNION ALL
     
SELECT   /*+PARALLEL(4)*/  DISTINCT DATA_DATE, MAIN_REGION_NAME,
                         SUB_REGION_NAME,
                         BSC_NAME,
                         B.BTS_NAME BTS_NAME,
                         CELL_NAME,
                         MAIN_REGION_ID,
                         SUB_REGION_ID,
                         CITY_ID, CITY_NAME,
                         BSC_ID,
                         B.BTS_ID BTS_ID,
                         CELL_ID
         FROM   NORTHI_DATA.OMC_BSC_BTS_CELL_LIST A LEFT OUTER JOIN 
         (SELECT DISTINCT NETWORK_ID BTS_ID ,RELATIVE_LOG_NAME BTS_NAME, TRUNC(FRAGMENT_DATE) DATA_DATE FROM HIZIR2.ENTITY WHERE RDN_CLASS=30 AND 
         FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
         ) B
         ON ( A.BTS_ID=B.BTS_ID) 
           WHERE 
               ( SUBSTR (B.BTS_NAME,LENGTH (B.BTS_NAME)- INSTR (REVERSE (B.BTS_NAME), '_')+ 2,LENGTH (B.BTS_NAME)) NOT IN('MEVSIM' ,'SLC' ,'SKD' ,'GUV' ,'TRF' ,'ODB','MOB' , 'Mob', 'Mobil', 'MOBIL' ,'TEST' ,'SWAP' ,'AKT' ,'RHM','SE') 
               AND B.BTS_NAME NOT LIKE '%~%'
               AND B.BTS_NAME NOT LIKE '%SWAP%'
               )      
              ) ,
              
              
               DS_DATA_2G AS
      (
      SELECT   /*+PARALLEL(4)*/ NETWORK_ID,FRAGMENT_DATE,
      SUM(CELL_AVAILABILITY-NVL(CELL_AVAILABILITY_OM,0))CELL_AVAILABILITY, MAX(HOUR)HOUR , SUM(REC_CNT)REC_CNT
      FROM   NORTHI_DATA.CELLSTS_DA
      WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
      GROUP BY NETWORK_ID, FRAGMENT_DATE
      ),  
      
DS_OBJ_DATA_3G AS
 (SELECT   /*+PARALLEL(4)*/ DISTINCT  DATA_DATE,MAIN_REGION_NAME,
                              SUB_REGION_NAME,
                              RNC_NAME,
                              B.NODEB_NAME,
                              CELL_NAME,
                              MAIN_REGION_ID,
                              SUB_REGION_ID,
                              CITY_ID, CITY_NAME,
                              RNC_ID,
                              A.NODEB_ID,
                              CELL_ID,
                              SUBSTR(A.CELL_NAME,8,1)  SUB_STR
              FROM   NORTHI_DATA.LIST_RNC_NODEB_CELL A,
              (SELECT NE_ID NODEB_ID ,NE_NAME NODEB_NAME, DATA_DATE FROM M2000.OBJECTS_HW3G WHERE NE_TYPE=30 AND DATA_DATE 
              BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
              )  B
              WHERE  A.NODEB_NAME=B.NODEB_NAME AND 
                     (
                     SUBSTR (B.NODEB_NAME,LENGTH (B.NODEB_NAME)- INSTR (REVERSE (B.NODEB_NAME), '_')+ 2,LENGTH (B.NODEB_NAME)) NOT IN('MEVSIM' ,'SLC' ,'SKD' ,'GUV' ,'TRF' ,'ODB','MOB' , 'Mob', 'Mobil', 'MOBIL' ,'TEST' ,'SWAP' ,'AKT' ,'RHM','SE') 
                     AND B.NODEB_NAME NOT LIKE '%~%'
                     AND B.NODEB_NAME NOT LIKE '%SWAP%'
                     ) AND SUBSTR(A.CELL_NAME,8,1) <> '3'
              ),

DS_DATA_3G AS
          (       
    SELECT    /*+PARALLEL(4)*/ NETWORK_ID,FRAGMENT_DATE,          
    SUM(VS_CELL_UNAVAILTIME_OM) VS_CELL_UNAVAILTIME_OM ,SUM(VS_CELL_UNAVAILTIME_SYS) VS_CELL_UNAVAILTIME_SYS,  SUM(REC_CNT) REC_CNT  , MAX(HOUR) HOUR 
    FROM   NORTHI_DATA.CELL_STATISTICS_DA
    WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
    GROUP BY NETWORK_ID, FRAGMENT_DATE      
           ) ,
           
DS_OBJ_DATA_4G AS
 (
SELECT   /*+PARALLEL(4)*/ DISTINCT  DATA_DATE, MAIN_REGION_NAME,
                              SUB_REGION_NAME,
                              B.ENODEB_NAME,
                              CELL_NAME,
                              MAIN_REGION_ID,
                              SUB_REGION_ID,
                              CITY_ID, CITY_NAME,
                              A.ENODEB_ID,
                              CELL_ID
              FROM   NORTHI_DATA.LIST_ENODEB_CELL A,
               (SELECT NE_ID ENODEB_ID ,NE_NAME ENODEB_NAME, DATA_DATE FROM NORTHI_PARSER.OBJECTS_HW4G WHERE NE_TYPE=30 
               AND DATA_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
               )  B
              WHERE  A.ENODEB_NAME=B.ENODEB_NAME AND 
                    ( 
                     SUBSTR (B.ENODEB_NAME,LENGTH (B.ENODEB_NAME)- INSTR (REVERSE (B.ENODEB_NAME), '_')+ 2,LENGTH (B.ENODEB_NAME)) NOT IN('MEVSIM' ,'SLC' ,'SKD' ,'GUV' ,'TRF' ,'ODB','MOB' , 'Mob', 'Mobil', 'MOBIL' ,'TEST' ,'SWAP' ,'AKT' ,'RHM','SE') 
                     AND B.ENODEB_NAME NOT LIKE '%~%'
                     AND B.ENODEB_NAME NOT LIKE '%SWAP%'
                     AND B.ENODEB_NAME NOT LIKE '%CROWD%'
                    )
 ),
 DS_DATA_4G AS
 (
 SELECT  /*+PARALLEL(4)*/ NETWORK_ID, FRAGMENT_DATE,    
 SUM(PARTIAL_AVAIL) PARTIAL_AVAIL , SUM(L_CELL_UNAVAIL_DUR_MANUAL) L_CELL_UNAVAIL_DUR_MANUAL, MAX(HOUR) HOUR,   SUM(REC_CNT) REC_CNT 
 FROM   NORTHI_DATA.CELLSTS_4G_DA
 WHERE DTYPE=1 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
 GROUP BY NETWORK_ID, FRAGMENT_DATE
 )          
      
            
              
      SELECT /*+PARALLEL(4)*/ COMB.NETWORK_ID,COMB.FRAGMENT_DATE,
      ROUND (100- ( ( SUM(COMB.CELL_AVAILABILITY)) * 100 / (60 * 60 * MAX(COMB.HOUR) * SUM(COMB.REC_CNT))),2) COMB_AVAILABILITY,
      ROUND (100- ( ( SUM(AVAIL_2G.CELL_AVAILABILITY)) * 100 / (60 * 60 * MAX(AVAIL_2G.HOUR) * SUM(AVAIL_2G.REC_CNT))),2) AVAILABILITY_2G,
      ROUND (100- ( ( SUM(AVAIL_3G.CELL_AVAILABILITY)) * 100 / (60 * 60 * MAX(AVAIL_3G.HOUR) * SUM(AVAIL_3G.REC_CNT))),2) AVAILABILITY_3G,
      ROUND (100- ( ( SUM(AVAIL_4G.CELL_AVAILABILITY)) * 100 / (60 * 60 * MAX(AVAIL_4G.HOUR) * SUM(AVAIL_4G.REC_CNT))),2) AVAILABILITY_4G
      
      FROM
      
      (     
    
     SELECT   -999 NETWORK_ID , TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
     SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
     FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
     WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
     GROUP BY TRUNC (FRAGMENT_DATE, 'IW')
     
     UNION ALL
     
      SELECT  SUB_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
     SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
     FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
     WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
     GROUP BY SUB_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
    
     UNION ALL
     
      SELECT   MAIN_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
     SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
     FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
     WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
     GROUP BY MAIN_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
     
     UNION ALL
     
      SELECT   CITY_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
     SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
     FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
     WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
     GROUP BY CITY_ID,TRUNC (FRAGMENT_DATE, 'IW')
     
     
     

     
     UNION ALL

     SELECT  -999 NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(VS_CELL_UNAVAILTIME_SYS) VS_CELL_UNAVAILTIME_SYS, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
     FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY TRUNC (FRAGMENT_DATE, 'IW')
     
      UNION ALL

     SELECT   SUB_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(VS_CELL_UNAVAILTIME_SYS) VS_CELL_UNAVAILTIME_SYS, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
     FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY SUB_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
     
      UNION ALL

     SELECT   MAIN_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(VS_CELL_UNAVAILTIME_SYS) VS_CELL_UNAVAILTIME_SYS, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
     FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY MAIN_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
     
      UNION ALL

     SELECT  CITY_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(VS_CELL_UNAVAILTIME_SYS) VS_CELL_UNAVAILTIME_SYS, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
     FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY CITY_ID,TRUNC (FRAGMENT_DATE, 'IW')
     
     UNION ALL
     
     SELECT   -999 NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) PARTIAL_AVAIL, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY TRUNC (FRAGMENT_DATE, 'IW')     
     
     UNION ALL
     
     SELECT   SUB_REGION_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) PARTIAL_AVAIL, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  SUB_REGION_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
     
     UNION ALL
     
     SELECT   MAIN_REGION_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) PARTIAL_AVAIL, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  MAIN_REGION_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
     
     UNION ALL
     
     SELECT    CITY_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) PARTIAL_AVAIL, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  CITY_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
        
     ) COMB  LEFT OUTER JOIN 
   
  (
   SELECT   -999 NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
  SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
  FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
  WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
  GROUP BY TRUNC (FRAGMENT_DATE, 'IW')
  
  UNION ALL
  
   SELECT   SUB_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
  SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
  FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
  WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
  GROUP BY SUB_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
 
  UNION ALL
  
   SELECT   MAIN_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
  SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
  FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
  WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
  GROUP BY MAIN_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
  
  UNION ALL
  
   SELECT  CITY_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,
  SUM(CELL_AVAILABILITY) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR , SUM(REC_CNT) REC_CNT
  FROM DS_OBJ_DATA_2G A,DS_DATA_2G B
  WHERE  B.NETWORK_ID = A.CELL_ID AND B.FRAGMENT_DATE=A.DATA_DATE 
  GROUP BY CITY_ID,TRUNC (FRAGMENT_DATE, 'IW')
  
  ) AVAIL_2G  ON (COMB.NETWORK_ID=AVAIL_2G.NETWORK_ID AND  COMB.FRAGMENT_DATE=AVAIL_2G.FRAGMENT_DATE )
  
  
  LEFT OUTER JOIN
   
    (
    
     SELECT  -999 NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
    SUM(VS_CELL_UNAVAILTIME_SYS) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
    FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
    WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
    GROUP BY TRUNC (FRAGMENT_DATE, 'IW')
    
     UNION ALL

    SELECT   SUB_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
    SUM(VS_CELL_UNAVAILTIME_SYS) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
    FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
    WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
    GROUP BY SUB_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
    
     UNION ALL

    SELECT   MAIN_REGION_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
    SUM(VS_CELL_UNAVAILTIME_SYS) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
    FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
    WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
    GROUP BY MAIN_REGION_ID,TRUNC (FRAGMENT_DATE, 'IW')
    
     UNION ALL

    SELECT   CITY_ID NETWORK_ID ,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
    SUM(VS_CELL_UNAVAILTIME_SYS) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR, SUM(REC_CNT) REC_CNT
    FROM  DS_DATA_3G A, DS_OBJ_DATA_3G B
    WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
    GROUP BY CITY_ID,TRUNC (FRAGMENT_DATE, 'IW')
    
    ) 
    AVAIL_3G ON (COMB.NETWORK_ID=AVAIL_3G.NETWORK_ID AND  COMB.FRAGMENT_DATE=AVAIL_3G.FRAGMENT_DATE  )
    
    LEFT OUTER JOIN 
    
     (
      SELECT   -999 NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY TRUNC (FRAGMENT_DATE, 'IW')     
     
     UNION ALL
     
     SELECT    SUB_REGION_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  SUB_REGION_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
     
     UNION ALL
     
     SELECT    MAIN_REGION_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  MAIN_REGION_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
     
     UNION ALL
     
     SELECT    CITY_ID NETWORK_ID,TRUNC (FRAGMENT_DATE, 'IW') FRAGMENT_DATE,  
     SUM(PARTIAL_AVAIL) CELL_AVAILABILITY, CASE WHEN MAX(HOUR) > 24 THEN 24 ELSE MAX(HOUR) END HOUR,   SUM(REC_CNT) REC_CNT 
     FROM  DS_DATA_4G A, DS_OBJ_DATA_4G B
     WHERE A.NETWORK_ID=B.CELL_ID AND A.FRAGMENT_DATE=B.DATA_DATE
     GROUP BY  CITY_ID ,TRUNC (FRAGMENT_DATE, 'IW')  
     ) AVAIL_4G ON  (COMB.NETWORK_ID=AVAIL_4G.NETWORK_ID AND  COMB.FRAGMENT_DATE=AVAIL_4G.FRAGMENT_DATE )
      
      WHERE COMB.NETWORK_ID <>-99     
      GROUP BY COMB.NETWORK_ID,COMB.FRAGMENT_DATE;

END;

PROCEDURE PROCESS_DASH_3G_UTIL_WA (XDATE DATE) 
AS
BEGIN 

INSERT INTO NORTHI_DATA.DASH_3G_UTIL_WA (NETWORK_ID, FRAGMENT_DATE, KPI120, KPI120_A)
WITH UTIL AS
(
SELECT NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, FRAGMENT_DATE, CELL_UTIL ,VS_HSDPA_UE_MEAN_CELL ,VS_HSDPA_MEANCH_THRO
FROM NORTHI_DATA.CELL_UTIL_GLB_3G_FY1819_WA A, NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE A.NETWORK_ID=X.CELL_ID AND 
FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999--TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
  
)
 
 SELECT -999 NETWORK_ID, FRAGMENT_DATE, 
ROUND(AVG(CELL_UTIL),2) "KPI120" ,
ROUND(SUM (CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN 
                 (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
           WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN
                 (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END)
           ELSE 0 END)*100/COUNT(*),2)   "KPI120_A"
FROM UTIL
GROUP BY FRAGMENT_DATE
 
UNION ALL

SELECT SUB_REGION_ID NETWORK_ID,  FRAGMENT_DATE, 
ROUND(AVG(CELL_UTIL),2) "KPI120" ,
ROUND(SUM (CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN 
                 (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
           WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN
                 (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END)
           ELSE 0 END)*100/COUNT(*),2)   "KPI120_A"
FROM UTIL
GROUP BY SUB_REGION_ID,FRAGMENT_DATE

UNION ALL


SELECT MAIN_REGION_ID NETWORK_ID,  FRAGMENT_DATE, 
ROUND(AVG(CELL_UTIL),2) "KPI120" ,
ROUND(SUM (CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN 
                 (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
           WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN
                 (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END)
           ELSE 0 END)*100/COUNT(*),2)   "KPI120_A"
FROM UTIL
GROUP BY MAIN_REGION_ID,FRAGMENT_DATE

UNION ALL

SELECT CITY_ID NETWORK_ID,  FRAGMENT_DATE, 
ROUND(AVG(CELL_UTIL),2) "KPI120" ,
ROUND(SUM (CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN 
                 (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END )
           WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN
                 (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END)
           ELSE 0 END)*100/COUNT(*),2)   "KPI120_A"
FROM UTIL
GROUP BY CITY_ID,FRAGMENT_DATE;
END;

--PROCEDURE PROCESS_DASH_4G_UTILPRB_WA (XDATE DATE) 
--AS
--BEGIN 
--INSERT INTO NORTHI_DATA.DASH_4G_UTILPRB_WA (FRAGMENT_DATE, NETWORK_ID, KPI160, KPI160A, KPI160B, KPI160B_3)
--
--WITH UTILPRB AS
--(
--SELECT  /*+ MATERIALIZE PARALLEL 16 */ FRAGMENT_DATE,NETWORK_ID,SUB_REGION_ID,MAIN_REGION_ID,CITY_ID,
--                        
--                         ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-15)*100,2) KPI_160_NORM ,
--                         
--                         CASE
--                            WHEN ROUND((DL_ACTIVE_USERS)/((5*BW-15)/15),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-15)*100,2) > 100 THEN 1
--                            
--                            ELSE 0
--                         END  HIGH_LOAD_FLAG, 
--                         
--                         CASE
--                            WHEN ROUND((DL_ACTIVE_USERS)/((5*BW-15)/15),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-15)*100,2) > 100 AND (DL_USER_THROUGHPUT)<5  THEN 1
--                            
--                            ELSE 0
--                         END CONGESTION_FLAG,
--                         
--                        CASE
--                          WHEN ROUND((DL_ACTIVE_USERS)/((5*BW-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 AND (DL_USER_THROUGHPUT)<3  THEN 1
--                   
--                          ELSE 0
--                        END  KPI160B_3
--FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_WA A , NORTHI_DATA.LIST_ENODEB_CELL X 
--WHERE A.NETWORK_ID=X.CELL_ID AND FRAGMENT_DATE  BETWEEN XDATE AND XDATE+6.99999 --TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
--)
--     SELECT /*+ PARALLEL(16) +*/  FRAGMENT_DATE , -999 NETWORK_ID ,
--     ROUND(AVG(KPI_160_NORM),2) "KPI160",
--     ROUND(SUM(HIGH_LOAD_FLAG)/SUM(1)*100,2) "KPI160A",
--     ROUND(SUM(CONGESTION_FLAG)/SUM(1)*100,2) "KPI160B",
--     ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3"
--     FROM UTILPRB
--     GROUP BY  FRAGMENT_DATE 
--     UNION ALL
--     SELECT /*+ PARALLEL(16) +*/  FRAGMENT_DATE , SUB_REGION_ID NETWORK_ID ,
--     ROUND(AVG(KPI_160_NORM),2) "KPI160",
--     ROUND(SUM(HIGH_LOAD_FLAG)/SUM(1)*100,2) "KPI160A",
--     ROUND(SUM(CONGESTION_FLAG)/SUM(1)*100,2) "KPI160B",
--     ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3"
--     FROM UTILPRB
--     GROUP BY  FRAGMENT_DATE,SUB_REGION_ID 
--      UNION ALL
--     SELECT /*+ PARALLEL(16) +*/  FRAGMENT_DATE , MAIN_REGION_ID NETWORK_ID ,
--     ROUND(AVG(KPI_160_NORM),2) "KPI160",
--     ROUND(SUM(HIGH_LOAD_FLAG)/SUM(1)*100,2) "KPI160A",
--     ROUND(SUM(CONGESTION_FLAG)/SUM(1)*100,2) "KPI160B",
--     ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3"
--     FROM UTILPRB
--     GROUP BY  FRAGMENT_DATE,MAIN_REGION_ID 
--          UNION ALL
--     SELECT /*+ PARALLEL(16) +*/  FRAGMENT_DATE , CITY_ID NETWORK_ID ,
--     ROUND(AVG(KPI_160_NORM),2) "KPI160",
--     ROUND(SUM(HIGH_LOAD_FLAG)/SUM(1)*100,2) "KPI160A",
--     ROUND(SUM(CONGESTION_FLAG)/SUM(1)*100,2) "KPI160B",
--     ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3"
--     FROM UTILPRB
--     GROUP BY  FRAGMENT_DATE,CITY_ID ;
--
--END;


PROCEDURE PROCESS_DASH_4G_UTILPRB1920_WA (XDATE DATE) 
AS
BEGIN 

INSERT INTO  NORTHI_DATA.DASH_4G_UTILPRB_1920_WA (FRAGMENT_DATE, NETWORK_ID, KPI160_3,  KPI160B_3, DL_NONGBR_THR)

WITH DS_PRB AS
(SELECT /*+PARALLEL(4)*/   TRUNC(FRAGMENT_DATE) FRAGMENT_DATE,NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,
ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) KPI160_3,
CASE
WHEN ROUND((A.DL_NONGBR_ACTIVE_USERS)/((5*BW-(0.15*VOLTE_SESSION_TIME)-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 AND (DL_NONGBR_USER_THROUGHPUT)<3  THEN 1
ELSE 0
END  KPI160B_3,
ROUND( DL_NONGBR_USER_THROUGHPUT,2)    DL_NONGBR_USER_THROUGHPUT    
FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB4G_1920_WA A , NORTHI_DATA.LIST_ENODEB_CELL X 
WHERE A.NETWORK_ID=X.CELL_ID AND  UPPER(X.ENODEB_NAME) NOT LIKE '%CROWD%' AND  FRAGMENT_DATE  BETWEEN XDATE AND XDATE+6.99999
)

SELECT /*+PARALLEL(4)*/ FRAGMENT_DATE , -999 NETWORK_ID ,
ROUND(AVG(KPI160_3),2) "KPI160_3",
ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),2) "DL_NONGBR_THR"
FROM   DS_PRB A  
GROUP BY FRAGMENT_DATE
UNION ALL
SELECT /*+PARALLEL(4)*/ FRAGMENT_DATE , SUB_REGION_ID NETWORK_ID ,
ROUND(AVG(KPI160_3),2) "KPI160_3",
ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),2) "DL_NONGBR_THR"
FROM   DS_PRB A  
GROUP BY FRAGMENT_DATE, SUB_REGION_ID
UNION ALL
SELECT /*+PARALLEL(4)*/ FRAGMENT_DATE , MAIN_REGION_ID NETWORK_ID ,
ROUND(AVG(KPI160_3),2) "KPI160_3",
ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),2) "DL_NONGBR_THR"
FROM   DS_PRB A  
GROUP BY FRAGMENT_DATE, MAIN_REGION_ID
UNION ALL
SELECT /*+PARALLEL(4)*/ FRAGMENT_DATE , CITY_ID NETWORK_ID ,
ROUND(AVG(KPI160_3),2) "KPI160_3",
ROUND(SUM(KPI160B_3)/SUM(1)*100,2) "KPI160B_3",
ROUND(AVG(DL_NONGBR_USER_THROUGHPUT),2) "DL_NONGBR_THR"
FROM   DS_PRB A  
GROUP BY FRAGMENT_DATE, CITY_ID;

END;

PROCEDURE PROCESS_DASH_KPI_WA (XDATE DATE) 
AS
BEGIN

INSERT INTO NORTHI_DATA.DASHBOARD_KPI_WA 
(FRAGMENT_DATE, NETWORK_ID, V3_24, V3_2G, V3_3G, V3_4G, V1_24, V1_2G, V1_3G, V1_4G, V2, V2_2G, V2_3G, V4, V4_2G, V4_3G, COMB_AVAILABILITY, AVAILABILITY_2G, AVAILABILITY_3G, AVAILABILITY_4G, KPI120, KPI120_A, KPI160, KPI160A, KPI160B, KPI160B_3,KPI160_3,DL_NONGBR_THR )
SELECT NED.FRAGMENT_DATE,NED.NETWORK_ID,  
V3_24, V3_2G, V3_3G, V3_4G, V1_24, V1_2G, V1_3G, V1_4G, V2, V2_2G, V2_3G, V4, V4_2G, V4_3G,
COMB_AVAILABILITY, AVAILABILITY_2G, AVAILABILITY_3G, AVAILABILITY_4G,
KPI120,KPI120_A,
NULL KPI160,NULL KPI160A,NULL KPI160B, KPI160B_3 , KPI160_3, DL_NONGBR_THR
FROM 
NORTHI_DATA.DASH_NED_WA NED,

NORTHI_DATA.DASH_AVAIL_WA AVAIL LEFT OUTER JOIN 

NORTHI_DATA.DASH_3G_UTIL_WA UTIL3G ON ( AVAIL.NETWORK_ID=UTIL3G.NETWORK_ID AND AVAIL.FRAGMENT_DATE=UTIL3G.FRAGMENT_DATE  ),

NORTHI_DATA.DASH_4G_UTILPRB_1920_WA UTIL4G

WHERE NED.NETWORK_ID=AVAIL.NETWORK_ID AND NED.FRAGMENT_DATE=AVAIL.FRAGMENT_DATE AND 
     
      NED.NETWORK_ID=UTIL4G.NETWORK_ID AND NED.FRAGMENT_DATE=UTIL4G.FRAGMENT_DATE AND NED.FRAGMENT_DATE BETWEEN XDATE AND XDATE+6.99999 --TRUNC(SYSDATE-7) AND TRUNC(SYSDATE-1)
     
 ;
 
    
END;

END DASHBOARD_KPI_WA;
/
