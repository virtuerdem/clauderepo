
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."PROCESS_AUTOMATION" AS

PROCEDURE CHECK_CELLSTS_CELL_COUNT AS
XCELL_COUNT NUMBER;
XSTATEMENT VARCHAR2(12000);
pRecipient VARCHAR2(4000);
XERROR_COUNT NUMBER;
XALARM_COUNT NUMBER;
BEGIN 
    XERROR_COUNT:=0;
    SELECT MAX(CNT) INTO XCELL_COUNT
    FROM 
    (
        SELECT FRAGMENT_DATE,COUNT(*) CNT
        FROM NORTHI_DATA.CELLSTS
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        AND DTYPE=1
        GROUP BY FRAGMENT_DATE
    )
    ORDER BY FRAGMENT_DATE;
    XSTATEMENT:='CELLSTS Missing Cells for Last 5 days'||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Maximum Number of CELLs: ' ||XCELL_COUNT||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Calculated according  Max Cell Count in 5 Days and displays approximate values.'||CHR(13)||CHR(10);
    FOR XCNT IN 
    (
        SELECT FRAGMENT_DATE,CNT
        FROM
        (
        SELECT FRAGMENT_DATE,(XCELL_COUNT-COUNT(*)) CNT
        FROM NORTHI_DATA.CELLSTS
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        AND DTYPE=1
        GROUP BY FRAGMENT_DATE
        )
        WHERE CNT>200
        ORDER BY FRAGMENT_DATE
    )
    LOOP
        SELECT COUNT(*) INTO XALARM_COUNT
        FROM NORTHI_PAT.ALARM_LIST
        WHERE VENDOR=1 AND STATISTIC='CELLSTS' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        IF XALARM_COUNT>0 THEN
            UPDATE NORTHI_PAT.ALARM_LIST SET ALARM_COUNT=ALARM_COUNT+1
            WHERE VENDOR=1 AND STATISTIC='CELLSTS' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        ELSE
            INSERT INTO NORTHI_PAT.ALARM_LIST (ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS,ALARM_COUNT)
            VALUES (ALARM_ID.NEXTVAL,1,'CELLSTS',1,1,XCNT.FRAGMENT_DATE,SYSDATE,NULL,1,'Missing : '||XCNT.CNT||' CELLs',1,1);
        END IF;
        XERROR_COUNT:=1;
        XSTATEMENT:=XSTATEMENT||' Data Date:  '||TO_CHAR(XCNT.FRAGMENT_DATE,'''DD.MM.YYYY HH24''')||' Missing : '||XCNT.CNT ||CHR(13)||CHR(10); 
    END LOOP;
    COMMIT;
    pRecipient:='vesile.taskiran@ttgint.com';
    IF XERROR_COUNT=1 THEN 
        NORTHI.SEND_MAIL(pRecipient,'CELLSTS Missing Cells',XSTATEMENT);
    END IF;
END CHECK_CELLSTS_CELL_COUNT ;

PROCEDURE CHECK_CARRSTS_CELL_COUNT AS
XCELL_COUNT NUMBER;
XSTATEMENT VARCHAR2(12000);
pRecipient VARCHAR2(4000);
XERROR_COUNT NUMBER;
XALARM_COUNT NUMBER;
BEGIN 
    XERROR_COUNT:=0;
    SELECT MAX(CNT) INTO XCELL_COUNT
    FROM 
    (
        SELECT FRAGMENT_DATE,COUNT(*) CNT
        FROM NORTHI_DATA.CARRSTS
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        AND DTYPE=2
        GROUP BY FRAGMENT_DATE
    )
    ORDER BY FRAGMENT_DATE;
    XSTATEMENT:='CARRSTS Missing Cells for Last 5 days'||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Maximum Number of CELLs: ' ||XCELL_COUNT||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Calculated according  Max Cell Count in 5 Days and displays approximate values.'||CHR(13)||CHR(10);
    FOR XCNT IN 
    (
        SELECT FRAGMENT_DATE,CNT
        FROM
        (
        SELECT FRAGMENT_DATE,(XCELL_COUNT-COUNT(*)) CNT
        FROM NORTHI_DATA.CARRSTS
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        AND DTYPE=2
        GROUP BY FRAGMENT_DATE
        )
        WHERE CNT>200
        ORDER BY FRAGMENT_DATE
    )
    LOOP
        SELECT COUNT(*) INTO XALARM_COUNT
        FROM NORTHI_PAT.ALARM_LIST
        WHERE VENDOR=1 AND STATISTIC='CARRSTS' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        IF XALARM_COUNT>0 THEN
            UPDATE NORTHI_PAT.ALARM_LIST SET ALARM_COUNT=ALARM_COUNT+1
            WHERE VENDOR=1 AND STATISTIC='CARRSTS' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        ELSE
            INSERT INTO NORTHI_PAT.ALARM_LIST (ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS,ALARM_COUNT)
            VALUES (ALARM_ID.NEXTVAL,1,'CARRSTS',1,1,XCNT.FRAGMENT_DATE,SYSDATE,NULL,1,'Missing : '||XCNT.CNT||' CELLs',1,1);
        END IF;
        XERROR_COUNT:=1;
        XSTATEMENT:=XSTATEMENT||' Data Date:  '||TO_CHAR(XCNT.FRAGMENT_DATE,'''DD.MM.YYYY HH24''')||' Missing : '||XCNT.CNT ||CHR(13)||CHR(10); 
    END LOOP;
    pRecipient:='vesile.taskiran@ttgint.com';
    IF XERROR_COUNT=1 THEN
        NORTHI.SEND_MAIL(pRecipient,'CARRSTS Missing Cells',XSTATEMENT);
    END IF;
    COMMIT;
END CHECK_CARRSTS_CELL_COUNT ;
        
PROCEDURE CHECK_GBL_CELL_COUNT AS
XCELL_COUNT NUMBER;
XSTATEMENT VARCHAR2(12000);
pRecipient VARCHAR2(4000);
XERROR_COUNT NUMBER;
XALARM_COUNT NUMBER;
BEGIN 
    XERROR_COUNT:=0;
    SELECT MAX(CNT) INTO XCELL_COUNT
    FROM 
    (
        SELECT FRAGMENT_DATE,COUNT(*) CNT
        FROM NORTHI_DATA.GBL
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
    )
    ORDER BY FRAGMENT_DATE;
    XSTATEMENT:='GBL Missing Data for Last 5 days'||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Maximum Number of CELLs: ' ||XCELL_COUNT||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Calculated according  Max Cell Count in 5 Days and displays approximate values.'||CHR(13)||CHR(10);
    FOR XCNT IN 
    (
        SELECT FRAGMENT_DATE,CNT
        FROM
        (
        SELECT FRAGMENT_DATE,(XCELL_COUNT-COUNT(*)) CNT
        FROM NORTHI_DATA.GBL
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
        )
        WHERE CNT>200
        ORDER BY FRAGMENT_DATE
    )
    LOOP
        SELECT COUNT(*) INTO XALARM_COUNT
        FROM NORTHI_PAT.ALARM_LIST
        WHERE VENDOR=1 AND STATISTIC='GBL' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        IF XALARM_COUNT>0 THEN
            UPDATE NORTHI_PAT.ALARM_LIST SET ALARM_COUNT=ALARM_COUNT+1
            WHERE VENDOR=1 AND STATISTIC='GBL' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        ELSE
            INSERT INTO NORTHI_PAT.ALARM_LIST (ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS,ALARM_COUNT)
            VALUES (ALARM_ID.NEXTVAL,1,'GBL',1,1,XCNT.FRAGMENT_DATE,SYSDATE,NULL,1,'Missing : '||XCNT.CNT||' GBLs',1,1);
        END IF;
        XERROR_COUNT:=1;
        XSTATEMENT:=XSTATEMENT||' Data Date:  '||TO_CHAR(XCNT.FRAGMENT_DATE,'''DD.MM.YYYY HH24''')||' Missing : '||XCNT.CNT ||CHR(13)||CHR(10); 
    END LOOP;
    pRecipient:='vesile.taskiran@ttgint.com';
    COMMIT;
    IF XERROR_COUNT=1 THEN
        NORTHI.SEND_MAIL(pRecipient,'GBL Missing Data',XSTATEMENT);
    END IF;
END CHECK_GBL_CELL_COUNT ;
    

PROCEDURE CHECK_LAPD_CELL_COUNT AS
XCELL_COUNT NUMBER;
XSTATEMENT VARCHAR2(12000);
pRecipient VARCHAR2(4000);
XERROR_COUNT NUMBER;
XALARM_COUNT NUMBER;
BEGIN 
    XERROR_COUNT:=0;
    SELECT MAX(CNT) INTO XCELL_COUNT
    FROM 
    (
        SELECT FRAGMENT_DATE,COUNT(*) CNT
        FROM NORTHI_DATA.LAPD
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
    )
    ORDER BY FRAGMENT_DATE;
    XSTATEMENT:='LAPD Missing Data for Last 5 days'||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Maximum Number of CELLs: ' ||XCELL_COUNT||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Calculated according  Max Cell Count in 5 Days and displays approximate values.'||CHR(13)||CHR(10);
    FOR XCNT IN 
    (
        SELECT FRAGMENT_DATE,CNT
        FROM
        (
        SELECT FRAGMENT_DATE,(XCELL_COUNT-COUNT(*)) CNT
        FROM NORTHI_DATA.LAPD
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
        )
        WHERE CNT>200
        ORDER BY FRAGMENT_DATE
    )
    LOOP
        SELECT COUNT(*) INTO XALARM_COUNT
        FROM NORTHI_PAT.ALARM_LIST
        WHERE VENDOR=1 AND STATISTIC='LAPD' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        IF XALARM_COUNT>0 THEN
            UPDATE NORTHI_PAT.ALARM_LIST SET ALARM_COUNT=ALARM_COUNT+1
            WHERE VENDOR=1 AND STATISTIC='LAPD' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        ELSE
            INSERT INTO NORTHI_PAT.ALARM_LIST (ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS,ALARM_COUNT)
            VALUES (ALARM_ID.NEXTVAL,1,'LAPD',1,1,XCNT.FRAGMENT_DATE,SYSDATE,NULL,1,'Missing : '||XCNT.CNT||' LAPDs',1,1);
        END IF;
        XERROR_COUNT:=1;
        XSTATEMENT:=XSTATEMENT||' Data Date:  '||TO_CHAR(XCNT.FRAGMENT_DATE,'''DD.MM.YYYY HH24''')||' Missing : '||XCNT.CNT ||CHR(13)||CHR(10); 
    END LOOP;
    pRecipient:='vesile.taskiran@ttgint.com';
    IF XERROR_COUNT=1 THEN
        NORTHI.SEND_MAIL(pRecipient,'LAPD Missing Data',XSTATEMENT);
    END IF;
    COMMIT;
END CHECK_LAPD_CELL_COUNT ;

PROCEDURE CHECK_S7LINK_CELL_COUNT AS
XCELL_COUNT NUMBER;
XSTATEMENT VARCHAR2(12000);
pRecipient VARCHAR2(4000);
XERROR_COUNT NUMBER;
XALARM_COUNT NUMBER;
BEGIN 
    XERROR_COUNT:=0;
    SELECT MAX(CNT) INTO XCELL_COUNT
    FROM 
    (
        SELECT FRAGMENT_DATE,COUNT(*) CNT
        FROM NORTHI_DATA.S7LINK
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
    )
    ORDER BY FRAGMENT_DATE;
    XSTATEMENT:='S7LINK Missing Data for Last 5 days'||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Maximum Number of CELLs: ' ||XCELL_COUNT||CHR(13)||CHR(10);
    XSTATEMENT:=XSTATEMENT ||'Calculated according  Max Cell Count in 5 Days and displays approximate values.'||CHR(13)||CHR(10);
    FOR XCNT IN 
    (
        SELECT FRAGMENT_DATE,CNT
        FROM
        (
        SELECT FRAGMENT_DATE,(XCELL_COUNT-COUNT(*)) CNT
        FROM NORTHI_DATA.S7LINK
        WHERE FRAGMENT_DATE BETWEEN SYSDATE-5 AND SYSDATE
        GROUP BY FRAGMENT_DATE
        )
        WHERE CNT>200
        ORDER BY FRAGMENT_DATE
    )
    LOOP
        SELECT COUNT(*) INTO XALARM_COUNT
        FROM NORTHI_PAT.ALARM_LIST
        WHERE VENDOR=1 AND STATISTIC='S7LINK' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        IF XALARM_COUNT>0 THEN
            UPDATE NORTHI_PAT.ALARM_LIST SET ALARM_COUNT=ALARM_COUNT+1
            WHERE VENDOR=1 AND STATISTIC='S7LINK' AND DATA_DATE=XCNT.FRAGMENT_DATE;
        ELSE
            INSERT INTO NORTHI_PAT.ALARM_LIST (ALARM_ID, VENDOR, STATISTIC, ALARM_TYPE, SEVERITY, DATA_DATE, ALARM_OPEN_DATE, ALARM_CLOSE_DATE, OWNER, ALARM_DETAIL, ALARM_STATUS,ALARM_COUNT)
            VALUES (ALARM_ID.NEXTVAL,1,'S7LINK',1,1,XCNT.FRAGMENT_DATE,SYSDATE,NULL,1,'Missing : '||XCNT.CNT||' MTLs',1,1);
        END IF;
        XERROR_COUNT:=1;
        XSTATEMENT:=XSTATEMENT||' Data Date:  '||TO_CHAR(XCNT.FRAGMENT_DATE,'''DD.MM.YYYY HH24''')||' Missing : '||XCNT.CNT ||CHR(13)||CHR(10); 
    END LOOP;
    pRecipient:='vesile.taskiran@ttgint.com';
    IF XERROR_COUNT=1 THEN
        NORTHI.SEND_MAIL(pRecipient,'S7LINK Missing Data',XSTATEMENT);
    END IF;
    COMMIT;
END CHECK_S7LINK_CELL_COUNT ;
        
END;
/
