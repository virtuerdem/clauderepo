
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."HOURLY_WORKS" AS
/******************************************************************************
   NAME:       LOADER_WORKS
   PURPOSE:

   REVISIONS:
   Ver        Date                                Author                                     Description
   ---------  ----------  --------------------------------------------   ------------------------------------
   2.0        25/03/2016  1.Erdem TARIKCI - Neslihan KUMBASAR  Loader works with aggregates.
******************************************************************************/
  
  PROCEDURE INSERT_HOURLY_PROCESS(P_SYSTEM_ID NUMBER)
  AS
  XEXIST NUMBER;
  BEGIN
     FOR XH IN
    (
            SELECT A.TABLE_NAME ORG_TABLE,A.TABLE_NAME||'_'||PARTITION_VALUE TABLE_NAME,PARSER_DATE,DATA_DATE,DTYPE
            FROM (
                SELECT B.TABLE_NAME,PARTITION_ID,MAX(sysdate) PARSER_DATE, DATA_DATE
                FROM 
                   (
                        SELECT S.TABLE_NAME,P.PARENT_NAME PARENT_NAME,PARTITION_ID 
                        FROM NORTHI_LOADER_PARENTS P,
                        NORTHI_LOADER_SETTINGS S 
                        WHERE S.TABLE_NAME=P.TABLE_NAME AND S.ACTIVE=1 AND P.ACTIVE=1 AND S.VENDOR_ID IN (SELECT VENDOR_ID FROM NORTHI_VENDOR_LIST WHERE SYSTEM_ID=3) 
                   ) B,
                   (   
                        SELECT DISTINCT DATA_DATE 
                        FROM NORTHI_LOADER_PROCESS WHERE LOADER_STATE=2 AND HOURLY_STATE=0 AND ORG_TABLE IN ('CELLSTS','CELL_STATISTICS','CELLSTS_4G') AND  DATA_DATE>=TRUNC(SYSDATE-1)   
                   ) A
                   GROUP BY B.TABLE_NAME,DATA_DATE,PARTITION_ID
                ) A, NORTHI_PARTITION_TYPE B
                WHERE A.PARTITION_ID=B.PARTITION_ID 
    )
    LOOP
            SELECT COUNT(*) INTO XEXIST FROM NORTHI_HOURLY_PROCESS WHERE TABLE_NAME=XH.TABLE_NAME AND DATA_DATE=XH.DATA_DATE  ;
            UPDATE NORTHI_LOADER_PROCESS SET HOURLY_STATE=1 WHERE ORG_TABLE IN  ('CELLSTS','CELL_STATISTICS','CELLSTS_4G') AND LOADER_STATE=2 AND DATA_DATE=XH.DATA_DATE; 
             IF XEXIST>0 THEN
                UPDATE NORTHI_HOURLY_PROCESS 
                SET AGGREGATE_STATE=0 ,DAILY_STATE=0,PROCESS_COUNT=PROCESS_COUNT+1 WHERE ORG_TABLE=XH.ORG_TABLE AND DATA_DATE=XH.DATA_DATE;
                 
             ELSE 
                INSERT INTO NORTHI_HOURLY_PROCESS(ORG_TABLE,TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,DAILY_STATE,SYSTEM_ID,DTYPE) 
                VALUES(XH.ORG_TABLE,XH.TABLE_NAME, XH.DATA_DATE,SYSDATE,0,SYSDATE,0,1,0,P_SYSTEM_ID,XH.DTYPE);
            END IF;    
    END LOOP;
    COMMIT;
  END;
  PROCEDURE BEGIN_HOURLY_TRANSFER(P_SYSTEM_ID NUMBER)
  AS
   XTABLE_NAME VARCHAR2(40);
  XDATA_DATE DATE;
  XROW_COUNT NUMBER;
  XVENDOR_ID NUMBER;
  XPARTITION_TYPE NUMBER;
  XPARTITION_NAME VARCHAR2(50);
   XDLT_COUNT NUMBER;
    XTBL_NAME  VARCHAR2(40);
    XDATE DATE;
  BEGIN
  XDLT_COUNT := 0;
  XVENDOR_ID :=5;
  XTBL_NAME:='AAA';
  XDATE:=TO_DATE('01.01.2016 00','DD.MM.YYYY HH24');
    FOR XLOG IN
    (
        SELECT TABLE_NAME TABLE_NAME,DATA_DATE,LOADER_DATE,PROCESS_COUNT LOADER_COUNT,ORG_TABLE,DTYPE,DECODE(DTYPE,1,ORG_TABLE,0,ORG_TABLE,TABLE_NAME) PROCEDURE_NAME 
        FROM NORTHI_HOURLY_PROCESS 
        WHERE  AGGREGATE_STATE=0 
        AND SYSTEM_ID=3 
        ORDER BY ORG_TABLE,DATA_DATE,DTYPE
    )
    LOOP
        XTABLE_NAME:=XLOG.ORG_TABLE;
       XDATA_DATE:=XLOG.DATA_DATE;
       IF XTBL_NAME!=XLOG.ORG_TABLE OR XDATE!=XLOG.DATA_DATE THEN
          XTBL_NAME:=XLOG.ORG_TABLE;
          XDATE:=XLOG.DATA_DATE;
          XDLT_COUNT:=0; 
       END IF;
       
       UPDATE NORTHI_HOURLY_PROCESS SET AGGREGATE_STATE=1 WHERE TABLE_NAME=XLOG.TABLE_NAME AND DATA_DATE=XLOG.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       COMMIT;
       
       IF XLOG.LOADER_COUNT>1 THEN
         IF XDLT_COUNT=0 THEN     
            DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XLOG.ORG_TABLE AND FRAGMENT_DATE=XLOG.DATA_DATE;
            COMMIT;  
            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XTABLE_NAME || ' WHERE  FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';
            XDLT_COUNT:=1;
         END IF;
       END IF; 
       
       
        IF  ((XLOG.ORG_TABLE='ALLNWSTS')) THEN
           EXECUTE_PROCEDURE(XLOG.ORG_TABLE,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
           EXECUTE_PROCEDURE(XLOG.ORG_TABLE||'40',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
           EXECUTE_PROCEDURE(XLOG.ORG_TABLE||'41',XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
           EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
          ELSE
           EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID); 
       END IF;
       
       --EXECUTE_PROCEDURE(XLOG.PROCEDURE_NAME,XDATA_DATE,XLOG.LOADER_DATE,XROW_COUNT,XVENDOR_ID);
  
       
       /*DELETE LOADED DATA KEEP AGGREGATED DATA.*/
       IF XLOG.DTYPE=13 THEN 
                DELETE FROM NORTHI_TABLE_LOGS WHERE TABLE_NAME=XTABLE_NAME AND AGGREGATE_TYPE='LOADER' AND FRAGMENT_DATE=XLOG.DATA_DATE;
                COMMIT;  
                EXECUTE IMMEDIATE 'DELETE FROM NORTHI_DATA.'|| XTABLE_NAME || ' WHERE  DTYPE=1 AND FRAGMENT_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';
       END IF;
       UPDATE NORTHI_HOURLY_PROCESS SET AGGREGATE_STATE=2 WHERE TABLE_NAME=XLOG.TABLE_NAME AND DATA_DATE=XLOG.DATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       COMMIT;     
    END LOOP;
    EXCEPTION
     WHEN NO_DATA_FOUND THEN
       NULL;
     WHEN OTHERS THEN
     UPDATE NORTHI_HOURLY_PROCESS SET AGGREGATE_STATE=3 WHERE ORG_TABLE=XTABLE_NAME AND DATA_DATE=XDATA_DATE AND SYSTEM_ID=P_SYSTEM_ID;
       RAISE;
  END;
  
  PROCEDURE EXECUTE_HOURLY_WORKS(P_SYSTEM_ID NUMBER) 
  AS
  XSYSTEM_NAME VARCHAR2(20);
  BEGIN
    SELECT SYSTEM_NAME INTO XSYSTEM_NAME FROM NORTHI_SYSTEM_LIST 
    WHERE SYSTEM_ID=P_SYSTEM_ID;
    XSYSTEM_NAME:='HOURLY_'||XSYSTEM_NAME;
    
    IF (LOADER_STATE.GET_STATE(XSYSTEM_NAME)=0) THEN
        LOADER_STATE.SET_START(XSYSTEM_NAME);
        INSERT_HOURLY_PROCESS(P_SYSTEM_ID);
        BEGIN_HOURLY_TRANSFER(P_SYSTEM_ID);
        LOADER_STATE.SET_END(XSYSTEM_NAME);
    END IF;
  END;
END ; 
/
