
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."EXTRA_WORKS" AS
/******************************************************************************
   NAME:       EXTRA_WORKS
   PURPOSE:

   REVISIONS:
   Ver        Date        Author           Description
   ---------  ----------  ---------------  ------------------------------------
   1.0        11/19/2009             1. Created this package.
******************************************************************************/
PROCEDURE PROCESS_REPORT_CODE_USAGE_HUAW(XDATE DATE)
AS
errm varchar2(4000);
errcode number;
BEGIN
    DELETE FROM NORTHI_DATA.REPORT_CODE_USAGE_HUAWEI WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    INSERT /*+ PARALLEL(4) */  INTO NORTHI_DATA.REPORT_CODE_USAGE_HUAWEI (NETWORK_ID,CELL,DL_CODE_USAGE,TYPE, FRAGMENT_DATE)
    SELECT NETWORK_ID,CELL,DL_NON_HS_CODE_USAGE,0, XDATE 
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY DL_NON_HS_CODE_USAGE DESC) RN,
    DL_NON_HS_CODE_USAGE/256 DL_NON_HS_CODE_USAGE,
    TARIH,
    1 BH_TYPE
    FROM 
    (
      SELECT A.NETWORK_ID,
             CELL,
             DL_NON_HS_CODE_USAGE,
             TARIH
     FROM (
     SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL, 
                AA.RNCID,
                AVG(( C67202942 + C67199698 )*64+( C67199691 + C67199699 )*32+(C67199692 + C67199700)*16+(C67199693 + C67199701)*8+(C67199694 + C67199702)*4+(C67202943 + C67199703 )*2+(C67199703 + C67199704 )) DL_NON_HS_CODE_USAGE,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                HIZIR2.M2_MULTI_RAB_SERVICE_PER_CELL AA
                WHERE
                AA.NETWORK_ID = BB.CELL_ID AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 
                GROUP BY
                AA.NETWORK_ID,BB.CELL_NAME,AA.RNCID , TRUNC(AA.DATA_DATE,'HH24')
                )A,
                  HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE B.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
           ) 
    )
    WHERE RN=1;
    COMMIT;
    
    INSERT /*+ PARALLEL(4) */  INTO NORTHI_DATA.REPORT_CODE_USAGE_HUAWEI (NETWORK_ID,CELL,DL_CODE_USAGE,TYPE, FRAGMENT_DATE)
    SELECT NETWORK_ID,CELL,DL_TOTAL_CODE_USAGE,1, XDATE 
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY DL_TOTAL_CODE_USAGE DESC) RN,
    DL_TOTAL_CODE_USAGE/256 DL_TOTAL_CODE_USAGE,
    TARIH,
    1 BH_TYPE
    FROM 
    (
      SELECT A.NETWORK_ID,
             CELL,
             (DL_NON_HS_CODE_USAGE+(C50341688*16)) DL_TOTAL_CODE_USAGE,
             TARIH
     FROM (
     SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL, 
                AA.RNCID,                
                AVG(( C67202942 +C67199698)*64+(C67199691 + C67199699)*32+( C67199692 + C67199700)*16+ (C67199693 + C67199701 )*8+(C67199694 + C67199702)*4+(C67202943 + C67199703)*2+( C67199703 + C67199704 ))  DL_NON_HS_CODE_USAGE,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                HIZIR2.M2_MULTI_RAB_SERVICE_PER_CELL AA
                WHERE
                AA.NETWORK_ID = BB.CELL_ID AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 
                GROUP BY
                AA.NETWORK_ID,BB.CELL_NAME,AA.RNCID , TRUNC(AA.DATA_DATE,'HH24')
                )A,
                  HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE B.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
           ) 
    )
    WHERE RN=1;
    COMMIT;
    
    EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',NULL );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
    
END;
PROCEDURE PROCESS_REPORT_ULUTL_GLOBAL_3G(XDATE DATE)
AS
errm varchar2(4000);
errcode number;
BEGIN
    DELETE FROM NORTHI_DATA.REPORT_CELL_ULUTIL_GLOBAL_3G WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    INSERT /*+ append */  INTO NORTHI_DATA.REPORT_CELL_ULUTIL_GLOBAL_3G
    SELECT NETWORK_ID,
    TRUNC(DATA_DATE) TARIH,
    MIN(C67199617) MEANRTWP 
    FROM HIZIR2.M2_TX_RX_POWER_PER_CELL AA
    WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
    GROUP BY NETWORK_ID,TRUNC(DATA_DATE);
    COMMIT;
    
     EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',NULL );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
       
END;

PROCEDURE REPORT_ULUTL_GLOBAL_3G_KKTC(XDATE DATE)
AS
errm varchar2(4000);
errcode number;
BEGIN
    DELETE FROM NORTHI_DATA.CELL_ULUTIL_GLOBAL_3G_KKTC WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    INSERT /*+ append */  INTO NORTHI_DATA.CELL_ULUTIL_GLOBAL_3G_KKTC
    SELECT NETWORK_ID,
    TRUNC(DATA_DATE) TARIH,
    MIN(C67199617) MEANRTWP 
    FROM NORTHI_PARSER_KKTC.M2_TX_RX_POWER_PER_CELL AA
    WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
    GROUP BY NETWORK_ID,TRUNC(DATA_DATE);
    COMMIT;
    
     EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',NULL );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
       
END;

PROCEDURE PROCESS_REPORT_NODEB_GLOBAL_3G(XDATE DATE)
AS
errm varchar2(4000);
errcode number;
BEGIN
    DELETE FROM NORTHI_DATA.REPORT_NODEB_CEUTIL_GLOBAL_3G WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    
    INSERT /*+ append */  INTO NORTHI_DATA.REPORT_NODEB_CEUTIL_GLOBAL_3G 
    SELECT NODEB,TARIH,DLCREDITUSED CREDITUSED, 1 BH_TYPE
    FROM 
    (
     SELECT   ZZ.NODEB,
     DATA_DATE TARIH,
     ROW_NUMBER() OVER (PARTITION BY ZZ.NODEB ORDER BY DLCREDITUSED DESC) RN ,
     DLCREDITUSED
     FROM   (  
        SELECT   BB.PARENT_NAME AS NODEB,
        SUM (AA.C67202570) / 2 AS DLCREDITUSED,
        TRUNC (DATA_DATE, 'HH24') DATA_DATE
        FROM   HIZIR2.M2_ALGORITHM_PER_CELL AA,
               NORTHI_DATA.LIST_CELL BB
        WHERE   AA.NETWORK_ID = BB.NE_ID
        AND DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
        GROUP BY   BB.PARENT_NAME, TRUNC (DATA_DATE, 'HH24')
             ) ZZ
    )     WHERE RN=1    
    UNION ALL
       
    SELECT NODEB,TARIH,ULCREDITUSED CREDITUSED, 2 BH_TYPE
    FROM 
    (   
       SELECT   ZZ.NODEB,
     DATA_DATE TARIH,
     ROW_NUMBER() OVER (PARTITION BY ZZ.NODEB ORDER BY ULCREDITUSED DESC) RN,
     ULCREDITUSED
     FROM   (  
        SELECT   BB.PARENT_NAME AS NODEB,
        SUM(AA.C67202567)/4 AS ULCREDITUSED,
        TRUNC (DATA_DATE, 'HH24') DATA_DATE
        FROM   HIZIR2.M2_ALGORITHM_PER_CELL AA,
               NORTHI_DATA.LIST_CELL BB
        WHERE   AA.NETWORK_ID = BB.NE_ID
        AND DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
        GROUP BY   BB.PARENT_NAME, TRUNC (DATA_DATE, 'HH24')
             ) ZZ
             )  
     WHERE RN=1;
             COMMIT;
             
              EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',NULL );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
             
END;        


PROCEDURE PROCESS_REPORT_CELL_GLOBAL_3G(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G';

    DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    
    /*   OLD QUERY
    INSERT  INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
    SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
    UTIL_POW,
    R99_CODE_USAGE,
    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
    MEANRTWP,MINRTWP,
    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
    AMR_CTRL_DL12_2 ,
    RB_DLCONVCS_64 , 
    R99,
    HSDPA_TOTALBYTES ,
    HSUPA_TOTALBYTES ,
    TARIH,
    1 BH_TYPE
    FROM 
    (
      SELECT A.NETWORK_ID,
             CELL,
             UTIL_POW,
             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
             MEANRTWP,
             MAXRTWP,
             MINRTWP,
             AMR_CTRL_DL12_2,
             RB_DLCONVCS_64,
             R99,
             HSDPA_TOTALBYTES,
             HSUPA_TOTALBYTES,
             TARIH
     FROM (
     /*SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL, 
                AA.RNCID,
                (POWER(10,AVG(AA.C67199618)/10)-0.15*POWER(10,MAX(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,MAX(CC.MAXTXPOWER)/100)) AS UTIL_POW, 
                AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64) R99_CODE_USAGE ,
                --AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700+C50341688)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64)/(256*0.75)*100 R99_CODE_USAGE ,
                AVG(C67199617) MEANRTWP,
                AVG(C67199680) MAXRTWP, 
                AVG(C67199681) MINRTWP,
                SUM(C67199620)/2 AMR_CTRL_DL12_2 ,
                SUM(C67199556)/2 RB_DLCONVCS_64 , 
                SUM(C67184000+C67183999+C67183998+C67183997+C67183996+C67183995+C67183994+C67183993+C67184008+C67184007+C67184006+C67184005+C67184004+
                C67184003+C67184002+C67184001+C67184021+C67184020+C67184019+C67184018+C67184017+C67184016+C67184015+C67184014+C67184029+C67184028+
                C67184027+C67184026+C67184025+C67184024+C67184023+C67184022) R99,
                SUM(C67189840) HSDPA_TOTALBYTES ,
                SUM(C67192486) HSUPA_TOTALBYTES ,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                HIZIR2.M2_TX_RX_POWER_PER_CELL AA,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(XDATE)-30 AND TRUNC(XDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                HIZIR2.M2_MULTI_RAB_SERVICE_PER_CELL DD,
                HIZIR2.M2_RB_PROC_PER_CELL EE,
                HIZIR2.M2_THROUGHPUT_PER_CELL FF,
                HIZIR2.M2_HSDPA_PER_CELL GG,
                HIZIR2.M2_HSUPA_PER_CELL HH
                --,HIZIR2. M2_HSDPA_PER_LOCAL_CELL XX
                WHERE
                AA.NETWORK_ID = DD.NETWORK_ID AND AA.RNCID = DD.RNCID AND 
                AA.DATA_DATE = DD.DATA_DATE AND
                AA.NETWORK_ID = EE.NETWORK_ID AND AA.RNCID = EE.RNCID AND 
                AA.DATA_DATE = EE.DATA_DATE AND
                AA.NETWORK_ID = FF.NETWORK_ID AND AA.RNCID = FF.RNCID AND 
                AA.DATA_DATE = FF.DATA_DATE AND
                AA.NETWORK_ID = GG.NETWORK_ID AND AA.RNCID = GG.RNCID AND 
                AA.DATA_DATE = GG.DATA_DATE AND
                AA.NETWORK_ID = HH.NETWORK_ID AND AA.RNCID = HH.RNCID AND 
                AA.DATA_DATE = HH.DATA_DATE AND
                AA.NETWORK_ID = BB.CELL_ID AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND
                AA.C67199618 > 0 AND
                BB.CELL_NAME = CELLNAME 
                GROUP BY
                AA.NETWORK_ID,BB.CELL_NAME,AA.RNCID , TRUNC(AA.DATA_DATE,'HH24')*/
     /*                          SELECT 
                B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                (POWER(10,(VS_MEAN_TCP/2)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                CODES_USED_AVG R99_CODE_USAGE, --AVG
                VS_MEANRTWP MEANRTWP, --AVG
                VS_MAXRTWP MAXRTWP, --AVG
                VS_MINRTWP MINRTWP, --AVG
                CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                TRAF_HSUPA HSUPA_TOTALBYTES
                FROM 
                (
                SELECT NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                FROM HIZIR2.M2_THROUGHPUT_PER_CELL
                WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
                GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') 
                ) A, NORTHI_DATA.CELL_STATISTICS B,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_UCELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB
                WHERE A.NETWORK_ID=B.NETWORK_ID
                AND A.RNCID=B.RNC_ID 
                AND A.DATA_DATE=B.FRAGMENT_DATE
                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                AND B.DTYPE=1
                AND VS_MEAN_TCP>0
                AND B.NETWORK_ID = BB.CELL_ID
                AND BB.CELL_NAME = CELLNAME
                )A,
                  HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE B.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
           ) 
    )
    WHERE RN=1;
            
    
    
    
    */
    
    /*
            INSERT'LER TAKILI KALDIGI ICIN ARALARA TEMP TABLELAR OLUSTURULDU
    
    
       
XSTATE := 'TRUNCATE TABLE  NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1';
    
    EXECUTE IMMEDIATE ' TRUNCATE TABLE  NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 ';
    
XSTATE := 'TRUNCATE TABLE  NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2';
    EXECUTE IMMEDIATE ' TRUNCATE TABLE  NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 ';
    
XSTATE := ' INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1';
    
     INSERT  INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 NOLOGGING
             SELECT  NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
               FROM HIZIR2.M2_THROUGHPUT_PER_CELL
             WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
        GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') ;
        
    COMMIT;
    

XSTATE := ' INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2';
    
    INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 NOLOGGING
                                           SELECT 
                                                            B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                                                            (POWER(10,(VS_MEAN_TCP/2)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                                                            CODES_USED_AVG R99_CODE_USAGE, --AVG
                                                            VS_MEANRTWP MEANRTWP, --AVG
                                                            VS_MAXRTWP MAXRTWP, --AVG
                                                            VS_MINRTWP MINRTWP, --AVG
                                                            CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                                                            CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                                                            PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                                                            TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                                                            TRAF_HSUPA HSUPA_TOTALBYTES
                                            FROM 
                                                    (
                                                            SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER 
                                                               FROM NORTHI_DATA.V_UCELLSETUP  
                                                             WHERE EXPORT_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 
                                                        GROUP BY REPLACE(CELLNAME,'"') 
                                                    ) CC,
                                                    NORTHI_DATA.CELL_STATISTICS B,
                                                    NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                                                    NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 A
                                            WHERE 
                                                        A.NETWORK_ID=B.NETWORK_ID
                                                AND A.RNCID=B.RNC_ID 
                                                AND A.DATA_DATE=B.FRAGMENT_DATE
                                                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                                                AND B.DTYPE=1
                                                AND VS_MEAN_TCP>0
                                                AND B.NETWORK_ID = BB.CELL_ID
                                                AND BB.CELL_NAME = CC.CELLNAME;
            COMMIT;                     

    
    
    */

    
DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1; COMMIT;

INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1(NETWORK_ID, RNCID, DATA_DATE, R99_MINUS)
SELECT  NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                                       FROM HIZIR2.M2_THROUGHPUT_PER_CELL
                                     WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
                                GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24');
                                
COMMIT;
                                            

DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2; COMMIT;

INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2(NETWORK_ID, RNCID, TARIH, CELL, UTIL_POW, R99_CODE_USAGE, MEANRTWP, MAXRTWP, MINRTWP, AMR_CTRL_DL12_2, RB_DLCONVCS_64, R99, HSDPA_TOTALBYTES, HSUPA_TOTALBYTES)
SELECT 
                                                            B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                                                            (POWER(10,(VS_MEAN_TCP)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                                                            CODES_USED_AVG R99_CODE_USAGE, --AVG
                                                            VS_MEANRTWP MEANRTWP, --AVG
                                                            VS_MAXRTWP MAXRTWP, --AVG
                                                            VS_MINRTWP MINRTWP, --AVG
                                                            CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                                                            CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                                                            PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                                                            TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                                                            TRAF_HSUPA HSUPA_TOTALBYTES
                                            FROM 
                                                    (      SELECT CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
                                                             UNION
                                                           SELECT CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
                                                            
                                                    ) CC,
                                                    NORTHI_DATA.CELL_STATISTICS B,
                                                    NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                                                    NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 A
                                            WHERE 
                                                        A.NETWORK_ID=B.NETWORK_ID
                                                AND A.RNCID=B.RNC_ID 
                                                AND A.DATA_DATE=B.FRAGMENT_DATE
                                                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                                                AND B.DTYPE=1
                                                AND VS_MEAN_TCP>0
                                                AND B.NETWORK_ID = BB.CELL_ID
                                                AND BB.CELL_NAME = CC.CELLNAME;

COMMIT;

XSTATE := ' INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G';
                                    
    INSERT /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
              SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                FROM (
                                SELECT    NETWORK_ID,CELL,
                                                ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
                                                UTIL_POW,
                                                R99_CODE_USAGE,
                                                GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
                                                MEANRTWP,MINRTWP,
                                                (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                AMR_CTRL_DL12_2 ,
                                                RB_DLCONVCS_64 , 
                                                R99,
                                                HSDPA_TOTALBYTES ,
                                                HSUPA_TOTALBYTES ,
                                                TARIH,
                                                1 BH_TYPE
                                FROM 
                                (
                                      SELECT A.NETWORK_ID,
                                             CELL,
                                             UTIL_POW,
                                             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                             MEANRTWP,
                                             MAXRTWP,
                                             MINRTWP,
                                             AMR_CTRL_DL12_2,
                                             RB_DLCONVCS_64,
                                             R99,
                                             HSDPA_TOTALBYTES,
                                             HSUPA_TOTALBYTES,
                                             TARIH
                                     FROM 
                                              NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 A,
                                              HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                                WHERE B.DATA_DATE BETWEEN  XDATE  AND XDATE+23.5/24 
                                      AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                      AND A.TARIH=B.DATA_DATE  
                             ) 
                )
                WHERE RN=1;
    
    
    COMMIT;

XSTATE := ' INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G - 2';
    
    INSERT  /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
                   SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                    FROM
                     (
                                    SELECT    NETWORK_ID,CELL,
                                                    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000)  DESC) RN,
                                                    UTIL_POW,
                                                    R99_CODE_USAGE,
                                                    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL,
                                                    MEANRTWP,MINRTWP,
                                                    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                    AMR_CTRL_DL12_2 ,
                                                    RB_DLCONVCS_64 , 
                                                    R99,
                                                    HSDPA_TOTALBYTES ,
                                                    HSUPA_TOTALBYTES ,
                                                    TARIH,
                                                    2 BH_TYPE
                                    FROM 
                                    ( 
                                                SELECT A.NETWORK_ID,
                                                             CELL,
                                                             UTIL_POW,
                                                             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                                             MEANRTWP,
                                                             MAXRTWP,
                                                             MINRTWP,
                                                             AMR_CTRL_DL12_2,
                                                             RB_DLCONVCS_64,
                                                             R99,
                                                             HSDPA_TOTALBYTES,
                                                             HSUPA_TOTALBYTES,
                                                             TARIH
                                                  FROM 
                                                              NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 A,
                                                              HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                                                WHERE DATA_DATE BETWEEN XDATE  AND XDATE+23.5/24 
                                                     AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                                     AND A.TARIH=B.DATA_DATE  
                                                )
                     )
                     WHERE RN=1;
                     
     COMMIT;

XSTATE := 'DELETE FROM NORTHI_DATA.UTIL_GLOBAL_3G_DAILYTOTAL';

    DELETE FROM NORTHI_DATA.UTIL_GLOBAL_3G_DAILYTOTAL WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
     
XSTATE := ' INSERT INTO NORTHI_DATA.UTIL_GLOBAL_3G_DAILYTOTAL';
     
     INSERT  /*+ APPEND */ INTO NORTHI_DATA.UTIL_GLOBAL_3G_DAILYTOTAL 
                    SELECT 
                    NETWORK_ID,CELL,
                    AVG(UTIL_POW) UTIL_POW,
                    AVG(R99_CODE_USAGE) R99_CODE_USAGE,
                    AVG(UTIL) UTIL,
                    AVG(MEANRTWP) MEANRTWP,
                    MIN(MINRTWP) MINRTWP,
                    SUM(TOTAL_TRAFFIC) TOTAL_TRAFFIC,
                    AVG(AMR_CTRL_DL12_2) AMR_CTRL_DL12_2,
                    AVG(RB_DLCONVCS_64) RB_DLCONVCS_64, 
                    AVG(R99) R99,
                    SUM(HSDPA_TOTALBYTES) HSDPA_TOTALBYTES,
                    SUM(HSUPA_TOTALBYTES) HSUPA_TOTALBYTES,
                    TRUNC(TARIH) TARIH
                    FROM (
                                SELECT    NETWORK_ID,CELL,
                                                UTIL_POW,
                                                R99_CODE_USAGE,
                                                GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
                                                MEANRTWP,MINRTWP,
                                                (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                AMR_CTRL_DL12_2 ,
                                                RB_DLCONVCS_64 , 
                                                R99,
                                                HSDPA_TOTALBYTES ,
                                                HSUPA_TOTALBYTES ,
                                                TARIH
                                FROM 
                                (
                                      SELECT A.NETWORK_ID,
                                             CELL,
                                             UTIL_POW,
                                             (R99_CODE_USAGE+(VS_PDSCHCODEUSED_MEAN*16))/(256*0.75)*100 R99_CODE_USAGE,
                                             MEANRTWP,
                                             MAXRTWP,
                                             MINRTWP,
                                             AMR_CTRL_DL12_2,
                                             RB_DLCONVCS_64,
                                             R99,
                                             HSDPA_TOTALBYTES,
                                             HSUPA_TOTALBYTES,
                                             TARIH
                                     FROM 
                                              NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 A,
                                              NORTHI_DATA.LCELL_STATISTICS B
                                WHERE B.FRAGMENT_DATE BETWEEN  TRUNC(SYSDATE-1) AND TRUNC(SYSDATE-1)+23/24
                                      AND A.NETWORK_ID=B.NETWORK_ID 
                                      AND A.TARIH=B.FRAGMENT_DATE
                             ) 
                    )
                    GROUP BY NETWORK_ID,CELL,TRUNC(TARIH);
                    
       COMMIT;
     
    /*  OLD QUERY
    INSERT  INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G        
    SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
    FROM (
    SELECT NETWORK_ID,CELL,
    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000)  DESC) RN,
    UTIL_POW,
    R99_CODE_USAGE,
    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL,
    MEANRTWP,MINRTWP,
    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
    AMR_CTRL_DL12_2 ,
    RB_DLCONVCS_64 , 
    R99,
    HSDPA_TOTALBYTES ,
    HSUPA_TOTALBYTES ,
    TARIH,
    2 BH_TYPE
    FROM 
    ( SELECT A.NETWORK_ID,
             CELL,
             
             UTIL_POW,
             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
             MEANRTWP,
             MAXRTWP,
             MINRTWP,
             AMR_CTRL_DL12_2,
             RB_DLCONVCS_64,
             R99,
             HSDPA_TOTALBYTES,
             HSUPA_TOTALBYTES,
             TARIH
             FROM (
            /* SELECT
                AA.NETWORK_ID, 
                BB.CELL_NAME  CELL,
                AA.RNCID, 
                (POWER(10,AVG(AA.C67199618)/10)-0.15*POWER(10,MAX(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,MAX(CC.MAXTXPOWER)/100)) AS UTIL_POW, 
                AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64) R99_CODE_USAGE ,
                --AVG((C67202944+C67199704)+(C67202943+C67199703)*2+(C67199694+C67199702)*4+(C67199693+C67199701)*8+(C67199692+C67199700+C50341688)*16+(C67199691+C67199699)*32+(C67202942+C67199698)*64)/(236*0.75)*100 R99_CODE_USAGE ,
                AVG(C67199617) MEANRTWP,
                AVG(C67199680) MAXRTWP, 
                AVG(C67199681) MINRTWP,
                SUM(C67199620)/2 AMR_CTRL_DL12_2 ,
                SUM(C67199556)/2 RB_DLCONVCS_64 , 
                SUM(C67184000+C67183999+C67183998+C67183997+C67183996+C67183995+C67183994+C67183993+C67184008+C67184007+C67184006+C67184005+C67184004+
                C67184003+C67184002+C67184001+C67184021+C67184020+C67184019+C67184018+C67184017+C67184016+C67184015+C67184014+C67184029+C67184028+
                C67184027+C67184026+C67184025+C67184024+C67184023+C67184022) R99,
                SUM(C67189840) HSDPA_TOTALBYTES ,
                SUM(C67192486) HSUPA_TOTALBYTES ,
                TRUNC(AA.DATA_DATE,'HH24') TARIH
                FROM
                HIZIR2.M2_TX_RX_POWER_PER_CELL AA,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_CELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(XDATE)-30 AND trunc(XDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                HIZIR2.M2_MULTI_RAB_SERVICE_PER_CELL DD,
                HIZIR2.M2_RB_PROC_PER_CELL EE,
                HIZIR2.M2_THROUGHPUT_PER_CELL FF,
                HIZIR2.M2_HSDPA_PER_CELL GG,
                HIZIR2.M2_HSUPA_PER_CELL HH
                --,HIZIR2. M2_HSDPA_PER_LOCAL_CELL XX
                WHERE
                AA.NETWORK_ID = DD.NETWORK_ID AND AA.RNCID = DD.RNCID AND 
                AA.DATA_DATE = DD.DATA_DATE AND
                AA.NETWORK_ID = EE.NETWORK_ID AND AA.RNCID = EE.RNCID AND 
                AA.DATA_DATE = EE.DATA_DATE AND
                AA.NETWORK_ID = FF.NETWORK_ID AND AA.RNCID = FF.RNCID AND 
                AA.DATA_DATE = FF.DATA_DATE AND
                AA.NETWORK_ID = GG.NETWORK_ID AND AA.RNCID = GG.RNCID AND 
                AA.DATA_DATE = GG.DATA_DATE AND
                AA.NETWORK_ID = HH.NETWORK_ID AND AA.RNCID = HH.RNCID AND 
                AA.DATA_DATE = HH.DATA_DATE AND
                AA.NETWORK_ID = BB.CELL_ID AND
                --AA.NETWORK_ID=XX.LOCAL_CELL_ID AND
                -- TRUNC(AA.DATA_DATE,'HH24') =XX.DATA_DATE AND
                AA.DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND
                AA.C67199618 > 0 AND
                BB.CELL_NAME = CELLNAME 
                GROUP BY
                AA.NETWORK_ID,AA.RNCID,BB.CELL_NAME,TRUNC(AA.DATA_DATE,'HH24')*/
            /*                   SELECT 
                B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                (POWER(10,(VS_MEAN_TCP/2)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                CODES_USED_AVG R99_CODE_USAGE, --AVG
                VS_MEANRTWP MEANRTWP, --AVG
                VS_MAXRTWP MAXRTWP, --AVG
                VS_MINRTWP MINRTWP, --AVG
                CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                TRAF_HSUPA HSUPA_TOTALBYTES
                FROM 
                (
                SELECT NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                FROM HIZIR2.M2_THROUGHPUT_PER_CELL
                WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
                GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') 
                ) A, NORTHI_DATA.CELL_STATISTICS B,
                (SELECT  REPLACE(CELLNAME,'"') CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_DATA.V_UCELLSETUP BB WHERE EXPORT_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 GROUP BY REPLACE(CELLNAME,'"') ) CC,
                NORTHI_DATA.LIST_RNC_NODEB_CELL BB
                WHERE A.NETWORK_ID=B.NETWORK_ID
                AND A.RNCID=B.RNC_ID 
                AND A.DATA_DATE=B.FRAGMENT_DATE
                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
                AND B.DTYPE=1
                AND VS_MEAN_TCP>0
                AND B.NETWORK_ID = BB.CELL_ID
                AND BB.CELL_NAME = CELLNAME
                 )A,
                  HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                  WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24 AND A.NETWORK_ID=B.LOCAL_CELL_ID AND A.TARIH=B.DATA_DATE  
                )
     )
     WHERE RN=1;
            
     
     */
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',XSTATE );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
    
END;

PROCEDURE PROCESS_CELL_UTIL_3G_90 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTIL_3G_90';

DELETE FROM NORTHI_DATA.CELL_UTIL_3G_90 WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;

INSERT /*+ APPEND */ INTO NORTHI_DATA.CELL_UTIL_3G_90 ( NETWORK_ID, CELL, UTIL, VS_HSDPA_UE_MEAN_CELL, TARIH)

WITH CC AS  
(
SELECT /*+ PARALLEL(4) */   CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT/*+ PARALLEL(4) */  CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
                                                            
),

  AA AS (
SELECT /*+ PARALLEL(4) */   NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,
SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
FROM HIZIR2.M2_THROUGHPUT_PER_CELL
WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24') 
) ,

 B AS
 (
 SELECT /*+ PARALLEL(4) */  DATA_DATE, LOCAL_CELL_ID, C50341688 FROM HIZIR2.M2_HSDPA_PER_LOCAL_CELL WHERE DATA_DATE BETWEEN XDATE AND XDATE+23.5/24
 )

SELECT  NETWORK_ID,CELL,UTIL,VS_HSDPA_UE_MEAN_CELL,TARIH
                FROM (
                                SELECT      NETWORK_ID,CELL,
                                                ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
                                                GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
                                                VS_HSDPA_UE_MEAN_CELL,
                                                TARIH
                                FROM 
                                (
                                      SELECT    A.NETWORK_ID,
                                             CELL,
                                             UTIL_POW,
                                             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,  -- VS_PDSCHCODEUSED_MEAN
                                             VS_HSDPA_UE_MEAN_CELL,
                                             TARIH
                                     FROM 
                                            (
                                            SELECT 
B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
(POWER(10,(VS_MEAN_TCP)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
CODES_USED_AVG R99_CODE_USAGE,
VS_HSDPA_UE_MEAN_CELL
FROM 
 CC,
NORTHI_DATA.CELL_STATISTICS B,
NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
 AA
WHERE 
AA.NETWORK_ID=B.NETWORK_ID
AND AA.RNCID=B.RNC_ID 
AND AA.DATA_DATE=B.FRAGMENT_DATE
AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
AND B.DTYPE=1
AND VS_MEAN_TCP>0
AND B.NETWORK_ID = BB.CELL_ID
AND BB.CELL_NAME = CC.CELLNAME

                                            ) A,
                                              B
                                WHERE B.DATA_DATE BETWEEN  XDATE AND XDATE+23.5/24
                                      AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                      AND A.TARIH=B.DATA_DATE  
                             ) 
                )
                where  UTIL >90;
                
                COMMIT;
                
                EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTIL_3G_90',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;
                
                
  PROCEDURE PROCESS_CELL_UTIL_3G_FY1819 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLB_3G_FY1819';

DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLB_3G_FY1819 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;



INSERT /*+ APPEND */ INTO  NORTHI_DATA.REPORT_CELL_UTIL_GLB_3G_FY1819 
(NETWORK_ID, FRAGMENT_DATE, CELL_UTIL, DL_UTIL, CODE_UTIL, VS_HSDPA_UE_MEAN_CELL, VS_HSDPA_MEANCH_THRO, TRAF_HSDPA, VS_AMR_ERLANG_BEST_CELL, VSHSUPAUEMEANCELL, TRAF_HSUPA, VQI_UL_BAD_PER_NUM,VQI_UL_BAD_PER_DEN,PS_UL_DATA,PS_DL_DATA)

WITH DS_CMEX AS
(
SELECT /*+ PARALLEL(4) */ CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT /*+ PARALLEL(4) */  CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
) ,

DS_LCELL AS
(
SELECT /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_DL_CODE_USED_MEAN) VS_DL_CODE_USED_MEAN
FROM NORTHI_DATA.LCELL_STATISTICS
WHERE DTYPE=1 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID, FRAGMENT_DATE
), 

DS_CELL AS
(
SELECT  /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_MEAN_TCP) VS_MEAN_TCP,
SUM(VS_HSDPA_UE_MEAN_CELL) VS_HSDPA_UE_MEAN_CELL,
SUM(VS_HSDPA_MEANCH_THRO) VS_HSDPA_MEANCH_THRO,
SUM(TRAF_HSDPA) TRAF_HSDPA,
SUM(VS_AMR_ERLANG_BEST_CELL) VS_AMR_ERLANG_BEST_CELL,
SUM(VSHSUPAUEMeanCell) VSHSUPAUEMeanCell,
SUM(TRAF_HSUPA) TRAF_HSUPA,
SUM(VQI_UL_BAD_PER_NUM) VQI_UL_BAD_PER_NUM,
SUM(VQI_UL_BAD_PER_DEN) VQI_UL_BAD_PER_DEN,
SUM(PS_UL_DATA) PS_UL_DATA,
SUM(PS_DL_DATA) PS_DL_DATA
FROM NORTHI_DATA.CELL_STATISTICS
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY  NETWORK_ID, FRAGMENT_DATE
)

SELECT  /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
    GREATEST(DL_UTIL ,CODE_UTIL) CELL_UTIL,
    DL_UTIL ,CODE_UTIL, 
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
    FROM 
  (
SELECT  /*+ PARALLEL(4) */
    C.NETWORK_ID,C.FRAGMENT_DATE ,cell_name cell,
    ROW_NUMBER() OVER (PARTITION BY CELL_NAME ORDER BY VS_HSDPA_UE_MEAN_CELL DESC, VS_AMR_ERLANG_BEST_CELL DESC) RN,
    (POWER(10,(VS_MEAN_TCP)/10))*100/(0.7*POWER(10,(MAXTXPOWER)/100)) DL_UTIL,
    NVL(VS_DL_CODE_USED_MEAN,0)/(0.7*256)*100 CODE_UTIL,
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL/2 VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
FROM DS_CMEX A, DS_LCELL B, DS_CELL C , NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE  A.CELLNAME=X.CELL_NAME AND B.NETWORK_ID=C.NETWORK_ID AND 
B.NETWORK_ID=X.CELL_ID AND B.FRAGMENT_DATE=C.FRAGMENT_DATE AND 
C.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
AND  VS_MEAN_TCP>0
) WHERE RN=1 ;

 COMMIT;
 
 
   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTIL_GLB_3G_FY1819',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;              


PROCEDURE CELL_UTIL_GLB_3G_FY1819_100 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTIL_GLB_3G_FY1819_100';

DELETE FROM NORTHI_DATA.CELL_UTIL_GLB_3G_FY1819_100 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24; 
COMMIT;

INSERT /*+ APPEND */ INTO  NORTHI_DATA.CELL_UTIL_GLB_3G_FY1819_100 (NETWORK_ID, FRAGMENT_DATE, VS_HSDPA_UE_MEAN_CELL, CELL_UTIL, VS_HSDPA_MEANCH_THRO)

WITH DS_CMEX AS
(
SELECT  CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT   CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
) ,

DS_LCELL AS
(
SELECT  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_DL_CODE_USED_MEAN) VS_DL_CODE_USED_MEAN
FROM NORTHI_DATA.LCELL_STATISTICS
WHERE DTYPE=1 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID, FRAGMENT_DATE
), 

DS_CELL AS
(
SELECT  /*+full(CELL_STATISTICS)*/  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_MEAN_TCP) VS_MEAN_TCP,
SUM(VS_HSDPA_UE_MEAN_CELL) VS_HSDPA_UE_MEAN_CELL,
SUM(VS_HSDPA_MEANCH_THRO) VS_HSDPA_MEANCH_THRO,
SUM(TRAF_HSDPA) TRAF_HSDPA,
SUM(VS_AMR_ERLANG_BEST_CELL) VS_AMR_ERLANG_BEST_CELL,
SUM(VSHSUPAUEMeanCell) VSHSUPAUEMeanCell,
SUM(TRAF_HSUPA) TRAF_HSUPA,
SUM(VQI_UL_BAD_PER_NUM) VQI_UL_BAD_PER_NUM,
SUM(VQI_UL_BAD_PER_DEN) VQI_UL_BAD_PER_DEN,
SUM(PS_UL_DATA) PS_UL_DATA,
SUM(PS_DL_DATA) PS_DL_DATA
FROM NORTHI_DATA.CELL_STATISTICS
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY  NETWORK_ID, FRAGMENT_DATE
)

SELECT NETWORK_ID, FRAGMENT_DATE, VS_HSDPA_UE_MEAN_CELL, CELL_UTIL, VS_HSDPA_MEANCH_THRO
FROM 
(
SELECT    NETWORK_ID, FRAGMENT_DATE,
    GREATEST(DL_UTIL ,CODE_UTIL) CELL_UTIL,
    DL_UTIL ,CODE_UTIL, 
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
    FROM 
(
SELECT  
    C.NETWORK_ID,C.FRAGMENT_DATE ,cell_name cell,
    (POWER(10,(VS_MEAN_TCP)/10))*100/(0.7*POWER(10,(MAXTXPOWER)/100)) DL_UTIL,
    VS_DL_CODE_USED_MEAN/(0.7*256)*100 CODE_UTIL,
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL/2 VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
FROM DS_CMEX A, DS_LCELL B, DS_CELL C , NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE  A.CELLNAME=X.CELL_NAME AND B.NETWORK_ID=C.NETWORK_ID AND 
B.NETWORK_ID=X.CELL_ID AND B.FRAGMENT_DATE=C.FRAGMENT_DATE AND 
C.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
AND  VS_MEAN_TCP>0
)
)
WHERE CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN  (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END ) WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END) ELSE 0 END > 0;

COMMIT;
 
 
   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTIL_GLB_3G_FY1819_100',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;      
            

 PROCEDURE REPORT_CELL_GLOBAL_3G_KKTC(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

DELETE FROM NORTHI_DATA.CELL_UTIL_GLOBAL_3G_KKTC WHERE TARIH BETWEEN XDATE AND XDATE+23/24; COMMIT;
    
DELETE FROM NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T1; COMMIT;
 
INSERT INTO NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T1 (NETWORK_ID, RNCID, DATA_DATE, R99_MINUS)
SELECT  NETWORK_ID,RNCID, TRUNC(DATA_DATE,'HH24') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE('SYS_VERSION','RAN12',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
FROM NORTHI_PARSER_KKTC.M2_THROUGHPUT_PER_CELL
WHERE DATA_DATE BETWEEN XDATE AND XDATE + 23.5/24
GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,'HH24');

COMMIT;

DELETE FROM NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T2; COMMIT; 

INSERT INTO NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T2 (NETWORK_ID, RNCID, TARIH, CELL, UTIL_POW, R99_CODE_USAGE, MEANRTWP, MAXRTWP, MINRTWP, AMR_CTRL_DL12_2, RB_DLCONVCS_64, R99, HSDPA_TOTALBYTES, HSUPA_TOTALBYTES)                      
SELECT 
                                                            B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                                                            (POWER(10,(VS_MEAN_TCP)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                                                            CODES_USED_AVG R99_CODE_USAGE, --AVG
                                                            VS_MEANRTWP MEANRTWP, --AVG
                                                            VS_MAXRTWP MAXRTWP, --AVG
                                                            VS_MINRTWP MINRTWP, --AVG
                                                            CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                                                            CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                                                            PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                                                            TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                                                            TRAF_HSUPA HSUPA_TOTALBYTES
                                            FROM 
                                                    (
                                                        SELECT CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER 
                                                        FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS  
                                                        WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 
                                                        GROUP BY CELLNAME
                                                        
                                                        UNION ALL
                                                        
                                                        SELECT CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER 
                                                        FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS  
                                                        WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 
                                                        GROUP BY CELLNAME
                                                    ) CC,
                                                    NORTHI_DATA.KKTC_CELLSTS_3G B,
                                                    NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                                                    NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T1 A
                                            WHERE 
                                                        A.NETWORK_ID=B.NETWORK_ID
                                                AND A.RNCID=B.RNC_ID 
                                                AND A.DATA_DATE=B.FRAGMENT_DATE
                                                AND B.FRAGMENT_DATE BETWEEN XDATE AND XDATE + 23.5/24
                                                AND B.DTYPE=1
                                                AND VS_MEAN_TCP>0
                                                AND B.NETWORK_ID = BB.CELL_ID
                                                AND BB.CELL_NAME = CC.CELLNAME;
      
COMMIT;

XSTATE := ' INSERT INTO NORTHI_DATA.CELL_UTIL_GLOBAL_3G_KKTC';
                                    
    INSERT /*+ APPEND */ INTO NORTHI_DATA.CELL_UTIL_GLOBAL_3G_KKTC 
              SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                FROM (
                                SELECT    NETWORK_ID,CELL,
                                                ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
                                                UTIL_POW,
                                                R99_CODE_USAGE,
                                                GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
                                                MEANRTWP,MINRTWP,
                                                (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                AMR_CTRL_DL12_2 ,
                                                RB_DLCONVCS_64 , 
                                                R99,
                                                HSDPA_TOTALBYTES ,
                                                HSUPA_TOTALBYTES ,
                                                TARIH,
                                                1 BH_TYPE
                                FROM 
                                (
                                      SELECT A.NETWORK_ID,
                                             CELL,
                                             UTIL_POW,
                                             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                             MEANRTWP,
                                             MAXRTWP,
                                             MINRTWP,
                                             AMR_CTRL_DL12_2,
                                             RB_DLCONVCS_64,
                                             R99,
                                             HSDPA_TOTALBYTES,
                                             HSUPA_TOTALBYTES,
                                             TARIH
                                     FROM 
                                              NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T2 A,
                                              NORTHI_PARSER_KKTC.M2_HSDPA_PER_LOCAL_CELL B
                                WHERE B.DATA_DATE BETWEEN  XDATE  AND XDATE+23.5/24 
                                      AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                      AND A.TARIH=B.DATA_DATE  
                             ) 
                )
                WHERE RN=1;
    
    
    COMMIT;

XSTATE := ' INSERT INTO NORTHI_DATA.CELL_UTIL_GLOBAL_3G_KKTC - 2';
    
    INSERT  /*+ APPEND */ INTO NORTHI_DATA.CELL_UTIL_GLOBAL_3G_KKTC 
                   SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                    FROM
                     (
                                    SELECT    NETWORK_ID,CELL,
                                                    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000)  DESC) RN,
                                                    UTIL_POW,
                                                    R99_CODE_USAGE,
                                                    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL,
                                                    MEANRTWP,MINRTWP,
                                                    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                    AMR_CTRL_DL12_2 ,
                                                    RB_DLCONVCS_64 , 
                                                    R99,
                                                    HSDPA_TOTALBYTES ,
                                                    HSUPA_TOTALBYTES ,
                                                    TARIH,
                                                    2 BH_TYPE
                                    FROM 
                                    ( 
                                                SELECT A.NETWORK_ID,
                                                             CELL,
                                                             UTIL_POW,
                                                             (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                                             MEANRTWP,
                                                             MAXRTWP,
                                                             MINRTWP,
                                                             AMR_CTRL_DL12_2,
                                                             RB_DLCONVCS_64,
                                                             R99,
                                                             HSDPA_TOTALBYTES,
                                                             HSUPA_TOTALBYTES,
                                                             TARIH
                                                  FROM 
                                                              NORTHI_DATA.UTIL_GLOBAL_3G_KKTC_T2 A,
                                                              NORTHI_PARSER_KKTC.M2_HSDPA_PER_LOCAL_CELL B
                                                WHERE DATA_DATE BETWEEN XDATE  AND XDATE+23.5/24 
                                                     AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                                     AND A.TARIH=B.DATA_DATE  
                                                )
                     )
                     WHERE RN=1;
                     
     COMMIT;
     
   
   EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',XSTATE );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
    
END;


PROCEDURE PROCESS_REPORT_CELL_GLOBAL_3GM(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
BEGIN
    DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G WHERE TARIH BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    
      BEGIN
             EXECUTE IMMEDIATE 'DROP TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 PURGE';
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;         
    
    
     BEGIN
             EXECUTE IMMEDIATE 
               'CREATE TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 NOLOGGING PARALLEL(4) TABLESPACE NORTHI_DATA AS
                  SELECT  NETWORK_ID,RNCID, TRUNC(DATA_DATE,''HH24'') DATA_DATE,SUM(C67184009+C67184010+C67184011+C67184012+DECODE(''SYS_VERSION'',''RAN12'',C67193548+C67193550+C67193552+C67193554+C73393908,0)+C67184030+C67184031+C67184032) R99_MINUS
                   FROM HIZIR2.M2_THROUGHPUT_PER_CELL
                 WHERE DATA_DATE BETWEEN TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'') AND TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')+23.5/24
            GROUP BY NETWORK_ID,RNCID,  TRUNC(DATA_DATE,''HH24'') ';
            
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;         
  
    
      BEGIN
             EXECUTE IMMEDIATE 'DROP TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 PURGE';
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;         
    
    
        BEGIN
             EXECUTE IMMEDIATE 
               'CREATE TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 NOLOGGING PARALLEL(4) TABLESPACE NORTHI_DATA AS
                      SELECT 
                                                            B.NETWORK_ID,B.RNC_ID RNCID,FRAGMENT_DATE tarih,cellname cell,
                                                            (POWER(10,(VS_MEAN_TCP)/10)-0.15*POWER(10,(CC.MAXTXPOWER)/100))*100/(0.6*POWER(10,(CC.MAXTXPOWER)/100)) UTIL_POW,
                                                            CODES_USED_AVG R99_CODE_USAGE, --AVG
                                                            VS_MEANRTWP MEANRTWP, --AVG
                                                            VS_MAXRTWP MAXRTWP, --AVG
                                                            VS_MINRTWP MINRTWP, --AVG
                                                            CS_VOICE_CALL_TRAFF/2 AMR_CTRL_DL12_2, --SUM
                                                            CS_VIDEO_CALL_TRAFF/2 RB_DLCONVCS_64, --SUM 
                                                            PS_DL_DATA+PS_UL_DATA-R99_MINUS R99, --SUM
                                                            TRAF_HSDPA HSDPA_TOTALBYTES, --SUM
                                                            TRAF_HSUPA HSUPA_TOTALBYTES
                                            FROM 
                                                    (
                                                        SELECT CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER 
                                                        FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS  
                                                        WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 
                                                        GROUP BY CELLNAME
                                                        
                                                        UNION ALL
                                                        
                                                        SELECT CELLNAME ,MAX(MAXTXPOWER) MAXTXPOWER 
                                                        FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS  
                                                        WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE)+30 
                                                        GROUP BY CELLNAME
                                                    ) CC,
                                                    NORTHI_DATA.CELL_STATISTICS B,
                                                    NORTHI_DATA.LIST_RNC_NODEB_CELL BB,
                                                    NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T1 A
                                            WHERE 
                                                        A.NETWORK_ID=B.NETWORK_ID
                                                AND A.RNCID=B.RNC_ID 
                                                AND A.DATA_DATE=B.FRAGMENT_DATE
                                                AND B.FRAGMENT_DATE BETWEEN TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'') AND TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')+23.5/24
                                                AND B.DTYPE=1
                                                AND VS_MEAN_TCP>0
                                                AND B.NETWORK_ID = BB.CELL_ID
                                                AND BB.CELL_NAME = CC.CELLNAME  ';
            
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;
          
          
            BEGIN
             EXECUTE IMMEDIATE 'DROP TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T3 PURGE';
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;                  

               BEGIN
             EXECUTE IMMEDIATE 
               'CREATE TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T3 NOLOGGING PARALLEL(4) TABLESPACE NORTHI_DATA AS
               
                 SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                    FROM (
                                    SELECT    NETWORK_ID,CELL,
                                                    ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY GREATEST(UTIL_POW,R99_CODE_USAGE) DESC) RN,
                                                    UTIL_POW,
                                                    R99_CODE_USAGE,
                                                    GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL ,
                                                    MEANRTWP,MINRTWP,
                                                    (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                    AMR_CTRL_DL12_2 ,
                                                    RB_DLCONVCS_64 , 
                                                    R99,
                                                    HSDPA_TOTALBYTES ,
                                                    HSUPA_TOTALBYTES ,
                                                    TARIH,
                                                    1 BH_TYPE
                                    FROM 
                                    (
                                          SELECT A.NETWORK_ID,
                                                 CELL,
                                                 UTIL_POW,
                                                 (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                                 MEANRTWP,
                                                 MAXRTWP,
                                                 MINRTWP,
                                                 AMR_CTRL_DL12_2,
                                                 RB_DLCONVCS_64,
                                                 R99,
                                                 HSDPA_TOTALBYTES,
                                                 HSUPA_TOTALBYTES,
                                                 TARIH
                                         FROM 
                                                  NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 A,
                                                  HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                                    WHERE B.DATA_DATE BETWEEN  TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')  AND TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')+23.5/24 
                                          AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                          AND A.TARIH=B.DATA_DATE  
                                 ) 
                    )
                    WHERE RN=1';
         EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;     
                                    
    INSERT /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
              SELECT *
                FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T3;
    
    COMMIT;
    
    
        BEGIN
             EXECUTE IMMEDIATE 'DROP TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T4 PURGE';
          EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;                  
          
                BEGIN
             EXECUTE IMMEDIATE 
               'CREATE TABLE NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T4 NOLOGGING PARALLEL(4) TABLESPACE NORTHI_DATA AS  
                          SELECT NETWORK_ID,CELL,UTIL_POW,R99_CODE_USAGE,UTIL,MEANRTWP,MINRTWP,TOTAL_TRAFFIC,AMR_CTRL_DL12_2 ,RB_DLCONVCS_64 , R99,HSDPA_TOTALBYTES ,HSUPA_TOTALBYTES ,TARIH, BH_TYPE
                            FROM
                             (
                                            SELECT    NETWORK_ID,CELL,
                                                            ROW_NUMBER() OVER (PARTITION BY CELL ORDER BY (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000)  DESC) RN,
                                                            UTIL_POW,
                                                            R99_CODE_USAGE,
                                                            GREATEST(UTIL_POW,R99_CODE_USAGE) UTIL,
                                                            MEANRTWP,MINRTWP,
                                                            (AMR_CTRL_DL12_2*12.2 + RB_DLCONVCS_64*64 + R99/3600000 + (HSDPA_TOTALBYTES+HSUPA_TOTALBYTES)/450000) TOTAL_TRAFFIC,
                                                            AMR_CTRL_DL12_2 ,
                                                            RB_DLCONVCS_64 , 
                                                            R99,
                                                            HSDPA_TOTALBYTES ,
                                                            HSUPA_TOTALBYTES ,
                                                            TARIH,
                                                            2 BH_TYPE
                                            FROM 
                                            ( 
                                                        SELECT A.NETWORK_ID,
                                                                     CELL,
                                                                     UTIL_POW,
                                                                     (R99_CODE_USAGE+(C50341688*16))/(256*0.75)*100 R99_CODE_USAGE,
                                                                     MEANRTWP,
                                                                     MAXRTWP,
                                                                     MINRTWP,
                                                                     AMR_CTRL_DL12_2,
                                                                     RB_DLCONVCS_64,
                                                                     R99,
                                                                     HSDPA_TOTALBYTES,
                                                                     HSUPA_TOTALBYTES,
                                                                     TARIH
                                                          FROM 
                                                                      NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T2 A,
                                                                      HIZIR2.M2_HSDPA_PER_LOCAL_CELL B
                                                        WHERE DATA_DATE BETWEEN TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')  AND TO_DATE('''||TO_CHAR(XDATE,'DD-MM-YYYY HH24')||''',''DD-MM-YYYY HH24'')+23.5/24 
                                                             AND A.NETWORK_ID=B.LOCAL_CELL_ID 
                                                             AND A.TARIH=B.DATA_DATE  
                                                        )
                             )
                             WHERE RN=1';
               
           EXCEPTION WHEN OTHERS THEN 
             NULL;
          END;     
               
    INSERT  /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G 
             SELECT *
                FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G_T4;
                     
     COMMIT;
     
      EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_REPORT_CODE_USAGE_HUAW',NULL );
       commit;                   
       
       --NORTHI.SEND_SMS('905415582888,905415581888,905418550351','NORTHI_LOADER.EXTRA_WORKS.PROCESS_REPORT_CODE_USAGE_HUAW',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
     
END;

PROCEDURE PROCESS_REPORT_CELL_GLOBAL_4G(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_4G';

    DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_4G WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
    COMMIT; 
 
--INSERT /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_4G (FRAGMENT_DATE, NETWORK_ID, UTIL_DL,UTIL_UL,UTIL, UTIL_DL_NEW,UTIL_UL_NEW, UTIL_NEW,CONN_USER_NORM,AVG_RRC_CONNECTED_USER,DL_TRAFFIC,UL_TRAFFIC,DL_USER_THROUGHPUT)
--
--SELECT FRAGMENT_DATE, NETWORK_ID,UTIL_DL,UTIL_UL, UTIL, UTIL_DL_NEW,UTIL_UL_NEW, UTIL_NEW, CONN_USER_NORM,AVG_RRC_CONNECTED_USER, DL_TRAFFIC,UL_TRAFFIC,DL_USER_THROUGHPUT
--FROM 
--(
--SELECT FRAGMENT_DATE, NETWORK_ID,UTIL_DL,UTIL_UL,GREATEST(UTIL_UL,UTIL_DL) UTIL,UTIL_DL_NEW,UTIL_UL_NEW, GREATEST(UTIL_UL_NEW,UTIL_DL_NEW) UTIL_NEW, CONN_USER_NORM, AVG_RRC_CONNECTED_USER, DL_TRAFFIC, UL_TRAFFIC,DL_USER_THROUGHPUT,
--row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY GREATEST(UTIL_UL,UTIL_DL) DESC)  RN
-- FROM
--(
--SELECT FRAGMENT_DATE, NETWORK_ID, 
--DECODE(RB,0,0,SUM(DL_CHMEAS_PRB)*100/RB)*NF UTIL_DL , 
--DECODE(RB,0,0,SUM(DL_CHMEAS_PRB)*100/RB)*NF_NEW UTIL_DL_NEW , 
--
--DECODE(SUM(RB-PUCCH_CHMEAS_PRB),0,0,SUM(UL_CHMEAS_PRB-PUCCH_CHMEAS_PRB)*100/SUM(RB-PUCCH_CHMEAS_PRB))*NF  UTIL_UL ,
--DECODE(SUM(RB-PUCCH_CHMEAS_PRB),0,0,SUM(UL_CHMEAS_PRB-PUCCH_CHMEAS_PRB)*100/SUM(RB-PUCCH_CHMEAS_PRB))*NF_NEW  UTIL_UL_NEW ,
--
--DECODE(CU,0,0,SUM(AVG_RRC_CONNECTED_USER)*100/CU*0.9) CONN_USER_NORM,
--ROUND(SUM(AVG_RRC_CONNECTED_USER),2) AVG_RRC_CONNECTED_USER,
--ROUND(SUM(DL_TRAFFIC_VOL)/8/(1024*1024),2) DL_TRAFFIC,
--ROUND(SUM(UL_TRAFFIC_VOL)/8/(1024*1024),2) UL_TRAFFIC,
--ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT
--FROM
--(SELECT FRAGMENT_DATE, NETWORK_ID, DL_CHMEAS_PRB,UL_CHMEAS_PRB, PUCCH_CHMEAS_PRB ,AVG_RRC_CONNECTED_USER,DL_TRAFFIC_VOL,UL_TRAFFIC_VOL,
--USER_DL_RMVLAST_TTI_TRAFF_VOL,L_THRP_TIME_DL_RMVLAST_TTI
--FROM NORTHI_DATA.CELLSTS_4G
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
--) A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
--WHERE A.NETWORK_ID=B.CELL_ID
--GROUP BY FRAGMENT_DATE, NETWORK_ID,RB,NF,NF_NEW,CU
--) ORDER BY 2,3 DESC,1
--) WHERE RN=1
--ORDER BY 2,1;



COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'REPORT_CELL_UTIL_GLOBAL_4G',XSTATE );
       commit;                   
       
       --NORTHI.SEND_SMS('905418550351','NORTHI_LOADER.EXTRA_WORKS.REPORT_CELL_UTIL_GLOBAL_4G',TO_CHAR(ERRCODE) ||': '||ERRM || '  '   );
       raise;
    
END;


PROCEDURE PROCESS_REPORT_CELL_UTILPRB_4G(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G';

    DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
    COMMIT; 


--INSERT /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G (FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_CELL_TRAFFIC_VOLUME, FBAND_ID, L_THRP_TIME_CELL_DL_HIGH_PREC, PI160_CELL_TPUT, PI160H_CA_USER_THPUT, PI160I_CA_USER_THPUT, PI160J_CELL_CA_TRF, PI160K_CELL_MAC_TRF, PI160L_CQI, PI160M_MCS, PI160N_RANK)
--
--SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_CELL_TRAFFIC_VOLUME, FBAND_ID, L_THRP_TIME_CELL_DL_HIGH_PREC, PI160_CELL_TPUT, PI160H_CA_USER_THPUT, PI160I_CA_USER_THPUT, PI160J_CELL_CA_TRF, PI160K_CELL_MAC_TRF, PI160L_CQI, PI160M_MCS, PI160N_RANK
--FROM 
--(
--SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_CELL_TRAFFIC_VOLUME, A.FBAND_ID, L_THRP_TIME_CELL_DL_HIGH_PREC, PI160_CELL_TPUT, PI160H_CA_USER_THPUT, PI160I_CA_USER_THPUT, PI160J_CELL_CA_TRF, PI160K_CELL_MAC_TRF, PI160L_CQI, PI160M_MCS, PI160N_RANK,
--row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_TRAFFIC_VOLUME DESC, FRAGMENT_DATE DESC)  RN
-- FROM
--
--(SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
--                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
--                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
--                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS,
--                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
--                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_TRAFFIC_VOLUME,
--                         ROUND(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),2) L_THRP_TIME_CELL_DL_HIGH_PREC,
--                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),0,0,(SUM(AVG_DL_CELL_THR_NUM)/1000)/SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)),2) PI160_CELL_TPUT,
--                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User),0,0,((SUM(AVG_DL_CELL_THR_NUM-L_Thrp_bits_DL_CAUser)-SUM(L_THRP_BITS_DL_LAST_TTI-L_Thrp_bits_DL_LastTTI_CAUser))/1000)/SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User)),2) PI160H_CA_USER_THPUT,
--                         CASE 
--                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) = 0 THEN NULL
--                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) <> 0 THEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2)
--                         END PI160I_CA_USER_THPUT,
--                         CASE
--                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) = 0 THEN NULL
--                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) <> 0 THEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2)
--                         END PI160J_CELL_CA_TRF,
--                         ROUND(SUM(L_Traffic_DL_MAC_TRFF)/(8*POWER(10,6)),2) PI160K_CELL_MAC_TRF,
--                         ROUND(DECODE(SUM(ChMeas_CQI_DL_SingleCW_DEN),0,0,SUM(ChMeas_CQI_DL_SingleCW_NUM)/SUM(ChMeas_CQI_DL_SingleCW_DEN)),2) PI160L_CQI,
--                         ROUND(DECODE(SUM(L_ChMeas_PDSCH_MCS_DEN),0,0,SUM(L_ChMeas_PDSCH_MCS_NUM)/SUM(L_ChMeas_PDSCH_MCS_DEN)),2) PI160M_MCS,
--                         ROUND(DECODE(SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4),0,0,SUM(L_ChMeas_RI_Rank1+(2*L_ChMeas_RI_Rank2)+(3*L_ChMeas_RI_Rank3)+(4*L_ChMeas_RI_Rank4))/SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4)),2) PI160N_RANK
--FROM NORTHI_DATA.CELLSTS_4G
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24  AND L_CHMEAS_PRB_DL_AVAIL!=0
--GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
--)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
--WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID=B.FBAND_ID
--) WHERE RN=1;

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'REPORT_CELL_UTIL_PRB_4G',XSTATE );
       commit;                   
       
     
       raise;
    
END;
PROCEDURE REPORT_CELL_UTILPRB_4G_1920(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920';

DELETE /*+ PARALLEL(16) */ FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920 WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
COMMIT; 

INSERT /*+ APPEND PARALLEL(16) */ INTO NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920 (FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL, KPI160_EXT1, KPI160_EXT2, KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME, LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED,NR_NON_GBR_ACT_DATA_USERS_DL, KPI_C_820, KPI160UAI, KPI160UAJ, KPI160UE, KPI160UF, KPI160UG, KPI160UK,KPI160uc,KPI160ud)

WITH DATASET AS
(
SELECT /*+ PARALLEL(16) */  NETWORK_ID, FRAGMENT_DATE, FBAND_ID, DL_CHMEAS_PRB,KPI160uc, L_CHMEAS_PRB_DL_AVAIL, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_FWA, USER_DL_RMVLAST_TTI_TRAFF_VOL, L_THRP_TIME_DL_RMVLAST_TTI, DL_NONGBR_USER_THR_NUM_FWA, DL_NONGBR_USER_THR_DEN_FWA, DL_TRAFFIC_VOL, L_THRP_TIME_CELL_DL_HIGH_PREC, AVG_DL_CELL_THR_NUM, L_Thrp_bits_DL_CAUser, L_THRP_BITS_DL_LAST_TTI, L_Thrp_bits_DL_LastTTI_CAUser, Thrp_Time_DL_RmvLastTTI_User, L_Traffic_DL_MAC_TRFF, AVG_CQI_256QM_NUM_FWA, AVG_CQI_256QM_DEN_FWA, L_ChMeas_PDSCH_MCS_NUM, L_ChMeas_PDSCH_MCS_DEN, L_ChMeas_RI_Rank1, L_ChMeas_RI_Rank2, L_ChMeas_RI_Rank3, L_ChMeas_RI_Rank4, VOLTE_TRAFFIC, VOLTE_DATA_VOLUME, TRAFFIC_VOLUME_QCI_8, L_THRP_BITS_DL_QCI_6789, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA_NUM, DL_USER_THRPUT_FWA_DEN, DL_DATA_VOLUME_FWA, CHMEAS_PRB_DL_PCELL_USED_AVG, CHMEAS_PRB_DL_SCELL_USED_AVG, DL_FIRST_PACKET_DELAY_NUM, DL_FIRST_PACKET_DELAY_DEN, DL_FIRST_PACKET_DELAY_MOB_NUM, DL_FIRST_PACKET_DELAY_MOB_DEN, DL_FIRST_PACKET_DELAY_FWA_NUM, DL_FIRST_PACKET_DELAY_FWA_DEN, DL_NONGBR_USER_EXPERIENCE_NUM, DL_NONGBR_USER_EXPERIENCE_DEN, AVERAGE_CQI_NON256QAM_NUM, AVERAGE_CQI_NON256QAM_DEN, EXT_PRB_NUM, EXT_PRB_DEN, DL_NONGBR_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_NUM, AVG_RRC_CONNECTED_USER, KPI160_EXT1, KPI160_EXT2_NUM, KPI160_EXT3, L_THRP_BITS_DL_QCI, THRP_BITS_DEXTQCI_INDEX0, THRP_BITS_DEXTQCI_INDEX1, THRP_BITS_DEXTQCI_INDEX2, DL_TRAFF_QCI_133_MB_NUM, L_THRP_BITS_DL_EXTQCI_INDEX5, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT_NUM, LTE_HU_DATA_VOLUME_NUM, LTE_NRML_HU_USER_THRPUT_NUM, LTE_NRML_HU_USER_THRPUT_DEN, CAT_M_PRB_USED_DL, 0 DL_RSOURCE_BLOCK_UTIL_RATE_NUM, 0 USER_DL_AVG_TPUT_DEN, UL_CHMEAS_PRB, L_CHMEAS_PRB_PUSH_AVG, UL_TRAFFIC_VOL, L_THRP_TIME_CELL_UL_HIGH_PREC, MAC_LAYER_DATA_VOLUME,KPI160ud_PAYDA,KPI160ud_PAY,KPI160uc
L_THRP_BITS_DL_QCI6,L_THRP_DL_LASTTTI_QCI6,DLTRAFFICVOLUME_QCI_7,THRP_BITS_DL_LASTTTI_QCI_7,DLTRAFFICVOLUME_QCI_8,THRP_BITS_DL_LASTTTI_QCI_8,L_THRP_BITS_DL_QCI9,THRP_BITS_DL_LASTTTI_QCI_9,THRP_BITSDL_LASTI_FLEXQCI_I4,DL_USER_TPUT_MBPS_QCI_7_PAYDA,DL_USER_THROUGHPUT_QCI_8_DEN ,THRP_TIMEDL_RMVLASTI_QCI_9,THRP_TIME_DL_RMVLAST_TTI_QCI6
FROM NORTHI_DATA.CELLSTS_4G_TMP
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24 AND L_CHMEAS_PRB_DL_AVAIL!=0

--UNION ALL
--
--SELECT /*+ PARALLEL(16) */ NETWORK_ID, FRAGMENT_DATE, -99 FBAND_ID, 0 DL_CHMEAS_PRB, 0 L_CHMEAS_PRB_DL_AVAIL, 0 DL_ACTIVE_USERS, 0 DL_NONGBR_ACTIVE_USERS_FWA, 0 USER_DL_RMVLAST_TTI_TRAFF_VOL, 0 L_THRP_TIME_DL_RMVLAST_TTI, 0 DL_NONGBR_USER_THR_NUM_FWA, 0 DL_NONGBR_USER_THR_DEN_FWA, 0 DL_TRAFFIC_VOL, 0 L_THRP_TIME_CELL_DL_HIGH_PREC, 0 AVG_DL_CELL_THR_NUM, 0 L_Thrp_bits_DL_CAUser, 0 L_THRP_BITS_DL_LAST_TTI, 0 L_Thrp_bits_DL_LastTTI_CAUser, 0 Thrp_Time_DL_RmvLastTTI_User, 0 L_Traffic_DL_MAC_TRFF, 0 AVG_CQI_256QM_NUM_FWA, 0 AVG_CQI_256QM_DEN_FWA, 0 L_ChMeas_PDSCH_MCS_NUM, 0 L_ChMeas_PDSCH_MCS_DEN, 0 L_ChMeas_RI_Rank1, 0 L_ChMeas_RI_Rank2, 0 L_ChMeas_RI_Rank3, 0 L_ChMeas_RI_Rank4, 0 VOLTE_TRAFFIC, 0 VOLTE_DATA_VOLUME, 0 TRAFFIC_VOLUME_QCI_8, 0 L_THRP_BITS_DL_QCI_6789, 0 DL_ACTIVE_USERS_FWA, 0 DL_USER_THRPUT_FWA_NUM, 0 DL_USER_THRPUT_FWA_DEN, 0 DL_DATA_VOLUME_FWA, 0 CHMEAS_PRB_DL_PCELL_USED_AVG, 0 CHMEAS_PRB_DL_SCELL_USED_AVG, 0 DL_FIRST_PACKET_DELAY_NUM, 0 DL_FIRST_PACKET_DELAY_DEN, 0 DL_FIRST_PACKET_DELAY_MOB_NUM, 0 DL_FIRST_PACKET_DELAY_MOB_DEN, 0 DL_FIRST_PACKET_DELAY_FWA_NUM, 0 DL_FIRST_PACKET_DELAY_FWA_DEN, 0 DL_NONGBR_USER_EXPERIENCE_NUM, 0 DL_NONGBR_USER_EXPERIENCE_DEN, 0 AVERAGE_CQI_NON256QAM_NUM, 0 AVERAGE_CQI_NON256QAM_DEN, 0 EXT_PRB_NUM, 0 EXT_PRB_DEN, 0 DL_NONGBR_ACTIVE_USERS, 0 DL_NONGBR_ACTIVE_USERS_NUM, 0 AVG_RRC_CONNECTED_USER, 0 KPI160_EXT1, 0 KPI160_EXT2_NUM, 0 KPI160_EXT3, 0 L_THRP_BITS_DL_QCI, 0 THRP_BITS_DEXTQCI_INDEX0, 0 THRP_BITS_DEXTQCI_INDEX1, 0 THRP_BITS_DEXTQCI_INDEX2, 0 DL_TRAFF_QCI_133_MB_NUM, 0 L_THRP_BITS_DL_EXTQCI_INDEX5, 0 LTE_HU_ACTIVE_USERS, 0 LTE_HU_USER_THRPUT_NUM, 0 LTE_HU_DATA_VOLUME_NUM, 0 LTE_NRML_HU_USER_THRPUT_NUM, 0 LTE_NRML_HU_USER_THRPUT_DEN, 0 CAT_M_PRB_USED_DL, DL_RSOURCE_BLOCK_UTIL_RATE_NUM, USER_DL_AVG_TPUT_DEN
--FROM NORTHI_DATA.GNB_STATISTICS
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24
),

DATASET_2 AS
(
SELECT TRUNC(FRAGMENT_DATE) FRAGMENT_DATE, NETWORK_ID, FBAND_ID, 
SUM(CASE WHEN ROUND((DL_NONGBR_ACTIVE_USERS)/((5*BW-(0.15*VOLTE_SESSION_TIME)-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 AND (DL_NONGBR_USER_THROUGHPUT)<3  THEN 1 ELSE 0 END)  KPI_C_820 
FROM NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920_H
WHERE FRAGMENT_DATE BETWEEN TRUNC(XDATE)+8/24 AND TRUNC(XDATE)+20/24
GROUP BY TRUNC(FRAGMENT_DATE), NETWORK_ID, FBAND_ID
)

SELECT A1.FRAGMENT_DATE, A1.NETWORK_ID, A1.FBAND, A1.BW, A1.PRBS_USED_BY_PDSCH, A1.AVAILABLE_PRBS, A1.DL_ACTIVE_USERS, A1.DL_NONGBR_ACTIVE_USERS, A1.DL_USER_THROUGHPUT, A1.DL_NONGBR_USER_THROUGHPUT, A1.DL_CELL_DATA_VOLUME, 
       A1.DL_CELL_ACTIVITY_TIME, A1.DL_CELL_THROUGHPUT, A1.NONCA_DL_USER_THROUGHPUT, A1.CA_DL_USER_THROUGHPUT, A1.CA_DL_DATA_VOLUME, A1.MAC_DL_DATA_VOLUME, A1.AVG_CQI, AVG_MCS, A1.AVG_RANK_INDICATION, A1.VOLTE_SESSION_TIME, 
       A1.VOLTE_DATA_VOLUME, A1.FBAND_ID, A1.TRAFFIC_VOLUME_QCI_8_MB, A1.L_THRP_BITS_DL_QCI_6789_MB, A1.DL_ACTIVE_USERS_FWA, A1.DL_USER_THRPUT_FWA, A1.DL_DATA_VOLUME_FWA, A1.DL_CA_ACTIVE_USERS, A1.DL_PCELL_USED_PRB, 
       DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, 
       DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL, KPI160_EXT1, KPI160_EXT2, KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME, LTE_NRML_HU_USER_THRPUT, 
       CAT_M_PRB_USED_DL, NR_PRB_USED,NR_NON_GBR_ACT_DATA_USERS_DL, A2.KPI_C_820, KPI160UAI, KPI160UAJ, KPI160UE, KPI160UF, KPI160UG, KPI160UK,KPI160uc,KPI160ud
FROM
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, 
       TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY,
       DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,
       KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,
       LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL,
       KPI160UAI, KPI160UAJ, KPI160UE, KPI160UF, KPI160UG, KPI160UK,KPI160uc,KPI160ud
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT,CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME,MAC_DL_DATA_VOLUME, AVG_CQI,AVG_MCS,AVG_RANK_INDICATION,VOLTE_SESSION_TIME,VOLTE_DATA_VOLUME,  
       A.FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB,L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB,
       DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS,
       DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL, KPI160UAI, KPI160UAJ, KPI160UE, KPI160UF, KPI160UG, KPI160UK,KPI160uc,KPI160ud,
       row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_NONGBR_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_DATA_VOLUME DESC, FRAGMENT_DATE DESC)  RN
FROM
(SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS, 
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,4) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),4) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)/1000,2) DL_CELL_ACTIVITY_TIME,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),0,0,(SUM(AVG_DL_CELL_THR_NUM)/1000)/SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)),2) DL_CELL_THROUGHPUT,
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User),0,0,((SUM(AVG_DL_CELL_THR_NUM-L_Thrp_bits_DL_CAUser)-SUM(L_THRP_BITS_DL_LAST_TTI-L_Thrp_bits_DL_LastTTI_CAUser))/1000)/SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User)),2) NONCA_DL_USER_THROUGHPUT,
                         CASE 
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) = 0 THEN NULL
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) <> 0 THEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2)
                         END  CA_DL_USER_THROUGHPUT,
                         CASE
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) = 0 THEN NULL
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) <> 0 THEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2)
                         END CA_DL_DATA_VOLUME,
                         ROUND(SUM(L_TRAFFIC_DL_MAC_TRFF)/(8*POWER(10,6)),2) MAC_DL_DATA_VOLUME,
                         ROUND(DECODE(SUM(AVG_CQI_256QM_DEN_FWA),0,0,SUM(AVG_CQI_256QM_NUM_FWA)/SUM(AVG_CQI_256QM_DEN_FWA)),2) AVG_CQI, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_ChMeas_PDSCH_MCS_DEN),0,0,SUM(L_ChMeas_PDSCH_MCS_NUM)/SUM(L_ChMeas_PDSCH_MCS_DEN)),2) AVG_MCS,
                         ROUND(DECODE(SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4),0,0,SUM(L_ChMeas_RI_Rank1+(2*L_ChMeas_RI_Rank2)+(3*L_ChMeas_RI_Rank3)+(4*L_ChMeas_RI_Rank4))/SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4)),2) AVG_RANK_INDICATION,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(SUM(VOLTE_DATA_VOLUME)/(8*POWER(10,6)),2) VOLTE_DATA_VOLUME,
                         ROUND(SUM(TRAFFIC_VOLUME_QCI_8)/8/1024/1024,2) TRAFFIC_VOLUME_QCI_8_MB,
                         ROUND(SUM(L_THRP_BITS_DL_QCI_6789)/8/1024/1024,2) L_THRP_BITS_DL_QCI_6789_MB,
                         ROUND(SUM(DL_ACTIVE_USERS_FWA)/3600000,4) DL_ACTIVE_USERS_FWA, 
                         ROUND(DECODE(SUM(DL_USER_THRPUT_FWA_DEN),0,0,(SUM(DL_USER_THRPUT_FWA_NUM)/1000)/SUM(DL_USER_THRPUT_FWA_DEN)),2) DL_USER_THRPUT_FWA, 
                         ROUND(SUM(DL_DATA_VOLUME_FWA)/8000000,2) DL_DATA_VOLUME_FWA, 
                         ROUND(SUM(Thrp_Time_DL_RmvLastTTI_User)/3600000,2) DL_CA_ACTIVE_USERS, 
                         ROUND(SUM(CHMEAS_PRB_DL_PCELL_USED_AVG),2) DL_PCELL_USED_PRB, 
                         ROUND(SUM(CHMEAS_PRB_DL_SCELL_USED_AVG),2) DL_SCELL_USED_PRB, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_NUM)/SUM(DL_FIRST_PACKET_DELAY_DEN)),2) DL_FIRST_PACKET_DELAY, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_FIRST_PACKET_DELAY_MOBILE, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FIRST_PACKET_DELAY_FWA, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_EXPERIENCE_DEN),0,0,(SUM(DL_NONGBR_USER_EXPERIENCE_NUM)/1000)/SUM(DL_NONGBR_USER_EXPERIENCE_DEN)),2) DL_NONGBR_USER_EXPERIENCE, 
                         ROUND(DECODE(SUM(AVERAGE_CQI_NON256QAM_DEN),0,0,SUM(AVERAGE_CQI_NON256QAM_NUM)/SUM(AVERAGE_CQI_NON256QAM_DEN)),2) AVERAGE_CQI_NON256QAM, 
                         ROUND(DECODE(SUM(EXT_PRB_DEN),0,0,SUM(EXT_PRB_NUM)*100/SUM(EXT_PRB_DEN)),2) EXT_PRB, 
                         ROUND(DECODE(SUM(DL_NONGBR_ACTIVE_USERS),0,0,(SUM(DL_NONGBR_ACTIVE_USERS_NUM)/1000)/SUM(DL_NONGBR_ACTIVE_USERS)),4) DL_NONGBR_NORM_USER_THRPUT, 
                         ROUND(SUM(AVG_RRC_CONNECTED_USER),2) RRC_CONNECTED_USERS,
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_NORM_USER_FIRST_PAC_DEL, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FWA_USER_PAC_DEL, 
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_EXT1,
                         ROUND(DECODE(SUM(KPI160_EXT1),0,0,(SUM(KPI160_EXT2_NUM)/1000)/SUM(KPI160_EXT1)),2) KPI160_EXT2,
                         ROUND(SUM(KPI160_EXT3)/8000000,2) KPI160_EXT3,
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_HU_C,
                         ROUND(DECODE(SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA),0,0,SUM(DL_TRAFFIC_VOL-L_THRP_BITS_DL_QCI-(THRP_BITS_DEXTQCI_INDEX0+THRP_BITS_DEXTQCI_INDEX1+THRP_BITS_DEXTQCI_INDEX2+DL_TRAFF_QCI_133_MB_NUM))/SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA)/1000),2) KPI160_HU_D,
                         ROUND(SUM(L_THRP_BITS_DL_EXTQCI_INDEX5)/8000000,2) KPI160_HU_E,
                         
                         ROUND(SUM(LTE_HU_ACTIVE_USERS) / 3600000,2) LTE_HU_ACTIVE_USERS,
                         ROUND(DECODE(SUM(LTE_HU_ACTIVE_USERS),0,0,SUM(LTE_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_HU_ACTIVE_USERS)),2) LTE_HU_USER_THRPUT,
                         ROUND(SUM(LTE_HU_DATA_VOLUME_NUM) / 8000000,2)  LTE_HU_DATA_VOLUME,
                         DECODE(SUM(THRP_TIME_DL_RMVLAST_TTI_QCI6+ DL_USER_TPUT_MBPS_QCI_7_PAYDA + DL_USER_THROUGHPUT_QCI_8_DEN + THRP_TIMEDL_RMVLASTI_QCI_9 + LTE_HU_ACTIVE_USERS),0,0,(SUM(L_THRP_BITS_DL_QCI6 - L_THRP_DL_LASTTTI_QCI6) + SUM(DLTRAFFICVOLUME_QCI_7 - THRP_BITS_DL_LASTTTI_QCI_7) + SUM(DLTRAFFICVOLUME_QCI_8 - THRP_BITS_DL_LASTTTI_QCI_8) + SUM(L_THRP_BITS_DL_QCI9 - THRP_BITS_DL_LASTTTI_QCI_9) + SUM(LTE_HU_DATA_VOLUME_NUM - THRP_BITSDL_LASTI_FLEXQCI_I4))/ 1000/SUM(THRP_TIME_DL_RMVLAST_TTI_QCI6+ DL_USER_TPUT_MBPS_QCI_7_PAYDA + DL_USER_THROUGHPUT_QCI_8_DEN + THRP_TIMEDL_RMVLASTI_QCI_9 + LTE_HU_ACTIVE_USERS)) LTE_NRML_HU_USER_THRPUT,
                         ROUND(SUM(CAT_M_PRB_USED_DL),2) CAT_M_PRB_USED_DL,
                         ROUND(SUM(DL_RSOURCE_BLOCK_UTIL_RATE_NUM),2) NR_PRB_USED, 
                         ROUND(SUM(USER_DL_AVG_TPUT_DEN),2) NR_NON_GBR_ACT_DATA_USERS_DL,
                         
                         ROUND(SUM(UL_CHMEAS_PRB),2) KPI160UAI,   
                         ROUND(SUM(L_CHMEAS_PRB_PUSH_AVG),2) KPI160UAJ, 
                         ROUND(SUM(UL_TRAFFIC_VOL) / 8000000,2) KPI160UE,
                         ROUND(SUM(L_THRP_TIME_CELL_UL_HIGH_PREC) / 1000,2) KPI160UF,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_UL_HIGH_PREC), 0 , 0 , (SUM(UL_TRAFFIC_VOL) / 1000) / SUM(L_THRP_TIME_CELL_UL_HIGH_PREC)),2) KPI160UG,
                         ROUND(SUM(MAC_LAYER_DATA_VOLUME) / 8000000,2) KPI160UK,
                         ROUND(SUM(KPI160uc)/3600000,2) KPI160uc,
                         ROUND(DECODE(SUM(KPI160ud_PAYDA),0,0,(SUM(KPI160ud_PAY)/SUM(KPI160ud_PAYDA))/1000),2) KPI160ud
                         
FROM DATASET
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID = B.FBAND_ID
) WHERE RN=1
) A1, DATASET_2 A2
WHERE A1.NETWORK_ID = A2.NETWORK_ID AND TRUNC(A1.FRAGMENT_DATE) = TRUNC(A2.FRAGMENT_DATE) AND A1.FBAND_ID = A2.FBAND_ID;

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'REPORT_CELL_UTIL_PRB_4G_1920',XSTATE );
       commit;                   
       
     
       raise;
    
END;
PROCEDURE PROCESS_CELL_UTIL_4G_90 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTIL_4G_90';

DELETE FROM NORTHI_DATA.CELL_UTIL_4G_90 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;

--INSERT /*+ APPEND */ INTO  NORTHI_DATA.CELL_UTIL_4G_90 (FRAGMENT_DATE, NETWORK_ID, UTIL, CONN_USER_NORM, DL_ACTIVE_USERS)
--
--SELECT /*+ PARALLEL(4) */ FRAGMENT_DATE, NETWORK_ID, UTIL, CONN_USER_NORM, DL_ACTIVE_USERS
--FROM 
--(
--SELECT  FRAGMENT_DATE, NETWORK_ID,UTIL_DL,UTIL_UL,GREATEST(UTIL_UL,UTIL_DL) UTIL,UTIL_DL_NEW,UTIL_UL_NEW, GREATEST(UTIL_UL_NEW,UTIL_DL_NEW) UTIL_NEW, CONN_USER_NORM, AVG_RRC_CONNECTED_USER, DL_TRAFFIC, UL_TRAFFIC, DL_ACTIVE_USERS,
--row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY GREATEST(UTIL_UL,UTIL_DL) DESC)  RN
-- FROM
--(
--SELECT FRAGMENT_DATE, NETWORK_ID, 
--DECODE(RB,0,0,SUM(DL_CHMEAS_PRB)*100/RB)*NF UTIL_DL , 
--DECODE(RB,0,0,SUM(DL_CHMEAS_PRB)*100/RB)*NF_NEW UTIL_DL_NEW , 
--
--DECODE(SUM(RB-PUCCH_CHMEAS_PRB),0,0,SUM(UL_CHMEAS_PRB-PUCCH_CHMEAS_PRB)*100/SUM(RB-PUCCH_CHMEAS_PRB))*NF  UTIL_UL ,
--DECODE(SUM(RB-PUCCH_CHMEAS_PRB),0,0,SUM(UL_CHMEAS_PRB-PUCCH_CHMEAS_PRB)*100/SUM(RB-PUCCH_CHMEAS_PRB))*NF_NEW  UTIL_UL_NEW ,
--
--DECODE(CU,0,0,SUM(AVG_RRC_CONNECTED_USER)*100/CU*0.9) CONN_USER_NORM,
--ROUND(SUM(AVG_RRC_CONNECTED_USER),2) AVG_RRC_CONNECTED_USER,
--ROUND(SUM(DL_TRAFFIC_VOL)/8/(1024*1024),2) DL_TRAFFIC,
--ROUND(SUM(UL_TRAFFIC_VOL)/8/(1024*1024),2) UL_TRAFFIC,
--ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS
--FROM
--(SELECT FRAGMENT_DATE, NETWORK_ID, DL_CHMEAS_PRB,UL_CHMEAS_PRB, PUCCH_CHMEAS_PRB ,AVG_RRC_CONNECTED_USER,DL_TRAFFIC_VOL,UL_TRAFFIC_VOL ,DL_ACTIVE_USERS
--FROM NORTHI_DATA.CELLSTS_4G
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23.5/24
--) A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
--WHERE A.NETWORK_ID=B.CELL_ID
--GROUP BY FRAGMENT_DATE, NETWORK_ID,RB,NF,NF_NEW,CU
--) 
--) WHERE (UTIL>90 AND CONN_USER_NORM>90) OR (UTIL < 10 AND CONN_USER_NORM < 10)
--;

 COMMIT;
                
                EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTIL_4G_90',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;

PROCEDURE PROCESS_CELL_UTILPRB_4G_100 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTILPRB_4G_100';

DELETE FROM NORTHI_DATA.CELL_UTILPRB_4G_100 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;

--INSERT /*+ APPEND */  INTO NORTHI_DATA.CELL_UTILPRB_4G_100  (FRAGMENT_DATE, NETWORK_ID, FBAND, FBAND_ID, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_USER_THROUGHPUT)
--
--SELECT /*+ PARALLEL(4) */ FRAGMENT_DATE, NETWORK_ID,FBAND,FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_USER_THROUGHPUT
--FROM 
--(
--SELECT  FRAGMENT_DATE, NETWORK_ID, FBAND,A.FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_USER_THROUGHPUT,DL_CELL_TRAFFIC_VOLUME,
--row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_TRAFFIC_VOLUME DESC, FRAGMENT_DATE DESC)  RN
-- FROM
--
--(SELECT  FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
--                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
--                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
--                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS,
--                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
--                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_TRAFFIC_VOLUME
--FROM NORTHI_DATA.CELLSTS_4G
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24  
--AND L_CHMEAS_PRB_DL_AVAIL!=0
--GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
--)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
--WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID=B.FBAND_ID
--) WHERE ROUND((DL_ACTIVE_USERS)/((5*BW-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 
--;

COMMIT;
                
                EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTILPRB_4G_100',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;

PROCEDURE CELL_UTILPRB_4G_1920_100 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTILPRB_4G_1920_100';

DELETE FROM NORTHI_DATA.CELL_UTILPRB_4G_1920_100 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;

INSERT /*+ APPEND */  INTO NORTHI_DATA.CELL_UTILPRB_4G_1920_100  (FRAGMENT_DATE, NETWORK_ID, FBAND, FBAND_ID, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT)

SELECT  FRAGMENT_DATE, NETWORK_ID,FBAND,FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT ,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT
FROM 
(
SELECT  FRAGMENT_DATE, NETWORK_ID, FBAND,A.FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS,DL_USER_THROUGHPUT,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT,
row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_NONGBR_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_DATA_VOLUME DESC, FRAGMENT_DATE DESC)  RN
 FROM

(SELECT  FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS,
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,2) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),2) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN),0,0,(SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL-DL_NORM_USER_THRPUT_NUM)/1000)/SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN)),2) DL_NONGBR_NORM_USER_THRPUT
FROM NORTHI_DATA.CELLSTS_4G_TMP
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24  
AND L_CHMEAS_PRB_DL_AVAIL!=0
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID=B.FBAND_ID
) WHERE ROUND((DL_ACTIVE_USERS)/((5*BW-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100;

COMMIT;
                
                EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTILPRB_4G_1920_100',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;

PROCEDURE PROCESS_NED_2G_REPORT (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.NED_2G_REPORT';

    DELETE FROM NORTHI_DATA.NED_2G_REPORT WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
    COMMIT; 
    
INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT (DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V2_DCR_DEN, V2_DCR_NUM, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

WITH DS_DA AS
(
SELECT  /*+ PARALLEL(4) */  FRAGMENT_DATE, NETWORK_ID,  SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID,
ROUND(SUM(NED_DCR_DC_NW),2) V1_DCR_NUM ,ROUND(SUM(DCR2_DEN),2) V1_DCR_DEN,
ROUND(SUM(NED_DCR_CALL),2) V2_DCR_DEN ,ROUND(SUM(NED_DCR_DC),2) V2_DCR_NUM ,ROUND(SUM(TCH_NORMSEIZS),2) V2_TOT_CALL  
FROM NORTHI_DATA.CELLSTS_DA 
WHERE DTYPE=1 AND FRAGMENT_dATE BETWEEN   XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID
),

DS_DBH AS (
SELECT /*+ PARALLEL(4) */   NETWORK_ID,TRUNC(FRAGMENT_DATE)  FRAGMENT_DATE,
ROUND(SUM(CSSR2_NUM),2) V3_CSSR_NUM ,
ROUND(SUM(CSSR2_DEN),2) V3_CSSR_DEN,
ROUND(SUM(TCH_ASS_SUCC),2) V3T_TCH_ASS_SUCC ,
ROUND(SUM(TCH_ASS_ATT),2) V3T_TCH_ASS_ATT ,
ROUND(SUM(TCH_ASS_ATT - CSTCHB_VF_NUM),2) V4_CSSR_NUM,
ROUND(SUM(TCH_ASS_ATT),2) V4_CSSR_DEN
 
FROM NORTHI_DATA.DBH_CELLSTS
WHERE BH_TYPE=1 AND FRAGMENT_DATE BETWEEN   XDATE AND XDATE+23/24
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE)
), 

DS_HO AS
(
 SELECT  /*+ PARALLEL(4) */  PCELLID, NETWORK_ID,  FRAGMENT_DATE, SUCC_CELL_OG_HO_DR
   FROM    NORTHI_DATA.CELLHO_DA
  WHERE   FRAGMENT_DATE BETWEEN   XDATE AND XDATE+23/24
) 

SELECT /*+ PARALLEL(4) */  1 DTYPE,  A.FRAGMENT_DATE,  A.NETWORK_ID , SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID,V1_DCR_NUM ,V1_DCR_DEN ,
NVL(H373K_Incoming,0)-NVL(H373K_Outgoing,0)+NVL(V2_DCR_DEN,0) V2_DCR_DEN, V2_DCR_NUM, V2_TOT_CALL ,V3_CSSR_NUM ,V3_CSSR_DEN ,V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT ,V4_CSSR_NUM,V4_CSSR_DEN
FROM DS_DA A, DS_DBH B  LEFT OUTER JOIN 
(
SELECT /*+ PARALLEL(4) */  OUTT.NETWORK_ID,OUTT.FRAGMENT_dATE,H373K_Outgoing,H373K_Incoming

FROM
(
select /*+ PARALLEL(4) */ NETWORK_ID, FRAGMENT_DATE, SUM(SUCC_CELL_OG_HO_DR) H373K_Outgoing 
from 
DS_HO aa
where FRAGMENT_DATE  BETWEEN  XDATE AND XDATE+23/24
group by NETWORK_ID, FRAGMENT_DATE
)OUTT,

(
select /*+ PARALLEL(4)  */  CELL_ID, FRAGMENT_DATE, SUM(SUCC_CELL_OG_HO_DR) H373K_Incoming 
from DS_HO aaa, NORTHI_DATA.OMC_BSC_BTS_CELL_LIST oo
where FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24 AND STATE_CELL=0
and aaa.PCELLID = oo.pcell_id 
group by FRAGMENT_DATE,CELL_ID
)INN
WHERE OUTT.FRAGMENT_DATE=INN.FRAGMENT_DATE AND OUTT.NETWORK_ID=INN.CELL_ID
) HO ON (HO.NETWORK_ID=B.NETWORK_ID AND HO.FRAGMENT_dATE=B.FRAGMENT_DATE)
WHERE A.NETWORK_ID=B.NETWORK_ID AND A.FRAGMENT_DATE=B.FRAGMENT_DATE;

COMMIT;



INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT     
(DTYPE ,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM,V1_DCR_DEN,V2_DCR_DEN,V2_DCR_NUM,V2_TOT_CALL,V3_CSSR_NUM,V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 2 DTYPE, FRAGMENT_DATE, SUB_REGION_ID NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V2_DCR_DEN) V2_DCR_DEN, 
SUM(V2_DCR_NUM) V2_DCR_NUM, 
SUM(V2_TOT_CALL) V2_TOT_CALL, 
SUM(V3_CSSR_NUM) V3_CSSR_NUM, 
SUM(V3_CSSR_DEN) V3_CSSR_DEN, 
SUM(V3T_TCH_ASS_SUCC) V3T_TCH_ASS_SUCC, 
SUM(V3T_TCH_ASS_ATT) V3T_TCH_ASS_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN) V4_CSSR_DEN
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, SUB_REGION_ID, MAIN_REGION_ID;

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT     
(DTYPE ,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM,V1_DCR_DEN,V2_DCR_DEN,V2_DCR_NUM,V2_TOT_CALL,V3_CSSR_NUM,V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 3 DTYPE, FRAGMENT_DATE, MAIN_REGION_ID NETWORK_ID, NULL SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V2_DCR_DEN) V2_DCR_DEN, 
SUM(V2_DCR_NUM) V2_DCR_NUM, 
SUM(V2_TOT_CALL) V2_TOT_CALL, 
SUM(V3_CSSR_NUM) V3_CSSR_NUM, 
SUM(V3_CSSR_DEN) V3_CSSR_DEN, 
SUM(V3T_TCH_ASS_SUCC) V3T_TCH_ASS_SUCC, 
SUM(V3T_TCH_ASS_ATT) V3T_TCH_ASS_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN) V4_CSSR_DEN
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, MAIN_REGION_ID;

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT     
(DTYPE ,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM,V1_DCR_DEN,V2_DCR_DEN,V2_DCR_NUM,V2_TOT_CALL,V3_CSSR_NUM,V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 4 DTYPE, FRAGMENT_DATE, CITY_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V2_DCR_DEN) V2_DCR_DEN, 
SUM(V2_DCR_NUM) V2_DCR_NUM, 
SUM(V2_TOT_CALL) V2_TOT_CALL, 
SUM(V3_CSSR_NUM) V3_CSSR_NUM, 
SUM(V3_CSSR_DEN) V3_CSSR_DEN, 
SUM(V3T_TCH_ASS_SUCC) V3T_TCH_ASS_SUCC, 
SUM(V3T_TCH_ASS_ATT) V3T_TCH_ASS_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN) V4_CSSR_DEN
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, CITY_ID;

COMMIT;



INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT     
(DTYPE ,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM,V1_DCR_DEN,V2_DCR_DEN,V2_DCR_NUM,V2_TOT_CALL,V3_CSSR_NUM,V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 5 DTYPE, FRAGMENT_DATE, ILCE_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, CITY_ID, ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V2_DCR_DEN) V2_DCR_DEN, 
SUM(V2_DCR_NUM) V2_DCR_NUM, 
SUM(V2_TOT_CALL) V2_TOT_CALL, 
SUM(V3_CSSR_NUM) V3_CSSR_NUM, 
SUM(V3_CSSR_DEN) V3_CSSR_DEN, 
SUM(V3T_TCH_ASS_SUCC) V3T_TCH_ASS_SUCC, 
SUM(V3T_TCH_ASS_ATT) V3T_TCH_ASS_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN) V4_CSSR_DEN
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, CITY_ID, ILCE_ID;

COMMIT;



INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_2G_REPORT     
(DTYPE ,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM,V1_DCR_DEN,V2_DCR_DEN,V2_DCR_NUM,V2_TOT_CALL,V3_CSSR_NUM,V3_CSSR_DEN, V3T_TCH_ASS_SUCC, V3T_TCH_ASS_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 6 DTYPE, FRAGMENT_DATE, -999 NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V2_DCR_DEN) V2_DCR_DEN, 
SUM(V2_DCR_NUM) V2_DCR_NUM, 
SUM(V2_TOT_CALL) V2_TOT_CALL, 
SUM(V3_CSSR_NUM) V3_CSSR_NUM, 
SUM(V3_CSSR_DEN) V3_CSSR_DEN, 
SUM(V3T_TCH_ASS_SUCC) V3T_TCH_ASS_SUCC, 
SUM(V3T_TCH_ASS_ATT) V3T_TCH_ASS_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN) V4_CSSR_DEN
FROM NORTHI_DATA.NED_2G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN  XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE;

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_NED_2G_REPORT',XSTATE );
       commit;                   
       
     
       raise;
    
END;

PROCEDURE PROCESS_NED_3G_REPORT (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.NED_3G_REPORT';

    DELETE FROM NORTHI_DATA.NED_3G_REPORT WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
    COMMIT; 

INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

WITH DS_DA AS 
(
SELECT /*+ PARALLEL(4) */ FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID,
ROUND(SUM(DCR23_2NUM),2) V1_DCR_NUM ,
ROUND(SUM(DCR23_DEN),2) V1_DCR_DEN ,
ROUND(SUM(VOICE_RAB_EST_F_R_NUM+VS_RAB_SUCCESTCS_AMRWB),2) V1_24_DCR_DEN ,
ROUND(SUM(VOICE_RAB_EST_F_R_DEN),2) V2_TOT_CALL
FROM NORTHI_dATA.CELL_STATISTICS_DA 
WHERE DTYPE=1 AND FRAGMENT_dATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID
),

DS_BH_1 AS 
(
SELECT /*+ PARALLEL(4) */ NETWORK_ID,TRUNC(FRAGMENT_DATE) FRAGMENT_DATE,
ROUND(SUM(CSSR23_DEN-CSSR23_NUM),2)  V4_CSSR_NUM,
ROUND(SUM(CSSR23_DEN),2) V4_CSSR_DEN
FROM NORTHI_DATA.DBH_CELL_STATISTICS 
WHERE BH_TYPE=4 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE)
),

DS_BH_2 AS 
(
SELECT /*+ PARALLEL(4)*/ NETWORK_ID,TRUNC(FRAGMENT_DATE) FRAGMENT_DATE,
ROUND(SUM(CSSR23_NUM),2) V3_CSSR_NUM, --RABVS E GORE BH ALINACAK (3597472 nolu case)
ROUND(SUM(CSSR23_DEN),2) V3_CSSR_DEN, --RABVS E GORE BH ALINACAK (3597472 nolu case)
ROUND(SUM(CS_RRC_CELLUPD_SUCC),2) V3T_RRC_UPD_SUCC, --RABVS E GORE BH ALINACAK (3597472 nolu case)
ROUND(SUM(CS_RRC_CELLUPD_ATT),2)  V3T_RRC_UPD_ATT, --RABVS E GORE BH ALINACAK (3597472 nolu case)
ROUND(SUM(CSSR23_DEN-CSSR23_NUM),2)  V3T_RAB_SUCC, --RABVS E GORE BH ALINACAK (3597472 nolu case)
ROUND(SUM(CSSR23_DEN),2) V3T_RAB_ATT --RABVS E GORE BH ALINACAK (3597472 nolu case)
FROM NORTHI_DATA.DBH_CELL_STATISTICS 
WHERE BH_TYPE=89 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE)
)

SELECT /*+ PARALLEL(4) */ 1 DTYPE, A.FRAGMENT_DATE, A.NETWORK_ID , SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID, V1_DCR_NUM ,V1_DCR_DEN , V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM ,V3_CSSR_DEN ,V3T_RRC_UPD_SUCC,V3T_RRC_UPD_ATT,V3T_RAB_SUCC,V3T_RAB_ATT,V4_CSSR_NUM,V4_CSSR_DEN
FROM DS_DA A, DS_BH_1 B LEFT OUTER JOIN DS_BH_2 C ON (B.NETWORK_ID = C.NETWORK_ID AND B.FRAGMENT_DATE = C.FRAGMENT_DATE)
WHERE A.NETWORK_ID=B.NETWORK_ID  AND A.FRAGMENT_DATE=B.FRAGMENT_DATE;

COMMIT;

INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)
SELECT 2 DTYPE, FRAGMENT_DATE, SUB_REGION_ID NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V1_24_DCR_DEN)V1_24_DCR_DEN, 
SUM(V2_TOT_CALL)V2_TOT_CALL, 
SUM(V3_CSSR_NUM)V3_CSSR_NUM, 
SUM(V3_CSSR_DEN)V3_CSSR_DEN, 
SUM(V3T_RRC_UPD_SUCC)V3T_RRC_UPD_SUCC, 
SUM(V3T_RRC_UPD_ATT)V3T_RRC_UPD_ATT, 
SUM(V3T_RAB_SUCC)V3T_RAB_SUCC, 
SUM(V3T_RAB_ATT)V3T_RAB_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN)V4_CSSR_DEN
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, SUB_REGION_ID,MAIN_REGION_ID;

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

SELECT 3 DTYPE, FRAGMENT_DATE, MAIN_REGION_ID NETWORK_ID, NULL SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V1_24_DCR_DEN)V1_24_DCR_DEN, 
SUM(V2_TOT_CALL)V2_TOT_CALL, 
SUM(V3_CSSR_NUM)V3_CSSR_NUM, 
SUM(V3_CSSR_DEN)V3_CSSR_DEN, 
SUM(V3T_RRC_UPD_SUCC)V3T_RRC_UPD_SUCC, 
SUM(V3T_RRC_UPD_ATT)V3T_RRC_UPD_ATT, 
SUM(V3T_RAB_SUCC)V3T_RAB_SUCC, 
SUM(V3T_RAB_ATT)V3T_RAB_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN)V4_CSSR_DEN
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,MAIN_REGION_ID;

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

SELECT 4 DTYPE, FRAGMENT_DATE, CITY_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, CITY_ID, NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V1_24_DCR_DEN)V1_24_DCR_DEN, 
SUM(V2_TOT_CALL)V2_TOT_CALL, 
SUM(V3_CSSR_NUM)V3_CSSR_NUM, 
SUM(V3_CSSR_DEN)V3_CSSR_DEN, 
SUM(V3T_RRC_UPD_SUCC)V3T_RRC_UPD_SUCC, 
SUM(V3T_RRC_UPD_ATT)V3T_RRC_UPD_ATT, 
SUM(V3T_RAB_SUCC)V3T_RAB_SUCC, 
SUM(V3T_RAB_ATT)V3T_RAB_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN)V4_CSSR_DEN
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,CITY_ID; 

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

SELECT 5 DTYPE, FRAGMENT_DATE, ILCE_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, CITY_ID,  ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V1_24_DCR_DEN)V1_24_DCR_DEN, 
SUM(V2_TOT_CALL)V2_TOT_CALL, 
SUM(V3_CSSR_NUM)V3_CSSR_NUM, 
SUM(V3_CSSR_DEN)V3_CSSR_DEN, 
SUM(V3T_RRC_UPD_SUCC)V3T_RRC_UPD_SUCC, 
SUM(V3T_RRC_UPD_ATT)V3T_RRC_UPD_ATT, 
SUM(V3T_RAB_SUCC)V3T_RAB_SUCC, 
SUM(V3T_RAB_ATT)V3T_RAB_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN)V4_CSSR_DEN
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,CITY_ID,ILCE_ID; 

COMMIT;


INSERT /*+ APPEND */ INTO NORTHI_DATA.NED_3G_REPORT 
(DTYPE,FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_DCR_NUM, V1_DCR_DEN, V1_24_DCR_DEN, V2_TOT_CALL, V3_CSSR_NUM, V3_CSSR_DEN, V3T_RRC_UPD_SUCC, V3T_RRC_UPD_ATT, V3T_RAB_SUCC, V3T_RAB_ATT, V4_CSSR_NUM, V4_CSSR_DEN)

SELECT 6 DTYPE, FRAGMENT_DATE, -999 NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID,NULL CITY_ID,  NULL ILCE_ID,
SUM(V1_DCR_NUM) V1_DCR_NUM, 
SUM(V1_DCR_DEN) V1_DCR_DEN, 
SUM(V1_24_DCR_DEN)V1_24_DCR_DEN, 
SUM(V2_TOT_CALL)V2_TOT_CALL, 
SUM(V3_CSSR_NUM)V3_CSSR_NUM, 
SUM(V3_CSSR_DEN)V3_CSSR_DEN, 
SUM(V3T_RRC_UPD_SUCC)V3T_RRC_UPD_SUCC, 
SUM(V3T_RRC_UPD_ATT)V3T_RRC_UPD_ATT, 
SUM(V3T_RAB_SUCC)V3T_RAB_SUCC, 
SUM(V3T_RAB_ATT)V3T_RAB_ATT, 
SUM(V4_CSSR_NUM)V4_CSSR_NUM, 
SUM(V4_CSSR_DEN)V4_CSSR_DEN
FROM NORTHI_DATA.NED_3G_REPORT 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE; 

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_NED_3G_REPORT',XSTATE );
       commit;                   
       
     
       raise;
    
END;

PROCEDURE PROCESS_NED_4G_REPORT (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.NED_4G_REPORT';

    DELETE FROM NORTHI_DATA.NED_4G_REPORT WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
    COMMIT; 

INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)
WITH DS_DA AS
(
SELECT /*+ PARALLEL(4) */  FRAGMENT_DATE, NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID, 
SUM(LE_RAB_ABNORMREL_ENBTOT+LE_RAB_ABNORMREL_MMETOT_VOIP-LE_RAB_ABN_MME_EUTRANGEN_VOIP) V1_24_DCR_NUM,
ROUND(sum(VOLTE_ACC_NUM),2) V1_24_DCR_DEN,
SUM(CS_RAB_EST_SR_NUM) V7_CSSR_NUM,
SUM(CS_RAB_EST_SR_DEN) V7_CSSR_DEN,
SUM(VOLTE_CALLS+LE_RAB_ABNORMREL_ENBTOT+LE_RAB_ABNORMREL_MMETOT_VOIP) V7_DCR_NUM
FROM NORTHI_dATA.CELLSTS_4G_DA 
WHERE DTYPE=1  AND  FRAGMENT_dATE  BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID

UNION ALL

SELECT /*+ PARALLEL(4) */  FRAGMENT_DATE, NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID, 
SUM(VOLTE_DCR_NUM) V1_24_DCR_NUM,
ROUND(sum(VOLTE_DCR_DEN),2) V1_24_DCR_DEN,
0 V7_CSSR_NUM,
0 V7_CSSR_DEN,
0 V7_DCR_NUM
FROM NORTHI_dATA.ULAK_4G_DA 
WHERE DTYPE=1  AND  FRAGMENT_dATE  BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID, ILCE_ID
),

DS_BH AS
(
SELECT /*+ PARALLEL(4) */ NETWORK_ID, TRUNC(FRAGMENT_DATE) FRAGMENT_DATE,
ROUND(SUM(CS_RAB_EST_SR_DEN-CS_RAB_EST_SR_NUM),2) V3_2018_CSSR_NUM,
ROUND(SUM(CS_RAB_EST_SR_DEN),2) V3_2018_CSSR_DEN,
ROUND(SUM(CS_RAB_EST_SR_NUM),2) V7R_BH_NUM
FROM NORTHI_DATA.DBH_CELLSTS_4G 
WHERE BH_TYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE)

UNION ALL

SELECT /*+ PARALLEL(4) */ NETWORK_ID, TRUNC(FRAGMENT_DATE) FRAGMENT_DATE,
0 V3_2018_CSSR_NUM,
ROUND(SUM(VOLTE_CSSR_DEN),2) V3_2018_CSSR_DEN,
ROUND(SUM(VOLTE_CSSR_NUM),2) V7R_BH_NUM
FROM NORTHI_DATA.DBH_ULAK_4G 
WHERE BH_TYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID,TRUNC(FRAGMENT_DATE)
)

SELECT /*+ PARALLEL(4) */ 1 DTYPE, A.FRAGMENT_DATE, A.NETWORK_ID,SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID,V1_24_DCR_NUM ,V1_24_DCR_DEN,V3_2018_CSSR_NUM,V3_2018_CSSR_DEN,V7_CSSR_NUM,V7_CSSR_DEN,V7_DCR_NUM,V7R_BH_NUM,V3_2018_CSSR_DEN V7R_BH_DEN
FROM DS_DA A, DS_BH B 
WHERE A.NETWORK_ID=B.NETWORK_ID  AND A.FRAGMENT_DATE=B.FRAGMENT_DATE;

COMMIT;


INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)
 
SELECT 2 DTYPE, FRAGMENT_DATE, SUB_REGION_ID NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_24_DCR_NUM) V1_24_DCR_NUM, 
SUM(V1_24_DCR_DEN) V1_24_DCR_DEN, 
SUM(V3_2018_CSSR_NUM) V3_2018_CSSR_NUM, 
SUM(V3_2018_CSSR_DEN) V3_2018_CSSR_DEN, 
SUM(V7_CSSR_NUM) V7_CSSR_NUM, 
SUM(V7_CSSR_DEN) V7_CSSR_DEN, 
SUM(V7_DCR_NUM) V7_DCR_NUM,
SUM(V7R_BH_NUM) V7R_BH_NUM,
SUM(V7R_BH_DEN) V7R_BH_DEN

FROM  NORTHI_DATA.NED_4G_REPORT
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE, SUB_REGION_ID,MAIN_REGION_ID;

COMMIT;


INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)

SELECT 3 DTYPE, FRAGMENT_DATE, MAIN_REGION_ID NETWORK_ID, NULL SUB_REGION_ID, MAIN_REGION_ID, NULL CITY_ID, NULL ILCE_ID,
SUM(V1_24_DCR_NUM) V1_24_DCR_NUM, 
SUM(V1_24_DCR_DEN) V1_24_DCR_DEN, 
SUM(V3_2018_CSSR_NUM) V3_2018_CSSR_NUM, 
SUM(V3_2018_CSSR_DEN) V3_2018_CSSR_DEN, 
SUM(V7_CSSR_NUM) V7_CSSR_NUM, 
SUM(V7_CSSR_DEN) V7_CSSR_DEN, 
SUM(V7_DCR_NUM) V7_DCR_NUM,
SUM(V7R_BH_NUM) V7R_BH_NUM,
SUM(V7R_BH_DEN) V7R_BH_DEN
FROM  NORTHI_DATA.NED_4G_REPORT
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,MAIN_REGION_ID;

COMMIT;



INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)

SELECT 4 DTYPE, FRAGMENT_DATE, CITY_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID,  CITY_ID, NULL ILCE_ID,
SUM(V1_24_DCR_NUM) V1_24_DCR_NUM, 
SUM(V1_24_DCR_DEN) V1_24_DCR_DEN, 
SUM(V3_2018_CSSR_NUM) V3_2018_CSSR_NUM, 
SUM(V3_2018_CSSR_DEN) V3_2018_CSSR_DEN, 
SUM(V7_CSSR_NUM) V7_CSSR_NUM, 
SUM(V7_CSSR_DEN) V7_CSSR_DEN, 
SUM(V7_DCR_NUM) V7_DCR_NUM,
SUM(V7R_BH_NUM) V7R_BH_NUM,
SUM(V7R_BH_DEN) V7R_BH_DEN
FROM  NORTHI_DATA.NED_4G_REPORT
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,CITY_ID;

COMMIT;


INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)

SELECT 5 DTYPE, FRAGMENT_DATE, ILCE_ID NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID,  CITY_ID,  ILCE_ID,
SUM(V1_24_DCR_NUM) V1_24_DCR_NUM, 
SUM(V1_24_DCR_DEN) V1_24_DCR_DEN, 
SUM(V3_2018_CSSR_NUM) V3_2018_CSSR_NUM, 
SUM(V3_2018_CSSR_DEN) V3_2018_CSSR_DEN, 
SUM(V7_CSSR_NUM) V7_CSSR_NUM, 
SUM(V7_CSSR_DEN) V7_CSSR_DEN, 
SUM(V7_DCR_NUM) V7_DCR_NUM,
SUM(V7R_BH_NUM) V7R_BH_NUM,
SUM(V7R_BH_DEN) V7R_BH_DEN
FROM  NORTHI_DATA.NED_4G_REPORT
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE,CITY_ID,ILCE_ID;

COMMIT;


INSERT /*+ APPEND */  INTO NORTHI_DATA.NED_4G_REPORT (DTYPE, FRAGMENT_DATE, NETWORK_ID, SUB_REGION_ID, MAIN_REGION_ID, CITY_ID,ILCE_ID, V1_24_DCR_NUM, V1_24_DCR_DEN, V3_2018_CSSR_NUM, V3_2018_CSSR_DEN, V7_CSSR_NUM, V7_CSSR_DEN, V7_DCR_NUM,V7R_BH_NUM,V7R_BH_DEN)

SELECT 6 DTYPE, FRAGMENT_DATE, -999 NETWORK_ID, NULL SUB_REGION_ID, NULL MAIN_REGION_ID, NULL  CITY_ID, NULL ILCE_ID,
SUM(V1_24_DCR_NUM) V1_24_DCR_NUM, 
SUM(V1_24_DCR_DEN) V1_24_DCR_DEN, 
SUM(V3_2018_CSSR_NUM) V3_2018_CSSR_NUM, 
SUM(V3_2018_CSSR_DEN) V3_2018_CSSR_DEN, 
SUM(V7_CSSR_NUM) V7_CSSR_NUM, 
SUM(V7_CSSR_DEN) V7_CSSR_DEN, 
SUM(V7_DCR_NUM) V7_DCR_NUM,
SUM(V7R_BH_NUM) V7R_BH_NUM,
SUM(V7R_BH_DEN) V7R_BH_DEN
FROM  NORTHI_DATA.NED_4G_REPORT
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY FRAGMENT_DATE;

COMMIT;

 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'PROCESS_NED_4G_REPORT',XSTATE );
       commit;                   
       
     
       raise;
    
END;


PROCEDURE SEND_EMAIL_3GRAN(XDATE DATE)
AS
XCOUNT NUMBER;
XEMAIL_TEXT VARCHAR2(32000);
XRESULT NUMBER;
pRecipient VARCHAR2(3000);
BEGIN
    XEMAIL_TEXT:='3GRAN Extra Tables Data Count for '||TO_CHAR(XDATE,'DD.MM.YYYY')||CHR(13)||CHR(10);
    XEMAIL_TEXT:=XEMAIL_TEXT||'TABLE_NAME'||CHR(9)||CHR(9)||CHR(9)||CHR(9)||'RECORD_COUNT'||CHR(13)||CHR(10);
    XEMAIL_TEXT:=XEMAIL_TEXT||'----------'||CHR(9)||CHR(9)||CHR(9)||CHR(9)||'------------'||CHR(13)||CHR(10);
    select COUNT(*) INTO XCOUNT 
    FROM NORTHI_DATA.REPORT_CELL_UTIL_GLOBAL_3G
    WHERE TARIH BETWEEN TRUNC(XDATE) AND (TRUNC(XDATE)+1)-0.005/24;
    XEMAIL_TEXT:=XEMAIL_TEXT||'REPORT_CELL_UTIL_GLOBAL_3G'||CHR(9)||CHR(9)||CHR(9)||XCOUNT||CHR(13)||CHR(10);
    select COUNT(*) INTO XCOUNT 
    FROM NORTHI_DATA.REPORT_NODEB_CEUTIL_GLOBAL_3G 
    WHERE TARIH BETWEEN TRUNC(XDATE) AND (TRUNC(XDATE)+1)-0.005/24;
    XEMAIL_TEXT:=XEMAIL_TEXT||'REPORT_NODEB_CEUTIL_GLOBAL_3G'||CHR(9)||CHR(9)||CHR(9)||XCOUNT||CHR(13)||CHR(10);
    select COUNT(*) INTO XCOUNT 
    FROM NORTHI_DATA.REPORT_CELL_ULUTIL_GLOBAL_3G
    WHERE TARIH BETWEEN TRUNC(XDATE) AND (TRUNC(XDATE)+1)-0.005/24;
    XEMAIL_TEXT:=XEMAIL_TEXT||'REPORT_CELL_ULUTIL_GLOBAL_3G'||CHR(9)||CHR(9)||CHR(9)||XCOUNT||CHR(13)||CHR(10);
    
    pRecipient:='northi@ttgint.com;canan.sahin@vodafone.com;hilal.uygur@vodafone.com;serafettin.basgoncu@vodafone.com;';
    
    NORTHI.SEND_MAIL(pRecipient,'NORTHI_3GRAN_DATA_CONTROL',XEMAIL_TEXT);
    --UTL_MAIL.SEND('pmtool@vodafone.com',pRecipient ,NULL,NULL,'NORTHI_3GRAN_DATA_CONTROL',XEMAIL_TEXT , 'text/plain; charset=us-ascii',NULL);
END;
PROCEDURE PROC_OBJECT_COUNT_DAILY(XDATA_DATE DATE) 
AS
BEGIN
    DELETE FROM NORTHI_DATA.OBJECT_COUNT_DAILY WHERE FRAGMENT_DATE=XDATA_DATE;
    COMMIT;
    INSERT /*+ append */  INTO NORTHI_DATA.OBJECT_COUNT_DAILY(FRAGMENT_DATE,RNC,NODEB,CELL) 
    SELECT A.FRAGMENT_DATE,A.NAME RNC,B.NAME NODEB,C.NAME CELL
    FROM 
    (
    --RNC
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME
        FROM NORTHI_DATA.OBJECTS_3G 
        WHERE OBJECT_CLASS_ID = 1 AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
    ) A,
    (
    --NODEB
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS_3G 
        WHERE OBJECT_CLASS_ID = 2 AND STATE=0 AND NAME NOT LIKE '%_ODB%' AND NAME!='UNKNOWN'
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
    ) B,
    (
    --CELL
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS_3G 
        WHERE OBJECT_CLASS_ID = 3  AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
    ) C;
    COMMIT;
END  PROC_OBJECT_COUNT_DAILY;
PROCEDURE PROC_OBJECT_COUNT_DAILY_SR(XDATA_DATE DATE)
AS
BEGIN
    DELETE FROM NORTHI_DATA.OBJECT_COUNT_DAILY_SR WHERE FRAGMENT_DATE=XDATA_DATE;
    COMMIT;
    INSERT /*+ append */  INTO NORTHI_DATA.OBJECT_COUNT_DAILY_SR(RGN,FRAGMENT_DATE,BSC,BTS,CELL,TRX) 
    SELECT A.RGN,A.FRAGMENT_DATE,A.NAME BSC,B.NAME BTS,C.NAME CELL,D.TRX_SAYISI TRX
    FROM 
    (
    --RNC
        SELECT REGION_NAME RGN,TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(DISTINCT BSC_NAME) NAME
        FROM NORTHI_DATA.OBJECTS A,NORTHI_DATA.OMC_BSC_BTS_CELL_LIST X
        WHERE A.NETWORK_ID=X.BSC_ID AND OBJECT_CLASS_ID = 31 AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND A.VENDOR_NAME='HUAWEI'
        GROUP BY REGION_NAME
    ) A,
    (
    --NODEB
        SELECT REGION_NAME RGN,TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(DISTINCT BTS_NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS A,NORTHI_DATA.OMC_BSC_BTS_CELL_LIST X 
        WHERE A.NETWORK_ID=X.BTS_ID AND  OBJECT_CLASS_ID = 30 AND STATE=0 AND NAME NOT LIKE '%_ODB%' AND NAME!='UNKNOWN'
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND A.VENDOR_NAME='HUAWEI'
        GROUP BY REGION_NAME
    ) B,
    (
    --CELL
        SELECT REGION_NAME RGN,TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(DISTINCT CELL_NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS A,NORTHI_DATA.OMC_BSC_BTS_CELL_LIST X
        WHERE A.NETWORK_ID=X.CELL_ID AND OBJECT_CLASS_ID = 37  AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND A.VENDOR_NAME='HUAWEI'
        GROUP BY REGION_NAME
    ) C,
    (
        SELECT 
        REGION_NAME RGN,
        SUM((B.C1278469484/8 + 
        B.C1278469486 + 
        B.C1278469487/2 + 
        B.C1278469488 +1)/8) TRX_SAYISI 
        FROM M2000.SR_CHANEL_CONF_PER_CELL B ,NORTHI_DATA.OMC_BSC_BTS_CELL_LIST X
        WHERE B.NETWORK_ID=X.CELL_ID 
        AND B.DATA_DATE =TO_DATE((TO_CHAR(XDATA_DATE,'dd.mm.yyyy')||' 07:00:00'),'dd.mm.yyyy hh24:mi:ss')
        GROUP BY REGION_NAME
    ) D
    WHERE A.RGN=B.RGN AND A.RGN=C.RGN AND A.RGN=D.RGN;
    COMMIT;
    INSERT /*+ append */  INTO NORTHI_DATA.OBJECT_COUNT_DAILY_SR(RGN,FRAGMENT_DATE,BSC,BTS,CELL,TRX) 
    SELECT 'NW' RGN, A.FRAGMENT_DATE,A.NAME BSC,B.NAME BTS,C.NAME CELL,D.TRX_SAYISI TRX
    FROM 
    (
    --RNC
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME
        FROM NORTHI_DATA.OBJECTS 
        WHERE OBJECT_CLASS_ID = 31 AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND VENDOR_NAME='HUAWEI'
    ) A,
    (
    --NODEB
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS 
        WHERE OBJECT_CLASS_ID = 30 AND STATE=0 AND NAME NOT LIKE '%_ODB%' AND NAME!='UNKNOWN'
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND VENDOR_NAME='HUAWEI'
    ) B,
    (
    --CELL
        SELECT TRUNC(XDATA_DATE) FRAGMENT_DATE,COUNT(NAME) NAME--,TRUNC(CREATED_DATE_TIME) CREATED_DATE_TIME
        FROM NORTHI_DATA.OBJECTS
        WHERE OBJECT_CLASS_ID = 37  AND STATE=0
        AND CREATED_DATE_TIME<=TRUNC(XDATA_DATE) AND NETWORK_ID!=-1
        AND VENDOR_NAME='HUAWEI'
    ) C,
    (
        SELECT 
        SUM((B.C1278469484/8 + 
        B.C1278469486 + 
        B.C1278469487/2 + 
        B.C1278469488 +1)/8) TRX_SAYISI 
        FROM NORTHI_DATA.OMC_BSC_BTS_CELL_LIST A, M2000.SR_CHANEL_CONF_PER_CELL B 
        WHERE B.NETWORK_ID = A.CELL_ID 
        AND B.DATA_DATE =TO_DATE((TO_CHAR(XDATA_DATE,'dd.mm.yyyy')||' 07:00:00'),'dd.mm.yyyy hh24:mi:ss')
    ) D;
    COMMIT;
END;
PROCEDURE CALC_POP_TRAFFIC_ATTEMPT (XDATE DATE)
AS
BEGIN
 DELETE FROM NORTHI_DATA.POPULATION_TRAFFIC_ATTEMPT WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
 COMMIT;
-- MERGE /*+ append parallel 8*/ INTO NORTHI_DATA.POPULATION_TRAFFIC_ATTEMPT A
--      USING (SELECT   D.POPULATION_NAME POPULATION_NAME, C.FRAGMENT_DATE FRAGMENT_DATE,
--                      SUM (C.DCR_VF_NUM) DCR_VF_NUM,
--                      SUM (C.TCH_NORMSEIZS) DCR_VF_CELL_DENOM,
--                      SUM (C.CSTCHB_VF_NUM) CSTCHB_VF_NUM,
--                      SUM (C.CSTCHB_VF_DENOM) CSTCHB_VF_DENOM,
--                      SUM (C.TCH_TRAFFIC) TCH_TRAFFIC,
--                      SUM (C.TCH_ATTEMPTS) TCH_ATTEMPT,
--                      SUM (C.TCH_TRAFFICHR) TCH_TRAFFIC_HR
--                 FROM NORTHI_DATA.CELLSTS C,(
--                                         SELECT DISTINCT POPULATION_NAME,N_ID  NETWORK_ID
--                                         FROM
--                                         (
--                                         SELECT POPULATION_NAME,A.NETWORK_ID N_ID
--                                         FROM
--                                         (
--                                             SELECT DISTINCT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID FROM
--                                             ( 
--                                                 SELECT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID
--                                                 FROM NORTHI_DATA.POPULATION_CELL_LIST D
--                                                 
--                                                 UNION ALL
--                                                 select POPULATION_NAME,POPULATION_ID,new_id NETWORK_ID,PCELL_ID
--                                                 from NORTHI_DATA.cell_tilda_list T,NORTHI_DATA.POPULATION_CELL_LIST D
--                                                 WHERE OLD_ID=NETWORK_ID
--                           
--                                             ) 
--                                          )A LEFT OUTER JOIN
--                                          (
--                                            SELECT NETWORK_ID,PCELL_ID
--                                            FROM NORTHI_DATA.POPULATION_CELL_LIST_OLD B
--                        
--                                          ) B
--                                          ON ( A.PCELL_ID=B.PCELL_ID )
--                                          UNION ALL
--                                          SELECT POPULATION_NAME,B.NETWORK_ID N_ID
--                                            FROM
--                                            (
--                                             SELECT DISTINCT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID FROM
--                                             ( 
--                                                 SELECT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID
--                                                 FROM NORTHI_DATA.POPULATION_CELL_LIST D
--                                                 WHERE POPULATION_ID=20415
--                                                 UNION ALL
--                                                 select POPULATION_NAME,POPULATION_ID,new_id NETWORK_ID,PCELL_ID
--                                                 from NORTHI_DATA.cell_tilda_list T,NORTHI_DATA.POPULATION_CELL_LIST D
--                                                 WHERE OLD_ID=NETWORK_ID AND  POPULATION_ID=20415
--                           
--                                             ) 
--                                            )A LEFT OUTER JOIN
--                                            ( 
--                                            SELECT NETWORK_ID,PCELL_ID
--                                            FROM NORTHI_DATA.POPULATION_CELL_LIST_OLD B
--                        
--                                            ) B
--                                            ON ( A.PCELL_ID=B.PCELL_ID )
--                                           )
--                                    
--                 ) D
--                WHERE 
--                  C.DTYPE=1 AND C.NETWORK_ID = D.NETWORK_ID
--                  AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
--             GROUP BY D.POPULATION_NAME, C.FRAGMENT_DATE
--             ORDER BY D.POPULATION_NAME) B
--      ON (A.POPULATION_ID = B.POPULATION_NAME  AND A.FRAGMENT_DATE = B.FRAGMENT_DATE)
--      WHEN NOT MATCHED THEN
--         INSERT (A.POPULATION_ID, A.FRAGMENT_DATE, A.TCH_TRAFFIC,
--                 A.TCH_ATTEMPT, A.DCR_VF_NUM, A.DCR_VF_CELL_DENOM,
--                 A.CSTCHB_VF_NUM, A.CSTCHB_VF_DENOM, A.TCH_TRAFFIC_HR)
--         VALUES (B.POPULATION_NAME, B.FRAGMENT_DATE, B.TCH_TRAFFIC,
--                 B.TCH_ATTEMPT, B.DCR_VF_NUM, B.DCR_VF_CELL_DENOM,
--                 B.CSTCHB_VF_NUM, B.CSTCHB_VF_DENOM, B.TCH_TRAFFIC_HR);

      insert /*+ append */ INTO NORTHI_DATA.POPULATION_TRAFFIC_ATTEMPT A 
          (A.POPULATION_ID, A.FRAGMENT_DATE, A.TCH_TRAFFIC, A.TCH_ATTEMPT, A.DCR_VF_NUM, A.DCR_VF_CELL_DENOM, A.CSTCHB_VF_NUM, A.CSTCHB_VF_DENOM, A.TCH_TRAFFIC_HR)
  SELECT   D.POPULATION_NAME POPULATION_NAME, C.FRAGMENT_DATE FRAGMENT_DATE,
                      SUM (C.TCH_TRAFFIC) TCH_TRAFFIC,
                      SUM (C.TCH_ATTEMPTS) TCH_ATTEMPT,
                      SUM (C.DCR_VF_NUM) DCR_VF_NUM,
                      SUM (C.DCR_NW_WITH_IRATHO_DEN) DCR_VF_CELL_DENOM,
                      SUM (C.CSTCHB_VF_NUM) CSTCHB_VF_NUM,
                      SUM (C.CSTCHB_VF_DENOM) CSTCHB_VF_DENOM,
                      SUM (C.TCH_TRAFFICHR) TCH_TRAFFIC_HR
                 FROM NORTHI_DATA.CELLSTS C,(
                                         SELECT DISTINCT POPULATION_NAME,N_ID  NETWORK_ID
                                         FROM
                                         (
                                         SELECT POPULATION_NAME,A.NETWORK_ID N_ID
                                         FROM
                                         (
                                             SELECT DISTINCT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID FROM
                                             ( 
                                                 SELECT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID
                                                 FROM NORTHI_DATA.POPULATION_CELL_LIST D
                                                 
                                                 UNION ALL
                                                 select POPULATION_NAME,POPULATION_ID,new_id NETWORK_ID,PCELL_ID
                                                 from NORTHI_DATA.cell_tilda_list T,NORTHI_DATA.POPULATION_CELL_LIST D
                                                 WHERE OLD_ID=NETWORK_ID
                           
                                             ) 
                                          )A LEFT OUTER JOIN
                                          (
                                            SELECT NETWORK_ID,PCELL_ID
                                            FROM NORTHI_DATA.POPULATION_CELL_LIST_OLD B
                        
                                          ) B
                                          ON ( A.PCELL_ID=B.PCELL_ID )
                                          UNION ALL
                                          SELECT POPULATION_NAME,B.NETWORK_ID N_ID
                                            FROM
                                            (
                                             SELECT DISTINCT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID FROM
                                             ( 
                                                 SELECT POPULATION_NAME,POPULATION_ID,NETWORK_ID,PCELL_ID
                                                 FROM NORTHI_DATA.POPULATION_CELL_LIST D
                                                 --WHERE POPULATION_ID=20415
                                                 UNION ALL
                                                 select POPULATION_NAME,POPULATION_ID,new_id NETWORK_ID,PCELL_ID
                                                 from NORTHI_DATA.cell_tilda_list T,NORTHI_DATA.POPULATION_CELL_LIST D
                                                 WHERE OLD_ID=NETWORK_ID --AND  POPULATION_ID=20415
                           
                                             ) 
                                            )A LEFT OUTER JOIN
                                            ( 
                                            SELECT NETWORK_ID,PCELL_ID
                                            FROM NORTHI_DATA.POPULATION_CELL_LIST_OLD B
                        
                                            ) B
                                            ON ( A.PCELL_ID=B.PCELL_ID )
                                           )
                                    
                 ) D
                WHERE 
                  C.DTYPE=1 AND C.NETWORK_ID = D.NETWORK_ID
                  AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
             GROUP BY D.POPULATION_NAME, C.FRAGMENT_DATE
             ORDER BY D.POPULATION_NAME;            
     commit;
END CALC_POP_TRAFFIC_ATTEMPT;
PROCEDURE CALC_ROAD_TRAFFIC_ATTEMPT (XDATE DATE)
AS
BEGIN
    DELETE FROM NORTHI_DATA.ROAD_TRAFFIC_ATTEMPT WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
    COMMIT;
    INSERT /*+ append */ INTO NORTHI_DATA.ROAD_TRAFFIC_ATTEMPT  
        (
            ROAD_TYPE,ROAD_ID, FRAGMENT_DATE, TCH_TRAFFIC,
            TCH_ATTEMPT, DCR_VF_NUM, DCR_VF_CELL_DENOM,
            CSTCHB_VF_NUM, CSTCHB_VF_DENOM, TCH_TRAFFIC_HR
        ) 
    SELECT   ROAD_TYPE,D.ROAD_NAME ROAD_NAME, C.FRAGMENT_DATE FRAGMENT_DATE,
                      SUM (C.TCH_TRAFFIC) TCH_TRAFFIC,
                      SUM (C.TCH_ATTEMPTS) TCH_ATTEMPT,
                      SUM (C.DCR_VF_NUM) DCR_VF_NUM,
                      SUM (C.TCH_NORMSEIZS) DCR_VF_CELL_DENOM,
                      SUM (C.CSTCHB_VF_NUM) CSTCHB_VF_NUM,
                      SUM (C.CSTCHB_VF_DENOM) CSTCHB_VF_DENOM,
                      SUM (C.TCH_TRAFFICHR) TCH_TRAFFIC_HR
                 FROM NORTHI_DATA.CELLSTS C,(
                 SELECT DISTINCT ROAD_TYPE,ROAD_NAME,ROAD_NAME_ID,NETWORK_ID FROM( 
                 SELECT ROAD_TYPE,ROAD_NAME,ROAD_NAME_ID,NETWORK_ID
                 FROM NORTHI_DATA.ROAD_CELL_LIST D
                 UNION ALL
                 select ROAD_TYPE,ROAD_NAME,ROAD_NAME_ID,new_id NETWORK_ID
                 from NORTHI_DATA.cell_tilda_list T,(SELECT * FROM NORTHI_DATA.ROAD_CELL_LIST WHERE FRAGMENT_DATE=TRUNC(XDATE,'MONTH')) D
                 WHERE OLD_ID=NETWORK_ID  
                 )
                 ) D
                WHERE 
                  C.NETWORK_ID = D.NETWORK_ID
                  AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
                  AND C.DTYPE=1
             GROUP BY ROAD_TYPE,D.ROAD_NAME, C.FRAGMENT_DATE;
     commit;
END CALC_ROAD_TRAFFIC_ATTEMPT;

PROCEDURE CELL_UTILPRB_4G_ULAK_1920(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.CELL_UTIL_PRB_4G_1920';

DELETE FROM NORTHI_DATA.CELL_UTIL_PRB_4G_ULAK_1920 WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24; COMMIT; 

INSERT /*+ APPEND */ INTO NORTHI_DATA.CELL_UTIL_PRB_4G_ULAK_1920 (FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BW, PM_ERAB_SESSIONTIMEQCI1, PM_DRB_PDCPSDUBITRTULVOLSUM, PM_DRB_PDCPSDUBITRTDLVOLSUM, PM_RRU_PRBTOTDLAVAILABLE, PM_RRU_PRBTOTDLUSED, PM_DRB_UETHRTOTTIMEDLQCI6, PM_DRB_UETHRTOTTIMEDLQCI7, PM_DRB_UETHRTOTTIMEDLQCI8, PM_DRB_UETHRTOTTIMEDLQCI9, PM_DRB_UETHRLASTTIMEDLQCI6, PM_DRB_UETHRLASTTIMEDLQCI7, PM_DRB_UETHRLASTTIMEDLQCI8, PM_DRB_UETHRLASTTIMEDLQCI9, PM_DRB_UETHRTOTVOLDLQCI6, PM_DRB_UETHRTOTVOLDLQCI7, PM_DRB_UETHRTOTVOLDLQCI8, PM_DRB_UETHRTOTVOLDLQCI9, PM_DRB_UETHRLASTVOLDLQCI6, PM_DRB_UETHRLASTVOLDLQCI7, PM_DRB_UETHRLASTVOLDLQCI8, PM_DRB_UETHRLASTVOLDLQCI9,KPI_C_820)

WITH DATASET AS
(
SELECT TRUNC(FRAGMENT_DATE) FRAGMENT_DATE, NETWORK_ID, FBAND_ID, SUM(KPI_C_820) KPI_C_820
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND_ID, CASE WHEN ROUND((SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9 -PM_DRB_UeThrLastTimeDlQCI6-PM_DRB_UeThrLastTimeDlQCI7-PM_DRB_UeThrLastTimeDlQCI8-PM_DRB_UeThrLastTimeDlQCI9)/(3600*1000))/(((5*BW)-0.15*SUM(PM_ERAB_SessionTimeQCI1/3600)-10)/10),2) > 1 AND ROUND(SUM(PM_RRU_PrbTotDlUsed)/SUM(PM_RRU_PrbTotDlAvailable-(3600*1000*10))*100,2) > 100 AND ROUND(((SUM(PM_DRB_UeThrTotVolDlQCI6+PM_DRB_UeThrTotVolDlQCI7+PM_DRB_UeThrTotVolDlQCI8+PM_DRB_UeThrTotVolDlQCI9) - SUM(PM_DRB_UeThrLastVolDlQCI6+PM_DRB_UeThrLastVolDlQCI7+PM_DRB_UeThrLastVolDlQCI8+PM_DRB_UeThrLastVolDlQCI9))/1000)/(SUM(PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9) - SUM(PM_DRB_UeThrLastTimeDlQCI6+PM_DRB_UeThrLastTimeDlQCI7+PM_DRB_UeThrLastTimeDlQCI8+PM_DRB_UeThrLastTimeDlQCI9)),2) < 3 THEN 1 ELSE 0 END  KPI_C_820
FROM NORTHI_DATA.CELL_UTILPRB_4G_ULAK_1920_H
WHERE FRAGMENT_DATE BETWEEN  XDATE+8/24 AND XDATE+20/24
GROUP BY FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BW
) GROUP BY TRUNC(FRAGMENT_DATE), NETWORK_ID, FBAND_ID
)

SELECT A.*,B.KPI_C_820
FROM
(
SELECT 
FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BW, PM_ERAB_SessionTimeQCI1, PM_DRB_PdcpSduBitRtUlVolSum, PM_DRB_PdcpSduBitRtDlVolSum, PM_RRU_PrbTotDlAvailable, PM_RRU_PrbTotDlUsed, PM_DRB_UeThrTotTimeDlQCI6, 
PM_DRB_UeThrTotTimeDlQCI7, PM_DRB_UeThrTotTimeDlQCI8, PM_DRB_UeThrTotTimeDlQCI9, PM_DRB_UeThrLastTimeDlQCI6, PM_DRB_UeThrLastTimeDlQCI7, PM_DRB_UeThrLastTimeDlQCI8, PM_DRB_UeThrLastTimeDlQCI9, 
PM_DRB_UeThrTotVolDlQCI6, PM_DRB_UeThrTotVolDlQCI7, PM_DRB_UeThrTotVolDlQCI8, PM_DRB_UeThrTotVolDlQCI9, PM_DRB_UeThrLastVolDlQCI6, PM_DRB_UeThrLastVolDlQCI7, PM_DRB_UeThrLastVolDlQCI8, PM_DRB_UeThrLastVolDlQCI9
FROM
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BAND_WIDTH BW, PM_ERAB_SessionTimeQCI1, PM_DRB_PdcpSduBitRtUlVolSum, PM_DRB_PdcpSduBitRtDlVolSum, PM_RRU_PrbTotDlAvailable, PM_RRU_PrbTotDlUsed, PM_DRB_UeThrTotTimeDlQCI6, 
PM_DRB_UeThrTotTimeDlQCI7, PM_DRB_UeThrTotTimeDlQCI8, PM_DRB_UeThrTotTimeDlQCI9, PM_DRB_UeThrLastTimeDlQCI6, PM_DRB_UeThrLastTimeDlQCI7, PM_DRB_UeThrLastTimeDlQCI8, PM_DRB_UeThrLastTimeDlQCI9, 
PM_DRB_UeThrTotVolDlQCI6, PM_DRB_UeThrTotVolDlQCI7, PM_DRB_UeThrTotVolDlQCI8, PM_DRB_UeThrTotVolDlQCI9, PM_DRB_UeThrLastVolDlQCI6, PM_DRB_UeThrLastVolDlQCI7, PM_DRB_UeThrLastVolDlQCI8, PM_DRB_UeThrLastVolDlQCI9,
row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY (PM_DRB_UeThrTotTimeDlQCI6+PM_DRB_UeThrTotTimeDlQCI7+PM_DRB_UeThrTotTimeDlQCI8+PM_DRB_UeThrTotTimeDlQCI9 -PM_DRB_UeThrLastTimeDlQCI6-PM_DRB_UeThrLastTimeDlQCI7-PM_DRB_UeThrLastTimeDlQCI8-PM_DRB_UeThrLastTimeDlQCI9)/(3600*1000) DESC, FRAGMENT_DATE DESC)  RN
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, 
SUM(VOLTE_TRAFFIC_NUM) PM_ERAB_SessionTimeQCI1,
SUM(UL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtUlVolSum,
SUM(DL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtDlVolSum,
SUM(PM_RRU_PRBTOTDLAVAILABLE) PM_RRU_PrbTotDlAvailable,
SUM(PM_RRU_PrbTotDlUsed) PM_RRU_PrbTotDlUsed,
SUM(PM_DRB_UeThrTotTimeDlQCI6) PM_DRB_UeThrTotTimeDlQCI6,
SUM(PM_DRB_UeThrTotTimeDlQCI7) PM_DRB_UeThrTotTimeDlQCI7,
SUM(PM_DRB_UeThrTotTimeDlQCI8) PM_DRB_UeThrTotTimeDlQCI8,
SUM(PM_DRB_UeThrTotTimeDlQCI9) PM_DRB_UeThrTotTimeDlQCI9,
SUM(PM_DRB_UeThrLastTimeDlQCI6) PM_DRB_UeThrLastTimeDlQCI6,
SUM(PM_DRB_UeThrLastTimeDlQCI7) PM_DRB_UeThrLastTimeDlQCI7,
SUM(PM_DRB_UeThrLastTimeDlQCI8) PM_DRB_UeThrLastTimeDlQCI8,
SUM(PM_DRB_UeThrLastTimeDlQCI9) PM_DRB_UeThrLastTimeDlQCI9,
SUM(PM_DRB_UeThrTotVolDlQCI6) PM_DRB_UeThrTotVolDlQCI6,
SUM(PM_DRB_UeThrTotVolDlQCI7) PM_DRB_UeThrTotVolDlQCI7,
SUM(PM_DRB_UeThrTotVolDlQCI8) PM_DRB_UeThrTotVolDlQCI8,
SUM(PM_DRB_UeThrTotVolDlQCI9) PM_DRB_UeThrTotVolDlQCI9,
SUM(PM_DRB_UeThrLastVolDlQCI6) PM_DRB_UeThrLastVolDlQCI6,
SUM(PM_DRB_UeThrLastVolDlQCI7) PM_DRB_UeThrLastVolDlQCI7,
SUM(PM_DRB_UeThrLastVolDlQCI8) PM_DRB_UeThrLastVolDlQCI8,
SUM(PM_DRB_UeThrLastVolDlQCI9) PM_DRB_UeThrLastVolDlQCI9
FROM NORTHI_DATA.ULAK_4G 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24 
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
) A, NORTHI_DATA.LIST_ULAK_ENODEB_CELL X, NORTHI_PARSER.OBJECTS_ULAK4G_DAILY Y
WHERE A.NETWORK_ID=X.CELL_ID AND A.NETWORK_ID = Y.NE_ID AND TRUNC(A.FRAGMENT_DATE) = Y.DATA_DATE
)
WHERE RN = 1)A, DATASET B
WHERE A.NETWORK_ID = B.NETWORK_ID AND TRUNC(A.FRAGMENT_DATE) = TRUNC(B.FRAGMENT_DATE);

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTILPRB_4G_ULAK_1920',XSTATE );
       commit;                   
       
     
       raise;
    
END;

 PROCEDURE KKTC_CELL_UTIL_3G_FY1819 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819';

DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24;
   
 COMMIT;



INSERT /*+ APPEND */ INTO  NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819 
(NETWORK_ID, FRAGMENT_DATE, CELL_UTIL, DL_UTIL, CODE_UTIL, VS_HSDPA_UE_MEAN_CELL, VS_HSDPA_MEANCH_THRO, TRAF_HSDPA, VS_AMR_ERLANG_BEST_CELL, VSHSUPAUEMEANCELL, TRAF_HSUPA, VQI_UL_BAD_PER_NUM,VQI_UL_BAD_PER_DEN,PS_UL_DATA,PS_DL_DATA)

WITH DS_CMEX AS
(
SELECT /*+ PARALLEL(4) */ CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT /*+ PARALLEL(4) */  CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
) ,

DS_LCELL AS
(
SELECT /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(NVL(VSDLCODEUSEDMEAN,0)) VS_DL_CODE_USED_MEAN
FROM NORTHI_DATA.KKTC_LCELLSTS_3G
WHERE DTYPE=1 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID, FRAGMENT_DATE
), 

DS_CELL AS
(
SELECT  /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_MEAN_TCP) VS_MEAN_TCP,
SUM(VS_HSDPA_UE_MEAN_CELL) VS_HSDPA_UE_MEAN_CELL,
SUM(VS_HSDPA_MEANCH_THRO) VS_HSDPA_MEANCH_THRO,
SUM(TRAF_HSDPA) TRAF_HSDPA,
SUM(VS_AMR_ERLANG_BEST_CELL) VS_AMR_ERLANG_BEST_CELL,
SUM(VSHSUPAUEMeanCell) VSHSUPAUEMeanCell,
SUM(TRAF_HSUPA) TRAF_HSUPA,
SUM(VQI_UL_BAD_PER_NUM) VQI_UL_BAD_PER_NUM,
SUM(VQI_UL_BAD_PER_DEN) VQI_UL_BAD_PER_DEN,
SUM(PS_UL_DATA) PS_UL_DATA,
SUM(PS_DL_DATA) PS_DL_DATA
FROM NORTHI_DATA.KKTC_CELLSTS_3G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24 AND  VS_MEAN_TCP>0
GROUP BY  NETWORK_ID, FRAGMENT_DATE
)

SELECT  /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
    GREATEST(DL_UTIL ,CODE_UTIL) CELL_UTIL,
    DL_UTIL ,CODE_UTIL, 
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
    FROM 
  (
SELECT  /*+ PARALLEL(4) */
    C.NETWORK_ID,C.FRAGMENT_DATE ,cell_name cell,
    ROW_NUMBER() OVER (PARTITION BY CELL_NAME ORDER BY VS_HSDPA_UE_MEAN_CELL DESC, VS_AMR_ERLANG_BEST_CELL DESC) RN,
    (POWER(10,(VS_MEAN_TCP)/10))*100/(0.7*POWER(10,(MAXTXPOWER)/100)) DL_UTIL,
    NVL(VS_DL_CODE_USED_MEAN,0)/(0.7*256)*100 CODE_UTIL,
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL/2 VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
FROM DS_CMEX A, DS_LCELL B, DS_CELL C , NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE  A.CELLNAME=X.CELL_NAME AND B.NETWORK_ID=C.NETWORK_ID AND 
B.NETWORK_ID=X.CELL_ID AND B.FRAGMENT_DATE=C.FRAGMENT_DATE AND 
C.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
) WHERE RN=1 ;

 COMMIT;
 
 
   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'KKTC_CELL_UTIL_3G_FY1819',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;   
                
PROCEDURE KKTC_CELL_UTIL_3G_FY1819_100 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819_100';

DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819_100 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24; 
COMMIT;

INSERT /*+ APPEND */ INTO  NORTHI_DATA.KKTC_CELL_UTIL_3G_FY1819_100 (NETWORK_ID, FRAGMENT_DATE, VS_HSDPA_UE_MEAN_CELL, CELL_UTIL, VS_HSDPA_MEANCH_THRO)

WITH DS_CMEX AS
(
SELECT /*+ PARALLEL(4) */ CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6900UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
UNION
SELECT /*+ PARALLEL(4) */ CELLNAME, MAX(MAXTXPOWER) MAXTXPOWER FROM NORTHI_CMEX.H3G_UCELL_BSC6910UMTS WHERE DATA_DATE BETWEEN TRUNC(SYSDATE)-30 AND TRUNC(SYSDATE) GROUP BY CELLNAME
) ,

DS_LCELL AS
(
SELECT /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(NVL(VSDLCODEUSEDMEAN,0)) VS_DL_CODE_USED_MEAN
FROM NORTHI_DATA.KKTC_LCELLSTS_3G
WHERE DTYPE=1 AND  FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
GROUP BY NETWORK_ID, FRAGMENT_DATE
), 

DS_CELL AS
(
SELECT /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
SUM(VS_MEAN_TCP) VS_MEAN_TCP,
SUM(VS_HSDPA_UE_MEAN_CELL) VS_HSDPA_UE_MEAN_CELL,
SUM(VS_HSDPA_MEANCH_THRO) VS_HSDPA_MEANCH_THRO,
SUM(TRAF_HSDPA) TRAF_HSDPA,
SUM(VS_AMR_ERLANG_BEST_CELL) VS_AMR_ERLANG_BEST_CELL,
SUM(VSHSUPAUEMeanCell) VSHSUPAUEMeanCell,
SUM(TRAF_HSUPA) TRAF_HSUPA,
SUM(VQI_UL_BAD_PER_NUM) VQI_UL_BAD_PER_NUM,
SUM(VQI_UL_BAD_PER_DEN) VQI_UL_BAD_PER_DEN,
SUM(PS_UL_DATA) PS_UL_DATA,
SUM(PS_DL_DATA) PS_DL_DATA
FROM NORTHI_DATA.KKTC_CELLSTS_3G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24 AND VS_MEAN_TCP>0
GROUP BY  NETWORK_ID, FRAGMENT_DATE
)

SELECT NETWORK_ID, FRAGMENT_DATE, VS_HSDPA_UE_MEAN_CELL, CELL_UTIL, VS_HSDPA_MEANCH_THRO
FROM 
(
SELECT  /*+ PARALLEL(4) */  NETWORK_ID, FRAGMENT_DATE,
    GREATEST(DL_UTIL ,CODE_UTIL) CELL_UTIL,
    DL_UTIL ,CODE_UTIL, 
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
    FROM 
(
SELECT  /*+ PARALLEL(4) */
    C.NETWORK_ID,C.FRAGMENT_DATE ,cell_name cell,
    (POWER(10,(VS_MEAN_TCP)/10))*100/(0.7*POWER(10,(MAXTXPOWER)/100)) DL_UTIL,
    VS_DL_CODE_USED_MEAN/(0.7*256)*100 CODE_UTIL,
    VS_HSDPA_UE_MEAN_CELL,
    VS_HSDPA_MEANCH_THRO VS_HSDPA_MEANCH_THRO,
    TRAF_HSDPA,
    VS_AMR_ERLANG_BEST_CELL/2 VS_AMR_ERLANG_BEST_CELL,
    VSHSUPAUEMeanCell,
    TRAF_HSUPA,
    VQI_UL_BAD_PER_NUM,
    VQI_UL_BAD_PER_DEN,
    PS_UL_DATA,
    PS_DL_DATA
FROM DS_CMEX A, DS_LCELL B, DS_CELL C , NORTHI_DATA.LIST_RNC_NODEB_CELL X
WHERE  A.CELLNAME=X.CELL_NAME AND B.NETWORK_ID=C.NETWORK_ID AND 
B.NETWORK_ID=X.CELL_ID AND B.FRAGMENT_DATE=C.FRAGMENT_DATE AND 
C.FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
)
)
WHERE CASE WHEN VS_HSDPA_UE_MEAN_CELL>0 THEN  (CASE WHEN (CELL_UTIL)>100 AND VS_HSDPA_UE_MEAN_CELL>10 AND (VS_HSDPA_MEANCH_THRO/1000)<1 THEN 1 ELSE 0 END ) WHEN VS_HSDPA_UE_MEAN_CELL<=0 THEN (CASE WHEN (CELL_UTIL)>100 THEN 1 ELSE 0 END) ELSE 0 END > 0;

COMMIT;
 
 
   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'KKTC_CELL_UTIL_3G_FY1819_100',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;             

PROCEDURE REPORT_CELL_UTILPRB_4G_1920_H (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

  -- EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920_H'; COMMIT;
  
   DELETE /*+ PARALLEL(16) */ FROM  NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920_H
            WHERE ( FRAGMENT_dATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24)  or FRAGMENT_DATE < TRUNC(SYSDATE-15); 
   commit; 
 
 
INSERT INTO NORTHI_DATA.REPORT_CELL_UTIL_PRB_4G_1920_H (FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL, KPI160_EXT1, KPI160_EXT2, KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME, LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED,NR_NON_GBR_ACT_DATA_USERS_DL,KPI160UAI,KPI160UAJ,KPI160UE,KPI160UF,KPI160UG,KPI160UK,KPI160_uc,KPI160_ud)
 
WITH DATASET AS
(
SELECT /*+ PARALLEL(16) */NETWORK_ID, FRAGMENT_DATE, FBAND_ID, DL_CHMEAS_PRB,KPI160uc, L_CHMEAS_PRB_DL_AVAIL, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_FWA, USER_DL_RMVLAST_TTI_TRAFF_VOL, L_THRP_TIME_DL_RMVLAST_TTI, DL_NONGBR_USER_THR_NUM_FWA, DL_NONGBR_USER_THR_DEN_FWA, DL_TRAFFIC_VOL, L_THRP_TIME_CELL_DL_HIGH_PREC, AVG_DL_CELL_THR_NUM, L_Thrp_bits_DL_CAUser, L_THRP_BITS_DL_LAST_TTI, L_Thrp_bits_DL_LastTTI_CAUser, Thrp_Time_DL_RmvLastTTI_User, L_Traffic_DL_MAC_TRFF, AVG_CQI_256QM_NUM_FWA, AVG_CQI_256QM_DEN_FWA, L_ChMeas_PDSCH_MCS_NUM, L_ChMeas_PDSCH_MCS_DEN, L_ChMeas_RI_Rank1, L_ChMeas_RI_Rank2, L_ChMeas_RI_Rank3, L_ChMeas_RI_Rank4, VOLTE_TRAFFIC, VOLTE_DATA_VOLUME, TRAFFIC_VOLUME_QCI_8, L_THRP_BITS_DL_QCI_6789, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA_NUM, DL_USER_THRPUT_FWA_DEN, DL_DATA_VOLUME_FWA, CHMEAS_PRB_DL_PCELL_USED_AVG, CHMEAS_PRB_DL_SCELL_USED_AVG, DL_FIRST_PACKET_DELAY_NUM, DL_FIRST_PACKET_DELAY_DEN, DL_FIRST_PACKET_DELAY_MOB_NUM, DL_FIRST_PACKET_DELAY_MOB_DEN, DL_FIRST_PACKET_DELAY_FWA_NUM, DL_FIRST_PACKET_DELAY_FWA_DEN, DL_NONGBR_USER_EXPERIENCE_NUM, DL_NONGBR_USER_EXPERIENCE_DEN, AVERAGE_CQI_NON256QAM_NUM, AVERAGE_CQI_NON256QAM_DEN, EXT_PRB_NUM, EXT_PRB_DEN, DL_NONGBR_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_NUM, AVG_RRC_CONNECTED_USER, KPI160_EXT1, KPI160_EXT2_NUM, KPI160_EXT3, L_THRP_BITS_DL_QCI, THRP_BITS_DEXTQCI_INDEX0, THRP_BITS_DEXTQCI_INDEX1, THRP_BITS_DEXTQCI_INDEX2, DL_TRAFF_QCI_133_MB_NUM, L_THRP_BITS_DL_EXTQCI_INDEX5, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT_NUM, LTE_HU_DATA_VOLUME_NUM, LTE_NRML_HU_USER_THRPUT_NUM, LTE_NRML_HU_USER_THRPUT_DEN, CAT_M_PRB_USED_DL, 0 DL_RSOURCE_BLOCK_UTIL_RATE_NUM, 0 USER_DL_AVG_TPUT_DEN, UL_CHMEAS_PRB, L_CHMEAS_PRB_PUSH_AVG, UL_TRAFFIC_VOL, L_THRP_TIME_CELL_UL_HIGH_PREC, MAC_LAYER_DATA_VOLUME,KPI160ud_PAYDA,KPI160ud_PAY,KPI160uc
L_THRP_BITS_DL_QCI6,L_THRP_DL_LASTTTI_QCI6,DLTRAFFICVOLUME_QCI_7,THRP_BITS_DL_LASTTTI_QCI_7,DLTRAFFICVOLUME_QCI_8,THRP_BITS_DL_LASTTTI_QCI_8,L_THRP_BITS_DL_QCI9,THRP_BITS_DL_LASTTTI_QCI_9,THRP_BITSDL_LASTI_FLEXQCI_I4,DL_USER_TPUT_MBPS_QCI_7_PAYDA,DL_USER_THROUGHPUT_QCI_8_DEN ,THRP_TIMEDL_RMVLASTI_QCI_9,THRP_TIME_DL_RMVLAST_TTI_QCI6
FROM NORTHI_DATA.CELLSTS_4G_TMP
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24 AND L_CHMEAS_PRB_DL_AVAIL!=0

--UNION ALL
--
--SELECT /*+ PARALLEL(16) */ NETWORK_ID, FRAGMENT_DATE, -99 FBAND_ID, 0 DL_CHMEAS_PRB, 0 L_CHMEAS_PRB_DL_AVAIL, 0 DL_ACTIVE_USERS, 0 DL_NONGBR_ACTIVE_USERS_FWA, 0 USER_DL_RMVLAST_TTI_TRAFF_VOL, 0 L_THRP_TIME_DL_RMVLAST_TTI, 0 DL_NONGBR_USER_THR_NUM_FWA, 0 DL_NONGBR_USER_THR_DEN_FWA, 0 DL_TRAFFIC_VOL, 0 L_THRP_TIME_CELL_DL_HIGH_PREC, 0 AVG_DL_CELL_THR_NUM, 0 L_Thrp_bits_DL_CAUser, 0 L_THRP_BITS_DL_LAST_TTI, 0 L_Thrp_bits_DL_LastTTI_CAUser, 0 Thrp_Time_DL_RmvLastTTI_User, 0 L_Traffic_DL_MAC_TRFF, 0 AVG_CQI_256QM_NUM_FWA, 0 AVG_CQI_256QM_DEN_FWA, 0 L_ChMeas_PDSCH_MCS_NUM, 0 L_ChMeas_PDSCH_MCS_DEN, 0 L_ChMeas_RI_Rank1, 0 L_ChMeas_RI_Rank2, 0 L_ChMeas_RI_Rank3, 0 L_ChMeas_RI_Rank4, 0 VOLTE_TRAFFIC, 0 VOLTE_DATA_VOLUME, 0 TRAFFIC_VOLUME_QCI_8, 0 L_THRP_BITS_DL_QCI_6789, 0 DL_ACTIVE_USERS_FWA, 0 DL_USER_THRPUT_FWA_NUM, 0 DL_USER_THRPUT_FWA_DEN, 0 DL_DATA_VOLUME_FWA, 0 CHMEAS_PRB_DL_PCELL_USED_AVG, 0 CHMEAS_PRB_DL_SCELL_USED_AVG, 0 DL_FIRST_PACKET_DELAY_NUM, 0 DL_FIRST_PACKET_DELAY_DEN, 0 DL_FIRST_PACKET_DELAY_MOB_NUM, 0 DL_FIRST_PACKET_DELAY_MOB_DEN, 0 DL_FIRST_PACKET_DELAY_FWA_NUM, 0 DL_FIRST_PACKET_DELAY_FWA_DEN, 0 DL_NONGBR_USER_EXPERIENCE_NUM, 0 DL_NONGBR_USER_EXPERIENCE_DEN, 0 AVERAGE_CQI_NON256QAM_NUM, 0 AVERAGE_CQI_NON256QAM_DEN, 0 EXT_PRB_NUM, 0 EXT_PRB_DEN, 0 DL_NONGBR_ACTIVE_USERS, 0 DL_NONGBR_ACTIVE_USERS_NUM, 0 AVG_RRC_CONNECTED_USER, 0 KPI160_EXT1, 0 KPI160_EXT2_NUM, 0 KPI160_EXT3, 0 L_THRP_BITS_DL_QCI, 0 THRP_BITS_DEXTQCI_INDEX0, 0 THRP_BITS_DEXTQCI_INDEX1, 0 THRP_BITS_DEXTQCI_INDEX2, 0 DL_TRAFF_QCI_133_MB_NUM, 0 L_THRP_BITS_DL_EXTQCI_INDEX5, 0 LTE_HU_ACTIVE_USERS, 0 LTE_HU_USER_THRPUT_NUM, 0 LTE_HU_DATA_VOLUME_NUM, 0 LTE_NRML_HU_USER_THRPUT_NUM, 0 LTE_NRML_HU_USER_THRPUT_DEN, 0 CAT_M_PRB_USED_DL, DL_RSOURCE_BLOCK_UTIL_RATE_NUM, USER_DL_AVG_TPUT_DEN
--FROM NORTHI_DATA.GNB_STATISTICS
--WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24
)

SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT,CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME,MAC_DL_DATA_VOLUME, AVG_CQI,AVG_MCS,AVG_RANK_INDICATION,VOLTE_SESSION_TIME,VOLTE_DATA_VOLUME,  
       A.FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB,L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB,
       DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS,
       DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL, KPI160UAI, KPI160UAJ, KPI160UE, KPI160UF, KPI160UG, KPI160UK,KPI160uc,KPI160ud
FROM
(SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS, 
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,4) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),4) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)/1000,2) DL_CELL_ACTIVITY_TIME,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),0,0,(SUM(AVG_DL_CELL_THR_NUM)/1000)/SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)),2) DL_CELL_THROUGHPUT,
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User),0,0,((SUM(AVG_DL_CELL_THR_NUM-L_Thrp_bits_DL_CAUser)-SUM(L_THRP_BITS_DL_LAST_TTI-L_Thrp_bits_DL_LastTTI_CAUser))/1000)/SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User)),2) NONCA_DL_USER_THROUGHPUT,
                         CASE 
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) = 0 THEN NULL
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) <> 0 THEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2)
                         END  CA_DL_USER_THROUGHPUT,
                         CASE
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) = 0 THEN NULL
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) <> 0 THEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2)
                         END CA_DL_DATA_VOLUME,
                         ROUND(SUM(L_Traffic_DL_MAC_TRFF)/(8*POWER(10,6)),2) MAC_DL_DATA_VOLUME,
                         ROUND(DECODE(SUM(AVG_CQI_256QM_DEN_FWA),0,0,SUM(AVG_CQI_256QM_NUM_FWA)/SUM(AVG_CQI_256QM_DEN_FWA)),2) AVG_CQI, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_ChMeas_PDSCH_MCS_DEN),0,0,SUM(L_ChMeas_PDSCH_MCS_NUM)/SUM(L_ChMeas_PDSCH_MCS_DEN)),2) AVG_MCS,
                         ROUND(DECODE(SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4),0,0,SUM(L_ChMeas_RI_Rank1+(2*L_ChMeas_RI_Rank2)+(3*L_ChMeas_RI_Rank3)+(4*L_ChMeas_RI_Rank4))/SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4)),2) AVG_RANK_INDICATION,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(SUM(VOLTE_DATA_VOLUME)/(8*POWER(10,6)),2) VOLTE_DATA_VOLUME,
                         ROUND(SUM(TRAFFIC_VOLUME_QCI_8)/8/1024/1024,2) TRAFFIC_VOLUME_QCI_8_MB,
                         ROUND(SUM(L_THRP_BITS_DL_QCI_6789)/8/1024/1024,2) L_THRP_BITS_DL_QCI_6789_MB,
                         ROUND(SUM(DL_ACTIVE_USERS_FWA)/3600000,4) DL_ACTIVE_USERS_FWA, 
                         ROUND(DECODE(SUM(DL_USER_THRPUT_FWA_DEN),0,0,(SUM(DL_USER_THRPUT_FWA_NUM)/1000)/SUM(DL_USER_THRPUT_FWA_DEN)),2) DL_USER_THRPUT_FWA, 
                         ROUND(SUM(DL_DATA_VOLUME_FWA)/8000000,2) DL_DATA_VOLUME_FWA, 
                         ROUND(SUM(Thrp_Time_DL_RmvLastTTI_User)/3600000,2) DL_CA_ACTIVE_USERS, 
                         ROUND(SUM(CHMEAS_PRB_DL_PCELL_USED_AVG),2) DL_PCELL_USED_PRB, 
                         ROUND(SUM(CHMEAS_PRB_DL_SCELL_USED_AVG),2) DL_SCELL_USED_PRB, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_NUM)/SUM(DL_FIRST_PACKET_DELAY_DEN)),2) DL_FIRST_PACKET_DELAY, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_FIRST_PACKET_DELAY_MOBILE, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FIRST_PACKET_DELAY_FWA, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_EXPERIENCE_DEN),0,0,(SUM(DL_NONGBR_USER_EXPERIENCE_NUM)/1000)/SUM(DL_NONGBR_USER_EXPERIENCE_DEN)),2) DL_NONGBR_USER_EXPERIENCE, 
                         ROUND(DECODE(SUM(AVERAGE_CQI_NON256QAM_DEN),0,0,SUM(AVERAGE_CQI_NON256QAM_NUM)/SUM(AVERAGE_CQI_NON256QAM_DEN)),2) AVERAGE_CQI_NON256QAM, 
                         ROUND(DECODE(SUM(EXT_PRB_DEN),0,0,SUM(EXT_PRB_NUM)*100/SUM(EXT_PRB_DEN)),2) EXT_PRB, 
                         ROUND(DECODE(SUM(DL_NONGBR_ACTIVE_USERS),0,0,(SUM(DL_NONGBR_ACTIVE_USERS_NUM)/1000)/SUM(DL_NONGBR_ACTIVE_USERS)),4) DL_NONGBR_NORM_USER_THRPUT, 
                         ROUND(SUM(AVG_RRC_CONNECTED_USER),2) RRC_CONNECTED_USERS,
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_NORM_USER_FIRST_PAC_DEL, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FWA_USER_PAC_DEL, 
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_EXT1,
                         ROUND(DECODE(SUM(KPI160_EXT1),0,0,(SUM(KPI160_EXT2_NUM)/1000)/SUM(KPI160_EXT1)),2) KPI160_EXT2,
                         ROUND(SUM(KPI160_EXT3)/8000000,2) KPI160_EXT3,
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_HU_C,
                         ROUND(DECODE(SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA),0,0,SUM(DL_TRAFFIC_VOL-L_THRP_BITS_DL_QCI-(THRP_BITS_DEXTQCI_INDEX0+THRP_BITS_DEXTQCI_INDEX1+THRP_BITS_DEXTQCI_INDEX2+DL_TRAFF_QCI_133_MB_NUM))/SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA)/1000),2) KPI160_HU_D,
                         ROUND(SUM(L_THRP_BITS_DL_EXTQCI_INDEX5)/8000000,2) KPI160_HU_E,
                         ROUND(SUM(LTE_HU_ACTIVE_USERS) / 3600000,2) LTE_HU_ACTIVE_USERS,
                         ROUND(DECODE(SUM(LTE_HU_ACTIVE_USERS),0,0,SUM(LTE_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_HU_ACTIVE_USERS)),2) LTE_HU_USER_THRPUT,
                         ROUND(SUM(LTE_HU_DATA_VOLUME_NUM) / 8000000,2)  LTE_HU_DATA_VOLUME,
                         DECODE(SUM(THRP_TIME_DL_RMVLAST_TTI_QCI6+ DL_USER_TPUT_MBPS_QCI_7_PAYDA + DL_USER_THROUGHPUT_QCI_8_DEN + THRP_TIMEDL_RMVLASTI_QCI_9 + LTE_HU_ACTIVE_USERS),0,0,(SUM(L_THRP_BITS_DL_QCI6 - L_THRP_DL_LASTTTI_QCI6) + SUM(DLTRAFFICVOLUME_QCI_7 - THRP_BITS_DL_LASTTTI_QCI_7) + SUM(DLTRAFFICVOLUME_QCI_8 - THRP_BITS_DL_LASTTTI_QCI_8) + SUM(L_THRP_BITS_DL_QCI9 - THRP_BITS_DL_LASTTTI_QCI_9) + SUM(LTE_HU_DATA_VOLUME_NUM - THRP_BITSDL_LASTI_FLEXQCI_I4))/ 1000/SUM(THRP_TIME_DL_RMVLAST_TTI_QCI6+ DL_USER_TPUT_MBPS_QCI_7_PAYDA + DL_USER_THROUGHPUT_QCI_8_DEN + THRP_TIMEDL_RMVLASTI_QCI_9 + LTE_HU_ACTIVE_USERS)) LTE_NRML_HU_USER_THRPUT,
                         ROUND(SUM(CAT_M_PRB_USED_DL),2) CAT_M_PRB_USED_DL,
                         ROUND(SUM(DL_RSOURCE_BLOCK_UTIL_RATE_NUM),2) NR_PRB_USED, 
                         ROUND(SUM(USER_DL_AVG_TPUT_DEN),2) NR_NON_GBR_ACT_DATA_USERS_DL,
                         
                         ROUND(SUM(UL_CHMEAS_PRB),2) KPI160UAI,   
                         ROUND(SUM(L_CHMEAS_PRB_PUSH_AVG),2) KPI160UAJ, 
                         ROUND(SUM(UL_TRAFFIC_VOL) / 8000000,2) KPI160UE,
                         ROUND(SUM(L_THRP_TIME_CELL_UL_HIGH_PREC) / 1000,2) KPI160UF,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_UL_HIGH_PREC), 0 , 0 , (SUM(UL_TRAFFIC_VOL) / 1000) / SUM(L_THRP_TIME_CELL_UL_HIGH_PREC)),2) KPI160UG,
                         ROUND(SUM(MAC_LAYER_DATA_VOLUME) / 8000000,2) KPI160UK,
                         ROUND(SUM(KPI160uc)/3600000,2) KPI160uc,
                         ROUND(DECODE(SUM(KPI160ud_PAYDA),0,0,(SUM(KPI160ud_PAY)/SUM(KPI160ud_PAYDA))/1000),2) KPI160ud
FROM DATASET
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID = B.FBAND_ID;
-- ORDER BY 1; -- Order by yapmaya gerek yok

   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'REPORT_CELL_UTILPRB_4G_1920_H',XSTATE );
                           commit;                   
                          
                           raise;
                                    
   END;   
PROCEDURE CELL_UTILPRB_4G_ULAK_1920_H (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

  -- EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.CELL_UTILPRB_4G_ULAK_1920_H'; COMMIT;
   
      DELETE /*+ PARALLEL(16) */ FROM  NORTHI_DATA.CELL_UTILPRB_4G_ULAK_1920_H
            WHERE ( FRAGMENT_dATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24)  or FRAGMENT_DATE < TRUNC(SYSDATE-15); 
   commit; 

INSERT /*+ APPEND */ INTO NORTHI_DATA.CELL_UTILPRB_4G_ULAK_1920_H (FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BW, PM_ERAB_SESSIONTIMEQCI1, PM_DRB_PDCPSDUBITRTULVOLSUM, PM_DRB_PDCPSDUBITRTDLVOLSUM, PM_RRU_PRBTOTDLAVAILABLE, PM_RRU_PRBTOTDLUSED, PM_DRB_UETHRTOTTIMEDLQCI6, PM_DRB_UETHRTOTTIMEDLQCI7, PM_DRB_UETHRTOTTIMEDLQCI8, PM_DRB_UETHRTOTTIMEDLQCI9, PM_DRB_UETHRLASTTIMEDLQCI6, PM_DRB_UETHRLASTTIMEDLQCI7, PM_DRB_UETHRLASTTIMEDLQCI8, PM_DRB_UETHRLASTTIMEDLQCI9, PM_DRB_UETHRTOTVOLDLQCI6, PM_DRB_UETHRTOTVOLDLQCI7, PM_DRB_UETHRTOTVOLDLQCI8, PM_DRB_UETHRTOTVOLDLQCI9, PM_DRB_UETHRLASTVOLDLQCI6, PM_DRB_UETHRLASTVOLDLQCI7, PM_DRB_UETHRLASTVOLDLQCI8, PM_DRB_UETHRLASTVOLDLQCI9)


SELECT FRAGMENT_DATE, NETWORK_ID, FBAND_ID, BAND_WIDTH BW, PM_ERAB_SessionTimeQCI1, PM_DRB_PdcpSduBitRtUlVolSum, PM_DRB_PdcpSduBitRtDlVolSum, PM_RRU_PrbTotDlAvailable, PM_RRU_PrbTotDlUsed, PM_DRB_UeThrTotTimeDlQCI6, 
PM_DRB_UeThrTotTimeDlQCI7, PM_DRB_UeThrTotTimeDlQCI8, PM_DRB_UeThrTotTimeDlQCI9, PM_DRB_UeThrLastTimeDlQCI6, PM_DRB_UeThrLastTimeDlQCI7, PM_DRB_UeThrLastTimeDlQCI8, PM_DRB_UeThrLastTimeDlQCI9, 
PM_DRB_UeThrTotVolDlQCI6, PM_DRB_UeThrTotVolDlQCI7, PM_DRB_UeThrTotVolDlQCI8, PM_DRB_UeThrTotVolDlQCI9, PM_DRB_UeThrLastVolDlQCI6, PM_DRB_UeThrLastVolDlQCI7, PM_DRB_UeThrLastVolDlQCI8, PM_DRB_UeThrLastVolDlQCI9
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, 
SUM(VOLTE_TRAFFIC_NUM) PM_ERAB_SessionTimeQCI1,
SUM(UL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtUlVolSum,
SUM(DL_TRAFFIC_VOLUME) PM_DRB_PdcpSduBitRtDlVolSum,
SUM(PM_RRU_PRBTOTDLAVAILABLE) PM_RRU_PrbTotDlAvailable,
SUM(PM_RRU_PrbTotDlUsed) PM_RRU_PrbTotDlUsed,
SUM(PM_DRB_UeThrTotTimeDlQCI6) PM_DRB_UeThrTotTimeDlQCI6,
SUM(PM_DRB_UeThrTotTimeDlQCI7) PM_DRB_UeThrTotTimeDlQCI7,
SUM(PM_DRB_UeThrTotTimeDlQCI8) PM_DRB_UeThrTotTimeDlQCI8,
SUM(PM_DRB_UeThrTotTimeDlQCI9) PM_DRB_UeThrTotTimeDlQCI9,
SUM(PM_DRB_UeThrLastTimeDlQCI6) PM_DRB_UeThrLastTimeDlQCI6,
SUM(PM_DRB_UeThrLastTimeDlQCI7) PM_DRB_UeThrLastTimeDlQCI7,
SUM(PM_DRB_UeThrLastTimeDlQCI8) PM_DRB_UeThrLastTimeDlQCI8,
SUM(PM_DRB_UeThrLastTimeDlQCI9) PM_DRB_UeThrLastTimeDlQCI9,
SUM(PM_DRB_UeThrTotVolDlQCI6) PM_DRB_UeThrTotVolDlQCI6,
SUM(PM_DRB_UeThrTotVolDlQCI7) PM_DRB_UeThrTotVolDlQCI7,
SUM(PM_DRB_UeThrTotVolDlQCI8) PM_DRB_UeThrTotVolDlQCI8,
SUM(PM_DRB_UeThrTotVolDlQCI9) PM_DRB_UeThrTotVolDlQCI9,
SUM(PM_DRB_UeThrLastVolDlQCI6) PM_DRB_UeThrLastVolDlQCI6,
SUM(PM_DRB_UeThrLastVolDlQCI7) PM_DRB_UeThrLastVolDlQCI7,
SUM(PM_DRB_UeThrLastVolDlQCI8) PM_DRB_UeThrLastVolDlQCI8,
SUM(PM_DRB_UeThrLastVolDlQCI9) PM_DRB_UeThrLastVolDlQCI9
FROM NORTHI_DATA.ULAK_4G 
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24 
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
) A, NORTHI_DATA.LIST_ULAK_ENODEB_CELL X, NORTHI_PARSER.OBJECTS_ULAK4G_DAILY Y
WHERE A.NETWORK_ID=X.CELL_ID AND A.NETWORK_ID = Y.NE_ID AND TRUNC(A.FRAGMENT_DATE) = Y.DATA_DATE;

   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'CELL_UTILPRB_4G_ULAK_1920_H',XSTATE );
                           commit;                   
                          
                           raise;
                                    
   END; 
   
PROCEDURE REPORT_CELL_UTILPRB_5G (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

   
DELETE /*+ PARALLEL(16) */ FROM  NORTHI_DATA.REPORT_CELL_UTIL_PRB_5G WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24; COMMIT; 

INSERT /*+ APPEND */ INTO NORTHI_DATA.REPORT_CELL_UTIL_PRB_5G (NETWORK_ID, FBAND_ID, FRAGMENT_DATE, NR_PRB_USED_PRB_DL, NR_AVAILABLE_PRB_DL, NONGBR_ACTIVE_DATA_USERS_DL, NONGBR_USER_THRPUT_DL, NR_CELL_MAC_DATA_VOL_DL, NR_CELL_ACTIVITY_TIME_DL)

WITH DATASET AS
(
SELECT * 
FROM NORTHI_DATA.CELLSTS_5G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24
)

SELECT NETWORK_ID, FBAND_ID, FRAGMENT_DATE, NR_PRB_USED_PRB_DL, NR_AVAILABLE_PRB_DL, NONGBR_ACTIVE_DATA_USERS_DL, NONGBR_USER_THRPUT_DL, NR_CELL_MAC_DATA_VOL_DL, NR_CELL_ACTIVITY_TIME_DL
FROM
(
SELECT NETWORK_ID, FBAND_ID, FRAGMENT_DATE, NR_PRB_USED_PRB_DL, NR_AVAILABLE_PRB_DL, NONGBR_ACTIVE_DATA_USERS_DL, NONGBR_USER_THRPUT_DL, NR_CELL_MAC_DATA_VOL_DL, NR_CELL_ACTIVITY_TIME_DL,
       ROW_NUMBER() OVER ( PARTITION BY NETWORK_ID ORDER BY NONGBR_ACTIVE_DATA_USERS_DL DESC, FRAGMENT_DATE DESC)  RN
FROM 
(
SELECT 
NETWORK_ID,
FBAND_ID,
FRAGMENT_DATE,
ROUND(SUM(N_PRB_DL_USED_AVG),2) NR_PRB_USED_PRB_DL,
ROUND(SUM(N_PRB_DL_AVAIL_AVG),2) NR_AVAILABLE_PRB_DL,
ROUND(SUM(DL_RMV_LAST_SLOT_TRNSFR_TIME) / 1000 / 3600000,3) NONGBR_ACTIVE_DATA_USERS_DL,
ROUND(DECODE(SUM(DL_RMV_LAST_SLOT_TRNSFR_TIME), 0, 0, 1000 * SUM(DL_RMV_LAST_SLOT_TRAFF_VOL)/SUM(DL_RMV_LAST_SLOT_TRNSFR_TIME)),2) NONGBR_USER_THRPUT_DL,
ROUND(SUM(N_THP_VOL_DL_CELL) / (8 * 1000),2) NR_CELL_MAC_DATA_VOL_DL,
ROUND(SUM(N_THP_TIME_DL_CELL) / 1000000,2) NR_CELL_ACTIVITY_TIME_DL
FROM DATASET
GROUP BY NETWORK_ID, FBAND_ID, FRAGMENT_DATE
)
)
WHERE RN = 1;

   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'REPORT_CELL_UTILPRB_5G',XSTATE );
                           commit;                   
                          
                           raise;
                                    
   END; 
   
PROCEDURE KKTC_CELL_UTILPRB_4G_1920_H (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

  -- EXECUTE IMMEDIATE 'TRUNCATE TABLE NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920_H'; COMMIT;
  
   DELETE /*+ PARALLEL(16) */ FROM  NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920_H
            WHERE ( FRAGMENT_dATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24)  or FRAGMENT_DATE < TRUNC(SYSDATE-15); 
   commit; 
 
 
   INSERT INTO NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920_H (FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL, KPI160_EXT1, KPI160_EXT2, KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME, LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED,NR_NON_GBR_ACT_DATA_USERS_DL)
 
WITH DATASET AS
(
SELECT NETWORK_ID, FRAGMENT_DATE, FBAND_ID, DL_CHMEAS_PRB, L_CHMEAS_PRB_DL_AVAIL, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_FWA, USER_DL_RMVLAST_TTI_TRAFF_VOL, L_THRP_TIME_DL_RMVLAST_TTI, DL_NONGBR_USER_THR_NUM_FWA, DL_NONGBR_USER_THR_DEN_FWA, DL_TRAFFIC_VOL, L_THRP_TIME_CELL_DL_HIGH_PREC, AVG_DL_CELL_THR_NUM, L_Thrp_bits_DL_CAUser, L_THRP_BITS_DL_LAST_TTI, L_Thrp_bits_DL_LastTTI_CAUser, Thrp_Time_DL_RmvLastTTI_User, L_Traffic_DL_MAC_TRFF, AVG_CQI_256QM_NUM_FWA, AVG_CQI_256QM_DEN_FWA, L_ChMeas_PDSCH_MCS_NUM, L_ChMeas_PDSCH_MCS_DEN, L_ChMeas_RI_Rank1, L_ChMeas_RI_Rank2, L_ChMeas_RI_Rank3, L_ChMeas_RI_Rank4, VOLTE_TRAFFIC, VOLTE_DATA_VOLUME, TRAFFIC_VOLUME_QCI_8, L_THRP_BITS_DL_QCI_6789, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA_NUM, DL_USER_THRPUT_FWA_DEN, DL_DATA_VOLUME_FWA, CHMEAS_PRB_DL_PCELL_USED_AVG, CHMEAS_PRB_DL_SCELL_USED_AVG, DL_FIRST_PACKET_DELAY_NUM, DL_FIRST_PACKET_DELAY_DEN, DL_FIRST_PACKET_DELAY_MOB_NUM, DL_FIRST_PACKET_DELAY_MOB_DEN, DL_FIRST_PACKET_DELAY_FWA_NUM, DL_FIRST_PACKET_DELAY_FWA_DEN, DL_NONGBR_USER_EXPERIENCE_NUM, DL_NONGBR_USER_EXPERIENCE_DEN, AVERAGE_CQI_NON256QAM_NUM, AVERAGE_CQI_NON256QAM_DEN, EXT_PRB_NUM, EXT_PRB_DEN, DL_NONGBR_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_NUM, AVG_RRC_CONNECTED_USER, KPI160_EXT1, KPI160_EXT2_NUM, KPI160_EXT3, L_THRP_BITS_DL_QCI, THRP_BITS_DEXTQCI_INDEX0, THRP_BITS_DEXTQCI_INDEX1, THRP_BITS_DEXTQCI_INDEX2, DL_TRAFF_QCI_133_MB_NUM, L_THRP_BITS_DL_EXTQCI_INDEX5, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT_NUM, LTE_HU_DATA_VOLUME_NUM, LTE_NRML_HU_USER_THRPUT_NUM, LTE_NRML_HU_USER_THRPUT_DEN, CAT_M_PRB_USED_DL, 0 DL_RSOURCE_BLOCK_UTIL_RATE_NUM, 0 USER_DL_AVG_TPUT_DEN
FROM NORTHI_DATA.KKTC_CELLSTS_4G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24 AND L_CHMEAS_PRB_DL_AVAIL!=0
)

SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT,CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME,MAC_DL_DATA_VOLUME, AVG_CQI,AVG_MCS,AVG_RANK_INDICATION,VOLTE_SESSION_TIME,VOLTE_DATA_VOLUME,  
       A.FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB,L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB,
       DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS,
       DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL
FROM
(
SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS, 
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,4) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),4) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)/1000,2) DL_CELL_ACTIVITY_TIME,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),0,0,(SUM(AVG_DL_CELL_THR_NUM)/1000)/SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)),2) DL_CELL_THROUGHPUT,
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User),0,0,((SUM(AVG_DL_CELL_THR_NUM-L_Thrp_bits_DL_CAUser)-SUM(L_THRP_BITS_DL_LAST_TTI-L_Thrp_bits_DL_LastTTI_CAUser))/1000)/SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User)),2) NONCA_DL_USER_THROUGHPUT,
                         CASE 
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) = 0 THEN NULL
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) <> 0 THEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2)
                         END  CA_DL_USER_THROUGHPUT,
                         CASE
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) = 0 THEN NULL
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) <> 0 THEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2)
                         END CA_DL_DATA_VOLUME,
                         ROUND(SUM(L_Traffic_DL_MAC_TRFF)/(8*POWER(10,6)),2) MAC_DL_DATA_VOLUME,
                         ROUND(DECODE(SUM(AVG_CQI_256QM_DEN_FWA),0,0,SUM(AVG_CQI_256QM_NUM_FWA)/SUM(AVG_CQI_256QM_DEN_FWA)),2) AVG_CQI, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_ChMeas_PDSCH_MCS_DEN),0,0,SUM(L_ChMeas_PDSCH_MCS_NUM)/SUM(L_ChMeas_PDSCH_MCS_DEN)),2) AVG_MCS,
                         ROUND(DECODE(SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4),0,0,SUM(L_ChMeas_RI_Rank1+(2*L_ChMeas_RI_Rank2)+(3*L_ChMeas_RI_Rank3)+(4*L_ChMeas_RI_Rank4))/SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4)),2) AVG_RANK_INDICATION,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(SUM(VOLTE_DATA_VOLUME)/(8*POWER(10,6)),2) VOLTE_DATA_VOLUME,
                         ROUND(SUM(TRAFFIC_VOLUME_QCI_8)/8/1024/1024,2) TRAFFIC_VOLUME_QCI_8_MB,
                         ROUND(SUM(L_THRP_BITS_DL_QCI_6789)/8/1024/1024,2) L_THRP_BITS_DL_QCI_6789_MB,
                         ROUND(SUM(DL_ACTIVE_USERS_FWA)/3600000,4) DL_ACTIVE_USERS_FWA, 
                         ROUND(DECODE(SUM(DL_USER_THRPUT_FWA_DEN),0,0,(SUM(DL_USER_THRPUT_FWA_NUM)/1000)/SUM(DL_USER_THRPUT_FWA_DEN)),2) DL_USER_THRPUT_FWA, 
                         ROUND(SUM(DL_DATA_VOLUME_FWA)/8000000,2) DL_DATA_VOLUME_FWA, 
                         ROUND(SUM(Thrp_Time_DL_RmvLastTTI_User)/3600000,2) DL_CA_ACTIVE_USERS, 
                         ROUND(SUM(CHMEAS_PRB_DL_PCELL_USED_AVG),2) DL_PCELL_USED_PRB, 
                         ROUND(SUM(CHMEAS_PRB_DL_SCELL_USED_AVG),2) DL_SCELL_USED_PRB, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_NUM)/SUM(DL_FIRST_PACKET_DELAY_DEN)),2) DL_FIRST_PACKET_DELAY, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_FIRST_PACKET_DELAY_MOBILE, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FIRST_PACKET_DELAY_FWA, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_EXPERIENCE_DEN),0,0,(SUM(DL_NONGBR_USER_EXPERIENCE_NUM)/1000)/SUM(DL_NONGBR_USER_EXPERIENCE_DEN)),2) DL_NONGBR_USER_EXPERIENCE, 
                         ROUND(DECODE(SUM(AVERAGE_CQI_NON256QAM_DEN),0,0,SUM(AVERAGE_CQI_NON256QAM_NUM)/SUM(AVERAGE_CQI_NON256QAM_DEN)),2) AVERAGE_CQI_NON256QAM, 
                         ROUND(DECODE(SUM(EXT_PRB_DEN),0,0,SUM(EXT_PRB_NUM)*100/SUM(EXT_PRB_DEN)),2) EXT_PRB, 
                         ROUND(DECODE(SUM(DL_NONGBR_ACTIVE_USERS),0,0,(SUM(DL_NONGBR_ACTIVE_USERS_NUM)/1000)/SUM(DL_NONGBR_ACTIVE_USERS)),4) DL_NONGBR_NORM_USER_THRPUT, 
                         ROUND(SUM(AVG_RRC_CONNECTED_USER),2) RRC_CONNECTED_USERS,
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_NORM_USER_FIRST_PAC_DEL, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FWA_USER_PAC_DEL, 
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_EXT1,
                         ROUND(DECODE(SUM(KPI160_EXT1),0,0,(SUM(KPI160_EXT2_NUM)/1000)/SUM(KPI160_EXT1)),2) KPI160_EXT2,
                         ROUND(SUM(KPI160_EXT3)/8000000,2) KPI160_EXT3,
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_HU_C,
                         ROUND(DECODE(SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA),0,0,SUM(DL_TRAFFIC_VOL-L_THRP_BITS_DL_QCI-(THRP_BITS_DEXTQCI_INDEX0+THRP_BITS_DEXTQCI_INDEX1+THRP_BITS_DEXTQCI_INDEX2+DL_TRAFF_QCI_133_MB_NUM))/SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA)/1000),2) KPI160_HU_D,
                         ROUND(SUM(L_THRP_BITS_DL_EXTQCI_INDEX5)/8000000,2) KPI160_HU_E,
                         ROUND(SUM(LTE_HU_ACTIVE_USERS) / 3600000,2) LTE_HU_ACTIVE_USERS,
                         ROUND(DECODE(SUM(LTE_HU_ACTIVE_USERS),0,0,SUM(LTE_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_HU_ACTIVE_USERS)),2) LTE_HU_USER_THRPUT,
                         ROUND(SUM(LTE_HU_DATA_VOLUME_NUM) / 8000000,2)  LTE_HU_DATA_VOLUME,
                         ROUND(DECODE(SUM(LTE_NRML_HU_USER_THRPUT_DEN),0,0,SUM(LTE_NRML_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_NRML_HU_USER_THRPUT_DEN)),2) LTE_NRML_HU_USER_THRPUT,
                         ROUND(SUM(CAT_M_PRB_USED_DL),2) CAT_M_PRB_USED_DL,
                         ROUND(SUM(DL_RSOURCE_BLOCK_UTIL_RATE_NUM),2) NR_PRB_USED, 
                         ROUND(SUM(USER_DL_AVG_TPUT_DEN),2) NR_NON_GBR_ACT_DATA_USERS_DL             
FROM DATASET
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID = B.FBAND_ID
;

   EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'KKTC_CELL_UTILPRB_4G_1920_H',XSTATE );
                           commit;                   
                          
                           raise;
                                    
   END;   
   
PROCEDURE KKTC_CELL_UTILPRB_4G_1920(XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);

BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920';

DELETE FROM NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920 WHERE FRAGMENT_DATE  BETWEEN XDATE AND XDATE+23/24;
COMMIT; 

INSERT /*+ APPEND */ INTO NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920 (FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL, KPI160_EXT1, KPI160_EXT2, KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME, LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED,NR_NON_GBR_ACT_DATA_USERS_DL, KPI_C_820)

WITH DATASET AS
(
SELECT NETWORK_ID, FRAGMENT_DATE, FBAND_ID, DL_CHMEAS_PRB, L_CHMEAS_PRB_DL_AVAIL, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_FWA, USER_DL_RMVLAST_TTI_TRAFF_VOL, L_THRP_TIME_DL_RMVLAST_TTI, DL_NONGBR_USER_THR_NUM_FWA, DL_NONGBR_USER_THR_DEN_FWA, DL_TRAFFIC_VOL, L_THRP_TIME_CELL_DL_HIGH_PREC, AVG_DL_CELL_THR_NUM, L_Thrp_bits_DL_CAUser, L_THRP_BITS_DL_LAST_TTI, L_Thrp_bits_DL_LastTTI_CAUser, Thrp_Time_DL_RmvLastTTI_User, L_Traffic_DL_MAC_TRFF, AVG_CQI_256QM_NUM_FWA, AVG_CQI_256QM_DEN_FWA, L_ChMeas_PDSCH_MCS_NUM, L_ChMeas_PDSCH_MCS_DEN, L_ChMeas_RI_Rank1, L_ChMeas_RI_Rank2, L_ChMeas_RI_Rank3, L_ChMeas_RI_Rank4, VOLTE_TRAFFIC, VOLTE_DATA_VOLUME, TRAFFIC_VOLUME_QCI_8, L_THRP_BITS_DL_QCI_6789, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA_NUM, DL_USER_THRPUT_FWA_DEN, DL_DATA_VOLUME_FWA, CHMEAS_PRB_DL_PCELL_USED_AVG, CHMEAS_PRB_DL_SCELL_USED_AVG, DL_FIRST_PACKET_DELAY_NUM, DL_FIRST_PACKET_DELAY_DEN, DL_FIRST_PACKET_DELAY_MOB_NUM, DL_FIRST_PACKET_DELAY_MOB_DEN, DL_FIRST_PACKET_DELAY_FWA_NUM, DL_FIRST_PACKET_DELAY_FWA_DEN, DL_NONGBR_USER_EXPERIENCE_NUM, DL_NONGBR_USER_EXPERIENCE_DEN, AVERAGE_CQI_NON256QAM_NUM, AVERAGE_CQI_NON256QAM_DEN, EXT_PRB_NUM, EXT_PRB_DEN, DL_NONGBR_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS_NUM, AVG_RRC_CONNECTED_USER, KPI160_EXT1, KPI160_EXT2_NUM, KPI160_EXT3, L_THRP_BITS_DL_QCI, THRP_BITS_DEXTQCI_INDEX0, THRP_BITS_DEXTQCI_INDEX1, THRP_BITS_DEXTQCI_INDEX2, DL_TRAFF_QCI_133_MB_NUM, L_THRP_BITS_DL_EXTQCI_INDEX5, LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT_NUM, LTE_HU_DATA_VOLUME_NUM, LTE_NRML_HU_USER_THRPUT_NUM, LTE_NRML_HU_USER_THRPUT_DEN, CAT_M_PRB_USED_DL, 0 DL_RSOURCE_BLOCK_UTIL_RATE_NUM, 0 USER_DL_AVG_TPUT_DEN
FROM NORTHI_DATA.KKTC_CELLSTS_4G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN TRUNC(XDATE) AND TRUNC(XDATE)+23/24 AND L_CHMEAS_PRB_DL_AVAIL!=0
),

DATASET_2 AS
(
SELECT TRUNC(FRAGMENT_DATE) FRAGMENT_DATE, NETWORK_ID, FBAND_ID, 
SUM(CASE WHEN ROUND((DL_NONGBR_ACTIVE_USERS)/((5*BW-(0.15*VOLTE_SESSION_TIME)-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100 AND (DL_NONGBR_USER_THROUGHPUT)<3  THEN 1 ELSE 0 END)  KPI_C_820 
FROM NORTHI_DATA.KKTC_CELL_UTIL_PRB_4G_1920_H
WHERE FRAGMENT_DATE BETWEEN TRUNC(XDATE)+8/24 AND TRUNC(XDATE)+20/24
GROUP BY TRUNC(FRAGMENT_DATE), NETWORK_ID, FBAND_ID
)

SELECT A1.*, A2.KPI_C_820
FROM
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT, CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME, MAC_DL_DATA_VOLUME, AVG_CQI, AVG_MCS, AVG_RANK_INDICATION, VOLTE_SESSION_TIME, VOLTE_DATA_VOLUME, FBAND_ID, 
       TRAFFIC_VOLUME_QCI_8_MB, L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB, DL_FIRST_PACKET_DELAY,
       DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS, DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,
       KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,
       LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL
FROM 
(
SELECT FRAGMENT_DATE, NETWORK_ID, FBAND, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT, DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,DL_CELL_ACTIVITY_TIME, 
       DL_CELL_THROUGHPUT, NONCA_DL_USER_THROUGHPUT,CA_DL_USER_THROUGHPUT, CA_DL_DATA_VOLUME,MAC_DL_DATA_VOLUME, AVG_CQI,AVG_MCS,AVG_RANK_INDICATION,VOLTE_SESSION_TIME,VOLTE_DATA_VOLUME,  
       A.FBAND_ID, TRAFFIC_VOLUME_QCI_8_MB,L_THRP_BITS_DL_QCI_6789_MB, DL_ACTIVE_USERS_FWA, DL_USER_THRPUT_FWA, DL_DATA_VOLUME_FWA, DL_CA_ACTIVE_USERS, DL_PCELL_USED_PRB, DL_SCELL_USED_PRB,
       DL_FIRST_PACKET_DELAY, DL_FIRST_PACKET_DELAY_MOBILE, DL_FIRST_PACKET_DELAY_FWA, DL_NONGBR_USER_EXPERIENCE, AVERAGE_CQI_NON256QAM, EXT_PRB, DL_NONGBR_NORM_USER_THRPUT, RRC_CONNECTED_USERS,
       DL_NORM_USER_FIRST_PAC_DEL, DL_FWA_USER_PAC_DEL,KPI160_EXT1,KPI160_EXT2,KPI160_EXT3, KPI160_HU_C, KPI160_HU_D, KPI160_HU_E,LTE_HU_ACTIVE_USERS, LTE_HU_USER_THRPUT, LTE_HU_DATA_VOLUME,
       LTE_NRML_HU_USER_THRPUT, CAT_M_PRB_USED_DL, NR_PRB_USED, NR_NON_GBR_ACT_DATA_USERS_DL,
       row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_NONGBR_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_DATA_VOLUME DESC, FRAGMENT_DATE DESC)  RN
FROM
(SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS, 
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,4) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),4) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)/1000,2) DL_CELL_ACTIVITY_TIME,
                         ROUND(DECODE(SUM(L_THRP_TIME_CELL_DL_HIGH_PREC),0,0,(SUM(AVG_DL_CELL_THR_NUM)/1000)/SUM(L_THRP_TIME_CELL_DL_HIGH_PREC)),2) DL_CELL_THROUGHPUT,
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User),0,0,((SUM(AVG_DL_CELL_THR_NUM-L_Thrp_bits_DL_CAUser)-SUM(L_THRP_BITS_DL_LAST_TTI-L_Thrp_bits_DL_LastTTI_CAUser))/1000)/SUM(L_THRP_TIME_DL_RMVLAST_TTI-Thrp_Time_DL_RmvLastTTI_User)),2) NONCA_DL_USER_THROUGHPUT,
                         CASE 
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) = 0 THEN NULL
                             WHEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2) <> 0 THEN ROUND(DECODE(SUM(Thrp_Time_DL_RmvLastTTI_User),0,0,(SUM(L_Thrp_bits_DL_CAUser-L_Thrp_bits_DL_LastTTI_CAUser)/1000)/SUM(Thrp_Time_DL_RmvLastTTI_User)),2)
                         END  CA_DL_USER_THROUGHPUT,
                         CASE
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) = 0 THEN NULL
                             WHEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2) <> 0 THEN ROUND(SUM(L_Thrp_bits_DL_CAUser)/(8*POWER(10,6)),2)
                         END CA_DL_DATA_VOLUME,
                         ROUND(SUM(L_TRAFFIC_DL_MAC_TRFF)/(8*POWER(10,6)),2) MAC_DL_DATA_VOLUME,
                         ROUND(DECODE(SUM(AVG_CQI_256QM_DEN_FWA),0,0,SUM(AVG_CQI_256QM_NUM_FWA)/SUM(AVG_CQI_256QM_DEN_FWA)),2) AVG_CQI, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_ChMeas_PDSCH_MCS_DEN),0,0,SUM(L_ChMeas_PDSCH_MCS_NUM)/SUM(L_ChMeas_PDSCH_MCS_DEN)),2) AVG_MCS,
                         ROUND(DECODE(SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4),0,0,SUM(L_ChMeas_RI_Rank1+(2*L_ChMeas_RI_Rank2)+(3*L_ChMeas_RI_Rank3)+(4*L_ChMeas_RI_Rank4))/SUM(L_ChMeas_RI_Rank1+L_ChMeas_RI_Rank2+L_ChMeas_RI_Rank3+L_ChMeas_RI_Rank4)),2) AVG_RANK_INDICATION,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(SUM(VOLTE_DATA_VOLUME)/(8*POWER(10,6)),2) VOLTE_DATA_VOLUME,
                         ROUND(SUM(TRAFFIC_VOLUME_QCI_8)/8/1024/1024,2) TRAFFIC_VOLUME_QCI_8_MB,
                         ROUND(SUM(L_THRP_BITS_DL_QCI_6789)/8/1024/1024,2) L_THRP_BITS_DL_QCI_6789_MB,
                         ROUND(SUM(DL_ACTIVE_USERS_FWA)/3600000,4) DL_ACTIVE_USERS_FWA, 
                         ROUND(DECODE(SUM(DL_USER_THRPUT_FWA_DEN),0,0,(SUM(DL_USER_THRPUT_FWA_NUM)/1000)/SUM(DL_USER_THRPUT_FWA_DEN)),2) DL_USER_THRPUT_FWA, 
                         ROUND(SUM(DL_DATA_VOLUME_FWA)/8000000,2) DL_DATA_VOLUME_FWA, 
                         ROUND(SUM(Thrp_Time_DL_RmvLastTTI_User)/3600000,2) DL_CA_ACTIVE_USERS, 
                         ROUND(SUM(CHMEAS_PRB_DL_PCELL_USED_AVG),2) DL_PCELL_USED_PRB, 
                         ROUND(SUM(CHMEAS_PRB_DL_SCELL_USED_AVG),2) DL_SCELL_USED_PRB, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_NUM)/SUM(DL_FIRST_PACKET_DELAY_DEN)),2) DL_FIRST_PACKET_DELAY, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_FIRST_PACKET_DELAY_MOBILE, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FIRST_PACKET_DELAY_FWA, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_EXPERIENCE_DEN),0,0,(SUM(DL_NONGBR_USER_EXPERIENCE_NUM)/1000)/SUM(DL_NONGBR_USER_EXPERIENCE_DEN)),2) DL_NONGBR_USER_EXPERIENCE, 
                         ROUND(DECODE(SUM(AVERAGE_CQI_NON256QAM_DEN),0,0,SUM(AVERAGE_CQI_NON256QAM_NUM)/SUM(AVERAGE_CQI_NON256QAM_DEN)),2) AVERAGE_CQI_NON256QAM, 
                         ROUND(DECODE(SUM(EXT_PRB_DEN),0,0,SUM(EXT_PRB_NUM)*100/SUM(EXT_PRB_DEN)),2) EXT_PRB, 
                         ROUND(DECODE(SUM(DL_NONGBR_ACTIVE_USERS),0,0,(SUM(DL_NONGBR_ACTIVE_USERS_NUM)/1000)/SUM(DL_NONGBR_ACTIVE_USERS)),4) DL_NONGBR_NORM_USER_THRPUT, 
                         ROUND(SUM(AVG_RRC_CONNECTED_USER),2) RRC_CONNECTED_USERS,
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_MOB_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_MOB_NUM)/SUM(DL_FIRST_PACKET_DELAY_MOB_DEN)),2) DL_NORM_USER_FIRST_PAC_DEL, 
                         ROUND(DECODE(SUM(DL_FIRST_PACKET_DELAY_FWA_DEN),0,0,SUM(DL_FIRST_PACKET_DELAY_FWA_NUM)/SUM(DL_FIRST_PACKET_DELAY_FWA_DEN)),2) DL_FWA_USER_PAC_DEL, 
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_EXT1,
                         ROUND(DECODE(SUM(KPI160_EXT1),0,0,(SUM(KPI160_EXT2_NUM)/1000)/SUM(KPI160_EXT1)),2) KPI160_EXT2,
                         ROUND(SUM(KPI160_EXT3)/8000000,2) KPI160_EXT3,
                         ROUND(SUM(KPI160_EXT1)/3600000,3) KPI160_HU_C,
                         ROUND(DECODE(SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA),0,0,SUM(DL_TRAFFIC_VOL-L_THRP_BITS_DL_QCI-(THRP_BITS_DEXTQCI_INDEX0+THRP_BITS_DEXTQCI_INDEX1+THRP_BITS_DEXTQCI_INDEX2+DL_TRAFF_QCI_133_MB_NUM))/SUM(KPI160_EXT1-DL_ACTIVE_USERS_FWA)/1000),2) KPI160_HU_D,
                         ROUND(SUM(L_THRP_BITS_DL_EXTQCI_INDEX5)/8000000,2) KPI160_HU_E,
                         
                         ROUND(SUM(LTE_HU_ACTIVE_USERS) / 3600000,2) LTE_HU_ACTIVE_USERS,
                         ROUND(DECODE(SUM(LTE_HU_ACTIVE_USERS),0,0,SUM(LTE_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_HU_ACTIVE_USERS)),2) LTE_HU_USER_THRPUT,
                         ROUND(SUM(LTE_HU_DATA_VOLUME_NUM) / 8000000,2)  LTE_HU_DATA_VOLUME,
                         ROUND(DECODE(SUM(LTE_NRML_HU_USER_THRPUT_DEN),0,0,SUM(LTE_NRML_HU_USER_THRPUT_NUM) / 1000 / SUM(LTE_NRML_HU_USER_THRPUT_DEN)),2) LTE_NRML_HU_USER_THRPUT,
                         ROUND(SUM(CAT_M_PRB_USED_DL),2) CAT_M_PRB_USED_DL,
                         ROUND(SUM(DL_RSOURCE_BLOCK_UTIL_RATE_NUM),2) NR_PRB_USED, 
                         ROUND(SUM(USER_DL_AVG_TPUT_DEN),2) NR_NON_GBR_ACT_DATA_USERS_DL 
                         
FROM DATASET
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)   A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID = B.FBAND_ID
) WHERE RN=1
) A1, DATASET_2 A2
WHERE A1.NETWORK_ID = A2.NETWORK_ID AND TRUNC(A1.FRAGMENT_DATE) = TRUNC(A2.FRAGMENT_DATE) AND A1.FBAND_ID = A2.FBAND_ID;

COMMIT;


 EXCEPTION
     WHEN NO_DATA_FOUND THEN
     
       NULL;
     WHEN OTHERS THEN
        errm:=SQLERRM;
        errcode:=sqlCODE;
       INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                             VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'KKTC_CELL_UTIL_PRB_4G_1920',XSTATE );
       commit;                   
       
     
       raise;
    
END;

PROCEDURE KKTC_CELL_UTILPRB_4G_1920_100 (XDATE DATE) 
AS
errm varchar2(4000);
errcode number;
XSTATE VARCHAR2(100);
BEGIN

XSTATE := 'DELETE FROM NORTHI_DATA.KKTC_CELL_UTILPRB_4G_1920_100';

DELETE FROM NORTHI_DATA.KKTC_CELL_UTILPRB_4G_1920_100 WHERE FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24; COMMIT;

INSERT /*+ APPEND */  INTO NORTHI_DATA.KKTC_CELL_UTILPRB_4G_1920_100  (FRAGMENT_DATE, NETWORK_ID, FBAND, FBAND_ID, BW, PRBS_USED_BY_PDSCH, AVAILABLE_PRBS, DL_ACTIVE_USERS, DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME, VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT)

WITH DATASET AS
(
SELECT FRAGMENT_DATE, NETWORK_ID,FBAND_ID, 
                         ROUND(SUM(DL_CHMEAS_PRB),2) PRBS_USED_BY_PDSCH,
                         ROUND(SUM(L_CHMEAS_PRB_DL_AVAIL),2) AVAILABLE_PRBS,
                         ROUND(SUM(DL_ACTIVE_USERS),2) DL_ACTIVE_USERS,
                         ROUND(SUM(DL_NONGBR_ACTIVE_USERS_FWA)/3600000,2) DL_NONGBR_ACTIVE_USERS, -- UPDATE OLDU
                         ROUND(DECODE(SUM(L_THRP_TIME_DL_RMVLAST_TTI),0,0,SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL)/SUM(L_THRP_TIME_DL_RMVLAST_TTI)/1000),2) DL_USER_THROUGHPUT, 
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA),0,0,SUM(DL_NONGBR_USER_THR_NUM_FWA)/SUM(DL_NONGBR_USER_THR_DEN_FWA)/1000),2) DL_NONGBR_USER_THROUGHPUT, -- UPDATE OLDU
                         ROUND(SUM(DL_TRAFFIC_VOL)/8/1000/1000,2) DL_CELL_DATA_VOLUME,
                         ROUND(SUM(VOLTE_TRAFFIC)/36000,2) VOLTE_SESSION_TIME,
                         ROUND(DECODE(SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN),0,0,(SUM(USER_DL_RMVLAST_TTI_TRAFF_VOL-DL_NORM_USER_THRPUT_NUM)/1000)/SUM(DL_NONGBR_USER_THR_DEN_FWA-DL_USER_THRPUT_FWA_DEN)),2) DL_NONGBR_NORM_USER_THRPUT
FROM NORTHI_DATA.KKTC_CELLSTS_4G
WHERE DTYPE=1 AND FRAGMENT_DATE BETWEEN XDATE AND XDATE+23/24  
AND L_CHMEAS_PRB_DL_AVAIL!=0
GROUP BY FRAGMENT_DATE, NETWORK_ID,FBAND_ID
)

SELECT  FRAGMENT_DATE, NETWORK_ID,FBAND,FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS, DL_USER_THROUGHPUT ,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT
FROM 
(
SELECT  FRAGMENT_DATE, NETWORK_ID, FBAND,A.FBAND_ID, BW,PRBS_USED_BY_PDSCH,AVAILABLE_PRBS,DL_ACTIVE_USERS,DL_NONGBR_ACTIVE_USERS,DL_USER_THROUGHPUT,DL_NONGBR_USER_THROUGHPUT, DL_CELL_DATA_VOLUME,VOLTE_SESSION_TIME,DL_NONGBR_NORM_USER_THRPUT,
row_number() OVER ( PARTITION BY NETWORK_ID ORDER BY DL_NONGBR_ACTIVE_USERS DESC, PRBS_USED_BY_PDSCH DESC, DL_CELL_DATA_VOLUME DESC, FRAGMENT_DATE DESC)  RN
 FROM DATASET A, NORTHI_DATA.VIEW_ENODEB_CELL_BW B
WHERE A.NETWORK_ID=B.CELL_ID AND A.FBAND_ID=B.FBAND_ID
) WHERE ROUND((DL_ACTIVE_USERS)/((5*BW-10)/10),2)  > 1 AND ROUND((PRBS_USED_BY_PDSCH)/(AVAILABLE_PRBS-10)*100,2) > 100;

COMMIT;
                
                EXCEPTION
                      WHEN NO_DATA_FOUND THEN
                      
                        NULL;
                      WHEN OTHERS THEN
                         errm:=SQLERRM;
                         errcode:=sqlCODE;
                        INSERT INTO NORTHI_ERROR_LOG (USER_NAME, ERROR_CODE, ERROR_MSG,TABLE_NAME, DATE_TIME, PROCEDURE_NAME,SQLTEXT) 
                                              VALUES (user     ,errCODE, ERRM  ,NULL   , sysdate  ,'KKTC_CELL_UTILPRB_4G_1920_100',XSTATE );
                           commit;                   
                          
                           raise;
                                    
                END;


END EXTRA_WORKS;
/
