
  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "NORTHI_LOADER"."RAW_DAILY_WORKS" AS

PROCEDURE INSERT_RAW_DA_PROCESS(P_VENDOR_ID NUMBER)
AS 
XEXISTS NUMBER;

 BEGIN

    FOR XDA IN

    (
        SELECT UPPER(A.TABLE_NAME) TABLE_NAME, VENDOR_ID,
        TRUNC(DATA_DATE) DATA_DATE, SUM(LOADED_DATA_COUNT) DATA_COUNT  ,A.OPERATOR_NAME 
        FROM NORTHI_PARSER_SETTINGS.PARSER_SQLLDR_LOGS A, 
        (
            SELECT 
            TABLE_NAME, VENDOR_ID ,OPERATOR_NAME
            FROM NORTHI_PARSER_SETTINGS.PARSER_RAW_TABLE_LIST
            WHERE TABLE_TYPE IN ('CELL', 'NRCELL', 'NRDUCELL') AND IS_ACTIVE=1 AND VENDOR_ID=P_VENDOR_ID
        ) B
        WHERE 
        A.TABLE_NAME=B.TABLE_NAME AND A.OPERATOR_NAME=B.OPERATOR_NAME
        AND PARSER_STATE=1  
        AND PDAILY_STATE=0 
        AND DATA_DATE =TRUNC(SYSDATE-1) AND TRUNC(DATA_DATE)!=TRUNC(SYSDATE)
        GROUP BY A.TABLE_NAME,TRUNC(DATA_DATE), A.OPERATOR_NAME ,VENDOR_ID

    )

    LOOP

            SELECT COUNT(*) INTO XEXISTS FROM NORTHI_RAW_DA_PROCESS WHERE TABLE_NAME=XDA.TABLE_NAME AND DATA_DATE=XDA.DATA_DATE AND VENDOR_ID=P_VENDOR_ID;

            INSERT INTO NORTHI_DATA.NI_TEST_ERROR(SQLTEXT,LOG_ORDER,DATE_TIME)VALUES(XDA.TABLE_NAME,'START-->',SYSDATE);

            UPDATE NORTHI_PARSER_SETTINGS.PARSER_SQLLDR_LOGS  SET PDAILY_STATE=1 WHERE TABLE_NAME =XDA.TABLE_NAME AND DATA_DATE=XDA.DATA_DATE AND OPERATOR_NAME=XDA.OPERATOR_NAME; 

            INSERT INTO NORTHI_DATA.NI_TEST_ERROR(SQLTEXT,LOG_ORDER,DATE_TIME)VALUES(XDA.TABLE_NAME,'<--END',SYSDATE);

             IF XEXISTS>0 THEN

                UPDATE NORTHI_RAW_DA_PROCESS 

                SET AGGREGATE_STATE=0 ,WEEKLY_STATE=0,MONTHLY_STATE=0,PROCESS_COUNT=PROCESS_COUNT+1 WHERE TABLE_NAME=XDA.TABLE_NAME AND DATA_DATE=XDA.DATA_DATE AND  VENDOR_ID=P_VENDOR_ID; 

                 

             ELSE 

                INSERT INTO NORTHI_RAW_DA_PROCESS(TABLE_NAME, DATA_DATE, LOADER_DATE, AGGREGATE_STATE, AGGREGATE_DATE, DATA_COUNT, PROCESS_COUNT,WEEKLY_STATE,MONTHLY_STATE,VENDOR_ID) 

                VALUES(XDA.TABLE_NAME,XDA.DATA_DATE,SYSDATE,0,SYSDATE,XDA.DATA_COUNT,1,0,0,P_VENDOR_ID);

            END IF;

            COMMIT;    

    END LOOP;

  END;

PROCEDURE BEGIN_RAW_DA_TRANSFER(P_VENDOR_ID NUMBER)

  AS 

  XTABLE_NAME VARCHAR2(40);

  XDATA_DATE DATE;

  XAGGREGATE_DATE DATE;

  XROW_COUNT NUMBER;

  XVENDOR_ID NUMBER;
  
  XPROC_TYPE VARCHAR2(30);

  BEGIN
  
   XPROC_TYPE:= 'RAW_DA';

   XVENDOR_ID :=P_VENDOR_ID;
  
   FOR XDA IN

    (

        SELECT TABLE_NAME,DATA_DATE DATA_DATE,AGGREGATE_DATE,PROCESS_COUNT FROM NORTHI_RAW_DA_PROCESS WHERE AGGREGATE_STATE=0 AND VENDOR_ID=P_VENDOR_ID ORDER BY DATA_DATE

    )

    LOOP 

     XTABLE_NAME:=XDA.TABLE_NAME;

     XDATA_DATE:=XDA.DATA_DATE;

     XAGGREGATE_DATE:=XDA.AGGREGATE_DATE;

            UPDATE NORTHI_RAW_DA_PROCESS SET AGGREGATE_STATE=1,WEEKLY_STATE=0,MONTHLY_STATE=0 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE; 
            
           IF XVENDOR_ID IN (1,4,5,6,7,9) THEN

            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_RAW_DA.'|| XTABLE_NAME || ' WHERE DATA_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

           ELSIF XVENDOR_ID IN (22,23,47) THEN
            
            EXECUTE IMMEDIATE 'DELETE FROM NORTHI_KKTC_RAW_DA.'|| XTABLE_NAME || ' WHERE DATA_DATE=TO_DATE('''||to_char(XDATA_DATE,'dd.mm.yyyy hh24')||''',''dd.mm.yyyy hh24'')';

           END IF;      
     
            COMMIT;

            EXECUTE_RAW_PROCEDURE(XTABLE_NAME,XDATA_DATE,XAGGREGATE_DATE,XROW_COUNT,XVENDOR_ID,XPROC_TYPE);

            UPDATE NORTHI_RAW_DA_PROCESS SET AGGREGATE_STATE=2,WEEKLY_STATE=0,MONTHLY_STATE=0 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

            COMMIT;

    END LOOP;   

    COMMIT;

     

    EXCEPTION

     WHEN NO_DATA_FOUND THEN

       NULL;

     WHEN OTHERS THEN

     UPDATE NORTHI_RAW_DA_PROCESS SET AGGREGATE_STATE=3 WHERE TABLE_NAME=XTABLE_NAME AND DATA_DATE=XDATA_DATE;

     COMMIT;

       RAISE;

  END;
 
  PROCEDURE EXECUTE_RAW_DA_WORKS(P_VENDOR_ID NUMBER)

  AS 

  XVENDOR_NAME VARCHAR2(50);

  BEGIN

  

   SELECT VENDOR_NAME INTO XVENDOR_NAME FROM NORTHI_LOADER.NORTHI_VENDOR_LIST 

   WHERE VENDOR_ID=P_VENDOR_ID;

   XVENDOR_NAME:=XVENDOR_NAME||'_RAW_DA';

  

    IF  (NORTHI_LOADER.LOADER_STATE.GET_STATE(XVENDOR_NAME)=0) THEN

        NORTHI_LOADER.LOADER_STATE.SET_START(XVENDOR_NAME);

        INSERT_RAW_DA_PROCESS(P_VENDOR_ID);

        BEGIN_RAW_DA_TRANSFER(P_VENDOR_ID);

        NORTHI_LOADER.LOADER_STATE.SET_END(XVENDOR_NAME);


    END IF;

  END ;


END;
/
